# LAE - 个人日程与主支线管理系统

## 🚀 当前开发状态: v3.0 Foundation Phase

**最新版本: v3.0-dev (2025-09-18)**

### ✅ v3.0 Phase 1 已完成 (2025-09-17)

**数据架构重构完成**：
- ✅ **V3动态画布字段**: 新增 `duration`, `start_time`, `is_precise`, `canvas_position_y` 字段
- ✅ **SQLAlchemy模型升级**: ScheduledEvent模型支持V3所有新特性
- ✅ **API端点全面升级**: 所有相关API支持V3字段和并排摆放逻辑
- ✅ **数据兼容性**: 完整的V2→V3兼容方法和迁移辅助函数
- ✅ **数据库重建**: 包含V3字段的新数据库架构
- ✅ **交互兼容性保证**: 保持V2的所有交互方式(侧边栏+点击, 直接点击)

**V3核心特性就绪**:
- 🟢 **动态时长支持**: 卡片高度可根据duration字段动态调整
- 🟢 **精确vs模糊时间**: 支持精确时间(start_time)和模糊时段(time_slot)双模式
- 🟢 **并排摆放**: 通过canvas_position_y支持同时段多任务并行
- 🟢 **向后兼容**: 所有V2功能和数据在V3中继续有效

### ✅ v3.0 Phase 2A 已完成 (2025-09-18)

**✅ 完整的V3 UI功能**:
- ✅ **V3模式切换**: 在周视图添加V2/V3切换开关
- ✅ **10分钟微网格基础**: 实现7:00-23:00时间范围的96个10分钟网格
- ✅ **缩放功能**: 支持50%-200%缩放，带有+/-按钮控制
- ✅ **时间轴渲染**: 完整的小时标记显示
- ✅ **数据安全处理**: 修复duration null值错误
- ✅ **画布高度动态调整**: 根据缩放级别自动计算画布高度
- ✅ **V3网格点击创建**: 基于点击位置计算时间并弹出创建窗口
- ✅ **V3创建窗口**: 支持时长、起始时间、精确模式等V3字段
- ✅ **V3编辑窗口**: 完整的编辑界面，支持所有V3字段修改
- ✅ **智能吸附系统**: 吸附线和时间提示功能
- ✅ **V3卡片渲染**: 卡片基于start_time正确定位，支持动态高度
- ✅ **V3交互系统**: 卡片点击编辑功能完全正常
- ✅ **时间槽计算**: 自动计算和显示功能完全就绪
- ✅ **侧边栏节点选择**: 选中侧边栏节点后创建卡片自动填入对应信息

**🔧 已修复的关键问题**:
1. ✅ **V3模糊卡片位置错误**:
   - 修复了`renderTaskCardV3()`方法中的位置计算逻辑
   - 确保所有卡片基于`start_time`字段正确定位，而非固定在8:00位置

2. ✅ **V3卡片点击编辑失效**:
   - 解决了事件绑定问题，使用全局`window.laeAppInstance`引用
   - 添加了`stopPropagation()`防止事件冒泡

3. ✅ **时间格式验证错误**:
   - 添加了`formatTimeForAPI()`方法处理时间格式转换
   - 修复了十点前时间"8:40"转换为"08:40:00"的API格式要求

4. ✅ **网格对齐问题**:
   - 修复了时间轴与日期列之间的80px对齐偏移
   - 移除了`.days-container`中的重复`margin-left`

5. ✅ **编辑事件验证错误**:
   - 添加了`time_slot`验证和重新计算逻辑
   - 确保编辑事件时正确更新相关时间字段

6. ✅ **侧边栏选择自动填入**:
   - 实现了V2兼容的`selectedNode`系统
   - 修复了`selectedDomainId`和`selectedActivityTypeId`的数据绑定

**系统现状**:
- 🟢 **数据库层**: V3架构完全就绪，支持所有新特性
- 🟢 **模型层**: V3 SQLAlchemy模型实现并包含兼容方法
- 🟢 **API层**: V3字段支持完成
- 🟢 **前端层**: V3核心功能全部实现，用户界面完全可用

### ⚠️ V3 Phase 2A+ 紧急Bug修复 (2025-09-18)

**🐛 当前发现的关键问题**:
1. **拖拽位置算法错误**:
   - 卡片拖拽时以鼠标指针位置为准，应该以卡片本身位置为准
   - 影响用户拖拽体验的准确性
2. **拖拽功能失效**:
   - 第一次拖拽正常，第二次及后续拖拽无效
   - 原生HTML5拖拽事件监听器失效问题

**🔧 技术修复方向**:
- 使用`setDragImage()`自定义拖拽图像和位置
- 重新评估原生拖拽 vs SortableJS方案
- 修复DOM更新后的事件重新绑定

### 📋 下一步计划 (V3 Phase 2B)

**🎯 Phase 2B: 拖拽系统紧急修复** (最高优先级)
1. **修复拖拽位置算法**: 改用卡片中心点计算
2. **修复拖拽事件持久性**: 确保多次拖拽操作正常
3. **优化拖拽用户体验**: 改善视觉反馈和交互流畅度

**🎯 Phase 2C: 高级交互功能** (后续开发)
1. **模糊vs精确任务机制**: 双击切换和精确时间编辑器
2. **并排摆放系统**: 碰撞检测和自动Y位置分配
3. **待定区域功能**: 周视图顶部的未确定时间卡片池

**🎯 Phase 2C: 体验优化与兼容**
4. **数据迁移脚本**: V2数据自动升级到V3格式
5. **性能优化**: 大量卡片渲染和拖拽流畅度优化
6. **拖拽系统增强**: 支持卡片大小调整和高级拖拽交互

---

## v1.0 系统文档 (已完成)

**版本: 1.0 (已完成)**

## 1\. 项目背景 (Project Background)

为了解决在多任务并行时，对未来时间安排的高度不确定性和焦虑感，本项目旨在开发一个供个人使用的日程/主支线任务管理系统。通过**量化与可视化**的手段，清晰、直观地掌控个人时间和精力。

`zeroPPD` 将作为本系统设计和实践的第一个核心应用场景。

## 2\. 核心功能 (Core Features)

  * **主支线任务管理:** 支持无限层级的父子任务结构。
  * **时间块估算与生成:** 以固定的“时段”为单位来规划任务。
  * **可视化排程白板:** 在周视图中通过拖拽方式安排日程。
  * **多视图切换:** 支持月视图、周视图和汇总视图。
  * **目标与进度管理:** 为每一次具体的日程安排附加一个可追踪的 `goal`。
  * **数据汇总与统计:** 在汇总视图中查看各主支线的精力投入和目标列表。

## 3\. 系统架构与技术栈 (System Architecture & Technical Stack)

本项目将采用**方案A：轻量级Web框架**模式进行开发，在本地运行，通过浏览器访问。

  * **后端 (Backend):**

      * **语言:** Python
      * **Web 框架:** Flask (或 FastAPI)
      * **职责:** 负责所有业务逻辑、数据处理，并通过 API 接口与前端交互。

  * **数据库 (Database):**

      * **类型:** SQLite (单个 `.db` 文件，易于管理)
      * **交互:** 采用 **SQLAlchemy** (ORM) 进行数据库操作，以获得更好的代码可读性和维护性。

  * **前端 (Frontend):**

      * **技术:** HTML, CSS, JavaScript
      * **职责:** 负责渲染用户界面 (UI)，处理用户交互（如点击、拖拽），并通过异步请求(Ajax/Fetch)调用后端 API。

## 4\. 数据模型 (Data Model)

系统的核心由两张 SQL 数据表构成，通过 SQLAlchemy 的 Models 进行定义。

#### 4.1. `activities` (活动库)

定义所有可供选择的活动卡片及其层级关系。

| 字段名 (Field) | 类型 (Type) | 描述 |
| :--- | :--- | :--- |
| `id` | INTEGER | 唯一主键 |
| `name` | TEXT | 活动名称 (如 "zeroPPD-读文献") |
| `parent_id` | INTEGER | 指向父级活动的 `id`，顶级活动为 `NULL` |
| `description` | TEXT | (可选) 对活动的详细描述 |
| `created_at` | DATETIME | 创建时间 |

#### 4.2. `scheduled_events` (已安排日程)

记录每一次具体的日程安排。

| 字段名 (Field) | 类型 (Type) | 描述 |
| :--- | :--- | :--- |
| `id` | INTEGER | 唯一主键 |
| `activity_id` | INTEGER | 外键，关联到 `activities.id` |
| `event_date` | DATE | 日程发生的日期 |
| `time_slot` | INTEGER | 时间槽编号 (详见时间槽规则) |
| `goal` | TEXT | 本次活动要达成的具体目标 (如 "读完第三篇文献") |
| `notes` | TEXT | 备注信息，不参与统计分析 |
| `status` | TEXT | 活动状态 (如: 'planned', 'completed') |

#### 4.3. 时间槽编码规则

采用两位数编码：**第一位代表时段，第二位代表该时段内的序号**

**当前实现的时间槽：**
- `21`: 上午第1时段
- `22`: 上午第2时段  
- `51`: 下午第1时段
- `52`: 下午第2时段
- `71`: 晚上时段

**扩展示例（未来可能添加）：**
- `81`, `82`: 睡前时段
- `11`, `12`, `13`: 早晨时段
- 等等

这种编码方式便于未来扩展更多时段，而不影响现有数据。

## 5\. 核心机制与视图逻辑 (Core Mechanisms & View Logic)

#### 5.1. 月视图 (Month View)

  * **功能:** 宏观展示整月日程负荷，并作为导航入口。
  * **逻辑:** 后端查询指定月份的 `scheduled_events`，按天聚合活动数量。前端渲染日历网格，在每日单元格内显示活动数量的缩略信息。点击某一周可跳转至对应的周视图。

#### 5.2. 周视图 (Week View)

  * **功能:** 项目的核心交互界面，用于日程的拖拽式编排。
  * **布局:**
      * **左侧 (或右侧):** “活动卡片池”。后端查询 `activities` 表并构建层级树，前端将其渲染为可拖拽的卡片列表。
      * **主区域:** 7天 x 5个时间槽的网格。
  * **交互逻辑:**
    1.  用户从“活动卡片池”中拖拽一个活动卡片。
    2.  将其放置 (drop) 到主区域的某个具体时间槽中。
    3.  此时，前端可弹出一个输入框，让用户填写本次的 `goal`。
    4.  信息收集完毕后，前端 JavaScript 向后端 API 发送一个 `POST` 请求，请求体包含 `{activity_id, event_date, time_slot, goal}`。
    5.  后端接收请求，在 `scheduled_events` 表中创建一条新记录。
    6.  成功后，前端将该活动卡片正式渲染在目标时间槽中。

#### 5.3. 汇总视图 (Summary View) - 层级化活动管理中心

  * **功能:** 所有活动（主支线）的管理中心和层级化统计仪表盘。
  * **核心特性:**
    1.  **层级化活动管理:** 支持多级活动结构（如 `zeroPPD` → `zeroPPD-读文献` → `读新加的文献`）
    2.  **完整 CRUD 功能:** 创建、修改、删除任意层级的活动
    3.  **聚合统计显示:** 父级活动统计包含所有子活动的数据
    4.  **Goal 追踪管理:** 显示每个活动的所有目标及完成状态
  
  * **详细逻辑:**
    1.  **活动层级展示:**
        - 按层级顺序显示，父级活动在上，子级活动缩进显示
        - 父级活动统计信息聚合所有子活动数据
        - 子级活动独立显示自己的统计信息
    
    2.  **统计信息展示:**
        - **安排次数统计:** 显示某月该活动被安排的总次数
        - **完成率统计:** 基于 goal 的完成状态计算
        - **Goal 列表:** 显示该活动的所有已安排目标及其日期
    
    3.  **Goal 管理系统:**
        - 当用户在周视图中拖拽活动到时间槽时，可添加具体目标
        - 示例：`zeroPPD-读文献` 安排在 "九月第四周周三上午第二时段"，目标："读完第三篇文献"
        - 汇总视图中显示：活动 `zeroPPD-读文献` 包含目标 "读完第三篇文献 (9月第4周周三)"
    
    4.  **活动卡片来源:**
        - 周视图中的拖拽卡片池来源于汇总视图创建的活动
        - 支持拖拽任意层级的活动（父级或子级）到时间槽

## 6\. 层级化活动架构 (Hierarchical Activity Architecture)

  * **设计理念:** LAE 系统采用递归的层级化活动管理，支持无限深度的活动嵌套。
  
  * **典型使用场景:**
    ```
    zeroPPD (顶级项目)
    ├── zeroPPD-读文献 (子活动)
    │   ├── 读新加的文献 (三级活动)
    │   └── 文献综述整理 (三级活动)
    ├── zeroPPD-分析数据 (子活动)
    │   ├── 数据清洗 (三级活动)
    │   └── 统计分析 (三级活动)
    └── zeroPPD-写论文 (子活动)
    ```
  
  * **核心功能特性:**
    1. **灵活拖拽:** 可将任意层级的活动拖拽到时间槽
    2. **聚合统计:** 父级活动自动聚合所有子活动的统计数据
    3. **Goal 管理:** 每个具体安排都有独立的目标和完成状态
    4. **月度追踪:** 按月统计每个活动的安排频次和目标完成情况

## 7\. Obsidian & Markdown 集成 (Obsidian & Markdown Integration)

  * **功能:** 提供"导出为 Markdown"功能，将日程安排无缝集成到现有的知识管理工作流中。
  * **实现:** 在 Python 后端创建一个 API 端点，用于生成指定时间范围（天/周）的 Markdown 格式日程。
  * **输出示例 (`YYYY-WW.md`):**
    ```markdown
    # 2025年第39周 日程总结

    ## 2025-09-22 (周一)
    - **上午1:** [ ] **zeroPPD-分析数据**: 完成初步数据清洗。
    - **上午2:** [ ] *未安排*
    ...

    ## 2025-09-23 (周二)
    - **上午1:** [ ] **zeroPPD-读文献**: 读完第三篇文献。
    ...
    ```

## 7\. 开发路线图 (Development Roadmap)

### 已完成阶段

1.  **✅ Phase 1: 后端与数据基础** *(已完成)*

      * ✅ 初始化 FastAPI 项目结构
      * ✅ 使用 SQLAlchemy 定义 `Activity` 和 `ScheduledEvent` 数据模型并创建数据库
      * ✅ 编写核心的后端 API 端点：
          * ✅ 对 `activities` 的完整 CRUD
          * ✅ 对 `scheduled_events` 的完整 CRUD  
          * ✅ 获取周/月日程的 API
          * ✅ 获取汇总统计的 API
      * ✅ 增加 `notes` 字段支持备注功能

2.  **✅ Phase 2: 核心 UI 开发** *(已完成)*

      * ✅ 搭建基础的 HTML 页面框架 (Bootstrap + Alpine.js + SortableJS)
      * ✅ 开发 **汇总视图**，实现活动管理和树形结构显示
      * ✅ 开发 **周视图**，实现 7×N 动态网格布局
      * ✅ 集成 JavaScript 拖拽库并解决所有交互问题
      * ✅ 完善拖拽功能和用户交互

3.  **✅ Phase 3: 功能增强** *(已完成)*

      * ✅ 完善拖拽功能和用户交互
      * ✅ 开发完整的 **月视图** 及其导航功能
      * ✅ 完善汇总视图的统计逻辑和数据展示
      * ✅ 优化用户体验和界面响应
      * ✅ 实现汇总视图活动编辑功能（名称、描述）
      * ✅ 实现月视图日程概览显示

4.  **✅ Phase 4: 调试与最后优化** *(已完成)*
      * ✅ 新功能：允许已在网格中的活动卡片被拖拽到其他空格子中
      * ✅ 新功能：将网格中的事件拖回活动池进行删除
      * ✅ 优化体验：修复卡池卡片拖拽后消失的问题
      * ✅ 优化体验：修复拖拽动画卡顿和重复初始化问题
      * ✅ 智能拖拽验证：自动检测和修复无效拖拽目标
      * ✅ 网格尺寸优化：增大间距和尺寸提高拖拽精度

✅ 已修复bug (2025-09-15)
- ~~目前月视图存在问题，无法显示~~ **已修复**
  ~~期望的目标功能是，缩略图可以显示对应日期中已经添加了几项日程。无需显示更多信息。~~

**修复说明**: 前后端数据结构不匹配问题已解决，月视图现在能正常显示日历和日程数量标记。

### 🎉 V1.0 开发完成 (2025-09-13)

**系统特性**：
- ✅ 层级化活动管理（无限嵌套支持）
- ✅ 直观的拖拽式日程安排
- ✅ 智能的拖拽位置判断和错误修复
- ✅ 三视图切换（汇总/周视图/月视图）
- ✅ 完整的CRUD操作和统计功能

**技术架构**：
- ✅ FastAPI + SQLAlchemy + SQLite 后端架构
- ✅ Bootstrap + Alpine.js + SortableJS 前端架构
- ✅ 响应式设计和跨浏览器兼容
- ✅ 完整的错误处理和用户反馈机制

**🟢 系统已可投入使用**，所有核心功能验证通过。

### 🚀 后续发展方向 (V2.0+)

**功能扩展**：
- Markdown导出功能（与Obsidian集成）
- 移动端适配和响应式优化
- 数据备份和恢复功能
- 更多时间槽类型支持

**性能优化**：
- 前端缓存机制
- 数据库查询优化
- 大数据量处理支持

**用户体验**：
- 界面主题定制
- 键盘快捷键支持
- 批量操作功能


## 8\. 技术栈详情

**后端技术栈:**
- **框架:** FastAPI 0.104.1
- **数据库:** SQLite + SQLAlchemy 2.0.23 ORM
- **服务器:** Uvicorn (开发环境)

**前端技术栈:**
- **基础:** HTML5 + CSS3 + JavaScript (ES6+)
- **UI框架:** Bootstrap 5.3.0
- **状态管理:** Alpine.js 3.13.0
- **拖拽功能:** SortableJS 1.15.0

**开发工具:**
- **依赖管理:** pip + requirements.txt  
- **开发服务器:** 热重载支持
- **API文档:** 自动生成 (FastAPI Swagger)

# LAE - 个人日程与主支线管理系统 v2 

## 7\. 开发路线图 (Development Roadmap) 



### LAE 个人日程与主支线管理系统 v2.0 - 系统架构与开发方案--草稿

#### 1. V2 核心理念：从线性安排到矩阵管理

LAE v2.0 的核心变革是从 v1 的单线“活动 (Activity)”模型，演进为“**领域 (Domain) x 类型 (Type)**”的双轴矩阵模型。

系统承认一个个体在执行具体任务（“行动”）时，其意图是多维度的：既有**目的性**（“我做这件事是**为了**什么领域/项目？”——由 **Domain** 定义），也包含**方法性**（“我正在做的这件事**是**何种性质的工作？”——由 **Type** 定义）。

V2 旨在通过一个高度灵活的界面，捕捉并管理这种多维度关系，同时将具有明确时间边界的目标（“日程”）作为领域的附加上下文，为日常行动提供清晰指引。

#### 2. V2 系统架构

##### 2.1 概念模型

* **主支线 (Domains):** 定义用户长期关注的、层级化的**责任领域或项目分支**。它是回答“为了什么”的轴。
* **活动类型 (Activity Types):** 定义工作**性质**的、扁平化的**标签**。它是回答“是什么”的轴。
* **日程 (Schedules):** **附属于**某个 Domain 节点下的、有时间限制的**具体目标**。它为 Domain 提供阶段性目标。
* **已安排活动 (Actions):** 用户在周视图中安排的**最小时间块单元**。它通过可选的 `domain_id` 和 `type_id` 在双轴矩阵中定位，并可选择性关联到 `schedule_id`。

##### 2.2 数据模型 (Data Model) - 初步方案

为支持新架构，数据库将进行结构性调整。此方案优先定义核心关系，`properties` 等细节字段可在后续迭代中添加。

1.  **`domains` 表 (由原 `activities` 表演进)**
    * `id` (INTEGER, PK): 主键
    * `name` (TEXT): 节点名称 (如 "zeroPPD")
    * `parent_id` (INTEGER, FK): 指向 `domains.id`，构建层级关系
    * `description` (TEXT, NULLABLE): 描述
    * *(后续添加 `properties` (JSON) 等字段)*

2.  **`activity_types` 表 (新增)**
    * `id` (INTEGER, PK): 主键
    * `name` (TEXT): 类型名称 (如 "读文献")
    * `parent_id` (INTEGER, FK): 指向 `activity_types.id`，支持类型层级化
    * *(后续添加 `properties` (JSON) 等字段)*

3.  **`schedules` 表 (新增)**
    * `id` (INTEGER, PK): 主键
    * `domain_id` (INTEGER, FK): **强制关联**到 `domains.id`
    * `name` (TEXT): 日程/目标名称
    * `deadline` (DATETIME, NULLABLE): 截止日期
    * `status` (TEXT): 状态 (e.g., 'ongoing', 'completed')

4.  **`scheduled_events` 表 (核心重构)**
    * `id` (INTEGER, PK): 主键
    * `event_date` (DATE): 日期
    * `time_slot` (INTEGER): 时间槽
    * `name` (TEXT): **用户自定义的行动名称**
    * `notes` (TEXT, NULLABLE): 备注
    * `status` (TEXT): 状态
    * `domain_id` (INTEGER, FK, **NULLABLE**): 关联到 `domains.id`
    * `type_id` (INTEGER, FK, **NULLABLE**): 关联到 `activity_types.id`
    * `schedule_id` (INTEGER, FK, **NULLABLE**): 关联到 `schedules.id`
    * *(后续添加 `custom_properties` (JSON) 字段以支持用户自定义覆盖)*

##### 2.3 技术栈 (Technical Stack)
技术栈保持与 v1 一致，以确保开发平稳过渡。
* **后端:** Python, FastAPI, SQLAlchemy (ORM)
* **数据库:** SQLite
* **前端:** HTML, CSS, JavaScript, Bootstrap, Alpine.js, SortableJS

#### 3. 初步开发方案 (Phased Approach)

此方案旨在“**先立骨架，再填血肉**”，优先实现核心的数据结构和交互流程。

##### **Phase 1: 数据库与后端重构 (The Foundation)**
* **目标:** 搭建支持 V2 模型的底层基础。
* **任务:**
    1.  **Schema 迁移:** 备份 v1 数据。根据上述 V2 数据模型，创建新的数据库 Schema。
    2.  **ORM 更新:** 在 SQLAlchemy 中创建 `Domain`, `ActivityType`, `Schedule` 的新 Model，并重构 `ScheduledEvent` Model。
    3.  **基础 API 开发:**
        * 为 `domains` 和 `activity_types` 提供完整的层级化 CRUD API。
        * 为 `schedules` 提供基础的 CRUD API (创建、读取、更新、删除)。
        * 重构 `scheduled_events` 的 CRUD API，使其支持新的 `name`, `domain_id`, `type_id`, `schedule_id` 字段。
    4.  **视图数据接口重构:** 修改向前端（周视图、月视图）提供数据的 API，使其返回符合新数据结构的数据。

##### **Phase 2: 核心交互实现 (Core Interaction Implementation)**
* **目标:** 让用户能够在新架构下，完成最核心的日程安排操作。
* **任务:**
    1.  **汇总视图 v2.1 (管理中心): ✅ 已完成**
        * ✅ 实现 `domains` 和 `activity_types` 的树状结构展示。
        * ✅ 提供基础的节点管理功能：创建、重命名、删除。
        * ✅ 编辑删除功能完全实现，包括模态框和API调用。

    2.  **周视图 v2.1 (交互革命):**
        * **构建侧边栏:** 在界面左侧或右侧，实现可切换的、可折叠的 `Domains` 和 `Types` 树状列表。
        * **实现点击创建:** 使用 SortableJS，允许用户从侧边栏选中一个 `Domain` 或 `Type` 节点，再点击空白网格，此时自动弹出编辑框、预填好对应 name（同选中的节点名称），并填好对应的domain或type属性。
        * **实现点击创建:** 允许用户直接点击空白时间槽，弹出空的编辑框。
          * **开发新版编辑框:** 创建一个支持 `Name` (必填) 以及 `Domain`, `Type`, `Schedule` (可选) 等字段的表单。
        * 确保 `scheduled_events` 的增、删、改在周视图界面功能正常。以及同样允许卡片在卡槽之间之间的拖拽移动。

##### **Phase 3: 功能完善与关联 (Feature Integration)**
* **目标:** 打通各模块间的关联，完善辅助功能。
* **任务:**
    1.  **Schedule 功能闭环:**
        * ✅ 在汇总视图中，为 `Domain` 节点添加管理其 `Schedules` 的界面。
        * ✅ 在周视图中，查询并渲染 `Schedules` 的跨天时间条。(已完成)
        
    2.  **宏观视图集成:**
        * ✅ 在月视图中，查询并渲染 `Schedules` 的跨天时间条，提供宏观规划视角。(已完成)
    






# 开发注意事项



## 🎉 v2.2 会话成果总结 (2025-09-16)

### ✅ 本次会话完成的关键功能
1. **📅 Schedule起始日期功能**:
   - 为Schedule模型添加了start_date字段
   - 更新了所有相关API支持起始日期
   - 完善了前端Schedule管理界面，支持起始和截止日期

2. **📊 Schedule时间条基础功能**:
   - ✅ 在周视图网格上方添加了Schedule时间条展示区域
   - ✅ 实现了API支持按日期范围查询Schedule数据
   - ✅ 完成了基础的时间条渲染和颜色系统
   - ✅ 添加了点击编辑Schedule的交互功能
   - ✅ 实现了跨天Schedule的检测和显示逻辑

### 🔄 当前待完成的时间条优化任务
**用户反馈的改进需求(2025-09-16)**:
1. **时间条布局优化**:
   - 🔄 修改时间条为垂直堆叠布局，避免重叠遮盖
   - 🔄 按截止时间排序确定垂直层次顺序
   - ✅ 增加时间条区域高度至120px(已完成)

2. **跨周连续时间条显示**:
   - 🔄 实现真正的连续时间条逻辑(如9.1-10.1在9.22-9.28周显示为完整横条)
   - 🔄 确保跨周Schedule显示为单条连续线而非分段

3. **交互体验优化**:
   - 🔄 优化悬停tooltip显示Schedule名称和日期信息
   - ✅ 点击编辑功能已实现

**当前代码状态**:
- Schedule时间条基础框架已搭建完成
- CSS样式已调整为支持垂直堆叠(position: relative)
- 时间条区域高度已增加到120px


---

## 🎉 v2.1 会话成果总结 (2025-09-15)

### ✅ 已完成的关键功能
1. **🔧 API错误修复**:
   - 修复了statistics API的500错误
   - 解决SQLAlchemy模型关系导入问题
   - 添加缺失的activity_id和goal字段保持v1兼容

2. **🏗️ Domain完整CRUD实现**:
   - ✅ 编辑模态框 (showEditDomainModal)
   - ✅ editDomain() 函数实现
   - ✅ updateDomain() API调用函数
   - ✅ deleteDomain() 删除功能

3. **⚡ ActivityType完整CRUD实现**:
   - ✅ 编辑模态框 (showEditActivityTypeModal)
   - ✅ editActivityType() 函数实现
   - ✅ updateActivityType() API调用函数
   - ✅ deleteActivityType() 删除功能

4. **🌐 服务器运行优化**:
   - 修复端口冲突问题
   - 服务器稳定运行在8002端口
   - 完整的错误处理和用户反馈

### 🎯 汇总视图v2.1 管理中心功能完成状态
- ✅ **Domain管理**: 创建、查看、编辑、删除全功能
- ✅ **ActivityType管理**: 创建、查看、编辑、删除全功能
- ✅ **树状结构展示**: 完整的层级显示
- ✅ **用户交互**: 直观的按钮操作和模态框体验

### 💻 当前开发环境
```bash
# 启动开发服务器
python run.py

# 访问应用程序 (当前端口)
http://127.0.0.1:8002

# API 文档
http://127.0.0.1:8002/docs
```



---
# LAE v3.0 愿景：从时间网格到流动画布

## 🎯 V3 核心理念：在模糊与精确之间取得平衡

V3 的本质性变革，是放弃 V2 僵化的固定时间槽网格，转向一个更自由、更灵活、更符合直觉的“时间画布”界面。其核心是在一个统一的视图中，**实现计划的模糊性与精确性的共存与无缝转换**。

### V3 周视图 新网池的关键设计

1. **底层结构：10分钟微网格与视觉层级**
    
    - 整个系统将构建在一个以**10分钟**为单位的底层精细网格之上，但这个网格在视觉上是次要的。
        
    - UI 将采用**视觉层级**设计：10分钟的微网格线细而浅，作为对齐辅助；而小时整点线或自定义时段（如“上午第一时段”）的分割线则粗而深，作为宏观视觉焦点。这为用户创造了一种“感知上自由，操作上规范”的体验。
        
2. **核心交互：动态卡片与吸附对齐**
    
    - **动态高度**：任务卡片的高度与其预估**时长**成正比，以10分钟为最小单位进行变化。这使得每日的工作负荷一目了然。
        
    - **吸附对齐**：所有卡片的拖拽、移动和调整大小，都会自动吸附到最近的10分钟网格线上，确保布局整洁，操作便捷。
        
    - **并行任务**：在同一时间段内，允许多张卡片**并排摆放**，以应对现实世界中非线性的、并行的工作流。
        
3. **关键机制：模糊呈现 vs. 精确数据**
    
    - **模糊任务 (默认)**：一张卡片被放置在 `10:30` 的线上，高度为60分钟。它在视觉上暗示了时间，但**不显示**明确的起止时间戳。这是规划的常态。
        
    - **精确任务 (按需)**：用户可以为一个事件指定精确时间，如 `13:15 - 14:02`。
        
        - **数据层**：系统会精确存储 `13:15` 和 `14:02`。
            
        - **显示层**：卡片上会明确标注 "13:15 - 14:02" 以示区别。
            
        - **布局层**：为了视觉和谐，卡片在画布上的位置和大小会被**就近圆整**。例如，它会自动吸附在 `13:10` 的线上，其高度会根据47分钟的总时长，被渲染为50分钟的高度（5个网格单位）。
            

4. 额外空间：
    周视图的最上方 额外开辟空间，可以用来放置还没有确定时间的卡片。这类卡片不考虑时长，因此统一用比较窄的高度即可。可以把卡片拖入到正式的网格中，此时则需要赋予卡片时间与高度。

这个设计在易用性与精确性之间取得了完美平衡，提供了一个既能宏观规划又能微观管理的强大工具。

### V3 完整开发方案

**核心原则**: 保持V2的交互方式兼容性 - 侧边栏选中节点后点击网格，或直接点击网格创建事件

#### 📋 Phase 1: 数据架构重构 (Foundation Redesign)

**目标**: 建立支持V3动态时长和精确时间的数据基础

**🔧 任务 1.1: 数据库Schema升级**
- **修改 `scheduled_events` 表**:
  ```sql
  -- 新增字段
  ALTER TABLE scheduled_events ADD COLUMN duration INTEGER; -- 时长(分钟)
  ALTER TABLE scheduled_events ADD COLUMN start_time TIME; -- 精确开始时间(可选)
  ALTER TABLE scheduled_events ADD COLUMN is_precise BOOLEAN DEFAULT FALSE; -- 是否精确任务
  ALTER TABLE scheduled_events ADD COLUMN canvas_position_y INTEGER DEFAULT 0; -- 画布Y坐标(并排摆放)

  -- 保留兼容性字段
  -- time_slot 保留用于向后兼容和模糊任务的大致时段定位
  ```

**🔧 任务 1.2: SQLAlchemy模型更新**
- 更新 `ScheduledEvent` 模型，添加新字段
- 添加数据验证逻辑：精确任务必须有 `start_time`，模糊任务使用 `time_slot`
- 实现兼容性方法，支持V2数据的平滑迁移

**🔧 任务 1.3: API端点升级**
- 修改 `/api/events/` 相关端点，支持新的数据字段
- 添加数据转换逻辑：V2格式 ↔ V3格式
- 确保现有API调用不中断，保持交互方式兼容性

#### 📋 Phase 2: 核心画布UI重构 (Canvas Interface)

**目标**: 实现10分钟网格系统和动态卡片交互

**🎨 任务 2.1: 10分钟微网格系统**
- **网格架构重设计**:
  ```css
  /* 新的网格系统 */
  .week-grid-v3 {
    display: grid;
    grid-template-columns: repeat(7, 1fr); /* 7天 */
    grid-template-rows: repeat(144, 10px); /* 24小时 * 6格/小时 = 144个10分钟格 */
  }

  /* 视觉层级 */
  .grid-line-10min { border: 0.5px solid #e0e0e0; } /* 细浅线 */
  .grid-line-hour { border: 2px solid #666; } /* 粗深线 */
  ```
- 实现可滚动的画布容器(24小时完整视图)
- 添加时间标尺显示(左侧Y轴)

**🎨 任务 2.2: 动态卡片系统**
- **卡片高度计算**:
  ```javascript
  // 卡片高度 = duration(分钟) / 10 * gridCellHeight(10px)
  function calculateCardHeight(durationMinutes) {
    return Math.max(durationMinutes / 10 * 10, 20); // 最小20px
  }
  ```
- 实现卡片拖拽时的实时高度调整
- 添加卡片内容显示：标题、时长、精确时间(如适用)

**🎨 任务 2.3: 智能吸附系统**
- 实现拖拽过程中的10分钟网格吸附
- 添加视觉反馈：吸附预览、对齐辅助线
- 支持卡片大小调整(拖拽底部边缘改变时长)

#### 📋 Phase 3: 高级交互功能 (Advanced Interactions)

**目标**: 实现精确vs模糊任务切换和并行摆放

**⚡ 任务 3.1: 模糊vs精确任务机制**
- **双击切换功能**: 模糊任务双击→精确任务编辑模式
- **精确任务编辑器**:
  ```javascript
  // 精确时间编辑组件
  {
    startTime: "13:15", // HH:MM格式
    endTime: "14:02",   // 或者 duration: 47
    isPrecise: true
  }
  ```
- 实现数据层精确存储 + 显示层圆整对齐的双重逻辑

**⚡ 任务 3.2: 并行摆放系统**
- **水平位置管理**: 添加 `canvas_position_y` 字段支持同时段多卡片
- **碰撞检测**: 自动计算合适的并排位置
- **并排布局优化**: 卡片宽度自动调整适应并行数量

**⚡ 任务 3.3: 待定区域功能**
- 在周视图顶部实现"未确定时间"卡片池
- 支持待定卡片拖拽到正式时间槽的转换
- 待定卡片统一样式(窄高度、特殊颜色)

#### 📋 Phase 4: 用户体验优化 (UX Enhancement)

**目标**: 完善交互体验和视觉反馈

**✨ 任务 4.1: 交互优化**
- **拖拽体验增强**: 平滑动画、阴影效果、拖拽预览
- **键盘快捷键**:
  - `D` - 切换到模糊/精确模式
  - `←→` - 调整时长±10分钟
  - `Esc` - 取消当前操作
- **右键菜单**: 快速编辑、删除、复制、精确时间设定

**✨ 任务 4.2: 视觉系统升级**
- **时间密度可视化**: 颜色深度反映该时段的任务密集程度
- **工作负荷指示器**: 侧边栏显示每日总时长统计
- **精确任务特殊标识**: 精确任务显示时钟图标⏰

**✨ 任务 4.3: 响应式适配**
- 支持不同屏幕尺寸的网格自适应
- 移动端触摸拖拽优化
- 缩放功能: 支持 25%~200% 画布缩放

#### 📋 Phase 5: 数据迁移与向后兼容 (Migration & Compatibility)

**目标**: 确保V2数据平滑迁移到V3

**🔄 任务 5.1: 数据迁移脚本**
```python
# 迁移逻辑示例
def migrate_v2_to_v3():
    for event in v2_events:
        v3_event = {
            **event,
            'duration': estimate_duration_from_timeslot(event.time_slot),
            'is_precise': False,
            'canvas_position_y': 0
        }
```

**🔄 任务 5.2: 兼容模式**
- V2视图保留选项(设置中可切换)
- V3模式下支持V2数据的正确显示
- 渐进式升级：用户可选择何时迁移到V3

#### 📋 Phase 6: 测试与优化 (Testing & Performance)

**目标**: 确保V3系统稳定性和性能

**🧪 任务 6.1: 核心功能测试**
- 10分钟网格系统精度测试
- 拖拽吸附准确性验证
- 精确vs模糊任务切换测试
- 并行摆放布局测试

**🧪 任务 6.2: 性能优化**
- 大量卡片(100+)的渲染性能测试
- 拖拽流畅度优化
- 内存使用情况监控

#### 🎯 开发优先级与里程碑

**🚀 MVP里程碑 (最小可用产品)**
- **Phase 1 + Phase 2.1-2.2**: 基础10分钟网格 + 动态卡片
- **预期效果**: 用户可以在新画布上创建和移动动态高度的任务卡片

**🎪 Beta里程碑 (功能完整版)**
- **Phase 1-3**: 包含精确任务和并行摆放的完整功能
- **预期效果**: 完整的V3体验，支持复杂时间安排场景

**🏆 Production里程碑 (生产就绪版)**
- **Phase 1-6**: 包含迁移、兼容和优化的最终版本
- **预期效果**: 稳定、高性能的V3系统，完全替代V2

#### 🔗 交互兼容性保证

**重要**: V3将完全保持V2的交互方式：
1. **侧边栏选中节点后点击网格** - 点击位置确定时间，默认给予合理时长（如60分钟）
2. **直接点击网格** - 弹出编辑框，用户可选择Domain/Type，同样默认时长
3. **所有V2的编辑和管理功能** - 在V3中继续有效

#### V3 初步开发规划





#### 完成新的周视图布局后：

##### **Phase 1: 属性系统 (Properties)**

- **目标:** 引入属性系统，为 V3 的高级功能打下基础。
    
- **任务:**
    
    1. **属性系统设计与实现:** 在汇总视图中，为 `Domain` 和 `Type` 节点添加编辑其 `properties` 的界面。
        
    2. **继承逻辑实现:** 在后端和前端实现“`Action` 的属性默认继承自 `Domain`，并允许用户自定义覆盖”的逻辑。
        

##### **Phase 2: 体验优化与 V2 问题修复**

- **目标:** 对 V2 版本的整体体验进行打磨，并修复已知问题。
    
- **任务:**
    
    1. **UI/UX 优化:** 根据实际使用体验，优化拖拽动画、表单交互、加载速度等细节。
        
    2. **拖拽管理:** 在汇总视图中，实现拖拽 `Domain` 和 `Type` 节点以调整其层级和顺序的功能（选做）。
        
    3. **交互逻辑优化:**
        
        - 在周视图的 `Action` 编辑框中，实现"选择 Domain 后，动态加载其关联 Schedules"的联动逻辑（允许把事件和schedule绑定）。
            
        - 修复 Schedule 时间条只有起始点的时候才应该有三角形标识的问题。
            
    4. **全面测试与 Bug 修复:**
        
        - 调查并清理数据库中用途不明的旧 `activity` 表。
            
        - 修复在新建 `Type` 并选择父节点时，看到已删除项目的诡异 Bug。

---

## 元认知
LAE schedule 方面
	汇总界面的更新 是比较小、好办的更新 只要描述清楚机制就行
	有一些变化和新增 涉及的机制比较复杂 可以让claude对目前整体框架进行描述 然后我单独问GEMINI 从而获得元信息 哪些变化比较易得等等