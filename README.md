# LAE - 个人日程与主支线管理系统 v1 

**版本: 1.0 **

## 1\. 项目背景 (Project Background)

为了解决在多任务并行时，对未来时间安排的高度不确定性和焦虑感，本项目旨在开发一个供个人使用的日程/主支线任务管理系统。通过**量化与可视化**的手段，清晰、直观地掌控个人时间和精力。

`zeroPPD` 将作为本系统设计和实践的第一个核心应用场景。

## 2\. 核心功能 (Core Features)

  * **主支线任务管理:** 支持无限层级的父子任务结构。
  * **时间块估算与生成:** 以固定的“时段”为单位来规划任务。
  * **可视化排程白板:** 在周视图中通过拖拽方式安排日程。
  * **多视图切换:** 支持月视图、周视图和汇总视图。
  * **目标与进度管理:** 为每一次具体的日程安排附加一个可追踪的 `goal`。
  * **数据汇总与统计:** 在汇总视图中查看各主支线的精力投入和目标列表。

## 3\. 系统架构与技术栈 (System Architecture & Technical Stack)

本项目将采用**方案A：轻量级Web框架**模式进行开发，在本地运行，通过浏览器访问。

  * **后端 (Backend):**

      * **语言:** Python
      * **Web 框架:** Flask (或 FastAPI)
      * **职责:** 负责所有业务逻辑、数据处理，并通过 API 接口与前端交互。

  * **数据库 (Database):**

      * **类型:** SQLite (单个 `.db` 文件，易于管理)
      * **交互:** 采用 **SQLAlchemy** (ORM) 进行数据库操作，以获得更好的代码可读性和维护性。

  * **前端 (Frontend):**

      * **技术:** HTML, CSS, JavaScript
      * **职责:** 负责渲染用户界面 (UI)，处理用户交互（如点击、拖拽），并通过异步请求(Ajax/Fetch)调用后端 API。

## 4\. 数据模型 (Data Model)

系统的核心由两张 SQL 数据表构成，通过 SQLAlchemy 的 Models 进行定义。

#### 4.1. `activities` (活动库)

定义所有可供选择的活动卡片及其层级关系。

| 字段名 (Field) | 类型 (Type) | 描述 |
| :--- | :--- | :--- |
| `id` | INTEGER | 唯一主键 |
| `name` | TEXT | 活动名称 (如 "zeroPPD-读文献") |
| `parent_id` | INTEGER | 指向父级活动的 `id`，顶级活动为 `NULL` |
| `description` | TEXT | (可选) 对活动的详细描述 |
| `created_at` | DATETIME | 创建时间 |

#### 4.2. `scheduled_events` (已安排日程)

记录每一次具体的日程安排。

| 字段名 (Field) | 类型 (Type) | 描述 |
| :--- | :--- | :--- |
| `id` | INTEGER | 唯一主键 |
| `activity_id` | INTEGER | 外键，关联到 `activities.id` |
| `event_date` | DATE | 日程发生的日期 |
| `time_slot` | INTEGER | 时间槽编号 (详见时间槽规则) |
| `goal` | TEXT | 本次活动要达成的具体目标 (如 "读完第三篇文献") |
| `notes` | TEXT | 备注信息，不参与统计分析 |
| `status` | TEXT | 活动状态 (如: 'planned', 'completed') |

#### 4.3. 时间槽编码规则

采用两位数编码：**第一位代表时段，第二位代表该时段内的序号**

**当前实现的时间槽：**
- `21`: 上午第1时段
- `22`: 上午第2时段  
- `51`: 下午第1时段
- `52`: 下午第2时段
- `71`: 晚上时段

**扩展示例（未来可能添加）：**
- `81`, `82`: 睡前时段
- `11`, `12`, `13`: 早晨时段
- 等等

这种编码方式便于未来扩展更多时段，而不影响现有数据。

## 5\. 核心机制与视图逻辑 (Core Mechanisms & View Logic)

#### 5.1. 月视图 (Month View)

  * **功能:** 宏观展示整月日程负荷，并作为导航入口。
  * **逻辑:** 后端查询指定月份的 `scheduled_events`，按天聚合活动数量。前端渲染日历网格，在每日单元格内显示活动数量的缩略信息。点击某一周可跳转至对应的周视图。

#### 5.2. 周视图 (Week View)

  * **功能:** 项目的核心交互界面，用于日程的拖拽式编排。
  * **布局:**
      * **左侧 (或右侧):** “活动卡片池”。后端查询 `activities` 表并构建层级树，前端将其渲染为可拖拽的卡片列表。
      * **主区域:** 7天 x 5个时间槽的网格。
  * **交互逻辑:**
    1.  用户从“活动卡片池”中拖拽一个活动卡片。
    2.  将其放置 (drop) 到主区域的某个具体时间槽中。
    3.  此时，前端可弹出一个输入框，让用户填写本次的 `goal`。
    4.  信息收集完毕后，前端 JavaScript 向后端 API 发送一个 `POST` 请求，请求体包含 `{activity_id, event_date, time_slot, goal}`。
    5.  后端接收请求，在 `scheduled_events` 表中创建一条新记录。
    6.  成功后，前端将该活动卡片正式渲染在目标时间槽中。

#### 5.3. 汇总视图 (Summary View) - 层级化活动管理中心

  * **功能:** 所有活动（主支线）的管理中心和层级化统计仪表盘。
  * **核心特性:**
    1.  **层级化活动管理:** 支持多级活动结构（如 `zeroPPD` → `zeroPPD-读文献` → `读新加的文献`）
    2.  **完整 CRUD 功能:** 创建、修改、删除任意层级的活动
    3.  **聚合统计显示:** 父级活动统计包含所有子活动的数据
    4.  **Goal 追踪管理:** 显示每个活动的所有目标及完成状态
  
  * **详细逻辑:**
    1.  **活动层级展示:**
        - 按层级顺序显示，父级活动在上，子级活动缩进显示
        - 父级活动统计信息聚合所有子活动数据
        - 子级活动独立显示自己的统计信息
    
    2.  **统计信息展示:**
        - **安排次数统计:** 显示某月该活动被安排的总次数
        - **完成率统计:** 基于 goal 的完成状态计算
        - **Goal 列表:** 显示该活动的所有已安排目标及其日期
    
    3.  **Goal 管理系统:**
        - 当用户在周视图中拖拽活动到时间槽时，可添加具体目标
        - 示例：`zeroPPD-读文献` 安排在 "九月第四周周三上午第二时段"，目标："读完第三篇文献"
        - 汇总视图中显示：活动 `zeroPPD-读文献` 包含目标 "读完第三篇文献 (9月第4周周三)"
    
    4.  **活动卡片来源:**
        - 周视图中的拖拽卡片池来源于汇总视图创建的活动
        - 支持拖拽任意层级的活动（父级或子级）到时间槽

## 6\. 层级化活动架构 (Hierarchical Activity Architecture)

  * **设计理念:** LAE 系统采用递归的层级化活动管理，支持无限深度的活动嵌套。
  
  * **典型使用场景:**
    ```
    zeroPPD (顶级项目)
    ├── zeroPPD-读文献 (子活动)
    │   ├── 读新加的文献 (三级活动)
    │   └── 文献综述整理 (三级活动)
    ├── zeroPPD-分析数据 (子活动)
    │   ├── 数据清洗 (三级活动)
    │   └── 统计分析 (三级活动)
    └── zeroPPD-写论文 (子活动)
    ```
  
  * **核心功能特性:**
    1. **灵活拖拽:** 可将任意层级的活动拖拽到时间槽
    2. **聚合统计:** 父级活动自动聚合所有子活动的统计数据
    3. **Goal 管理:** 每个具体安排都有独立的目标和完成状态
    4. **月度追踪:** 按月统计每个活动的安排频次和目标完成情况

## 7\. Obsidian & Markdown 集成 (Obsidian & Markdown Integration)

  * **功能:** 提供"导出为 Markdown"功能，将日程安排无缝集成到现有的知识管理工作流中。
  * **实现:** 在 Python 后端创建一个 API 端点，用于生成指定时间范围（天/周）的 Markdown 格式日程。
  * **输出示例 (`YYYY-WW.md`):**
    ```markdown
    # 2025年第39周 日程总结

    ## 2025-09-22 (周一)
    - **上午1:** [ ] **zeroPPD-分析数据**: 完成初步数据清洗。
    - **上午2:** [ ] *未安排*
    ...

    ## 2025-09-23 (周二)
    - **上午1:** [ ] **zeroPPD-读文献**: 读完第三篇文献。
    ...
    ```

## 7\. 开发路线图 (Development Roadmap)

### 已完成阶段

1.  **✅ Phase 1: 后端与数据基础** *(已完成)*

      * ✅ 初始化 FastAPI 项目结构
      * ✅ 使用 SQLAlchemy 定义 `Activity` 和 `ScheduledEvent` 数据模型并创建数据库
      * ✅ 编写核心的后端 API 端点：
          * ✅ 对 `activities` 的完整 CRUD
          * ✅ 对 `scheduled_events` 的完整 CRUD  
          * ✅ 获取周/月日程的 API
          * ✅ 获取汇总统计的 API
      * ✅ 增加 `notes` 字段支持备注功能

2.  **✅ Phase 2: 核心 UI 开发** *(已完成)*

      * ✅ 搭建基础的 HTML 页面框架 (Bootstrap + Alpine.js + SortableJS)
      * ✅ 开发 **汇总视图**，实现活动管理和树形结构显示
      * ✅ 开发 **周视图**，实现 7×N 动态网格布局
      * ✅ 集成 JavaScript 拖拽库并解决所有交互问题
      * ✅ 完善拖拽功能和用户交互

3.  **✅ Phase 3: 功能增强** *(已完成)*

      * ✅ 完善拖拽功能和用户交互
      * ✅ 开发完整的 **月视图** 及其导航功能
      * ✅ 完善汇总视图的统计逻辑和数据展示
      * ✅ 优化用户体验和界面响应
      * ✅ 实现汇总视图活动编辑功能（名称、描述）
      * ✅ 实现月视图日程概览显示

4.  **✅ Phase 4: 调试与最后优化** *(已完成)*
      * ✅ 新功能：允许已在网格中的活动卡片被拖拽到其他空格子中
      * ✅ 新功能：将网格中的事件拖回活动池进行删除
      * ✅ 优化体验：修复卡池卡片拖拽后消失的问题
      * ✅ 优化体验：修复拖拽动画卡顿和重复初始化问题
      * ✅ 智能拖拽验证：自动检测和修复无效拖拽目标
      * ✅ 网格尺寸优化：增大间距和尺寸提高拖拽精度

### 🎉 V1.0 开发完成 (2025-09-13)

**系统特性**：
- ✅ 层级化活动管理（无限嵌套支持）
- ✅ 直观的拖拽式日程安排
- ✅ 智能的拖拽位置判断和错误修复
- ✅ 三视图切换（汇总/周视图/月视图）
- ✅ 完整的CRUD操作和统计功能

**技术架构**：
- ✅ FastAPI + SQLAlchemy + SQLite 后端架构
- ✅ Bootstrap + Alpine.js + SortableJS 前端架构
- ✅ 响应式设计和跨浏览器兼容
- ✅ 完整的错误处理和用户反馈机制

**🟢 系统已可投入使用**，所有核心功能验证通过。

### 🚀 后续发展方向 (V2.0+)

**功能扩展**：
- Markdown导出功能（与Obsidian集成）
- 移动端适配和响应式优化
- 数据备份和恢复功能
- 更多时间槽类型支持

**性能优化**：
- 前端缓存机制
- 数据库查询优化
- 大数据量处理支持

**用户体验**：
- 界面主题定制
- 键盘快捷键支持
- 批量操作功能


## 8\. 技术栈详情

**后端技术栈:**
- **框架:** FastAPI 0.104.1
- **数据库:** SQLite + SQLAlchemy 2.0.23 ORM
- **服务器:** Uvicorn (开发环境)

**前端技术栈:**
- **基础:** HTML5 + CSS3 + JavaScript (ES6+)
- **UI框架:** Bootstrap 5.3.0
- **状态管理:** Alpine.js 3.13.0
- **拖拽功能:** SortableJS 1.15.0

**开发工具:**
- **依赖管理:** pip + requirements.txt  
- **开发服务器:** 热重载支持
- **API文档:** 自动生成 (FastAPI Swagger)

# LAE - 个人日程与主支线管理系统 v2 

## 7\. 开发路线图 (Development Roadmap) 
### 1. ✅ 已修复bug (2025-09-15)
- ~~目前月视图存在问题，无法显示~~ **已修复**
  ~~期望的目标功能是，缩略图可以显示对应日期中已经添加了几项日程。无需显示更多信息。~~

**修复说明**: 前后端数据结构不匹配问题已解决，月视图现在能正常显示日历和日程数量标记。



### LAE 个人日程与主支线管理系统 v2.0 - 系统架构与开发方案--草稿

#### 1. V2 核心理念：从线性安排到矩阵管理

LAE v2.0 的核心变革是从 v1 的单线“活动 (Activity)”模型，演进为“**领域 (Domain) x 类型 (Type)**”的双轴矩阵模型。

系统承认一个个体在执行具体任务（“行动”）时，其意图是多维度的：既有**目的性**（“我做这件事是**为了**什么领域/项目？”——由 **Domain** 定义），也包含**方法性**（“我正在做的这件事**是**何种性质的工作？”——由 **Type** 定义）。

V2 旨在通过一个高度灵活的界面，捕捉并管理这种多维度关系，同时将具有明确时间边界的目标（“日程”）作为领域的附加上下文，为日常行动提供清晰指引。

#### 2. V2 系统架构

##### 2.1 概念模型

* **主支线 (Domains):** 定义用户长期关注的、层级化的**责任领域或项目分支**。它是回答“为了什么”的轴。
* **活动类型 (Activity Types):** 定义工作**性质**的、扁平化的**标签**。它是回答“是什么”的轴。
* **日程 (Schedules):** **附属于**某个 Domain 节点下的、有时间限制的**具体目标**。它为 Domain 提供阶段性目标。
* **已安排活动 (Actions):** 用户在周视图中安排的**最小时间块单元**。它通过可选的 `domain_id` 和 `type_id` 在双轴矩阵中定位，并可选择性关联到 `schedule_id`。

##### 2.2 数据模型 (Data Model) - 初步方案

为支持新架构，数据库将进行结构性调整。此方案优先定义核心关系，`properties` 等细节字段可在后续迭代中添加。

1.  **`domains` 表 (由原 `activities` 表演进)**
    * `id` (INTEGER, PK): 主键
    * `name` (TEXT): 节点名称 (如 "zeroPPD")
    * `parent_id` (INTEGER, FK): 指向 `domains.id`，构建层级关系
    * `description` (TEXT, NULLABLE): 描述
    * *(后续添加 `properties` (JSON) 等字段)*

2.  **`activity_types` 表 (新增)**
    * `id` (INTEGER, PK): 主键
    * `name` (TEXT): 类型名称 (如 "读文献")
    * `parent_id` (INTEGER, FK): 指向 `activity_types.id`，支持类型层级化
    * *(后续添加 `properties` (JSON) 等字段)*

3.  **`schedules` 表 (新增)**
    * `id` (INTEGER, PK): 主键
    * `domain_id` (INTEGER, FK): **强制关联**到 `domains.id`
    * `name` (TEXT): 日程/目标名称
    * `deadline` (DATETIME, NULLABLE): 截止日期
    * `status` (TEXT): 状态 (e.g., 'ongoing', 'completed')

4.  **`scheduled_events` 表 (核心重构)**
    * `id` (INTEGER, PK): 主键
    * `event_date` (DATE): 日期
    * `time_slot` (INTEGER): 时间槽
    * `name` (TEXT): **用户自定义的行动名称**
    * `notes` (TEXT, NULLABLE): 备注
    * `status` (TEXT): 状态
    * `domain_id` (INTEGER, FK, **NULLABLE**): 关联到 `domains.id`
    * `type_id` (INTEGER, FK, **NULLABLE**): 关联到 `activity_types.id`
    * `schedule_id` (INTEGER, FK, **NULLABLE**): 关联到 `schedules.id`
    * *(后续添加 `custom_properties` (JSON) 字段以支持用户自定义覆盖)*

##### 2.3 技术栈 (Technical Stack)
技术栈保持与 v1 一致，以确保开发平稳过渡。
* **后端:** Python, FastAPI, SQLAlchemy (ORM)
* **数据库:** SQLite
* **前端:** HTML, CSS, JavaScript, Bootstrap, Alpine.js, SortableJS

#### 3. 初步开发方案 (Phased Approach)

此方案旨在“**先立骨架，再填血肉**”，优先实现核心的数据结构和交互流程。

##### **Phase 1: 数据库与后端重构 (The Foundation)**
* **目标:** 搭建支持 V2 模型的底层基础。
* **任务:**
    1.  **Schema 迁移:** 备份 v1 数据。根据上述 V2 数据模型，创建新的数据库 Schema。
    2.  **ORM 更新:** 在 SQLAlchemy 中创建 `Domain`, `ActivityType`, `Schedule` 的新 Model，并重构 `ScheduledEvent` Model。
    3.  **基础 API 开发:**
        * 为 `domains` 和 `activity_types` 提供完整的层级化 CRUD API。
        * 为 `schedules` 提供基础的 CRUD API (创建、读取、更新、删除)。
        * 重构 `scheduled_events` 的 CRUD API，使其支持新的 `name`, `domain_id`, `type_id`, `schedule_id` 字段。
    4.  **视图数据接口重构:** 修改向前端（周视图、月视图）提供数据的 API，使其返回符合新数据结构的数据。

##### **Phase 2: 核心交互实现 (Core Interaction Implementation)**
* **目标:** 让用户能够在新架构下，完成最核心的日程安排操作。
* **任务:**
    1.  **汇总视图 v2.1 (管理中心):**
        * 实现 `domains` 和 `activity_types` 的树状结构展示。
        * 提供基础的节点管理功能：创建、重命名、删除。
        * (暂缓) 复杂的拖拽排序和属性编辑功能。
    2.  **周视图 v2.1 (交互革命):**
        * **构建侧边栏:** 在界面左侧或右侧，实现可切换的、可折叠的 `Domains` 和 `Types` 树状列表。
        * **实现拖拽创建:** 使用 SortableJS，允许用户从侧边栏拖拽一个 `Domain` 或 `Type` 节点到时间槽中，并自动弹出编辑框、预填好对应 ID。
        * **实现点击创建:** 允许用户直接点击空白时间槽，弹出空的编辑框。
        * **开发新版编辑框:** 创建一个支持 `Name` (必填) 以及 `Domain`, `Type`, `Schedule` (可选) 等字段的表单。
        * 确保 `scheduled_events` 的增、删、改、查在周视图界面功能正常。

##### **Phase 3: 功能完善与关联 (Feature Integration)**
* **目标:** 打通各模块间的关联，完善辅助功能。
* **任务:**
    1.  **Schedule 功能闭环:**
        * 在汇总视图中，为 `Domain` 节点添加管理其 `Schedules` 的界面。
        * 在周视图的 `Action` 编辑框中，实现“选择 Domain 后，动态加载其关联 Schedules”的联动逻辑。
    2.  **宏观视图集成:**
        * 在月视图中，查询并渲染 `Schedules` 的跨天时间条，提供宏观规划视角。
    3.  **拖拽管理:** 在汇总视图中，实现拖拽 `Domain` 和 `Type` 节点以调整其层级和顺序的功能。

##### **Phase 4: 属性系统与体验优化 (Properties & UX Polish)**
* **目标:** 引入属性系统，并对整体体验进行打磨。
* **任务:**
    1.  **属性系统设计与实现:** 在汇总视图中，为 `Domain` 和 `Type` 节点添加编辑其 `properties` 的界面。
    2.  **继承逻辑实现:** 在后端和前端实现“`Action` 的属性默认继承自 `Domain`，并允许用户自定义覆盖”的逻辑。
    3.  **UI/UX 优化:** 根据实际使用体验，优化拖拽动画、表单交互、加载速度等细节。
    4.  **全面测试与 Bug 修复。**



# 开发注意事项（AI无需阅读此板块）


## 元认知 
LAE schedule 方面
	汇总界面的更新 是比较小、好办的更新 只要描述清楚机制就行
	有一些变化和新增 涉及的机制比较复杂 可以让claude对目前整体框架进行描述 然后我单独问GEMINI 从而获得元信息 哪些变化比较易得等等 

