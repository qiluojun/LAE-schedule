<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAE - ‰∏™‰∫∫Êó•Á®ã‰∏é‰∏ªÊîØÁ∫øÁÆ°ÁêÜÁ≥ªÁªü v16 Summary Stats</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.0/dist/cdn.min.js"></script>
    <!-- SortableJS -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <style>
        .time-slot {
            min-height: 120px;
            border: 2px solid #dee2e6;
            border-radius: 0.375rem;
            background-color: #f8f9fa;
            transition: background-color 0.2s, transform 0.1s, border-color 0.2s;
            padding: 8px;
            position: relative;
        }
        .time-slot:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }
        .time-slot.occupied {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        .activity-card {
            cursor: grab;
            transition: transform 0.2s;
        }
        .activity-card:hover {
            transform: translateY(-2px);
        }
        .activity-card:active {
            cursor: grabbing;
        }
        .sortable-chosen {
            opacity: 0.8;
            transform: rotate(3deg);
        }
        .sortable-drag {
            opacity: 0.8;
            transform: rotate(5deg);
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }
        .sortable-ghost {
            opacity: 0.4;
            background: #e3f2fd;
            border: 2px dashed #2196f3;
        }
        .time-slot.sortable-over {
            background-color: #e8f5e8;
            border-color: #4caf50;
            border-width: 3px;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        .scheduled-event {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin: 0.25rem 0;
            cursor: pointer;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .scheduled-event:hover {
            background-color: #fff2a8;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .activity-pool {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 1rem;
            background-color: #f8f9fa;
        }
        .week-grid {
            display: grid;
            grid-template-columns: auto repeat(7, 1fr);
            gap: 8px;
            background-color: transparent;
            border-radius: 0.5rem;
            padding: 12px;
            border: 2px solid #dee2e6;
        }
        .week-header {
            background-color: #6c757d;
            color: white;
            text-align: center;
            padding: 0.5rem;
            font-weight: bold;
            border-radius: 0.375rem;
            border: 2px solid #6c757d;
        }
        .time-label {
            background-color: #495057;
            color: white;
            text-align: center;
            padding: 1rem 0.5rem;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 120px;
            border-radius: 0.375rem;
            border: 2px solid #495057;
        }
    </style>
</head>
<body>
    <div x-data="laeApp()" class="container-fluid">
        <!-- ÂØºËà™Ê†è -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-3">
            <div class="container-fluid">
                <span class="navbar-brand">LAE - Êó•Á®ãÁÆ°ÁêÜÁ≥ªÁªü</span>
                
                <!-- ËßÜÂõæÂàáÊç¢ÊåâÈíÆ -->
                <div class="navbar-nav me-auto">
                    <button 
                        class="nav-link btn btn-link"
                        :class="{ 'active text-warning': currentView === 'summary' }"
                        @click="switchView('summary')"
                    >
                        Ê±áÊÄªËßÜÂõæ
                    </button>
                    <button 
                        class="nav-link btn btn-link"
                        :class="{ 'active text-warning': currentView === 'week' }"
                        @click="switchView('week')"
                    >
                        Âë®ËßÜÂõæ
                    </button>
                    <button 
                        class="nav-link btn btn-link"
                        :class="{ 'active text-warning': currentView === 'month' }"
                        @click="switchView('month')"
                    >
                        ÊúàËßÜÂõæ
                    </button>
                </div>
                
                <!-- ÂΩìÂâçÊó•ÊúüÊòæÁ§∫ -->
                <div class="navbar-text text-light">
                    <span x-text="getCurrentDateString()"></span>
                </div>
            </div>
        </nav>

        <!-- Ê±áÊÄªËßÜÂõæ -->
        <div x-show="currentView === 'summary'" class="row">
            <!-- ÁªüËÆ°‰ª™Ë°®Êùø -->
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Êï∞ÊçÆÁªüËÆ°</h5>
                        <div class="d-flex align-items-center">
                            <select class="form-select form-select-sm me-2" x-model="summaryMonth" @change="loadSummaryStatistics()">
                                <option value="">ÂÖ®ÈÉ®Êó∂Èó¥</option>
                                <template x-for="month in availableMonths" :key="month.value">
                                    <option :value="month.value" x-text="month.label"></option>
                                </template>
                            </select>
                            <button class="btn btn-outline-primary btn-sm" @click="loadSummaryStatistics()">
                                üìä Âà∑Êñ∞ÁªüËÆ°
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row" x-show="summaryStats">
                            <div class="col-md-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <h4 x-text="summaryStats?.total_events || 0"></h4>
                                        <p class="mb-0">ÊÄªÂÆâÊéíÊ¨°Êï∞</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h4 x-text="summaryStats?.completed_events || 0"></h4>
                                        <p class="mb-0">Â∑≤ÂÆåÊàêÊ¨°Êï∞</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning text-white">
                                    <div class="card-body text-center">
                                        <h4 x-text="Math.round((summaryStats?.completion_rate || 0) * 100) + '%'"></h4>
                                        <p class="mb-0">ÂÆåÊàêÁéá</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h4 x-text="summaryStats?.total_activities || 0"></h4>
                                        <p class="mb-0">Ê¥ªÂä®ÊÄªÊï∞</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ê¥ªÂä®ÁÆ°ÁêÜ -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Ê¥ªÂä®ÁÆ°ÁêÜ</h5>
                        <button class="btn btn-primary btn-sm" @click="showNewActivityModal = true">
                            + Êñ∞Âª∫Ê¥ªÂä®
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="activity-tree" class="mt-3">
                            <!-- Ê¥ªÂä®Ê†ëÂ∞ÜÂú®ËøôÈáåÊ∏≤Êüì -->
                            <div x-html="renderActivityTreeWithStats()"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Âë®ËßÜÂõæ -->
        <div x-show="currentView === 'week'" class="row">
            <!-- Ê¥ªÂä®Ê±† -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Ê¥ªÂä®Âç°ÁâáÊ±†</h6>
                    </div>
                    <div class="card-body">
                        <div class="activity-pool" id="activity-pool" x-html="renderActivityPool()">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Âë®Êó•Á®ãÁΩëÊ†º -->
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <button class="btn btn-outline-primary btn-sm" @click="previousWeek()">
                                ‚Äπ ‰∏ä‰∏ÄÂë®
                            </button>
                            <span class="mx-3 fw-bold" x-text="getWeekTitle()"></span>
                            <button class="btn btn-outline-primary btn-sm" @click="nextWeek()">
                                ‰∏ã‰∏ÄÂë® ‚Ä∫
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="week-grid" id="week-grid" x-html="renderFullWeekGrid()">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÊúàËßÜÂõæ -->
        <div x-show="currentView === 'month'">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <button class="btn btn-outline-primary btn-sm" @click="previousMonth()">
                            ‚Äπ ‰∏ä‰∏™Êúà
                        </button>
                        <span class="mx-3 fw-bold" x-text="getMonthTitle()"></span>
                        <button class="btn btn-outline-primary btn-sm" @click="nextMonth()">
                            ‰∏ã‰∏™Êúà ‚Ä∫
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row text-center fw-bold mb-2">
                        <div class="col">Âë®‰∏Ä</div>
                        <div class="col">Âë®‰∫å</div>
                        <div class="col">Âë®‰∏â</div>
                        <div class="col">Âë®Âõõ</div>
                        <div class="col">Âë®‰∫î</div>
                        <div class="col">Âë®ÂÖ≠</div>
                        <div class="col">Âë®Êó•</div>
                    </div>
                    <div id="month-calendar">
                        <!-- ÊúàÂéÜÂ∞ÜÂú®ËøôÈáåÊ∏≤Êüì -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Êñ∞Âª∫Ê¥ªÂä®Ê®°ÊÄÅÊ°Ü -->
        <div x-show="showNewActivityModal" class="modal" :class="{ 'd-block': showNewActivityModal }" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Êñ∞Âª∫Ê¥ªÂä®</h5>
                        <button type="button" class="btn-close" @click="showNewActivityModal = false"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="createActivity()">
                            <div class="mb-3">
                                <label class="form-label">Ê¥ªÂä®ÂêçÁß∞</label>
                                <input type="text" class="form-control" x-model="newActivity.name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Áà∂Ê¥ªÂä®</label>
                                <select class="form-control" x-model="newActivity.parent_id">
                                    <option value="">Êó†ÔºàÈ°∂Á∫ßÊ¥ªÂä®Ôºâ</option>
                                    <template x-for="activity in flatActivities" :key="activity.id">
                                        <option :value="activity.id" x-text="activity.name"></option>
                                    </template>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ÊèèËø∞</label>
                                <textarea class="form-control" rows="3" x-model="newActivity.description"></textarea>
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-secondary me-2" @click="showNewActivityModal = false">ÂèñÊ∂à</button>
                                <button type="submit" class="btn btn-primary">ÂàõÂª∫</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÁºñËæëÊ¥ªÂä®Ê®°ÊÄÅÊ°Ü -->
        <div x-show="showEditActivityModal" class="modal" :class="{ 'd-block': showEditActivityModal }" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ÁºñËæëÊ¥ªÂä®</h5>
                        <button type="button" class="btn-close" @click="showEditActivityModal = false"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="updateActivity()">
                            <div class="mb-3">
                                <label class="form-label">Ê¥ªÂä®ÂêçÁß∞</label>
                                <input type="text" class="form-control" x-model="editingActivity.name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ÊèèËø∞</label>
                                <textarea class="form-control" rows="3" x-model="editingActivity.description"></textarea>
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-secondary me-2" @click="showEditActivityModal = false">ÂèñÊ∂à</button>
                                <button type="submit" class="btn btn-primary">‰øùÂ≠ò</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÁºñËæëÊó•Á®ãÊ®°ÊÄÅÊ°Ü - Âè™Âú®Âë®ËßÜÂõæ‰∏≠ÊòæÁ§∫ -->
        <div x-show="showEditEventModal && currentView === 'week'" class="modal" :class="{ 'd-block': showEditEventModal && currentView === 'week' }" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ÁºñËæëÊó•Á®ã</h5>
                        <button type="button" class="btn-close" @click="forceCloseModal()"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="saveScheduledEvent()">
                            <div class="mb-3">
                                <label class="form-label">Êó•ÊúüÊó∂Èó¥</label>
                                <div class="row">
                                    <div class="col-8">
                                        <input type="date" class="form-control" x-model="editingEvent.event_date" required readonly>
                                    </div>
                                    <div class="col-4">
                                        <select class="form-control" x-model="editingEvent.time_slot" required>
                                            <template x-for="slot in timeSlots" :key="slot.value">
                                                <option :value="slot.value" x-text="slot.name"></option>
                                            </template>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3" x-show="editingEvent.activity_name">
                                <label class="form-label">Ê¥ªÂä®</label>
                                <input type="text" class="form-control" :value="editingEvent.activity_name" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ÁõÆÊ†á</label>
                                <input type="text" class="form-control" x-model="editingEvent.goal" placeholder="Êú¨Ê¨°Ë¶ÅËææÊàêÁöÑÂÖ∑‰ΩìÁõÆÊ†á">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Â§áÊ≥®</label>
                                <textarea class="form-control" rows="3" x-model="editingEvent.notes" placeholder="È¢ùÂ§ñÂ§áÊ≥®‰ø°ÊÅØ"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Áä∂ÊÄÅ</label>
                                <select class="form-control" x-model="editingEvent.status">
                                    <option value="planned">ËÆ°Âàí‰∏≠</option>
                                    <option value="completed">Â∑≤ÂÆåÊàê</option>
                                </select>
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-danger me-2" @click="deleteScheduledEvent()" x-show="editingEvent.id">Âà†Èô§</button>
                                <button type="button" class="btn btn-secondary me-2" @click="forceCloseModal()">ÂèñÊ∂à</button>
                                <button type="submit" class="btn btn-primary">‰øùÂ≠ò</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Áõ¥Êé•ÂµåÂÖ•JavaScript‰ª£Á†Å‰ª•ÈÅøÂÖçË∑ØÂæÑÈóÆÈ¢ò
        function laeApp() {
            return {
                // ÂΩìÂâçËßÜÂõæÁä∂ÊÄÅ
                currentView: 'week',
                
                // Êó•ÊúüÁä∂ÊÄÅ
                currentDate: new Date(),
                currentWeekStart: null,
                currentMonth: new Date().getMonth() + 1,
                currentYear: new Date().getFullYear(),
                
                // Êï∞ÊçÆÁä∂ÊÄÅ
                activities: [],
                flatActivities: [],
                weekSchedule: {},
                monthSchedule: {},

                // Áî®‰∫éÂº∫Âà∂Ëß¶ÂèëAlpine.jsÈáçÊñ∞Ê∏≤ÊüìÁöÑËæÖÂä©ÂèòÈáè
                refreshTrigger: 0,
                
                // Ê±áÊÄªËßÜÂõæÊï∞ÊçÆ
                summaryStats: null,
                summaryMonth: '',
                availableMonths: [],
                activityStats: {},
                
                // Êó∂Èó¥ÊßΩÈÖçÁΩÆ
                timeSlots: [
                    { value: 21, name: '‰∏äÂçàÁ¨¨1Êó∂ÊÆµ' },
                    { value: 22, name: '‰∏äÂçàÁ¨¨2Êó∂ÊÆµ' },
                    { value: 51, name: '‰∏ãÂçàÁ¨¨1Êó∂ÊÆµ' },
                    { value: 52, name: '‰∏ãÂçàÁ¨¨2Êó∂ÊÆµ' },
                    { value: 71, name: 'Êôö‰∏äÊó∂ÊÆµ' }
                ],
                
                // Ê®°ÊÄÅÊ°ÜÁä∂ÊÄÅ
                showNewActivityModal: false,
                showEditActivityModal: false,
                showEditEventModal: false,
                
                // Ë°®ÂçïÊï∞ÊçÆ
                newActivity: {
                    name: '',
                    parent_id: '',
                    description: ''
                },
                
                editingActivity: {
                    id: null,
                    name: '',
                    description: ''
                },
                
                editingEvent: {
                    id: null,
                    activity_id: null,
                    activity_name: '',
                    event_date: '',
                    time_slot: 21,
                    goal: '',
                    notes: '',
                    status: 'planned'
                },
                
                // Âë®Êï∞ÊçÆ
                weekDates: [],
                
                // Âº∫Âà∂ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                forceCloseModal() {
                    console.log('Force closing modal');
                    console.log('Before reset - showEditEventModal:', this.showEditEventModal);
                    console.log('Before reset - currentView:', this.currentView);
                    
                    this.showEditEventModal = false;
                    this.showNewActivityModal = false;
                    this.showEditActivityModal = false;
                    
                    console.log('After reset - showEditEventModal:', this.showEditEventModal);
                    console.log('Modal condition check:', this.showEditEventModal && this.currentView === 'week');
                    
                    // ÈáçÁΩÆÁºñËæë‰∫ã‰ª∂Êï∞ÊçÆ
                    this.editingEvent = {
                        id: null,
                        activity_id: null,
                        activity_name: '',
                        event_date: '',
                        time_slot: 21,
                        goal: '',
                        notes: '',
                        status: 'planned'
                    };
                    
                    // ÈáçÁΩÆÁºñËæëÊ¥ªÂä®Êï∞ÊçÆ
                    this.editingActivity = {
                        id: null,
                        name: '',
                        description: ''
                    };
                },
                
                // ÂàùÂßãÂåñ
                async init() {
                    console.log('Initializing LAE App... v9 - Debug Enhanced');
                    console.log('Initial view:', this.currentView);
                    console.log('Time slots configuration:', this.timeSlots);
                    
                    // ÂàõÂª∫ÂÖ®Â±ÄÂºïÁî®‰ª•‰æøHTML onclickËÆøÈóÆ
                    window.laeAppInstance = this;
                    
                    // Âº∫Âà∂ÈáçÁΩÆÊâÄÊúâÊ®°ÊÄÅÊ°ÜÁä∂ÊÄÅ
                    this.forceCloseModal();
                    
                    await this.loadActivities();
                    console.log('Activities loaded, count:', this.flatActivities.length);
                    
                    this.updateWeekDates();
                    console.log('Week dates updated:', this.weekDates);
                    
                    // Ê†πÊçÆÂΩìÂâçËßÜÂõæÂä†ËΩΩÊï∞ÊçÆ
                    if (this.currentView === 'week') {
                        await this.loadWeekSchedule();
                    } else if (this.currentView === 'month') {
                        await this.loadMonthSchedule();
                    } else if (this.currentView === 'summary') {
                        await this.initSummaryData();
                    }
                    
                    // Á°Æ‰øùDOMÊ∏≤ÊüìÂÆåÊàêÂêéÂàùÂßãÂåñÊãñÊãΩÂäüËÉΩ
                    this.$nextTick(() => {
                        console.log('DOM updated, initializing drag and drop in 300ms...');
                        
                        // Â¶ÇÊûúÊòØÂë®ËßÜÂõæÔºåÊâãÂä®Ê∏≤ÊüìÁΩëÊ†º
                        if (this.currentView === 'week') {
                            const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                            if (gridContainer) {
                                gridContainer.innerHTML = this.renderFullWeekGrid();
                                console.log('Week grid manually rendered');
                            }
                        }
                        
                        setTimeout(() => {
                            this.initDragAndDrop();
                        }, 300);
                    });
                },
                
                // APIË∞ÉÁî®ÊñπÊ≥ï
                async apiCall(endpoint, options = {}) {
                    try {
                        console.log('üåê APIË∞ÉÁî®:', {
                            endpoint,
                            method: options.method || 'GET',
                            body: options.body
                        });

                        const response = await fetch(`/api${endpoint}`, {
                            headers: {
                                'Content-Type': 'application/json',
                                ...options.headers
                            },
                            ...options
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('‚ùå APIÈîôËØØËØ¶ÊÉÖ:', {
                                status: response.status,
                                statusText: response.statusText,
                                url: response.url,
                                errorBody: errorText
                            });
                            throw new Error(`APIÈîôËØØ: ${response.status} - ${errorText}`);
                        }

                        const result = await response.json();
                        console.log('‚úÖ APIÊàêÂäü:', result);
                        return result;
                    } catch (error) {
                        console.error('APIË∞ÉÁî®Â§±Ë¥•:', error);
                        alert('Êìç‰ΩúÂ§±Ë¥•: ' + error.message);
                        throw error;
                    }
                },
                
                // Âä†ËΩΩÊ¥ªÂä®Êï∞ÊçÆ
                async loadActivities() {
                    try {
                        this.activities = await this.apiCall('/activities/tree');
                        this.flatActivities = await this.apiCall('/activities/');
                        console.log('Activities loaded:', this.flatActivities.length);
                    } catch (error) {
                        console.error('Âä†ËΩΩÊ¥ªÂä®Â§±Ë¥•:', error);
                    }
                },
                
                // ÂàõÂª∫Êñ∞Ê¥ªÂä®
                async createActivity() {
                    try {
                        const activityData = {
                            name: this.newActivity.name,
                            description: this.newActivity.description || null,
                            parent_id: this.newActivity.parent_id || null
                        };
                        
                        await this.apiCall('/activities/', {
                            method: 'POST',
                            body: JSON.stringify(activityData)
                        });
                        
                        // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
                        await this.loadActivities();
                        
                        // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°ÜÂπ∂ÈáçÁΩÆË°®Âçï
                        this.showNewActivityModal = false;
                        this.newActivity = { name: '', parent_id: '', description: '' };
                        
                        // Â¶ÇÊûúÂú®Ê±áÊÄªËßÜÂõæÔºåÈáçÊñ∞Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆ
                        if (this.currentView === 'summary') {
                            await this.initSummaryData();
                        }
                        
                    } catch (error) {
                        console.error('ÂàõÂª∫Ê¥ªÂä®Â§±Ë¥•:', error);
                    }
                },
                
                // ÁºñËæëÊ¥ªÂä®
                editActivity(activityId) {
                    const activity = this.flatActivities.find(a => a.id === activityId);
                    if (!activity) {
                        console.error('Activity not found:', activityId);
                        return;
                    }
                    
                    this.editingActivity = {
                        id: activity.id,
                        name: activity.name,
                        description: activity.description || ''
                    };
                    
                    this.showEditActivityModal = true;
                },
                
                // Êõ¥Êñ∞Ê¥ªÂä®
                async updateActivity() {
                    try {
                        const activityData = {
                            name: this.editingActivity.name,
                            description: this.editingActivity.description || null
                        };
                        
                        await this.apiCall(`/activities/${this.editingActivity.id}`, {
                            method: 'PUT',
                            body: JSON.stringify(activityData)
                        });
                        
                        // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
                        await this.loadActivities();
                        
                        // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°ÜÂπ∂ÈáçÁΩÆË°®Âçï
                        this.showEditActivityModal = false;
                        this.editingActivity = { id: null, name: '', description: '' };
                        
                        // Â¶ÇÊûúÂú®Ê±áÊÄªËßÜÂõæÔºåÈáçÊñ∞Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆ
                        if (this.currentView === 'summary') {
                            await this.initSummaryData();
                        }
                        
                    } catch (error) {
                        console.error('Êõ¥Êñ∞Ê¥ªÂä®Â§±Ë¥•:', error);
                    }
                },
                
                // ËßÜÂõæÂàáÊç¢
                async switchView(view) {
                    console.log('Switching from', this.currentView, 'to', view);
                    this.currentView = view;
                    
                    // ÂàáÊç¢ËßÜÂõæÊó∂Ê∏ÖÁêÜÊâÄÊúâÊ®°ÊÄÅÊ°ÜÁä∂ÊÄÅ
                    this.showNewActivityModal = false;
                    this.showEditActivityModal = false;
                    this.showEditEventModal = false;
                    
                    if (view === 'week') {
                        console.log('Entering week view...');
                        console.log('Current week dates:', this.weekDates);
                        console.log('Time slots:', this.timeSlots);
                        
                        await this.loadWeekSchedule();
                        
                        // Âº∫Âà∂ÈáçÊñ∞Ê∏≤ÊüìÁΩëÊ†º
                        this.$nextTick(() => {
                            // ÊâãÂä®Ëß¶ÂèëÈáçÊñ∞Ê∏≤Êüì
                            const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                            if (gridContainer) {
                                gridContainer.innerHTML = this.renderFullWeekGrid();
                            }
                            
                            console.log('Week view DOM updated, checking elements...');
                            console.log('Activity pool element:', document.getElementById('activity-pool'));
                            console.log('Week grid element:', document.getElementById('week-grid'));
                            console.log('Time slot elements:', document.querySelectorAll('.time-slot').length);
                            
                            setTimeout(() => {
                                this.initDragAndDrop();
                            }, 200);
                        });
                    } else if (view === 'month') {
                        await this.loadMonthSchedule();
                    } else if (view === 'summary') {
                        await this.initSummaryData();
                    }
                },
                
                // Âë®ËßÜÂõæÁõ∏ÂÖ≥ÊñπÊ≥ï
                updateWeekDates() {
                    const start = new Date(this.currentDate);
                    start.setDate(start.getDate() - start.getDay() + 1); // Ëé∑ÂèñÂë®‰∏Ä
                    this.currentWeekStart = new Date(start);
                    
                    this.weekDates = [];
                    for (let i = 0; i < 7; i++) {
                        const date = new Date(start);
                        date.setDate(start.getDate() + i);
                        this.weekDates.push(date.toISOString().split('T')[0]);
                    }
                },
                
                async loadWeekSchedule() {
                    try {
                        const targetDate = this.weekDates[0]; // Âë®‰∏Ä
                        console.log('Loading week schedule for:', targetDate);
                        const data = await this.apiCall(`/calendar/week/${targetDate}`);
                        
                        // ËΩ¨Êç¢Êï∞ÊçÆÊ†ºÂºè‰ª•‰æøÊü•Êâæ
                        this.weekSchedule = {};
                        data.schedule.forEach(day => {
                            this.weekSchedule[day.date] = day.slots;
                        });
                        console.log('Week schedule loaded:', this.weekSchedule);
                        console.log('Schedule data structure:', data);
                    } catch (error) {
                        console.error('Âä†ËΩΩÂë®Êó•Á®ãÂ§±Ë¥•:', error);
                        // Âç≥‰ΩøÂä†ËΩΩÂ§±Ë¥•‰πüË¶ÅÂàùÂßãÂåñÁ©∫ÁöÑÂë®Êó•Á®ãÂØπË±°
                        this.weekSchedule = {};
                    }
                },
                
                getScheduledEvent(date, timeSlot) {
                    return this.weekSchedule[date]?.[timeSlot] || null;
                },
                
                async previousWeek() {
                    console.log('‚¨ÖÔ∏è ÂàáÊç¢Âà∞‰∏ä‰∏ÄÂë®');
                    this.currentDate.setDate(this.currentDate.getDate() - 7);
                    this.updateWeekDates();
                    await this.loadWeekSchedule();

                    // Á°Æ‰øùÂàáÊç¢Âë®ÂêéÈáçÊñ∞ÂàùÂßãÂåñÊãñÊãΩÂäüËÉΩ
                    this.$nextTick(() => {
                        const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                        if (gridContainer) {
                            gridContainer.innerHTML = this.renderFullWeekGrid();
                            console.log('Âë®Êï∞ÊçÆÂàáÊç¢ÂêéÈáçÊñ∞Ê∏≤ÊüìÁΩëÊ†º');

                            setTimeout(() => {
                                this.initDragAndDrop();
                                console.log('Âë®Êï∞ÊçÆÂàáÊç¢ÂêéÈáçÊñ∞ÂàùÂßãÂåñÊãñÊãΩ');
                            }, 200);
                        }
                    });
                },

                async nextWeek() {
                    console.log('‚û°Ô∏è ÂàáÊç¢Âà∞‰∏ã‰∏ÄÂë®');
                    this.currentDate.setDate(this.currentDate.getDate() + 7);
                    this.updateWeekDates();
                    await this.loadWeekSchedule();

                    // Á°Æ‰øùÂàáÊç¢Âë®ÂêéÈáçÊñ∞ÂàùÂßãÂåñÊãñÊãΩÂäüËÉΩ
                    this.$nextTick(() => {
                        const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                        if (gridContainer) {
                            gridContainer.innerHTML = this.renderFullWeekGrid();
                            console.log('Âë®Êï∞ÊçÆÂàáÊç¢ÂêéÈáçÊñ∞Ê∏≤ÊüìÁΩëÊ†º');

                            setTimeout(() => {
                                this.initDragAndDrop();
                                console.log('Âë®Êï∞ÊçÆÂàáÊç¢ÂêéÈáçÊñ∞ÂàùÂßãÂåñÊãñÊãΩ');
                            }, 200);
                        }
                    });
                },
                
                // Êó•Á®ãÁºñËæë
                editScheduledEvent(date, timeSlot) {
                    console.log('Editing event for:', date, timeSlot, 'Current view:', this.currentView);
                    
                    // Âè™Âú®Âë®ËßÜÂõæ‰∏≠ÂÖÅËÆ∏ÁºñËæë
                    if (this.currentView !== 'week') {
                        console.log('Edit event modal blocked - not in week view');
                        return;
                    }
                    
                    const event = this.getScheduledEvent(date, timeSlot);
                    
                    if (event) {
                        // ÁºñËæëÁé∞Êúâ‰∫ã‰ª∂
                        this.editingEvent = {
                            id: event.id,
                            activity_id: event.activity_id,
                            activity_name: event.activity_name,
                            event_date: date,
                            time_slot: timeSlot,
                            goal: event.goal || '',
                            notes: event.notes || '',
                            status: event.status
                        };
                    } else {
                        // ÂàõÂª∫Êñ∞‰∫ã‰ª∂Ôºà‰ΩÜÈúÄË¶ÅÂÖàÈÄâÊã©Ê¥ªÂä®Ôºâ
                        this.editingEvent = {
                            id: null,
                            activity_id: null,
                            activity_name: '',
                            event_date: date,
                            time_slot: timeSlot,
                            goal: '',
                            notes: '',
                            status: 'planned'
                        };
                    }
                    
                    this.showEditEventModal = true;
                },
                
                async saveScheduledEvent() {
                    try {
                        if (!this.editingEvent.activity_id) {
                            alert('ËØ∑ÂÖàÊãñÊãΩÊ¥ªÂä®Âà∞Êó∂Èó¥ÊßΩ‰∏≠');
                            return;
                        }
                        
                        const eventData = {
                            activity_id: this.editingEvent.activity_id,
                            event_date: this.editingEvent.event_date,
                            time_slot: this.editingEvent.time_slot,
                            goal: this.editingEvent.goal || null,
                            notes: this.editingEvent.notes || null,
                            status: this.editingEvent.status
                        };
                        
                        if (this.editingEvent.id) {
                            // Êõ¥Êñ∞Áé∞Êúâ‰∫ã‰ª∂
                            await this.apiCall(`/events/${this.editingEvent.id}`, {
                                method: 'PUT',
                                body: JSON.stringify(eventData)
                            });
                        } else {
                            // ÂàõÂª∫Êñ∞‰∫ã‰ª∂
                            await this.apiCall('/events/', {
                                method: 'POST',
                                body: JSON.stringify(eventData)
                            });
                        }
                        
                        // Âà∑Êñ∞Êï∞ÊçÆ
                        await this.loadWeekSchedule();
                        this.forceCloseModal();
                        
                    } catch (error) {
                        console.error('‰øùÂ≠òÊó•Á®ãÂ§±Ë¥•:', error);
                    }
                },
                
                async deleteScheduledEvent() {
                    if (!this.editingEvent.id) return;
                    
                    if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Êó•Á®ãÂêóÔºü')) {
                        try {
                            await this.apiCall(`/events/${this.editingEvent.id}`, {
                                method: 'DELETE'
                            });
                            
                            await this.loadWeekSchedule();
                            this.forceCloseModal();
                        } catch (error) {
                            console.error('Âà†Èô§Êó•Á®ãÂ§±Ë¥•:', error);
                        }
                    }
                },
                
                // ÊãñÊãΩÂäüËÉΩÂàùÂßãÂåñ
                initDragAndDrop() {
                    console.log('Initializing drag and drop...', 'Current view:', this.currentView);
                    
                    // Âè™Âú®Âë®ËßÜÂõæ‰∏≠ÂàùÂßãÂåñÊãñÊãΩÂäüËÉΩ
                    if (this.currentView !== 'week') {
                        console.log('Drag and drop skipped - not in week view');
                        return;
                    }
                    
                    const self = this; // ‰øùÂ≠òAlpine.jsÂÆû‰æãÂºïÁî®
                    
                    // Âè™Ê∏ÖÁêÜÊó∂Èó¥ÊßΩÁöÑSortableÂÆû‰æãÔºå‰øùÁïôÊ¥ªÂä®Ê±†ÁöÑÂÆû‰æã
                    document.querySelectorAll('.time-slot.sortable-initialized').forEach(el => {
                        if (el.sortableInstance) {
                            el.sortableInstance.destroy();
                        }
                        el.classList.remove('sortable-initialized');
                    });
                    
                    console.log('Cleaned up time slot sortable instances');
                    
                    // ÂàùÂßãÂåñÊ¥ªÂä®Ê±†ÁöÑÊãñÊãΩÔºà‰ΩøÁî®‰∏ìÈó®ÊñπÊ≥ïÔºâ
                    this.initActivityPoolDragAndDrop();
                    
                    // ÂàùÂßãÂåñÊó∂Èó¥ÊßΩÁöÑÊãñÊãΩÊé•Êî∂
                    const timeSlots = document.querySelectorAll('.time-slot');
                    console.log('Found time slots:', timeSlots.length);
                    
                    timeSlots.forEach((slot, index) => {
                        if (!slot.classList.contains('sortable-initialized')) {
                            console.log(`Initializing time slot ${index}:`, {
                                date: slot.getAttribute('data-date'),
                                timeSlot: slot.getAttribute('data-time-slot')
                            });
                            
                            slot.sortableInstance = Sortable.create(slot, {
                                group: {
                                    name: 'activities',
                                    pull: true,  // ÂÖÅËÆ∏‰ªéÊó∂Èó¥ÊßΩÊãñÂá∫ÔºàÁî®‰∫éÂà†Èô§ÊàñÁßªÂä®Ôºâ
                                    put: true    // ÂÖÅËÆ∏ÊãñÂÖ•Êó∂Èó¥ÊßΩ
                                },
                                animation: 200,
                                ghostClass: 'sortable-ghost',
                                chosenClass: 'sortable-chosen',
                                dragClass: 'sortable-drag',
                                // ÊèêÈ´òÊãñÊãΩÂà§Êñ≠Á≤æÂ∫¶ÁöÑÂèÇÊï∞
                                tolerance: 'pointer', // ‰ΩøÁî®Èº†Ê†áÊåáÈíà‰ΩçÁΩÆÂà§Êñ≠ÔºåËÄå‰∏çÊòØÂÖÉÁ¥†‰∏≠ÂøÉ
                                forceAutoScrollFallback: false, // Á¶ÅÁî®Ëá™Âä®ÊªöÂä®ÈÅøÂÖç‰ΩçÁΩÆËÆ°ÁÆóÈîôËØØ
                                fallbackTolerance: 5, // ËÆæÁΩÆÂÆπÂ∑Æ‰∏∫5pxÔºåÊèêÈ´òÁ≤æÂ∫¶
                                // ÂΩì‰ªéÊ¥ªÂä®Ê±†ÊãñÊãΩÂà∞Êó∂Èó¥ÊßΩ
                                onAdd: function(evt) {
                                    console.log('Drop event triggered on slot:', evt.to);
                                    const activityId = evt.item.getAttribute('data-activity-id');
                                    const date = evt.to.getAttribute('data-date');
                                    const timeSlot = parseInt(evt.to.getAttribute('data-time-slot'));
                                    const fromPool = evt.from.id === 'activity-pool';
                                    const fromTimeSlot = evt.from.classList.contains('time-slot');

                                    // ËØ¶ÁªÜÁöÑÊãñÊãΩÂà§Êñ≠Ë∞ÉËØï‰ø°ÊÅØ
                                    const targetRect = evt.to.getBoundingClientRect();
                                    const isValidTarget = self.validateDropTarget(evt.to, targetRect);

                                    console.log('üéØ ÊãñÊãΩ‰ΩçÁΩÆÂà§Êñ≠ËØ¶ÊÉÖ:', {
                                        ÁõÆÊ†áÊßΩ‰Ωç: `${date} ${timeSlot}`,
                                        ÁõÆÊ†áÂÖÉÁ¥†: evt.to,
                                        ÁõÆÊ†áÂÖÉÁ¥†Ê†áÁ≠æ: evt.to.tagName,
                                        ÁõÆÊ†áÂÖÉÁ¥†Á±ªÂêç: evt.to.className,
                                        ÁõÆÊ†áÂÖÉÁ¥†ID: evt.to.id,
                                        ÁõÆÊ†áÂÖÉÁ¥†ÂèØËßÅÊÄß: window.getComputedStyle(evt.to).display,
                                        ÁõÆÊ†áÂÖÉÁ¥†ÈÄèÊòéÂ∫¶: window.getComputedStyle(evt.to).opacity,
                                        ÁõÆÊ†áÂÖÉÁ¥†ËæπÁïå: {
                                            left: targetRect.left,
                                            right: targetRect.right,
                                            top: targetRect.top,
                                            bottom: targetRect.bottom,
                                            width: targetRect.width,
                                            height: targetRect.height
                                        },
                                        ÁõÆÊ†áÊúâÊïàÊÄß: isValidTarget ? '‚úÖ ÊúâÊïà' : '‚ùå Êó†Êïà',
                                        ÊãñÊãΩÊ∫ê: fromPool ? 'Ê¥ªÂä®Ê±†' : 'Êó∂Èó¥ÊßΩ',
                                        Ê¥ªÂä®ID: activityId,
                                        ÊâÄÊúâÊó∂Èó¥ÊßΩÂÖÉÁ¥†Êï∞Èáè: document.querySelectorAll('.time-slot').length,
                                        ÂΩìÂâçÊó∂Èó¥ÊßΩÊòØÂê¶Â≠òÂú®: document.querySelector(`[data-date="${date}"][data-time-slot="${timeSlot}"]`) !== null
                                    });

                                    // È™åËØÅÁõÆÊ†áÂÖÉÁ¥†ÊúâÊïàÊÄß
                                    if (!isValidTarget) {
                                        console.warn('‚ö†Ô∏è Ê£ÄÊµãÂà∞Êó†ÊïàÁõÆÊ†áÂÖÉÁ¥†ÔºåÂ∞ùËØïÈáçÊñ∞ÂÆö‰Ωç...');

                                        // Â∞ùËØïÊâæÂà∞ÊúÄËøëÁöÑÊúâÊïàÊó∂Èó¥ÊßΩ
                                        const validTarget = self.findNearestValidTimeSlot(evt.originalEvent);
                                        if (validTarget) {
                                            console.log('üîÑ ÈáçÂÆöÂêëÂà∞ÊúâÊïàÁõÆÊ†á:', validTarget);
                                            // Êõ¥Êñ∞ÁõÆÊ†áÊï∞ÊçÆ
                                            evt.to = validTarget;
                                            const newDate = validTarget.getAttribute('data-date');
                                            const newTimeSlot = parseInt(validTarget.getAttribute('data-time-slot'));

                                            console.log('üéØ ÈáçÂÆöÂêëÂêéÁöÑÁõÆÊ†á:', {
                                                ÂéüÁõÆÊ†á: `${date} ${timeSlot}`,
                                                Êñ∞ÁõÆÊ†á: `${newDate} ${newTimeSlot}`
                                            });

                                            // ‰ΩøÁî®Êñ∞ÁöÑÁõÆÊ†áÊï∞ÊçÆ
                                            if (fromTimeSlot) {
                                                self.handleMoveEvent(activityId, evt.from.getAttribute('data-date'),
                                                    parseInt(evt.from.getAttribute('data-time-slot')), newDate, newTimeSlot);
                                            } else {
                                                self.handleDrop(activityId, newDate, newTimeSlot);
                                            }
                                        } else {
                                            console.error('‚ùå Êâæ‰∏çÂà∞ÊúâÊïàÁöÑÁõÆÊ†áÊó∂Èó¥ÊßΩ');
                                            evt.item.remove();
                                        }
                                        return;
                                    }

                                    console.log('Drop details:', {
                                        activityId, date, timeSlot,
                                        fromPool, fromTimeSlot,
                                        fromElement: evt.from.id || evt.from.className
                                    });

                                    if (!activityId || !date || !timeSlot) {
                                        console.error('Missing required drop data');
                                        evt.item.remove();
                                        return;
                                    }

                                    // Á´ãÂç≥ÁßªÈô§ÊãñÊãΩÁöÑ‰∏¥Êó∂ÂÖÉÁ¥†
                                    evt.item.remove();

                                    // Â¶ÇÊûúÊòØ‰ªéÂÖ∂‰ªñÊó∂Èó¥ÊßΩÁßªÂä®ËøáÊù•ÁöÑÔºåÈúÄË¶ÅÂÖàÂà†Èô§ÂéüÊúâ‰∫ã‰ª∂
                                    if (fromTimeSlot) {
                                        const originalDate = evt.from.getAttribute('data-date');
                                        const originalTimeSlot = parseInt(evt.from.getAttribute('data-time-slot'));
                                        console.log('Moving from time slot:', originalDate, originalTimeSlot);

                                        // Â§ÑÁêÜÁßªÂä®‰∫ã‰ª∂ÔºàÂÖàÂà†Èô§Âéü‰∫ã‰ª∂ÔºåÂÜçÂàõÂª∫Êñ∞‰∫ã‰ª∂Ôºâ
                                        self.handleMoveEvent(activityId, originalDate, originalTimeSlot, date, timeSlot);
                                    } else {
                                        // ‰ªéÊ¥ªÂä®Ê±†ÊãñÊãΩÔºåÂàõÂª∫Êñ∞‰∫ã‰ª∂
                                        self.handleDrop(activityId, date, timeSlot);
                                    }
                                },
                                // ÂΩì‰ªéÊó∂Èó¥ÊßΩÊãñÊãΩÂÖÉÁ¥†Âá∫ÂéªÊó∂
                                onRemove: function(evt) {
                                    console.log('Item removed from time slot:', {
                                        from: evt.from,
                                        to: evt.to,
                                        toId: evt.to.id,
                                        toClass: evt.to.className
                                    });

                                    // Â¶ÇÊûúÊãñÊãΩÂà∞Ê¥ªÂä®Ê±†ÔºåËßÜ‰∏∫Âà†Èô§Êìç‰Ωú
                                    if (evt.to.id === 'activity-pool') {
                                        const date = evt.from.getAttribute('data-date');
                                        const timeSlot = parseInt(evt.from.getAttribute('data-time-slot'));
                                        const eventId = evt.item.getAttribute('data-event-id');

                                        console.log('Deleting event by drag to pool:', { date, timeSlot, eventId });

                                        if (eventId) {
                                            self.deleteEventById(eventId);
                                        } else {
                                            // Â§áÁî®Âà†Èô§ÊñπÊ≥ïÔºöÊ†πÊçÆÊó•ÊúüÂíåÊó∂Èó¥ÊßΩÊü•ÊâæÂπ∂Âà†Èô§
                                            self.deleteEventByDateSlot(date, timeSlot);
                                        }
                                    }
                                    // Â¶ÇÊûúÊòØÁßªÂä®Âà∞ÂÖ∂‰ªñÊó∂Èó¥ÊßΩÔºåonAdd‰ºöÂ§ÑÁêÜ
                                }
                            });
                            slot.classList.add('sortable-initialized');
                        }
                    });
                    
                    console.log('Drag and drop initialization completed');
                },
                
                // Âè™ÂàùÂßãÂåñÊó∂Èó¥ÊßΩÁöÑÊãñÊãΩÂäüËÉΩÔºàÁî®‰∫éÂä®ÊÄÅÈáçÊñ∞ÂàùÂßãÂåñÔºâ
                initTimeSlotsDragAndDrop() {
                    if (this.currentView !== 'week') {
                        return;
                    }

                    console.log('Re-initializing time slots drag and drop...');
                    const self = this;

                    // Êõ¥ÂΩªÂ∫ïÁöÑÊ∏ÖÁêÜÊó∂Èó¥ÊßΩÁöÑSortableÂÆû‰æã
                    document.querySelectorAll('.time-slot').forEach(el => {
                        if (el.sortableInstance) {
                            console.log('Destroying existing sortable instance for time slot');
                            try {
                                el.sortableInstance.destroy();
                            } catch (e) {
                                console.warn('Error destroying sortable instance:', e);
                            }
                            el.sortableInstance = null;
                        }
                        el.classList.remove('sortable-initialized');

                        // Ê∏ÖÁêÜÂèØËÉΩÊÆãÁïôÁöÑÊãñÊãΩÁõ∏ÂÖ≥ÁöÑCSSÁ±ª
                        el.classList.remove('sortable-chosen', 'sortable-drag', 'sortable-ghost', 'sortable-over');
                    });

                    // Á≠âÂæÖ‰∏ÄÂ∏ßÊù•Á°Æ‰øùDOMÂÆåÂÖ®Ê∏ÖÁêÜ
                    requestAnimationFrame(() => {
                        // ÈáçÊñ∞ÂàùÂßãÂåñÊó∂Èó¥ÊßΩÁöÑÊãñÊãΩÊé•Êî∂
                        const timeSlots = document.querySelectorAll('.time-slot');
                        console.log('Re-initializing time slots:', timeSlots.length);

                        timeSlots.forEach((slot, index) => {
                            if (!slot.classList.contains('sortable-initialized')) {
                                slot.sortableInstance = Sortable.create(slot, {
                                    group: {
                                        name: 'activities',
                                        pull: true,
                                        put: true
                                    },
                                    animation: 200,
                                    ghostClass: 'sortable-ghost',
                                    chosenClass: 'sortable-chosen',
                                    dragClass: 'sortable-drag',
                                    // ÊèêÈ´òÊãñÊãΩÂà§Êñ≠Á≤æÂ∫¶ÁöÑÂèÇÊï∞
                                    tolerance: 'pointer', // ‰ΩøÁî®Èº†Ê†áÊåáÈíà‰ΩçÁΩÆÂà§Êñ≠ÔºåËÄå‰∏çÊòØÂÖÉÁ¥†‰∏≠ÂøÉ
                                    forceAutoScrollFallback: false, // Á¶ÅÁî®Ëá™Âä®ÊªöÂä®ÈÅøÂÖç‰ΩçÁΩÆËÆ°ÁÆóÈîôËØØ
                                    fallbackTolerance: 5, // ËÆæÁΩÆÂÆπÂ∑Æ‰∏∫5pxÔºåÊèêÈ´òÁ≤æÂ∫¶
                                    onAdd: function(evt) {
                                        console.log('Drop event triggered on slot:', evt.to);
                                        const activityId = evt.item.getAttribute('data-activity-id');
                                        const date = evt.to.getAttribute('data-date');
                                        const timeSlot = parseInt(evt.to.getAttribute('data-time-slot'));
                                        const fromPool = evt.from.id === 'activity-pool';
                                        const fromTimeSlot = evt.from.classList.contains('time-slot');

                                        // ËØ¶ÁªÜÁöÑÊãñÊãΩÂà§Êñ≠Ë∞ÉËØï‰ø°ÊÅØ
                                        const targetRect = evt.to.getBoundingClientRect();
                                        const isValidTarget = self.validateDropTarget(evt.to, targetRect);

                                        console.log('üéØ ÊãñÊãΩ‰ΩçÁΩÆÂà§Êñ≠ËØ¶ÊÉÖ:', {
                                            ÁõÆÊ†áÊßΩ‰Ωç: `${date} ${timeSlot}`,
                                            ÁõÆÊ†áÊúâÊïàÊÄß: isValidTarget ? '‚úÖ ÊúâÊïà' : '‚ùå Êó†Êïà',
                                            ÁõÆÊ†áÂÖÉÁ¥†: evt.to,
                                            ÁõÆÊ†áÂÖÉÁ¥†Ê†áÁ≠æ: evt.to.tagName,
                                            ÁõÆÊ†áÂÖÉÁ¥†Á±ªÂêç: evt.to.className,
                                            ÁõÆÊ†áÂÖÉÁ¥†ID: evt.to.id,
                                            ÁõÆÊ†áÂÖÉÁ¥†ÂèØËßÅÊÄß: window.getComputedStyle(evt.to).display,
                                            ÁõÆÊ†áÂÖÉÁ¥†ÈÄèÊòéÂ∫¶: window.getComputedStyle(evt.to).opacity,
                                            ÁõÆÊ†áÂÖÉÁ¥†ËæπÁïå: {
                                                left: targetRect.left,
                                                right: targetRect.right,
                                                top: targetRect.top,
                                                bottom: targetRect.bottom,
                                                width: targetRect.width,
                                                height: targetRect.height
                                            },
                                            ÊãñÊãΩÊ∫ê: fromPool ? 'Ê¥ªÂä®Ê±†' : 'Êó∂Èó¥ÊßΩ',
                                            Ê¥ªÂä®ID: activityId,
                                            ÊâÄÊúâÊó∂Èó¥ÊßΩÂÖÉÁ¥†Êï∞Èáè: document.querySelectorAll('.time-slot').length,
                                            ÂΩìÂâçÊó∂Èó¥ÊßΩÊòØÂê¶Â≠òÂú®: document.querySelector(`[data-date="${date}"][data-time-slot="${timeSlot}"]`) !== null
                                        });

                                        // È™åËØÅÁõÆÊ†áÂÖÉÁ¥†ÊúâÊïàÊÄß
                                        if (!isValidTarget) {
                                            console.warn('‚ö†Ô∏è Ê£ÄÊµãÂà∞Êó†ÊïàÁõÆÊ†áÂÖÉÁ¥†ÔºåÂ∞ùËØïÈáçÊñ∞ÂÆö‰Ωç...');

                                            // Â∞ùËØïÊâæÂà∞ÊúÄËøëÁöÑÊúâÊïàÊó∂Èó¥ÊßΩ
                                            const validTarget = self.findNearestValidTimeSlot(evt.originalEvent);
                                            if (validTarget) {
                                                console.log('üîÑ ÈáçÂÆöÂêëÂà∞ÊúâÊïàÁõÆÊ†á:', validTarget);
                                                const newDate = validTarget.getAttribute('data-date');
                                                const newTimeSlot = parseInt(validTarget.getAttribute('data-time-slot'));

                                                console.log('üéØ ÈáçÂÆöÂêëÂêéÁöÑÁõÆÊ†á:', {
                                                    ÂéüÁõÆÊ†á: `${date} ${timeSlot}`,
                                                    Êñ∞ÁõÆÊ†á: `${newDate} ${newTimeSlot}`
                                                });

                                                evt.item.remove();

                                                // ‰ΩøÁî®Êñ∞ÁöÑÁõÆÊ†áÊï∞ÊçÆ
                                                if (fromTimeSlot) {
                                                    self.handleMoveEvent(activityId, evt.from.getAttribute('data-date'),
                                                        parseInt(evt.from.getAttribute('data-time-slot')), newDate, newTimeSlot);
                                                } else {
                                                    self.handleDrop(activityId, newDate, newTimeSlot);
                                                }
                                            } else {
                                                console.error('‚ùå Êâæ‰∏çÂà∞ÊúâÊïàÁöÑÁõÆÊ†áÊó∂Èó¥ÊßΩ');
                                                evt.item.remove();
                                            }
                                            return;
                                        }

                                        console.log('Drop details:', {
                                            activityId, date, timeSlot,
                                            fromPool, fromTimeSlot,
                                            fromElement: evt.from.id || evt.from.className
                                        });

                                        if (!activityId || !date || !timeSlot) {
                                            console.error('Missing required drop data');
                                            evt.item.remove();
                                            return;
                                        }

                                        evt.item.remove();

                                        // Â¶ÇÊûúÊòØ‰ªéÂÖ∂‰ªñÊó∂Èó¥ÊßΩÁßªÂä®ËøáÊù•ÁöÑÔºåÈúÄË¶ÅÂÖàÂà†Èô§ÂéüÊúâ‰∫ã‰ª∂
                                        if (fromTimeSlot) {
                                            const originalDate = evt.from.getAttribute('data-date');
                                            const originalTimeSlot = parseInt(evt.from.getAttribute('data-time-slot'));
                                            console.log('Moving from time slot:', originalDate, originalTimeSlot);

                                            // Â§ÑÁêÜÁßªÂä®‰∫ã‰ª∂ÔºàÂÖàÂà†Èô§Âéü‰∫ã‰ª∂ÔºåÂÜçÂàõÂª∫Êñ∞‰∫ã‰ª∂Ôºâ
                                            self.handleMoveEvent(activityId, originalDate, originalTimeSlot, date, timeSlot);
                                        } else {
                                            // ‰ªéÊ¥ªÂä®Ê±†ÊãñÊãΩÔºåÂàõÂª∫Êñ∞‰∫ã‰ª∂
                                            self.handleDrop(activityId, date, timeSlot);
                                        }
                                    },
                                    onRemove: function(evt) {
                                        console.log('Item removed from time slot:', {
                                            from: evt.from,
                                            to: evt.to,
                                            toId: evt.to.id,
                                            toClass: evt.to.className
                                        });

                                        // Â¶ÇÊûúÊãñÊãΩÂà∞Ê¥ªÂä®Ê±†ÔºåËßÜ‰∏∫Âà†Èô§Êìç‰Ωú
                                        if (evt.to.id === 'activity-pool') {
                                            const date = evt.from.getAttribute('data-date');
                                            const timeSlot = parseInt(evt.from.getAttribute('data-time-slot'));
                                            const eventId = evt.item.getAttribute('data-event-id');

                                            console.log('Deleting event by drag to pool:', { date, timeSlot, eventId });

                                            if (eventId) {
                                                self.deleteEventById(eventId);
                                            } else {
                                                // Â§áÁî®Âà†Èô§ÊñπÊ≥ïÔºöÊ†πÊçÆÊó•ÊúüÂíåÊó∂Èó¥ÊßΩÊü•ÊâæÂπ∂Âà†Èô§
                                                self.deleteEventByDateSlot(date, timeSlot);
                                            }
                                        }
                                        // Â¶ÇÊûúÊòØÁßªÂä®Âà∞ÂÖ∂‰ªñÊó∂Èó¥ÊßΩÔºåonAdd‰ºöÂ§ÑÁêÜ
                                    }
                                });
                                slot.classList.add('sortable-initialized');
                            }
                        });

                        console.log('Time slots drag and drop re-initialization completed');
                    });
                },
                
                // Êñ∞Â¢ûÔºöÂ§ÑÁêÜ‰∫ã‰ª∂ÁßªÂä®Ôºà‰ªé‰∏Ä‰∏™Êó∂Èó¥ÊßΩÁßªÂä®Âà∞Âè¶‰∏Ä‰∏™Êó∂Èó¥ÊßΩÔºâ
                async handleMoveEvent(activityId, fromDate, fromTimeSlot, toDate, toTimeSlot) {
                    try {
                        console.log('=== MOVE EVENT HANDLER START ===');
                        console.log('Moving event:', {
                            activityId,
                            from: { date: fromDate, timeSlot: fromTimeSlot },
                            to: { date: toDate, timeSlot: toTimeSlot }
                        });

                        // Ê£ÄÊü•ÁõÆÊ†áÊó∂Èó¥ÊßΩÊòØÂê¶Â∑≤Ë¢´Âç†Áî®
                        const targetEvent = this.getScheduledEvent(toDate, toTimeSlot);
                        if (targetEvent) {
                            alert('ÁõÆÊ†áÊó∂Èó¥ÊßΩÂ∑≤ÊúâÂÆâÊéíÔºåÊó†Ê≥ïÁßªÂä®');
                            // ÈáçÊñ∞Ê∏≤ÊüìÁΩëÊ†º‰ª•ÊÅ¢Â§çÂéüÁä∂
                            await this.loadWeekSchedule();
                            const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                            if (gridContainer) {
                                gridContainer.innerHTML = this.renderFullWeekGrid();
                                setTimeout(() => {
                                    this.initTimeSlotsDragAndDrop();
                                }, 100);
                            }
                            return;
                        }

                        // ÊâæÂà∞Âéü‰∫ã‰ª∂
                        const originalEvent = this.getScheduledEvent(fromDate, fromTimeSlot);
                        if (!originalEvent) {
                            console.error('Original event not found');
                            alert('Êâæ‰∏çÂà∞ÂéüÂßã‰∫ã‰ª∂');
                            return;
                        }

                        console.log('Original event found:', originalEvent);

                        // Êõ¥Êñ∞‰∫ã‰ª∂ÁöÑÊó•ÊúüÂíåÊó∂Èó¥ÊßΩ
                        const updateData = {
                            activity_id: parseInt(activityId),
                            event_date: toDate,
                            time_slot: parseInt(toTimeSlot),
                            goal: originalEvent.goal || '',
                            notes: originalEvent.notes || '',
                            status: originalEvent.status || 'planned'
                        };

                        console.log('Updating event with data:', updateData);

                        const result = await this.apiCall(`/events/${originalEvent.id}`, {
                            method: 'PUT',
                            body: JSON.stringify(updateData)
                        });

                        console.log('Event moved successfully:', result);

                        // Âà∑Êñ∞Êï∞ÊçÆÂíåÈáçÊñ∞Ê∏≤Êüì
                        await this.loadWeekSchedule();
                        const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                        if (gridContainer) {
                            gridContainer.innerHTML = this.renderFullWeekGrid();
                            console.log('Week grid re-rendered after move');

                            setTimeout(() => {
                                this.initTimeSlotsDragAndDrop();
                                // Á°Æ‰øùÊ¥ªÂä®Ê±†Áä∂ÊÄÅÊ≠£Â∏∏
                                this.verifyActivityPoolState();
                            }, 100);
                        }

                        console.log('=== MOVE EVENT HANDLER SUCCESS ===');

                    } catch (error) {
                        console.error('=== MOVE EVENT HANDLER ERROR ===');
                        console.error('ÁßªÂä®‰∫ã‰ª∂Â§±Ë¥•:', error);
                        alert('ÁßªÂä®‰∫ã‰ª∂Â§±Ë¥•: ' + error.message);

                        // ÈáçÊñ∞Ê∏≤ÊüìÁΩëÊ†º‰ª•ÊÅ¢Â§çÂéüÁä∂
                        await this.loadWeekSchedule();
                        const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                        if (gridContainer) {
                            gridContainer.innerHTML = this.renderFullWeekGrid();
                            setTimeout(() => {
                                this.initTimeSlotsDragAndDrop();
                            }, 100);
                        }
                    }
                },

                // Êñ∞Â¢ûÔºöÈÄöËøá‰∫ã‰ª∂IDÂà†Èô§‰∫ã‰ª∂
                async deleteEventById(eventId) {
                    try {
                        console.log('Deleting event by ID:', eventId);

                        await this.apiCall(`/events/${eventId}`, {
                            method: 'DELETE'
                        });

                        console.log('Event deleted successfully');

                        // Âà∑Êñ∞Êï∞ÊçÆÂíåÈáçÊñ∞Ê∏≤Êüì
                        await this.loadWeekSchedule();
                        const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                        if (gridContainer) {
                            gridContainer.innerHTML = this.renderFullWeekGrid();
                            setTimeout(() => {
                                this.initTimeSlotsDragAndDrop();
                                // Á°Æ‰øùÊ¥ªÂä®Ê±†Áä∂ÊÄÅÊ≠£Â∏∏
                                this.verifyActivityPoolState();
                            }, 100);
                        }

                    } catch (error) {
                        console.error('Âà†Èô§‰∫ã‰ª∂Â§±Ë¥•:', error);
                        alert('Âà†Èô§‰∫ã‰ª∂Â§±Ë¥•: ' + error.message);
                    }
                },

                // Êñ∞Â¢ûÔºöÈÄöËøáÊó•ÊúüÂíåÊó∂Èó¥ÊßΩÂà†Èô§‰∫ã‰ª∂
                async deleteEventByDateSlot(date, timeSlot) {
                    try {
                        console.log('Deleting event by date/slot:', { date, timeSlot });

                        const event = this.getScheduledEvent(date, timeSlot);
                        if (!event) {
                            console.log('No event found at specified slot');
                            return;
                        }

                        await this.deleteEventById(event.id);

                    } catch (error) {
                        console.error('ÊåâÊó•ÊúüÊó∂Èó¥ÊßΩÂà†Èô§‰∫ã‰ª∂Â§±Ë¥•:', error);
                        alert('Âà†Èô§‰∫ã‰ª∂Â§±Ë¥•: ' + error.message);
                    }
                },

                async handleDrop(activityId, date, timeSlot) {
                    try {
                        console.log('=== DROP HANDLER START ===');
                        console.log('Handling drop:', { activityId, date, timeSlot });
                        console.log('Type check:', typeof activityId, typeof date, typeof timeSlot);
                        
                        // È™åËØÅËæìÂÖ•ÂèÇÊï∞
                        if (!activityId || !date || !timeSlot) {
                            console.error('Invalid drop parameters:', { activityId, date, timeSlot });
                            alert('ÊãñÊãΩÂèÇÊï∞ÈîôËØØÔºåËØ∑ÈáçËØï');
                            return;
                        }
                        
                        // Ê£ÄÊü•ÊòØÂê¶Â∑≤Êúâ‰∫ã‰ª∂
                        const existing = this.getScheduledEvent(date, timeSlot);
                        console.log('Existing event check:', existing);
                        if (existing) {
                            alert('ËØ•Êó∂Èó¥ÊßΩÂ∑≤ÊúâÂÆâÊéíÔºåËØ∑ÈÄâÊã©ÂÖ∂‰ªñÊó∂Èó¥ÊàñÂÖàÂà†Èô§Áé∞ÊúâÂÆâÊéí');
                            return;
                        }
                        
                        // ÊâæÂà∞Ê¥ªÂä®‰ø°ÊÅØ
                        console.log('Searching for activity with ID:', activityId, 'in:', this.flatActivities.length, 'activities');
                        const activity = this.flatActivities.find(a => a.id == activityId);
                        console.log('Activity search result:', activity);
                        if (!activity) {
                            console.error('Activity not found:', activityId);
                            console.error('Available activities:', this.flatActivities.map(a => ({ id: a.id, name: a.name })));
                            alert('Êú™ÊâæÂà∞Ê¥ªÂä®‰ø°ÊÅØÔºåID: ' + activityId);
                            return;
                        }
                        
                        console.log('Found activity:', activity);
                        
                        // ÂàõÂª∫Êñ∞ÁöÑÊó•Á®ã‰∫ã‰ª∂
                        const eventData = {
                            activity_id: parseInt(activityId),
                            event_date: date,
                            time_slot: parseInt(timeSlot),
                            goal: '',
                            notes: '',
                            status: 'planned'
                        };
                        
                        console.log('Creating event:', eventData);
                        
                        const result = await this.apiCall('/events/', {
                            method: 'POST',
                            body: JSON.stringify(eventData)
                        });
                        
                        console.log('Event created:', result);
                        
                        // Âà∑Êñ∞Êï∞ÊçÆ
                        console.log('Reloading week schedule after successful drop...');
                        await this.loadWeekSchedule();
                        
                        // ÈáçÊñ∞Ê∏≤ÊüìÁΩëÊ†º
                        const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                        if (gridContainer) {
                            gridContainer.innerHTML = this.renderFullWeekGrid();
                            console.log('Week grid re-rendered after drop');

                            // Âè™ÈáçÊñ∞ÂàùÂßãÂåñÊó∂Èó¥ÊßΩÁöÑÊãñÊãΩÂäüËÉΩÔºå‰∏çÂΩ±ÂìçÊ¥ªÂä®Ê±†
                            setTimeout(() => {
                                this.initTimeSlotsDragAndDrop();
                                // Á°Æ‰øùÊ¥ªÂä®Ê±†Áä∂ÊÄÅÊ≠£Â∏∏
                                this.verifyActivityPoolState();
                            }, 100);
                        }
                        
                        // ÊãñÊãΩÊàêÂäüÔºå‰∏çËá™Âä®ÊâìÂºÄÁºñËæëÊ°Ü
                        // Áî®Êà∑ÂèØ‰ª•ÊâãÂä®ÁÇπÂáªÊó∂Èó¥ÊßΩ‰∏≠ÁöÑ‰∫ã‰ª∂Êù•ÁºñËæë
                        
                        console.log('=== DROP HANDLER SUCCESS ===');
                        
                    } catch (error) {
                        console.error('=== DROP HANDLER ERROR ===');
                        console.error('Â§ÑÁêÜÊãñÊãΩÂ§±Ë¥•:', error);
                        console.error('Error details:', {
                            name: error.name,
                            message: error.message,
                            stack: error.stack
                        });
                        alert('ÂàõÂª∫Êó•Á®ãÂ§±Ë¥•: ' + error.message);
                    }
                },
                
                // Ê±áÊÄªËßÜÂõæÊ∏≤Êüì
                renderActivityTree() {
                    if (!this.activities.length) return '<p class="text-muted">ÊöÇÊó†Ê¥ªÂä®</p>';
                    
                    const renderNode = (activity, level = 0) => {
                        let html = `
                            <div class="mb-2" style="margin-left: ${level * 20}px;">
                                <div class="d-flex justify-content-between align-items-center border-bottom pb-2">
                                    <div>
                                        <strong>${activity.name}</strong>
                                        ${activity.description ? `<br><small class="text-muted">${activity.description}</small>` : ''}
                                    </div>
                                    <div class="text-end">
                                        <button class="btn btn-outline-danger btn-sm" 
                                                onclick="deleteActivity(${activity.id})">
                                            Âà†Èô§
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        if (activity.children && activity.children.length > 0) {
                            activity.children.forEach(child => {
                                html += renderNode(child, level + 1);
                            });
                        }
                        
                        return html;
                    };
                    
                    return this.activities.map(activity => renderNode(activity)).join('');
                },
                
                // Â∏¶ÁªüËÆ°‰ø°ÊÅØÁöÑÊ±áÊÄªËßÜÂõæÊ∏≤Êüì
                renderActivityTreeWithStats() {
                    if (!this.activities.length) return '<p class="text-muted">ÊöÇÊó†Ê¥ªÂä®</p>';
                    
                    const renderNode = (activity, level = 0) => {
                        const stats = this.activityStats[activity.id] || {};
                        const totalEvents = stats.total_events || 0;
                        const completedEvents = stats.completed_events || 0;
                        const completionRate = stats.completion_rate || 0;
                        
                        let html = `
                            <div class="mb-3" style="margin-left: ${level * 20}px;">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">${activity.name}</h6>
                                                ${activity.description ? `<p class="text-muted small mb-2">${activity.description}</p>` : ''}
                                                
                                                <!-- ÁªüËÆ°‰ø°ÊÅØ -->
                                                <div class="row text-center mb-2">
                                                    <div class="col-4">
                                                        <small class="text-muted d-block">ÊÄªÂÆâÊéí</small>
                                                        <strong class="text-primary">${totalEvents}</strong>
                                                    </div>
                                                    <div class="col-4">
                                                        <small class="text-muted d-block">Â∑≤ÂÆåÊàê</small>
                                                        <strong class="text-success">${completedEvents}</strong>
                                                    </div>
                                                    <div class="col-4">
                                                        <small class="text-muted d-block">ÂÆåÊàêÁéá</small>
                                                        <strong class="text-warning">${Math.round(completionRate * 100)}%</strong>
                                                    </div>
                                                </div>
                                                
                                                <!-- Goal ÂàóË°® -->
                                                ${this.renderActivityGoals(stats)}
                                            </div>
                                            <div class="text-end">
                                                <button class="btn btn-outline-primary btn-sm me-2" 
                                                        onclick="window.laeAppInstance.editActivity(${activity.id})">
                                                    ÁºñËæë
                                                </button>
                                                <button class="btn btn-outline-danger btn-sm" 
                                                        onclick="deleteActivity(${activity.id})">
                                                    Âà†Èô§
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        if (activity.children && activity.children.length > 0) {
                            activity.children.forEach(child => {
                                html += renderNode(child, level + 1);
                            });
                        }
                        
                        return html;
                    };
                    
                    return this.activities.map(activity => renderNode(activity)).join('');
                },
                
                // Ê∏≤ÊüìÊ¥ªÂä®ÁöÑGoalÂàóË°®
                renderActivityGoals(stats) {
                    if (!stats.sub_activities || !stats.sub_activities.length) {
                        return '<small class="text-muted">ÊöÇÊó†ÁõÆÊ†áËÆ∞ÂΩï</small>';
                    }
                    
                    let html = '<div class="mt-2"><small class="text-muted d-block mb-1">ÊúÄËøëÁõÆÊ†á:</small>';
                    
                    // ÊòæÁ§∫ÊúÄËøëÁöÑÂá†‰∏™goals
                    let goalCount = 0;
                    for (const subActivity of stats.sub_activities) {
                        if (subActivity.goals && subActivity.goals.length > 0) {
                            for (const goal of subActivity.goals.slice(-3)) { // Âè™ÊòæÁ§∫ÊúÄËøë3‰∏™
                                if (goalCount >= 5) break; // ÊúÄÂ§öÊòæÁ§∫5‰∏™
                                
                                const statusColor = goal.status === 'completed' ? 'success' : 'secondary';
                                const statusIcon = goal.status === 'completed' ? '‚úì' : '‚óã';
                                
                                html += `
                                    <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                                        <small><span class="text-${statusColor}">${statusIcon}</span> ${goal.goal}</small>
                                        <small class="text-muted">${goal.date}</small>
                                    </div>
                                `;
                                goalCount++;
                            }
                        }
                        if (goalCount >= 5) break;
                    }
                    
                    html += '</div>';
                    return goalCount > 0 ? html : '<small class="text-muted">ÊöÇÊó†ÁõÆÊ†áËÆ∞ÂΩï</small>';
                },
                
                // ÂÆåÊï¥Âë®ËßÜÂõæÁΩëÊ†ºÊ∏≤ÊüìÔºàÂåÖÂê´Ê†áÈ¢òË°åÂíåÊâÄÊúâÊó∂Èó¥ÊßΩÔºâ
                renderFullWeekGrid() {
                    if (!this.timeSlots.length || !this.weekDates.length) {
                        return '<p class="text-muted">Âä†ËΩΩ‰∏≠...</p>';
                    }
                    
                    let html = '';
                    
                    console.log('Rendering full week grid:', {
                        timeSlots: this.timeSlots.length,
                        weekDates: this.weekDates.length,
                        totalElements: (this.timeSlots.length + 1) * 8 // (5+1)Ë°å √ó 8Âàó
                    });
                    
                    // 1. ÁîüÊàêÊ†áÈ¢òË°åÔºà8‰∏™ÂÖÉÁ¥†Ôºö1‰∏™"Êó∂Èó¥"Ê†áÈ¢ò + 7‰∏™Êó•ÊúüÊ†áÈ¢òÔºâ
                    html += '<div class="week-header">Êó∂Èó¥</div>';
                    for (const day of this.weekDates) {
                        const date = new Date(day);
                        const weekday = ['Âë®‰∏Ä', 'Âë®‰∫å', 'Âë®‰∏â', 'Âë®Âõõ', 'Âë®‰∫î', 'Âë®ÂÖ≠', 'Âë®Êó•'][date.getDay() === 0 ? 6 : date.getDay() - 1];
                        const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
                        html += `
                            <div class="week-header">
                                <div>${weekday}</div>
                                <div>${dateStr}</div>
                            </div>
                        `;
                    }
                    
                    // 2. ‰∏∫ÊØè‰∏™Êó∂Èó¥ÊÆµÁîüÊàê‰∏ÄË°åÔºà8‰∏™ÂÖÉÁ¥†Ôºö1‰∏™Êó∂Èó¥Ê†áÁ≠æ + 7‰∏™Êó∂Èó¥ÊßΩÔºâ
                    for (const slot of this.timeSlots) {
                        // Êó∂Èó¥Ê†áÁ≠æÔºàÁ¨¨‰∏ÄÂàóÔºâ
                        html += `<div class="time-label">${slot.name}</div>`;
                        
                        // ËØ•Êó∂Èó¥ÊÆµÁöÑ7‰∏™Êó∂Èó¥ÊßΩÔºàÂë®‰∏ÄÂà∞Âë®Êó•Ôºâ
                        for (const day of this.weekDates) {
                            const event = this.getScheduledEvent(day, slot.value);
                            const occupiedClass = event ? 'occupied' : '';
                            
                            html += `
                                <div class="time-slot p-2 ${occupiedClass}" 
                                     data-date="${day}" 
                                     data-time-slot="${slot.value}"
                                     onclick="window.laeAppInstance.editScheduledEvent('${day}', ${slot.value})">
                            `;
                            
                            if (event) {
                                html += `
                                    <div class="scheduled-event activity-card"
                                         data-activity-id="${event.activity_id}"
                                         data-event-id="${event.id}">
                                        <div class="fw-bold mb-1" style="font-size: 0.85rem; line-height: 1.2;">${event.activity_name || ''}</div>
                                        ${event.goal ? `<div class="mb-1" style="font-size: 0.75rem; color: #666; line-height: 1.3;">${event.goal}</div>` : ''}
                                        ${event.notes ? `<div style="font-size: 0.7rem; color: #888; line-height: 1.2;">Â§áÊ≥®: ${event.notes}</div>` : ''}
                                    </div>
                                `;
                            }
                            
                            html += '</div>';
                        }
                    }
                    
                    console.log('Generated full grid HTML, total elements:', (html.match(/<div/g) || []).length);
                    return html;
                },
                
                // Ê∏≤ÊüìÊ¥ªÂä®Ê±†
                renderActivityPool() {
                    if (!this.flatActivities.length) {
                        return '<p class="text-muted">ÊöÇÊó†Ê¥ªÂä®</p>';
                    }

                    return this.flatActivities.map(activity => `
                        <div class="activity-card card mb-2" data-activity-id="${activity.id}">
                            <div class="card-body py-2 px-3">
                                <div class="fw-bold" style="font-size: 0.875rem;">${activity.name}</div>
                                <small class="text-muted">${activity.description || ''}</small>
                            </div>
                        </div>
                    `).join('');
                },

                // ‰øùÁïôÂéüÂáΩÊï∞‰ª•Â§áÁî®
                renderWeekGrid() {
                    return this.renderFullWeekGrid();
                },
                
                // Êñ∞Â¢ûÔºöÂà∑Êñ∞Ê¥ªÂä®Ê±†ÊñπÊ≥ï
                refreshActivityPool() {
                    console.log('Refreshing activity pool...');
                    const activityPool = document.getElementById('activity-pool');
                    if (!activityPool) {
                        console.error('Activity pool not found');
                        return;
                    }

                    // ÈîÄÊØÅÁé∞ÊúâÁöÑ Sortable ÂÆû‰æã
                    if (activityPool.sortableInstance) {
                        activityPool.sortableInstance.destroy();
                        activityPool.sortableInstance = null;
                    }
                    activityPool.classList.remove('sortable-initialized');

                    // Ëß¶ÂèëAlpine.jsÈáçÊñ∞Ê∏≤ÊüìÊ¥ªÂä®Ê±†Ôºàx-html‰ºöËá™Âä®ÈáçÊñ∞Ê∏≤ÊüìÔºâ
                    console.log('Triggering Alpine.js re-render for activity pool');

                    // Á≠âÂæÖAlpine.jsÈáçÊñ∞Ê∏≤ÊüìÂÆåÊàêÔºåÁÑ∂ÂêéÈáçÊñ∞ÂàùÂßãÂåñÊãñÊãΩÂäüËÉΩ
                    this.$nextTick(() => {
                        console.log('Activity pool re-rendered, re-initializing drag and drop');
                        this.initActivityPoolDragAndDrop();
                    });
                },

                // Êñ∞Â¢ûÔºöÈ™åËØÅÊãñÊãΩÁõÆÊ†áÊúâÊïàÊÄß
                validateDropTarget(targetElement, targetRect) {
                    // Ê£ÄÊü•Âü∫Êú¨ÊúâÊïàÊÄß
                    if (!targetElement || !targetElement.classList.contains('time-slot')) {
                        return false;
                    }

                    // Ê£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶ÂèØËßÅÂíåÊúâËæπÁïå
                    if (targetRect.width === 0 || targetRect.height === 0) {
                        console.warn('ÁõÆÊ†áÂÖÉÁ¥†ËæπÁïå‰∏∫0');
                        return false;
                    }

                    // Ê£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶Âú®ËßÜÂè£ÂÜÖ
                    if (targetRect.left === 0 && targetRect.top === 0 &&
                        targetRect.right === 0 && targetRect.bottom === 0) {
                        console.warn('ÁõÆÊ†áÂÖÉÁ¥†‰ΩçÁΩÆÂÖ®‰∏∫0');
                        return false;
                    }

                    // Ê£ÄÊü•CSSÊòæÁ§∫Áä∂ÊÄÅ
                    const computedStyle = window.getComputedStyle(targetElement);
                    if (computedStyle.display === 'none' || computedStyle.visibility === 'hidden') {
                        console.warn('ÁõÆÊ†áÂÖÉÁ¥†Ë¢´ÈöêËóè');
                        return false;
                    }

                    return true;
                },

                // Êñ∞Â¢ûÔºöÊ†πÊçÆÈº†Ê†á‰ΩçÁΩÆÊâæÂà∞ÊúÄËøëÁöÑÊúâÊïàÊó∂Èó¥ÊßΩ
                findNearestValidTimeSlot(mouseEvent) {
                    if (!mouseEvent) {
                        console.warn('Ê≤°ÊúâÈº†Ê†á‰∫ã‰ª∂‰ø°ÊÅØ');
                        return null;
                    }

                    const mouseX = mouseEvent.clientX || mouseEvent.pageX;
                    const mouseY = mouseEvent.clientY || mouseEvent.pageY;

                    console.log('Èº†Ê†á‰ΩçÁΩÆ:', { x: mouseX, y: mouseY });

                    // Ëé∑ÂèñÊâÄÊúâÊúâÊïàÁöÑÊó∂Èó¥ÊßΩ
                    const timeSlots = Array.from(document.querySelectorAll('.time-slot')).filter(slot => {
                        const rect = slot.getBoundingClientRect();
                        return this.validateDropTarget(slot, rect);
                    });

                    console.log('ÊâæÂà∞ÊúâÊïàÊó∂Èó¥ÊßΩÊï∞Èáè:', timeSlots.length);

                    if (timeSlots.length === 0) {
                        return null;
                    }

                    // ÊâæÂà∞Ë∑ùÁ¶ªÈº†Ê†áÊúÄËøëÁöÑÊó∂Èó¥ÊßΩ
                    let nearestSlot = null;
                    let minDistance = Infinity;

                    timeSlots.forEach(slot => {
                        const rect = slot.getBoundingClientRect();
                        const centerX = rect.left + rect.width / 2;
                        const centerY = rect.top + rect.height / 2;

                        const distance = Math.sqrt(
                            Math.pow(mouseX - centerX, 2) + Math.pow(mouseY - centerY, 2)
                        );

                        if (distance < minDistance) {
                            minDistance = distance;
                            nearestSlot = slot;
                        }
                    });

                    console.log('ÊúÄËøëÊó∂Èó¥ÊßΩË∑ùÁ¶ª:', minDistance);
                    return nearestSlot;
                },

                // Êñ∞Â¢ûÔºöÈ™åËØÅÊ¥ªÂä®Ê±†Áä∂ÊÄÅ
                verifyActivityPoolState() {
                    console.log('Verifying activity pool state...');
                    const activityPool = document.getElementById('activity-pool');
                    if (!activityPool) {
                        console.error('Activity pool not found during verification');
                        return;
                    }

                    const currentCards = activityPool.querySelectorAll('.activity-card');
                    const expectedCount = this.flatActivities.length;

                    console.log('Activity pool verification:', {
                        currentCards: currentCards.length,
                        expectedCount: expectedCount,
                        isInitialized: activityPool.classList.contains('sortable-initialized')
                    });

                    // Â¶ÇÊûúÂç°ÁâáÊï∞Èáè‰∏çÂåπÈÖçÊàñËÄÖÊ≤°ÊúâÂàùÂßãÂåñÔºåÂà∑Êñ∞Ê¥ªÂä®Ê±†
                    if (currentCards.length !== expectedCount || !activityPool.classList.contains('sortable-initialized')) {
                        console.warn('Activity pool state incorrect, refreshing...');
                        this.refreshActivityPool();
                    } else {
                        console.log('Activity pool state verified - all good');
                    }
                },

                // Êñ∞Â¢ûÔºö‰ªÖÂàùÂßãÂåñÊ¥ªÂä®Ê±†ÁöÑÊãñÊãΩÂäüËÉΩ
                initActivityPoolDragAndDrop() {
                    console.log('Initializing activity pool drag and drop...');
                    const activityPool = document.getElementById('activity-pool');
                    if (!activityPool || activityPool.classList.contains('sortable-initialized')) {
                        console.log('Activity pool already initialized or not found');
                        return;
                    }

                    const self = this;

                    activityPool.sortableInstance = Sortable.create(activityPool, {
                        group: {
                            name: 'activities',
                            pull: 'clone', // Á°Æ‰øùÊòØÂÖãÈöÜÊ®°Âºè
                            put: function(to, from) {
                                // Âè™ÂÖÅËÆ∏‰ªétime-slotÊãñÊãΩÂõûÊ¥ªÂä®Ê±†ÔºàÂà†Èô§ÂäüËÉΩÔºâ
                                return from.classList && from.classList.contains('time-slot');
                            }
                        },
                        sort: false, // Ê¥ªÂä®Ê±†ÂÜÖ‰∏çÂÖÅËÆ∏ÊéíÂ∫è
                        animation: 200,
                        ghostClass: 'sortable-ghost',
                        chosenClass: 'sortable-chosen',
                        dragClass: 'sortable-drag',
                        // ÂÖ≥ÈîÆÔºöÁ°Æ‰øùÂÖãÈöÜË°å‰∏∫Ê≠£Á°Æ
                        onClone: function(evt) {
                            console.log('Activity cloned from pool:', evt.clone);
                            const originalId = evt.item.getAttribute('data-activity-id');
                            if (originalId) {
                                evt.clone.setAttribute('data-activity-id', originalId);
                            }
                        },
                        // ‰ªéÊ¥ªÂä®Ê±†ÂºÄÂßãÊãñÊãΩÊó∂
                        onStart: function(evt) {
                            console.log('Drag started from activity pool:', evt.item.getAttribute('data-activity-id'));
                            evt.item.classList.add('dragging-from-pool');
                        },
                        // ÊãñÊãΩÁªìÊùüÊó∂ÁöÑÊ∏ÖÁêÜÂíåÊÅ¢Â§ç
                        onEnd: function(evt) {
                            console.log('Drag ended from activity pool');

                            // Ê∏ÖÁêÜÊ†áËÆ∞
                            if (evt.item) {
                                evt.item.classList.remove('dragging-from-pool');
                            }

                            // Ê£ÄÊü•Ê¥ªÂä®Ê±†Áä∂ÊÄÅ
                            const currentCards = activityPool.querySelectorAll('.activity-card');
                            console.log('Activity pool cards after drag:', currentCards.length, 'Expected:', self.flatActivities.length);

                            // Â¶ÇÊûúÂç°ÁâáÊï∞Èáè‰∏çÂåπÈÖçÔºåÂº∫Âà∂Âà∑Êñ∞
                            if (currentCards.length !== self.flatActivities.length) {
                                console.warn('Activity pool cards count mismatch, forcing refresh');
                                setTimeout(() => {
                                    self.refreshActivityPool();
                                }, 100);
                            }
                        },
                        // Â§ÑÁêÜÂà†Èô§Êìç‰ΩúÔºà‰ªéÊó∂Èó¥ÊßΩÊãñÂõûÊ¥ªÂä®Ê±†Ôºâ
                        onAdd: function(evt) {
                            console.log('Item dropped back to activity pool - deleting event');
                            evt.item.remove();
                            // Âà†Èô§Êìç‰ΩúÁî±Êó∂Èó¥ÊßΩÁöÑ onRemove Â§ÑÁêÜ
                        }
                    });

                    activityPool.classList.add('sortable-initialized');
                    console.log('Activity pool sortable initialized successfully');
                },

                // Â∑•ÂÖ∑ÊñπÊ≥ï
                getCurrentDateString() {
                    return this.currentDate.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        weekday: 'long'
                    });
                },
                
                getWeekTitle() {
                    if (this.weekDates.length === 0) return '';
                    const start = new Date(this.weekDates[0]);
                    const end = new Date(this.weekDates[6]);
                    return `${start.getMonth() + 1}Êúà${start.getDate()}Êó• - ${end.getMonth() + 1}Êúà${end.getDate()}Êó•`;
                },
                
                getMonthTitle() {
                    return `${this.currentYear}Âπ¥${this.currentMonth}Êúà`;
                },
                
                // ÊúàËßÜÂõæÁõ∏ÂÖ≥ÊñπÊ≥ï
                previousMonth() {
                    this.currentMonth--;
                    if (this.currentMonth < 1) {
                        this.currentMonth = 12;
                        this.currentYear--;
                    }
                    this.loadMonthSchedule();
                },
                
                nextMonth() {
                    this.currentMonth++;
                    if (this.currentMonth > 12) {
                        this.currentMonth = 1;
                        this.currentYear++;
                    }
                    this.loadMonthSchedule();
                },
                
                async loadMonthSchedule() {
                    try {
                        console.log(`Loading month schedule for ${this.currentYear}-${this.currentMonth}`);
                        
                        // Ê∏≤ÊüìÊúàÂéÜÔºàÁé∞Âú®Áõ¥Êé•Âú®renderMonthCalendar‰∏≠Âä†ËΩΩÊï∞ÊçÆÔºâ
                        await this.renderMonthCalendar();
                        
                        console.log('Month schedule loaded and rendered');
                    } catch (error) {
                        console.error('Âä†ËΩΩÊúàÊó•Á®ãÂ§±Ë¥•:', error);
                        const monthCalendarContainer = document.getElementById('month-calendar');
                        if (monthCalendarContainer) {
                            monthCalendarContainer.innerHTML = '<p class="text-danger">Âä†ËΩΩÊúàËßÜÂõæÂ§±Ë¥•</p>';
                        }
                    }
                },
                
                // Ê±áÊÄªËßÜÂõæÁõ∏ÂÖ≥ÊñπÊ≥ï
                async initSummaryData() {
                    console.log('Initializing summary data...');
                    await this.generateAvailableMonths();
                    await this.loadSummaryStatistics();
                    await this.loadActivityStatistics();
                },
                
                generateAvailableMonths() {
                    // ÁîüÊàêÂèØÈÄâÊã©ÁöÑÊúà‰ªΩÂàóË°®ÔºàÁÆÄÂåñÁâàÊú¨ÔºåÂü∫‰∫éÂΩìÂâçÊó•ÊúüÔºâ
                    const now = new Date();
                    const months = [];
                    
                    // Ê∑ªÂä†ÂΩìÂâçÊúàÂíåÂâçÈù¢Âá†‰∏™Êúà
                    for (let i = 2; i >= 0; i--) {
                        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                        months.push({
                            value: `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`,
                            label: `${date.getFullYear()}Âπ¥${date.getMonth() + 1}Êúà`
                        });
                    }
                    
                    this.availableMonths = months;
                    console.log('Available months:', this.availableMonths);
                },
                
                async loadSummaryStatistics() {
                    try {
                        console.log('Loading summary statistics for month:', this.summaryMonth);
                        let endpoint = '/statistics/summary';
                        
                        // Â¶ÇÊûúÈÄâÊã©‰∫ÜÁâπÂÆöÊúà‰ªΩÔºåÊ∑ªÂä†Êü•ËØ¢ÂèÇÊï∞ÔºàÂÅáËÆæÂêéÁ´ØÊîØÊåÅÔºâ
                        if (this.summaryMonth) {
                            endpoint += `?month=${this.summaryMonth}`;
                        }
                        
                        this.summaryStats = await this.apiCall(endpoint);
                        console.log('Summary statistics loaded:', this.summaryStats);
                    } catch (error) {
                        console.error('Failed to load summary statistics:', error);
                        this.summaryStats = {
                            total_activities: 0,
                            total_events: 0,
                            completed_events: 0,
                            completion_rate: 0
                        };
                    }
                },
                
                async loadActivityStatistics() {
                    try {
                        console.log('Loading activity statistics...');
                        this.activityStats = {};
                        
                        // ‰∏∫ÊØè‰∏™Ê¥ªÂä®Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆ
                        for (const activity of this.flatActivities) {
                            const stats = await this.apiCall(`/statistics/activities/${activity.id}/statistics`);
                            this.activityStats[activity.id] = stats;
                            console.log(`Stats for ${activity.name}:`, stats);
                        }
                    } catch (error) {
                        console.error('Failed to load activity statistics:', error);
                        this.activityStats = {};
                    }
                },
                
                formatWeekday(dateString) {
                    const date = new Date(dateString);
                    return ['Âë®‰∏Ä', 'Âë®‰∫å', 'Âë®‰∏â', 'Âë®Âõõ', 'Âë®‰∫î', 'Âë®ÂÖ≠', 'Âë®Êó•'][date.getDay() === 0 ? 6 : date.getDay() - 1];
                },
                
                formatDate(dateString) {
                    const date = new Date(dateString);
                    return `${date.getMonth() + 1}/${date.getDate()}`;
                },
                
                // ÊúàÂéÜÊ∏≤ÊüìÔºàÁÆÄÂåñÁâàÊú¨ÔºåÊòæÁ§∫‰∫ã‰ª∂Êï∞ÈáèÔºâ
                async renderMonthCalendar() {
                    try {
                        // ÈáçÊñ∞Âä†ËΩΩÊúàÊï∞ÊçÆ‰ª•Ëé∑ÂèñÂÆåÊï¥ÁöÑÂ§©Êï∞‰ø°ÊÅØ
                        const data = await this.apiCall(`/calendar/month/${this.currentYear}/${this.currentMonth}`);
                        
                        if (!data.days || data.days.length === 0) {
                            const monthCalendarContainer = document.getElementById('month-calendar');
                            if (monthCalendarContainer) {
                                monthCalendarContainer.innerHTML = '<p class="text-muted">Êó†Ê≥ïÂä†ËΩΩÊúàËßÜÂõæÊï∞ÊçÆ</p>';
                            }
                            return;
                        }
                        
                        const firstDay = new Date(this.currentYear, this.currentMonth - 1, 1);
                        const lastDay = new Date(this.currentYear, this.currentMonth, 0);
                        
                        // ËÆ°ÁÆóÊúàÂéÜÂ∫îËØ•‰ªéÂì™‰∏ÄÂ§©ÂºÄÂßãÔºàÂë®‰∏ÄÔºâ
                        const startDate = new Date(firstDay);
                        const dayOfWeek = firstDay.getDay() === 0 ? 7 : firstDay.getDay();
                        startDate.setDate(firstDay.getDate() - dayOfWeek + 1);
                        
                        // ËÆ°ÁÆóÊúàÂéÜÂ∫îËØ•Âà∞Âì™‰∏ÄÂ§©ÁªìÊùüÔºàÁ°Æ‰øùÂÆåÊï¥ÁöÑÂë®Ôºâ
                        const endDate = new Date(lastDay);
                        const endDayOfWeek = lastDay.getDay() === 0 ? 7 : lastDay.getDay();
                        endDate.setDate(lastDay.getDate() + (7 - endDayOfWeek));
                        
                        // ÂàõÂª∫Êó•ÊúüÂà∞‰∫ã‰ª∂Êï∞ÈáèÁöÑÊò†Â∞Ñ
                        const dayEventsMap = {};
                        data.days.forEach(day => {
                            dayEventsMap[day.date] = {
                                event_count: day.event_count,
                                is_today: day.is_today
                            };
                        });
                        
                        let html = '';
                        let currentDate = new Date(startDate);
                        
                        // ÊåâÂë®Ê∏≤Êüì
                        while (currentDate <= endDate) {
                            html += '<div class="row mb-1">';
                            
                            // ‰∏ÄÂë®7Â§©
                            for (let i = 0; i < 7; i++) {
                                const dateStr = currentDate.toISOString().split('T')[0];
                                const dayData = dayEventsMap[dateStr] || { event_count: 0, is_today: false };
                                const isCurrentMonth = currentDate.getMonth() === this.currentMonth - 1;
                                
                                let cellClass = 'col border p-2';
                                if (!isCurrentMonth) {
                                    cellClass += ' text-muted bg-light';
                                }
                                if (dayData.is_today) {
                                    cellClass += ' bg-warning bg-opacity-25 fw-bold';
                                }
                                
                                html += `<div class="${cellClass}" style="min-height: 100px;">`;
                                html += `<div class="fw-bold">${currentDate.getDate()}</div>`;
                                
                                // ÊòæÁ§∫‰∫ã‰ª∂Êï∞Èáè
                                if (dayData.event_count > 0) {
                                    html += `
                                        <div class="mt-2">
                                            <span class="badge bg-primary">${dayData.event_count} ‰∏™Êó•Á®ã</span>
                                        </div>
                                    `;
                                }
                                
                                html += '</div>';
                                
                                // ÁßªÂä®Âà∞‰∏ã‰∏ÄÂ§©
                                currentDate.setDate(currentDate.getDate() + 1);
                            }
                            
                            html += '</div>';
                        }
                        
                        // Êõ¥Êñ∞DOM
                        const monthCalendarContainer = document.getElementById('month-calendar');
                        if (monthCalendarContainer) {
                            monthCalendarContainer.innerHTML = html;
                        }
                    } catch (error) {
                        console.error('Ê∏≤ÊüìÊúàÂéÜÂ§±Ë¥•:', error);
                        const monthCalendarContainer = document.getElementById('month-calendar');
                        if (monthCalendarContainer) {
                            monthCalendarContainer.innerHTML = '<p class="text-danger">Âä†ËΩΩÊúàËßÜÂõæÂ§±Ë¥•</p>';
                        }
                    }
                },
                
                // Ëé∑ÂèñÊó∂Èó¥ÊßΩÂêçÁß∞ÁöÑËæÖÂä©ÊñπÊ≥ï
                getTimeSlotName(timeSlotValue) {
                    const slot = this.timeSlots.find(s => s.value === timeSlotValue);
                    return slot ? slot.name.replace('Á¨¨1Êó∂ÊÆµ', '1').replace('Á¨¨2Êó∂ÊÆµ', '2').replace('Êó∂ÊÆµ', '') : `Êó∂ÊÆµ${timeSlotValue}`;
                }
            }
        }

        // ÂÖ®Â±ÄËæÖÂä©ÂáΩÊï∞
        async function deleteActivity(activityId) {
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Ê¥ªÂä®ÂêóÔºüËøôÂ∞ÜÂà†Èô§ÊâÄÊúâÁõ∏ÂÖ≥ÁöÑÊó•Á®ãÂÆâÊéí„ÄÇ')) {
                try {
                    await fetch(`/api/activities/${activityId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    // Âà∑Êñ∞È°µÈù¢
                    location.reload();
                } catch (error) {
                    console.error('Âà†Èô§Ê¥ªÂä®Â§±Ë¥•:', error);
                    alert('Âà†Èô§Â§±Ë¥•');
                }
            }
        }
    </script>
</body>
</html>