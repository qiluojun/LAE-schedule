<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAE - ä¸ªäººæ—¥ç¨‹ä¸ä¸»æ”¯çº¿ç®¡ç†ç³»ç»Ÿ v16 Summary Stats</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.0/dist/cdn.min.js"></script>
    <!-- SortableJS -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <style>
        .time-slot {
            min-height: 120px;
            border: 2px solid #dee2e6;
            border-radius: 0.375rem;
            background-color: #f8f9fa;
            transition: background-color 0.2s, transform 0.1s, border-color 0.2s;
            padding: 8px;
            position: relative;
        }
        .time-slot:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }
        .time-slot.occupied {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        .activity-card {
            cursor: grab;
            transition: transform 0.2s;
        }
        .activity-card:hover {
            transform: translateY(-2px);
        }
        .activity-card:active {
            cursor: grabbing;
        }
        .sortable-chosen {
            opacity: 0.8;
            transform: rotate(3deg);
        }
        .sortable-drag {
            opacity: 0.8;
            transform: rotate(5deg);
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }
        .sortable-ghost {
            opacity: 0.4;
            background: #e3f2fd;
            border: 2px dashed #2196f3;
        }
        .time-slot.sortable-over {
            background-color: #e8f5e8;
            border-color: #4caf50;
            border-width: 3px;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        .scheduled-event {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin: 0.25rem 0;
            cursor: pointer;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .scheduled-event:hover {
            background-color: #fff2a8;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .activity-pool {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 1rem;
            background-color: #f8f9fa;
        }
        .week-grid {
            display: grid;
            grid-template-columns: auto repeat(7, 1fr);
            gap: 8px;
            background-color: transparent;
            border-radius: 0.5rem;
            padding: 12px;
            border: 2px solid #dee2e6;
        }
        .week-header {
            background-color: #6c757d;
            color: white;
            text-align: center;
            padding: 0.5rem;
            font-weight: bold;
            border-radius: 0.375rem;
            border: 2px solid #6c757d;
        }
        .time-label {
            background-color: #495057;
            color: white;
            text-align: center;
            padding: 1rem 0.5rem;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 120px;
            border-radius: 0.375rem;
            border: 2px solid #495057;
        }
    </style>
</head>
<body>
    <div x-data="laeApp()" class="container-fluid">
        <!-- å¯¼èˆªæ  -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-3">
            <div class="container-fluid">
                <span class="navbar-brand">LAE - æ—¥ç¨‹ç®¡ç†ç³»ç»Ÿ</span>
                
                <!-- è§†å›¾åˆ‡æ¢æŒ‰é’® -->
                <div class="navbar-nav me-auto">
                    <button 
                        class="nav-link btn btn-link"
                        :class="{ 'active text-warning': currentView === 'summary' }"
                        @click="switchView('summary')"
                    >
                        æ±‡æ€»è§†å›¾
                    </button>
                    <button 
                        class="nav-link btn btn-link"
                        :class="{ 'active text-warning': currentView === 'week' }"
                        @click="switchView('week')"
                    >
                        å‘¨è§†å›¾
                    </button>
                    <button 
                        class="nav-link btn btn-link"
                        :class="{ 'active text-warning': currentView === 'month' }"
                        @click="switchView('month')"
                    >
                        æœˆè§†å›¾
                    </button>
                </div>
                
                <!-- å½“å‰æ—¥æœŸæ˜¾ç¤º -->
                <div class="navbar-text text-light">
                    <span x-text="getCurrentDateString()"></span>
                </div>
            </div>
        </nav>

        <!-- æ±‡æ€»è§†å›¾ -->
        <div x-show="currentView === 'summary'" class="row">
            <!-- ç»Ÿè®¡ä»ªè¡¨æ¿ -->
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">æ•°æ®ç»Ÿè®¡</h5>
                        <div class="d-flex align-items-center">
                            <select class="form-select form-select-sm me-2" x-model="summaryMonth" @change="loadSummaryStatistics()">
                                <option value="">å…¨éƒ¨æ—¶é—´</option>
                                <template x-for="month in availableMonths" :key="month.value">
                                    <option :value="month.value" x-text="month.label"></option>
                                </template>
                            </select>
                            <button class="btn btn-outline-primary btn-sm" @click="loadSummaryStatistics()">
                                ğŸ“Š åˆ·æ–°ç»Ÿè®¡
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row" x-show="summaryStats">
                            <div class="col-md-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <h4 x-text="summaryStats?.total_events || 0"></h4>
                                        <p class="mb-0">æ€»å®‰æ’æ¬¡æ•°</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h4 x-text="summaryStats?.completed_events || 0"></h4>
                                        <p class="mb-0">å·²å®Œæˆæ¬¡æ•°</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning text-white">
                                    <div class="card-body text-center">
                                        <h4 x-text="Math.round((summaryStats?.completion_rate || 0) * 100) + '%'"></h4>
                                        <p class="mb-0">å®Œæˆç‡</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h4 x-text="summaryStats?.total_activities || 0"></h4>
                                        <p class="mb-0">æ´»åŠ¨æ€»æ•°</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ´»åŠ¨ç®¡ç† -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">æ´»åŠ¨ç®¡ç†</h5>
                        <button class="btn btn-primary btn-sm" @click="showNewActivityModal = true">
                            + æ–°å»ºæ´»åŠ¨
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="activity-tree" class="mt-3">
                            <!-- æ´»åŠ¨æ ‘å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
                            <div x-html="renderActivityTreeWithStats()"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å‘¨è§†å›¾ -->
        <div x-show="currentView === 'week'" class="row">
            <!-- æ´»åŠ¨æ±  -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">æ´»åŠ¨å¡ç‰‡æ± </h6>
                    </div>
                    <div class="card-body">
                        <div class="activity-pool" id="activity-pool" x-html="renderActivityPool()">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å‘¨æ—¥ç¨‹ç½‘æ ¼ -->
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <button class="btn btn-outline-primary btn-sm" @click="previousWeek()">
                                â€¹ ä¸Šä¸€å‘¨
                            </button>
                            <span class="mx-3 fw-bold" x-text="getWeekTitle()"></span>
                            <button class="btn btn-outline-primary btn-sm" @click="nextWeek()">
                                ä¸‹ä¸€å‘¨ â€º
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="week-grid" id="week-grid" x-html="renderFullWeekGrid()">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æœˆè§†å›¾ -->
        <div x-show="currentView === 'month'">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <button class="btn btn-outline-primary btn-sm" @click="previousMonth()">
                            â€¹ ä¸Šä¸ªæœˆ
                        </button>
                        <span class="mx-3 fw-bold" x-text="getMonthTitle()"></span>
                        <button class="btn btn-outline-primary btn-sm" @click="nextMonth()">
                            ä¸‹ä¸ªæœˆ â€º
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row text-center fw-bold mb-2">
                        <div class="col">å‘¨ä¸€</div>
                        <div class="col">å‘¨äºŒ</div>
                        <div class="col">å‘¨ä¸‰</div>
                        <div class="col">å‘¨å››</div>
                        <div class="col">å‘¨äº”</div>
                        <div class="col">å‘¨å…­</div>
                        <div class="col">å‘¨æ—¥</div>
                    </div>
                    <div id="month-calendar">
                        <!-- æœˆå†å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- æ–°å»ºæ´»åŠ¨æ¨¡æ€æ¡† -->
        <div x-show="showNewActivityModal" class="modal" :class="{ 'd-block': showNewActivityModal }" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">æ–°å»ºæ´»åŠ¨</h5>
                        <button type="button" class="btn-close" @click="showNewActivityModal = false"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="createActivity()">
                            <div class="mb-3">
                                <label class="form-label">æ´»åŠ¨åç§°</label>
                                <input type="text" class="form-control" x-model="newActivity.name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">çˆ¶æ´»åŠ¨</label>
                                <select class="form-control" x-model="newActivity.parent_id">
                                    <option value="">æ— ï¼ˆé¡¶çº§æ´»åŠ¨ï¼‰</option>
                                    <template x-for="activity in flatActivities" :key="activity.id">
                                        <option :value="activity.id" x-text="activity.name"></option>
                                    </template>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">æè¿°</label>
                                <textarea class="form-control" rows="3" x-model="newActivity.description"></textarea>
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-secondary me-2" @click="showNewActivityModal = false">å–æ¶ˆ</button>
                                <button type="submit" class="btn btn-primary">åˆ›å»º</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¼–è¾‘æ´»åŠ¨æ¨¡æ€æ¡† -->
        <div x-show="showEditActivityModal" class="modal" :class="{ 'd-block': showEditActivityModal }" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ç¼–è¾‘æ´»åŠ¨</h5>
                        <button type="button" class="btn-close" @click="showEditActivityModal = false"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="updateActivity()">
                            <div class="mb-3">
                                <label class="form-label">æ´»åŠ¨åç§°</label>
                                <input type="text" class="form-control" x-model="editingActivity.name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">æè¿°</label>
                                <textarea class="form-control" rows="3" x-model="editingActivity.description"></textarea>
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-secondary me-2" @click="showEditActivityModal = false">å–æ¶ˆ</button>
                                <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¼–è¾‘æ—¥ç¨‹æ¨¡æ€æ¡† - åªåœ¨å‘¨è§†å›¾ä¸­æ˜¾ç¤º -->
        <div x-show="showEditEventModal && currentView === 'week'" class="modal" :class="{ 'd-block': showEditEventModal && currentView === 'week' }" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ç¼–è¾‘æ—¥ç¨‹</h5>
                        <button type="button" class="btn-close" @click="forceCloseModal()"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="saveScheduledEvent()">
                            <div class="mb-3">
                                <label class="form-label">æ—¥æœŸæ—¶é—´</label>
                                <div class="row">
                                    <div class="col-8">
                                        <input type="date" class="form-control" x-model="editingEvent.event_date" required readonly>
                                    </div>
                                    <div class="col-4">
                                        <select class="form-control" x-model="editingEvent.time_slot" required>
                                            <template x-for="slot in timeSlots" :key="slot.value">
                                                <option :value="slot.value" x-text="slot.name"></option>
                                            </template>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3" x-show="editingEvent.activity_name">
                                <label class="form-label">æ´»åŠ¨</label>
                                <input type="text" class="form-control" :value="editingEvent.activity_name" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ç›®æ ‡</label>
                                <input type="text" class="form-control" x-model="editingEvent.goal" placeholder="æœ¬æ¬¡è¦è¾¾æˆçš„å…·ä½“ç›®æ ‡">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">å¤‡æ³¨</label>
                                <textarea class="form-control" rows="3" x-model="editingEvent.notes" placeholder="é¢å¤–å¤‡æ³¨ä¿¡æ¯"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">çŠ¶æ€</label>
                                <select class="form-control" x-model="editingEvent.status">
                                    <option value="planned">è®¡åˆ’ä¸­</option>
                                    <option value="completed">å·²å®Œæˆ</option>
                                </select>
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-danger me-2" @click="deleteScheduledEvent()" x-show="editingEvent.id">åˆ é™¤</button>
                                <button type="button" class="btn btn-secondary me-2" @click="forceCloseModal()">å–æ¶ˆ</button>
                                <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç›´æ¥åµŒå…¥JavaScriptä»£ç ä»¥é¿å…è·¯å¾„é—®é¢˜
        function laeApp() {
            return {
                // å½“å‰è§†å›¾çŠ¶æ€
                currentView: 'week',
                
                // æ—¥æœŸçŠ¶æ€
                currentDate: new Date(),
                currentWeekStart: null,
                currentMonth: new Date().getMonth() + 1,
                currentYear: new Date().getFullYear(),
                
                // æ•°æ®çŠ¶æ€
                activities: [],
                flatActivities: [],
                weekSchedule: {},
                monthSchedule: {},

                // ç”¨äºå¼ºåˆ¶è§¦å‘Alpine.jsé‡æ–°æ¸²æŸ“çš„è¾…åŠ©å˜é‡
                refreshTrigger: 0,
                
                // æ±‡æ€»è§†å›¾æ•°æ®
                summaryStats: null,
                summaryMonth: '',
                availableMonths: [],
                activityStats: {},
                
                // æ—¶é—´æ§½é…ç½®
                timeSlots: [
                    { value: 21, name: 'ä¸Šåˆç¬¬1æ—¶æ®µ' },
                    { value: 22, name: 'ä¸Šåˆç¬¬2æ—¶æ®µ' },
                    { value: 51, name: 'ä¸‹åˆç¬¬1æ—¶æ®µ' },
                    { value: 52, name: 'ä¸‹åˆç¬¬2æ—¶æ®µ' },
                    { value: 71, name: 'æ™šä¸Šæ—¶æ®µ' }
                ],
                
                // æ¨¡æ€æ¡†çŠ¶æ€
                showNewActivityModal: false,
                showEditActivityModal: false,
                showEditEventModal: false,
                
                // è¡¨å•æ•°æ®
                newActivity: {
                    name: '',
                    parent_id: '',
                    description: ''
                },
                
                editingActivity: {
                    id: null,
                    name: '',
                    description: ''
                },
                
                editingEvent: {
                    id: null,
                    activity_id: null,
                    activity_name: '',
                    event_date: '',
                    time_slot: 21,
                    goal: '',
                    notes: '',
                    status: 'planned'
                },
                
                // å‘¨æ•°æ®
                weekDates: [],
                
                // å¼ºåˆ¶å…³é—­æ¨¡æ€æ¡†
                forceCloseModal() {
                    console.log('Force closing modal');
                    console.log('Before reset - showEditEventModal:', this.showEditEventModal);
                    console.log('Before reset - currentView:', this.currentView);
                    
                    this.showEditEventModal = false;
                    this.showNewActivityModal = false;
                    this.showEditActivityModal = false;
                    
                    console.log('After reset - showEditEventModal:', this.showEditEventModal);
                    console.log('Modal condition check:', this.showEditEventModal && this.currentView === 'week');
                    
                    // é‡ç½®ç¼–è¾‘äº‹ä»¶æ•°æ®
                    this.editingEvent = {
                        id: null,
                        activity_id: null,
                        activity_name: '',
                        event_date: '',
                        time_slot: 21,
                        goal: '',
                        notes: '',
                        status: 'planned'
                    };
                    
                    // é‡ç½®ç¼–è¾‘æ´»åŠ¨æ•°æ®
                    this.editingActivity = {
                        id: null,
                        name: '',
                        description: ''
                    };
                },
                
                // åˆå§‹åŒ–
                async init() {
                    console.log('Initializing LAE App... v9 - Debug Enhanced');
                    console.log('Initial view:', this.currentView);
                    console.log('Time slots configuration:', this.timeSlots);
                    
                    // åˆ›å»ºå…¨å±€å¼•ç”¨ä»¥ä¾¿HTML onclickè®¿é—®
                    window.laeAppInstance = this;
                    
                    // å¼ºåˆ¶é‡ç½®æ‰€æœ‰æ¨¡æ€æ¡†çŠ¶æ€
                    this.forceCloseModal();
                    
                    await this.loadActivities();
                    console.log('Activities loaded, count:', this.flatActivities.length);
                    
                    this.updateWeekDates();
                    console.log('Week dates updated:', this.weekDates);
                    
                    // æ ¹æ®å½“å‰è§†å›¾åŠ è½½æ•°æ®
                    if (this.currentView === 'week') {
                        await this.loadWeekSchedule();
                    } else if (this.currentView === 'month') {
                        await this.loadMonthSchedule();
                    } else if (this.currentView === 'summary') {
                        await this.initSummaryData();
                    }
                    
                    // ç¡®ä¿DOMæ¸²æŸ“å®Œæˆååˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
                    this.$nextTick(() => {
                        console.log('DOM updated, initializing drag and drop in 300ms...');
                        
                        // å¦‚æœæ˜¯å‘¨è§†å›¾ï¼Œæ‰‹åŠ¨æ¸²æŸ“ç½‘æ ¼
                        if (this.currentView === 'week') {
                            const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                            if (gridContainer) {
                                gridContainer.innerHTML = this.renderFullWeekGrid();
                                console.log('Week grid manually rendered');
                            }
                        }
                        
                        setTimeout(() => {
                            this.initDragAndDrop();
                        }, 300);
                    });
                },
                
                // APIè°ƒç”¨æ–¹æ³•
                async apiCall(endpoint, options = {}) {
                    try {
                        console.log('ğŸŒ APIè°ƒç”¨:', {
                            endpoint,
                            method: options.method || 'GET',
                            body: options.body
                        });

                        const response = await fetch(`/api${endpoint}`, {
                            headers: {
                                'Content-Type': 'application/json',
                                ...options.headers
                            },
                            ...options
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('âŒ APIé”™è¯¯è¯¦æƒ…:', {
                                status: response.status,
                                statusText: response.statusText,
                                url: response.url,
                                errorBody: errorText
                            });
                            throw new Error(`APIé”™è¯¯: ${response.status} - ${errorText}`);
                        }

                        const result = await response.json();
                        console.log('âœ… APIæˆåŠŸ:', result);
                        return result;
                    } catch (error) {
                        console.error('APIè°ƒç”¨å¤±è´¥:', error);
                        alert('æ“ä½œå¤±è´¥: ' + error.message);
                        throw error;
                    }
                },
                
                // åŠ è½½æ´»åŠ¨æ•°æ®
                async loadActivities() {
                    try {
                        this.activities = await this.apiCall('/activities/tree');
                        this.flatActivities = await this.apiCall('/activities/');
                        console.log('Activities loaded:', this.flatActivities.length);
                    } catch (error) {
                        console.error('åŠ è½½æ´»åŠ¨å¤±è´¥:', error);
                    }
                },
                
                // åˆ›å»ºæ–°æ´»åŠ¨
                async createActivity() {
                    try {
                        const activityData = {
                            name: this.newActivity.name,
                            description: this.newActivity.description || null,
                            parent_id: this.newActivity.parent_id || null
                        };
                        
                        await this.apiCall('/activities/', {
                            method: 'POST',
                            body: JSON.stringify(activityData)
                        });
                        
                        // é‡æ–°åŠ è½½æ•°æ®
                        await this.loadActivities();
                        
                        // å…³é—­æ¨¡æ€æ¡†å¹¶é‡ç½®è¡¨å•
                        this.showNewActivityModal = false;
                        this.newActivity = { name: '', parent_id: '', description: '' };
                        
                        // å¦‚æœåœ¨æ±‡æ€»è§†å›¾ï¼Œé‡æ–°åŠ è½½ç»Ÿè®¡æ•°æ®
                        if (this.currentView === 'summary') {
                            await this.initSummaryData();
                        }
                        
                    } catch (error) {
                        console.error('åˆ›å»ºæ´»åŠ¨å¤±è´¥:', error);
                    }
                },
                
                // ç¼–è¾‘æ´»åŠ¨
                editActivity(activityId) {
                    const activity = this.flatActivities.find(a => a.id === activityId);
                    if (!activity) {
                        console.error('Activity not found:', activityId);
                        return;
                    }
                    
                    this.editingActivity = {
                        id: activity.id,
                        name: activity.name,
                        description: activity.description || ''
                    };
                    
                    this.showEditActivityModal = true;
                },
                
                // æ›´æ–°æ´»åŠ¨
                async updateActivity() {
                    try {
                        const activityData = {
                            name: this.editingActivity.name,
                            description: this.editingActivity.description || null
                        };
                        
                        await this.apiCall(`/activities/${this.editingActivity.id}`, {
                            method: 'PUT',
                            body: JSON.stringify(activityData)
                        });
                        
                        // é‡æ–°åŠ è½½æ•°æ®
                        await this.loadActivities();
                        
                        // å…³é—­æ¨¡æ€æ¡†å¹¶é‡ç½®è¡¨å•
                        this.showEditActivityModal = false;
                        this.editingActivity = { id: null, name: '', description: '' };
                        
                        // å¦‚æœåœ¨æ±‡æ€»è§†å›¾ï¼Œé‡æ–°åŠ è½½ç»Ÿè®¡æ•°æ®
                        if (this.currentView === 'summary') {
                            await this.initSummaryData();
                        }
                        
                    } catch (error) {
                        console.error('æ›´æ–°æ´»åŠ¨å¤±è´¥:', error);
                    }
                },
                
                // è§†å›¾åˆ‡æ¢
                async switchView(view) {
                    console.log('Switching from', this.currentView, 'to', view);
                    this.currentView = view;
                    
                    // åˆ‡æ¢è§†å›¾æ—¶æ¸…ç†æ‰€æœ‰æ¨¡æ€æ¡†çŠ¶æ€
                    this.showNewActivityModal = false;
                    this.showEditActivityModal = false;
                    this.showEditEventModal = false;
                    
                    if (view === 'week') {
                        console.log('Entering week view...');
                        console.log('Current week dates:', this.weekDates);
                        console.log('Time slots:', this.timeSlots);
                        
                        await this.loadWeekSchedule();
                        
                        // å¼ºåˆ¶é‡æ–°æ¸²æŸ“ç½‘æ ¼
                        this.$nextTick(() => {
                            // æ‰‹åŠ¨è§¦å‘é‡æ–°æ¸²æŸ“
                            const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                            if (gridContainer) {
                                gridContainer.innerHTML = this.renderFullWeekGrid();
                            }
                            
                            console.log('Week view DOM updated, checking elements...');
                            console.log('Activity pool element:', document.getElementById('activity-pool'));
                            console.log('Week grid element:', document.getElementById('week-grid'));
                            console.log('Time slot elements:', document.querySelectorAll('.time-slot').length);
                            
                            setTimeout(() => {
                                this.initDragAndDrop();
                            }, 200);
                        });
                    } else if (view === 'month') {
                        await this.loadMonthSchedule();
                    } else if (view === 'summary') {
                        await this.initSummaryData();
                    }
                },
                
                // å‘¨è§†å›¾ç›¸å…³æ–¹æ³•
                updateWeekDates() {
                    const start = new Date(this.currentDate);
                    start.setDate(start.getDate() - start.getDay() + 1); // è·å–å‘¨ä¸€
                    this.currentWeekStart = new Date(start);
                    
                    this.weekDates = [];
                    for (let i = 0; i < 7; i++) {
                        const date = new Date(start);
                        date.setDate(start.getDate() + i);
                        this.weekDates.push(date.toISOString().split('T')[0]);
                    }
                },
                
                async loadWeekSchedule() {
                    try {
                        const targetDate = this.weekDates[0]; // å‘¨ä¸€
                        console.log('Loading week schedule for:', targetDate);
                        const data = await this.apiCall(`/calendar/week/${targetDate}`);
                        
                        // è½¬æ¢æ•°æ®æ ¼å¼ä»¥ä¾¿æŸ¥æ‰¾
                        this.weekSchedule = {};
                        data.schedule.forEach(day => {
                            this.weekSchedule[day.date] = day.slots;
                        });
                        console.log('Week schedule loaded:', this.weekSchedule);
                        console.log('Schedule data structure:', data);
                    } catch (error) {
                        console.error('åŠ è½½å‘¨æ—¥ç¨‹å¤±è´¥:', error);
                        // å³ä½¿åŠ è½½å¤±è´¥ä¹Ÿè¦åˆå§‹åŒ–ç©ºçš„å‘¨æ—¥ç¨‹å¯¹è±¡
                        this.weekSchedule = {};
                    }
                },
                
                getScheduledEvent(date, timeSlot) {
                    return this.weekSchedule[date]?.[timeSlot] || null;
                },
                
                async previousWeek() {
                    console.log('â¬…ï¸ åˆ‡æ¢åˆ°ä¸Šä¸€å‘¨');
                    this.currentDate.setDate(this.currentDate.getDate() - 7);
                    this.updateWeekDates();
                    await this.loadWeekSchedule();

                    // ç¡®ä¿åˆ‡æ¢å‘¨åé‡æ–°åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
                    this.$nextTick(() => {
                        const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                        if (gridContainer) {
                            gridContainer.innerHTML = this.renderFullWeekGrid();
                            console.log('å‘¨æ•°æ®åˆ‡æ¢åé‡æ–°æ¸²æŸ“ç½‘æ ¼');

                            setTimeout(() => {
                                this.initDragAndDrop();
                                console.log('å‘¨æ•°æ®åˆ‡æ¢åé‡æ–°åˆå§‹åŒ–æ‹–æ‹½');
                            }, 200);
                        }
                    });
                },

                async nextWeek() {
                    console.log('â¡ï¸ åˆ‡æ¢åˆ°ä¸‹ä¸€å‘¨');
                    this.currentDate.setDate(this.currentDate.getDate() + 7);
                    this.updateWeekDates();
                    await this.loadWeekSchedule();

                    // ç¡®ä¿åˆ‡æ¢å‘¨åé‡æ–°åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
                    this.$nextTick(() => {
                        const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                        if (gridContainer) {
                            gridContainer.innerHTML = this.renderFullWeekGrid();
                            console.log('å‘¨æ•°æ®åˆ‡æ¢åé‡æ–°æ¸²æŸ“ç½‘æ ¼');

                            setTimeout(() => {
                                this.initDragAndDrop();
                                console.log('å‘¨æ•°æ®åˆ‡æ¢åé‡æ–°åˆå§‹åŒ–æ‹–æ‹½');
                            }, 200);
                        }
                    });
                },
                
                // æ—¥ç¨‹ç¼–è¾‘
                editScheduledEvent(date, timeSlot) {
                    console.log('Editing event for:', date, timeSlot, 'Current view:', this.currentView);
                    
                    // åªåœ¨å‘¨è§†å›¾ä¸­å…è®¸ç¼–è¾‘
                    if (this.currentView !== 'week') {
                        console.log('Edit event modal blocked - not in week view');
                        return;
                    }
                    
                    const event = this.getScheduledEvent(date, timeSlot);
                    
                    if (event) {
                        // ç¼–è¾‘ç°æœ‰äº‹ä»¶
                        this.editingEvent = {
                            id: event.id,
                            activity_id: event.activity_id,
                            activity_name: event.activity_name,
                            event_date: date,
                            time_slot: timeSlot,
                            goal: event.goal || '',
                            notes: event.notes || '',
                            status: event.status
                        };
                    } else {
                        // åˆ›å»ºæ–°äº‹ä»¶ï¼ˆä½†éœ€è¦å…ˆé€‰æ‹©æ´»åŠ¨ï¼‰
                        this.editingEvent = {
                            id: null,
                            activity_id: null,
                            activity_name: '',
                            event_date: date,
                            time_slot: timeSlot,
                            goal: '',
                            notes: '',
                            status: 'planned'
                        };
                    }
                    
                    this.showEditEventModal = true;
                },
                
                async saveScheduledEvent() {
                    try {
                        if (!this.editingEvent.activity_id) {
                            alert('è¯·å…ˆæ‹–æ‹½æ´»åŠ¨åˆ°æ—¶é—´æ§½ä¸­');
                            return;
                        }
                        
                        const eventData = {
                            activity_id: this.editingEvent.activity_id,
                            event_date: this.editingEvent.event_date,
                            time_slot: this.editingEvent.time_slot,
                            goal: this.editingEvent.goal || null,
                            notes: this.editingEvent.notes || null,
                            status: this.editingEvent.status
                        };
                        
                        if (this.editingEvent.id) {
                            // æ›´æ–°ç°æœ‰äº‹ä»¶
                            await this.apiCall(`/events/${this.editingEvent.id}`, {
                                method: 'PUT',
                                body: JSON.stringify(eventData)
                            });
                        } else {
                            // åˆ›å»ºæ–°äº‹ä»¶
                            await this.apiCall('/events/', {
                                method: 'POST',
                                body: JSON.stringify(eventData)
                            });
                        }
                        
                        // åˆ·æ–°æ•°æ®
                        await this.loadWeekSchedule();
                        this.forceCloseModal();
                        
                    } catch (error) {
                        console.error('ä¿å­˜æ—¥ç¨‹å¤±è´¥:', error);
                    }
                },
                
                async deleteScheduledEvent() {
                    if (!this.editingEvent.id) return;
                    
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ—¥ç¨‹å—ï¼Ÿ')) {
                        try {
                            await this.apiCall(`/events/${this.editingEvent.id}`, {
                                method: 'DELETE'
                            });
                            
                            await this.loadWeekSchedule();
                            this.forceCloseModal();
                        } catch (error) {
                            console.error('åˆ é™¤æ—¥ç¨‹å¤±è´¥:', error);
                        }
                    }
                },
                
                // æ‹–æ‹½åŠŸèƒ½åˆå§‹åŒ–
                initDragAndDrop() {
                    console.log('Initializing drag and drop...', 'Current view:', this.currentView);
                    
                    // åªåœ¨å‘¨è§†å›¾ä¸­åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
                    if (this.currentView !== 'week') {
                        console.log('Drag and drop skipped - not in week view');
                        return;
                    }
                    
                    const self = this; // ä¿å­˜Alpine.jså®ä¾‹å¼•ç”¨
                    
                    // åªæ¸…ç†æ—¶é—´æ§½çš„Sortableå®ä¾‹ï¼Œä¿ç•™æ´»åŠ¨æ± çš„å®ä¾‹
                    document.querySelectorAll('.time-slot.sortable-initialized').forEach(el => {
                        if (el.sortableInstance) {
                            el.sortableInstance.destroy();
                        }
                        el.classList.remove('sortable-initialized');
                    });
                    
                    console.log('Cleaned up time slot sortable instances');
                    
                    // åˆå§‹åŒ–æ´»åŠ¨æ± çš„æ‹–æ‹½ï¼ˆä½¿ç”¨ä¸“é—¨æ–¹æ³•ï¼‰
                    this.initActivityPoolDragAndDrop();
                    
                    // åˆå§‹åŒ–æ—¶é—´æ§½çš„æ‹–æ‹½æ¥æ”¶
                    const timeSlots = document.querySelectorAll('.time-slot');
                    console.log('Found time slots:', timeSlots.length);
                    
                    timeSlots.forEach((slot, index) => {
                        if (!slot.classList.contains('sortable-initialized')) {
                            console.log(`Initializing time slot ${index}:`, {
                                date: slot.getAttribute('data-date'),
                                timeSlot: slot.getAttribute('data-time-slot')
                            });
                            
                            slot.sortableInstance = Sortable.create(slot, {
                                group: {
                                    name: 'activities',
                                    pull: true,  // å…è®¸ä»æ—¶é—´æ§½æ‹–å‡ºï¼ˆç”¨äºåˆ é™¤æˆ–ç§»åŠ¨ï¼‰
                                    put: true    // å…è®¸æ‹–å…¥æ—¶é—´æ§½
                                },
                                animation: 200,
                                ghostClass: 'sortable-ghost',
                                chosenClass: 'sortable-chosen',
                                dragClass: 'sortable-drag',
                                // æé«˜æ‹–æ‹½åˆ¤æ–­ç²¾åº¦çš„å‚æ•°
                                tolerance: 'pointer', // ä½¿ç”¨é¼ æ ‡æŒ‡é’ˆä½ç½®åˆ¤æ–­ï¼Œè€Œä¸æ˜¯å…ƒç´ ä¸­å¿ƒ
                                forceAutoScrollFallback: false, // ç¦ç”¨è‡ªåŠ¨æ»šåŠ¨é¿å…ä½ç½®è®¡ç®—é”™è¯¯
                                fallbackTolerance: 5, // è®¾ç½®å®¹å·®ä¸º5pxï¼Œæé«˜ç²¾åº¦
                                // å½“ä»æ´»åŠ¨æ± æ‹–æ‹½åˆ°æ—¶é—´æ§½
                                onAdd: function(evt) {
                                    console.log('Drop event triggered on slot:', evt.to);
                                    const activityId = evt.item.getAttribute('data-activity-id');
                                    const date = evt.to.getAttribute('data-date');
                                    const timeSlot = parseInt(evt.to.getAttribute('data-time-slot'));
                                    const fromPool = evt.from.id === 'activity-pool';
                                    const fromTimeSlot = evt.from.classList.contains('time-slot');

                                    // è¯¦ç»†çš„æ‹–æ‹½åˆ¤æ–­è°ƒè¯•ä¿¡æ¯
                                    const targetRect = evt.to.getBoundingClientRect();
                                    const isValidTarget = self.validateDropTarget(evt.to, targetRect);

                                    console.log('ğŸ¯ æ‹–æ‹½ä½ç½®åˆ¤æ–­è¯¦æƒ…:', {
                                        ç›®æ ‡æ§½ä½: `${date} ${timeSlot}`,
                                        ç›®æ ‡å…ƒç´ : evt.to,
                                        ç›®æ ‡å…ƒç´ æ ‡ç­¾: evt.to.tagName,
                                        ç›®æ ‡å…ƒç´ ç±»å: evt.to.className,
                                        ç›®æ ‡å…ƒç´ ID: evt.to.id,
                                        ç›®æ ‡å…ƒç´ å¯è§æ€§: window.getComputedStyle(evt.to).display,
                                        ç›®æ ‡å…ƒç´ é€æ˜åº¦: window.getComputedStyle(evt.to).opacity,
                                        ç›®æ ‡å…ƒç´ è¾¹ç•Œ: {
                                            left: targetRect.left,
                                            right: targetRect.right,
                                            top: targetRect.top,
                                            bottom: targetRect.bottom,
                                            width: targetRect.width,
                                            height: targetRect.height
                                        },
                                        ç›®æ ‡æœ‰æ•ˆæ€§: isValidTarget ? 'âœ… æœ‰æ•ˆ' : 'âŒ æ— æ•ˆ',
                                        æ‹–æ‹½æº: fromPool ? 'æ´»åŠ¨æ± ' : 'æ—¶é—´æ§½',
                                        æ´»åŠ¨ID: activityId,
                                        æ‰€æœ‰æ—¶é—´æ§½å…ƒç´ æ•°é‡: document.querySelectorAll('.time-slot').length,
                                        å½“å‰æ—¶é—´æ§½æ˜¯å¦å­˜åœ¨: document.querySelector(`[data-date="${date}"][data-time-slot="${timeSlot}"]`) !== null
                                    });

                                    // éªŒè¯ç›®æ ‡å…ƒç´ æœ‰æ•ˆæ€§
                                    if (!isValidTarget) {
                                        console.warn('âš ï¸ æ£€æµ‹åˆ°æ— æ•ˆç›®æ ‡å…ƒç´ ï¼Œå°è¯•é‡æ–°å®šä½...');

                                        // å°è¯•æ‰¾åˆ°æœ€è¿‘çš„æœ‰æ•ˆæ—¶é—´æ§½
                                        const validTarget = self.findNearestValidTimeSlot(evt.originalEvent);
                                        if (validTarget) {
                                            console.log('ğŸ”„ é‡å®šå‘åˆ°æœ‰æ•ˆç›®æ ‡:', validTarget);
                                            // æ›´æ–°ç›®æ ‡æ•°æ®
                                            evt.to = validTarget;
                                            const newDate = validTarget.getAttribute('data-date');
                                            const newTimeSlot = parseInt(validTarget.getAttribute('data-time-slot'));

                                            console.log('ğŸ¯ é‡å®šå‘åçš„ç›®æ ‡:', {
                                                åŸç›®æ ‡: `${date} ${timeSlot}`,
                                                æ–°ç›®æ ‡: `${newDate} ${newTimeSlot}`
                                            });

                                            // ä½¿ç”¨æ–°çš„ç›®æ ‡æ•°æ®
                                            if (fromTimeSlot) {
                                                self.handleMoveEvent(activityId, evt.from.getAttribute('data-date'),
                                                    parseInt(evt.from.getAttribute('data-time-slot')), newDate, newTimeSlot);
                                            } else {
                                                self.handleDrop(activityId, newDate, newTimeSlot);
                                            }
                                        } else {
                                            console.error('âŒ æ‰¾ä¸åˆ°æœ‰æ•ˆçš„ç›®æ ‡æ—¶é—´æ§½');
                                            evt.item.remove();
                                        }
                                        return;
                                    }

                                    console.log('Drop details:', {
                                        activityId, date, timeSlot,
                                        fromPool, fromTimeSlot,
                                        fromElement: evt.from.id || evt.from.className
                                    });

                                    if (!activityId || !date || !timeSlot) {
                                        console.error('Missing required drop data');
                                        evt.item.remove();
                                        return;
                                    }

                                    // ç«‹å³ç§»é™¤æ‹–æ‹½çš„ä¸´æ—¶å…ƒç´ 
                                    evt.item.remove();

                                    // å¦‚æœæ˜¯ä»å…¶ä»–æ—¶é—´æ§½ç§»åŠ¨è¿‡æ¥çš„ï¼Œéœ€è¦å…ˆåˆ é™¤åŸæœ‰äº‹ä»¶
                                    if (fromTimeSlot) {
                                        const originalDate = evt.from.getAttribute('data-date');
                                        const originalTimeSlot = parseInt(evt.from.getAttribute('data-time-slot'));
                                        console.log('Moving from time slot:', originalDate, originalTimeSlot);

                                        // å¤„ç†ç§»åŠ¨äº‹ä»¶ï¼ˆå…ˆåˆ é™¤åŸäº‹ä»¶ï¼Œå†åˆ›å»ºæ–°äº‹ä»¶ï¼‰
                                        self.handleMoveEvent(activityId, originalDate, originalTimeSlot, date, timeSlot);
                                    } else {
                                        // ä»æ´»åŠ¨æ± æ‹–æ‹½ï¼Œåˆ›å»ºæ–°äº‹ä»¶
                                        self.handleDrop(activityId, date, timeSlot);
                                    }
                                },
                                // å½“ä»æ—¶é—´æ§½æ‹–æ‹½å…ƒç´ å‡ºå»æ—¶
                                onRemove: function(evt) {
                                    console.log('Item removed from time slot:', {
                                        from: evt.from,
                                        to: evt.to,
                                        toId: evt.to.id,
                                        toClass: evt.to.className
                                    });

                                    // å¦‚æœæ‹–æ‹½åˆ°æ´»åŠ¨æ± ï¼Œè§†ä¸ºåˆ é™¤æ“ä½œ
                                    if (evt.to.id === 'activity-pool') {
                                        const date = evt.from.getAttribute('data-date');
                                        const timeSlot = parseInt(evt.from.getAttribute('data-time-slot'));
                                        const eventId = evt.item.getAttribute('data-event-id');

                                        console.log('Deleting event by drag to pool:', { date, timeSlot, eventId });

                                        if (eventId) {
                                            self.deleteEventById(eventId);
                                        } else {
                                            // å¤‡ç”¨åˆ é™¤æ–¹æ³•ï¼šæ ¹æ®æ—¥æœŸå’Œæ—¶é—´æ§½æŸ¥æ‰¾å¹¶åˆ é™¤
                                            self.deleteEventByDateSlot(date, timeSlot);
                                        }
                                    }
                                    // å¦‚æœæ˜¯ç§»åŠ¨åˆ°å…¶ä»–æ—¶é—´æ§½ï¼ŒonAddä¼šå¤„ç†
                                }
                            });
                            slot.classList.add('sortable-initialized');
                        }
                    });
                    
                    console.log('Drag and drop initialization completed');
                },
                
                // åªåˆå§‹åŒ–æ—¶é—´æ§½çš„æ‹–æ‹½åŠŸèƒ½ï¼ˆç”¨äºåŠ¨æ€é‡æ–°åˆå§‹åŒ–ï¼‰
                initTimeSlotsDragAndDrop() {
                    if (this.currentView !== 'week') {
                        return;
                    }

                    console.log('Re-initializing time slots drag and drop...');
                    const self = this;

                    // æ›´å½»åº•çš„æ¸…ç†æ—¶é—´æ§½çš„Sortableå®ä¾‹
                    document.querySelectorAll('.time-slot').forEach(el => {
                        if (el.sortableInstance) {
                            console.log('Destroying existing sortable instance for time slot');
                            try {
                                el.sortableInstance.destroy();
                            } catch (e) {
                                console.warn('Error destroying sortable instance:', e);
                            }
                            el.sortableInstance = null;
                        }
                        el.classList.remove('sortable-initialized');

                        // æ¸…ç†å¯èƒ½æ®‹ç•™çš„æ‹–æ‹½ç›¸å…³çš„CSSç±»
                        el.classList.remove('sortable-chosen', 'sortable-drag', 'sortable-ghost', 'sortable-over');
                    });

                    // ç­‰å¾…ä¸€å¸§æ¥ç¡®ä¿DOMå®Œå…¨æ¸…ç†
                    requestAnimationFrame(() => {
                        // é‡æ–°åˆå§‹åŒ–æ—¶é—´æ§½çš„æ‹–æ‹½æ¥æ”¶
                        const timeSlots = document.querySelectorAll('.time-slot');
                        console.log('Re-initializing time slots:', timeSlots.length);

                        timeSlots.forEach((slot, index) => {
                            if (!slot.classList.contains('sortable-initialized')) {
                                slot.sortableInstance = Sortable.create(slot, {
                                    group: {
                                        name: 'activities',
                                        pull: true,
                                        put: true
                                    },
                                    animation: 200,
                                    ghostClass: 'sortable-ghost',
                                    chosenClass: 'sortable-chosen',
                                    dragClass: 'sortable-drag',
                                    // æé«˜æ‹–æ‹½åˆ¤æ–­ç²¾åº¦çš„å‚æ•°
                                    tolerance: 'pointer', // ä½¿ç”¨é¼ æ ‡æŒ‡é’ˆä½ç½®åˆ¤æ–­ï¼Œè€Œä¸æ˜¯å…ƒç´ ä¸­å¿ƒ
                                    forceAutoScrollFallback: false, // ç¦ç”¨è‡ªåŠ¨æ»šåŠ¨é¿å…ä½ç½®è®¡ç®—é”™è¯¯
                                    fallbackTolerance: 5, // è®¾ç½®å®¹å·®ä¸º5pxï¼Œæé«˜ç²¾åº¦
                                    onAdd: function(evt) {
                                        console.log('Drop event triggered on slot:', evt.to);
                                        const activityId = evt.item.getAttribute('data-activity-id');
                                        const date = evt.to.getAttribute('data-date');
                                        const timeSlot = parseInt(evt.to.getAttribute('data-time-slot'));
                                        const fromPool = evt.from.id === 'activity-pool';
                                        const fromTimeSlot = evt.from.classList.contains('time-slot');

                                        // è¯¦ç»†çš„æ‹–æ‹½åˆ¤æ–­è°ƒè¯•ä¿¡æ¯
                                        const targetRect = evt.to.getBoundingClientRect();
                                        const isValidTarget = self.validateDropTarget(evt.to, targetRect);

                                        console.log('ğŸ¯ æ‹–æ‹½ä½ç½®åˆ¤æ–­è¯¦æƒ…:', {
                                            ç›®æ ‡æ§½ä½: `${date} ${timeSlot}`,
                                            ç›®æ ‡æœ‰æ•ˆæ€§: isValidTarget ? 'âœ… æœ‰æ•ˆ' : 'âŒ æ— æ•ˆ',
                                            ç›®æ ‡å…ƒç´ : evt.to,
                                            ç›®æ ‡å…ƒç´ æ ‡ç­¾: evt.to.tagName,
                                            ç›®æ ‡å…ƒç´ ç±»å: evt.to.className,
                                            ç›®æ ‡å…ƒç´ ID: evt.to.id,
                                            ç›®æ ‡å…ƒç´ å¯è§æ€§: window.getComputedStyle(evt.to).display,
                                            ç›®æ ‡å…ƒç´ é€æ˜åº¦: window.getComputedStyle(evt.to).opacity,
                                            ç›®æ ‡å…ƒç´ è¾¹ç•Œ: {
                                                left: targetRect.left,
                                                right: targetRect.right,
                                                top: targetRect.top,
                                                bottom: targetRect.bottom,
                                                width: targetRect.width,
                                                height: targetRect.height
                                            },
                                            æ‹–æ‹½æº: fromPool ? 'æ´»åŠ¨æ± ' : 'æ—¶é—´æ§½',
                                            æ´»åŠ¨ID: activityId,
                                            æ‰€æœ‰æ—¶é—´æ§½å…ƒç´ æ•°é‡: document.querySelectorAll('.time-slot').length,
                                            å½“å‰æ—¶é—´æ§½æ˜¯å¦å­˜åœ¨: document.querySelector(`[data-date="${date}"][data-time-slot="${timeSlot}"]`) !== null
                                        });

                                        // éªŒè¯ç›®æ ‡å…ƒç´ æœ‰æ•ˆæ€§
                                        if (!isValidTarget) {
                                            console.warn('âš ï¸ æ£€æµ‹åˆ°æ— æ•ˆç›®æ ‡å…ƒç´ ï¼Œå°è¯•é‡æ–°å®šä½...');

                                            // å°è¯•æ‰¾åˆ°æœ€è¿‘çš„æœ‰æ•ˆæ—¶é—´æ§½
                                            const validTarget = self.findNearestValidTimeSlot(evt.originalEvent);
                                            if (validTarget) {
                                                console.log('ğŸ”„ é‡å®šå‘åˆ°æœ‰æ•ˆç›®æ ‡:', validTarget);
                                                const newDate = validTarget.getAttribute('data-date');
                                                const newTimeSlot = parseInt(validTarget.getAttribute('data-time-slot'));

                                                console.log('ğŸ¯ é‡å®šå‘åçš„ç›®æ ‡:', {
                                                    åŸç›®æ ‡: `${date} ${timeSlot}`,
                                                    æ–°ç›®æ ‡: `${newDate} ${newTimeSlot}`
                                                });

                                                evt.item.remove();

                                                // ä½¿ç”¨æ–°çš„ç›®æ ‡æ•°æ®
                                                if (fromTimeSlot) {
                                                    self.handleMoveEvent(activityId, evt.from.getAttribute('data-date'),
                                                        parseInt(evt.from.getAttribute('data-time-slot')), newDate, newTimeSlot);
                                                } else {
                                                    self.handleDrop(activityId, newDate, newTimeSlot);
                                                }
                                            } else {
                                                console.error('âŒ æ‰¾ä¸åˆ°æœ‰æ•ˆçš„ç›®æ ‡æ—¶é—´æ§½');
                                                evt.item.remove();
                                            }
                                            return;
                                        }

                                        console.log('Drop details:', {
                                            activityId, date, timeSlot,
                                            fromPool, fromTimeSlot,
                                            fromElement: evt.from.id || evt.from.className
                                        });

                                        if (!activityId || !date || !timeSlot) {
                                            console.error('Missing required drop data');
                                            evt.item.remove();
                                            return;
                                        }

                                        evt.item.remove();

                                        // å¦‚æœæ˜¯ä»å…¶ä»–æ—¶é—´æ§½ç§»åŠ¨è¿‡æ¥çš„ï¼Œéœ€è¦å…ˆåˆ é™¤åŸæœ‰äº‹ä»¶
                                        if (fromTimeSlot) {
                                            const originalDate = evt.from.getAttribute('data-date');
                                            const originalTimeSlot = parseInt(evt.from.getAttribute('data-time-slot'));
                                            console.log('Moving from time slot:', originalDate, originalTimeSlot);

                                            // å¤„ç†ç§»åŠ¨äº‹ä»¶ï¼ˆå…ˆåˆ é™¤åŸäº‹ä»¶ï¼Œå†åˆ›å»ºæ–°äº‹ä»¶ï¼‰
                                            self.handleMoveEvent(activityId, originalDate, originalTimeSlot, date, timeSlot);
                                        } else {
                                            // ä»æ´»åŠ¨æ± æ‹–æ‹½ï¼Œåˆ›å»ºæ–°äº‹ä»¶
                                            self.handleDrop(activityId, date, timeSlot);
                                        }
                                    },
                                    onRemove: function(evt) {
                                        console.log('Item removed from time slot:', {
                                            from: evt.from,
                                            to: evt.to,
                                            toId: evt.to.id,
                                            toClass: evt.to.className
                                        });

                                        // å¦‚æœæ‹–æ‹½åˆ°æ´»åŠ¨æ± ï¼Œè§†ä¸ºåˆ é™¤æ“ä½œ
                                        if (evt.to.id === 'activity-pool') {
                                            const date = evt.from.getAttribute('data-date');
                                            const timeSlot = parseInt(evt.from.getAttribute('data-time-slot'));
                                            const eventId = evt.item.getAttribute('data-event-id');

                                            console.log('Deleting event by drag to pool:', { date, timeSlot, eventId });

                                            if (eventId) {
                                                self.deleteEventById(eventId);
                                            } else {
                                                // å¤‡ç”¨åˆ é™¤æ–¹æ³•ï¼šæ ¹æ®æ—¥æœŸå’Œæ—¶é—´æ§½æŸ¥æ‰¾å¹¶åˆ é™¤
                                                self.deleteEventByDateSlot(date, timeSlot);
                                            }
                                        }
                                        // å¦‚æœæ˜¯ç§»åŠ¨åˆ°å…¶ä»–æ—¶é—´æ§½ï¼ŒonAddä¼šå¤„ç†
                                    }
                                });
                                slot.classList.add('sortable-initialized');
                            }
                        });

                        console.log('Time slots drag and drop re-initialization completed');
                    });
                },
                
                // æ–°å¢ï¼šå¤„ç†äº‹ä»¶ç§»åŠ¨ï¼ˆä»ä¸€ä¸ªæ—¶é—´æ§½ç§»åŠ¨åˆ°å¦ä¸€ä¸ªæ—¶é—´æ§½ï¼‰
                async handleMoveEvent(activityId, fromDate, fromTimeSlot, toDate, toTimeSlot) {
                    try {
                        console.log('=== MOVE EVENT HANDLER START ===');
                        console.log('Moving event:', {
                            activityId,
                            from: { date: fromDate, timeSlot: fromTimeSlot },
                            to: { date: toDate, timeSlot: toTimeSlot }
                        });

                        // æ£€æŸ¥ç›®æ ‡æ—¶é—´æ§½æ˜¯å¦å·²è¢«å ç”¨
                        const targetEvent = this.getScheduledEvent(toDate, toTimeSlot);
                        if (targetEvent) {
                            alert('ç›®æ ‡æ—¶é—´æ§½å·²æœ‰å®‰æ’ï¼Œæ— æ³•ç§»åŠ¨');
                            // é‡æ–°æ¸²æŸ“ç½‘æ ¼ä»¥æ¢å¤åŸçŠ¶
                            await this.loadWeekSchedule();
                            const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                            if (gridContainer) {
                                gridContainer.innerHTML = this.renderFullWeekGrid();
                                setTimeout(() => {
                                    this.initTimeSlotsDragAndDrop();
                                }, 100);
                            }
                            return;
                        }

                        // æ‰¾åˆ°åŸäº‹ä»¶
                        const originalEvent = this.getScheduledEvent(fromDate, fromTimeSlot);
                        if (!originalEvent) {
                            console.error('Original event not found');
                            alert('æ‰¾ä¸åˆ°åŸå§‹äº‹ä»¶');
                            return;
                        }

                        console.log('Original event found:', originalEvent);

                        // æ›´æ–°äº‹ä»¶çš„æ—¥æœŸå’Œæ—¶é—´æ§½
                        const updateData = {
                            activity_id: parseInt(activityId),
                            event_date: toDate,
                            time_slot: parseInt(toTimeSlot),
                            goal: originalEvent.goal || '',
                            notes: originalEvent.notes || '',
                            status: originalEvent.status || 'planned'
                        };

                        console.log('Updating event with data:', updateData);

                        const result = await this.apiCall(`/events/${originalEvent.id}`, {
                            method: 'PUT',
                            body: JSON.stringify(updateData)
                        });

                        console.log('Event moved successfully:', result);

                        // åˆ·æ–°æ•°æ®å’Œé‡æ–°æ¸²æŸ“
                        await this.loadWeekSchedule();
                        const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                        if (gridContainer) {
                            gridContainer.innerHTML = this.renderFullWeekGrid();
                            console.log('Week grid re-rendered after move');

                            setTimeout(() => {
                                this.initTimeSlotsDragAndDrop();
                                // ç¡®ä¿æ´»åŠ¨æ± çŠ¶æ€æ­£å¸¸
                                this.verifyActivityPoolState();
                            }, 100);
                        }

                        console.log('=== MOVE EVENT HANDLER SUCCESS ===');

                    } catch (error) {
                        console.error('=== MOVE EVENT HANDLER ERROR ===');
                        console.error('ç§»åŠ¨äº‹ä»¶å¤±è´¥:', error);
                        alert('ç§»åŠ¨äº‹ä»¶å¤±è´¥: ' + error.message);

                        // é‡æ–°æ¸²æŸ“ç½‘æ ¼ä»¥æ¢å¤åŸçŠ¶
                        await this.loadWeekSchedule();
                        const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                        if (gridContainer) {
                            gridContainer.innerHTML = this.renderFullWeekGrid();
                            setTimeout(() => {
                                this.initTimeSlotsDragAndDrop();
                            }, 100);
                        }
                    }
                },

                // æ–°å¢ï¼šé€šè¿‡äº‹ä»¶IDåˆ é™¤äº‹ä»¶
                async deleteEventById(eventId) {
                    try {
                        console.log('Deleting event by ID:', eventId);

                        await this.apiCall(`/events/${eventId}`, {
                            method: 'DELETE'
                        });

                        console.log('Event deleted successfully');

                        // åˆ·æ–°æ•°æ®å’Œé‡æ–°æ¸²æŸ“
                        await this.loadWeekSchedule();
                        const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                        if (gridContainer) {
                            gridContainer.innerHTML = this.renderFullWeekGrid();
                            setTimeout(() => {
                                this.initTimeSlotsDragAndDrop();
                                // ç¡®ä¿æ´»åŠ¨æ± çŠ¶æ€æ­£å¸¸
                                this.verifyActivityPoolState();
                            }, 100);
                        }

                    } catch (error) {
                        console.error('åˆ é™¤äº‹ä»¶å¤±è´¥:', error);
                        alert('åˆ é™¤äº‹ä»¶å¤±è´¥: ' + error.message);
                    }
                },

                // æ–°å¢ï¼šé€šè¿‡æ—¥æœŸå’Œæ—¶é—´æ§½åˆ é™¤äº‹ä»¶
                async deleteEventByDateSlot(date, timeSlot) {
                    try {
                        console.log('Deleting event by date/slot:', { date, timeSlot });

                        const event = this.getScheduledEvent(date, timeSlot);
                        if (!event) {
                            console.log('No event found at specified slot');
                            return;
                        }

                        await this.deleteEventById(event.id);

                    } catch (error) {
                        console.error('æŒ‰æ—¥æœŸæ—¶é—´æ§½åˆ é™¤äº‹ä»¶å¤±è´¥:', error);
                        alert('åˆ é™¤äº‹ä»¶å¤±è´¥: ' + error.message);
                    }
                },

                async handleDrop(activityId, date, timeSlot) {
                    try {
                        console.log('=== DROP HANDLER START ===');
                        console.log('Handling drop:', { activityId, date, timeSlot });
                        console.log('Type check:', typeof activityId, typeof date, typeof timeSlot);
                        
                        // éªŒè¯è¾“å…¥å‚æ•°
                        if (!activityId || !date || !timeSlot) {
                            console.error('Invalid drop parameters:', { activityId, date, timeSlot });
                            alert('æ‹–æ‹½å‚æ•°é”™è¯¯ï¼Œè¯·é‡è¯•');
                            return;
                        }
                        
                        // æ£€æŸ¥æ˜¯å¦å·²æœ‰äº‹ä»¶
                        const existing = this.getScheduledEvent(date, timeSlot);
                        console.log('Existing event check:', existing);
                        if (existing) {
                            alert('è¯¥æ—¶é—´æ§½å·²æœ‰å®‰æ’ï¼Œè¯·é€‰æ‹©å…¶ä»–æ—¶é—´æˆ–å…ˆåˆ é™¤ç°æœ‰å®‰æ’');
                            return;
                        }
                        
                        // æ‰¾åˆ°æ´»åŠ¨ä¿¡æ¯
                        console.log('Searching for activity with ID:', activityId, 'in:', this.flatActivities.length, 'activities');
                        const activity = this.flatActivities.find(a => a.id == activityId);
                        console.log('Activity search result:', activity);
                        if (!activity) {
                            console.error('Activity not found:', activityId);
                            console.error('Available activities:', this.flatActivities.map(a => ({ id: a.id, name: a.name })));
                            alert('æœªæ‰¾åˆ°æ´»åŠ¨ä¿¡æ¯ï¼ŒID: ' + activityId);
                            return;
                        }
                        
                        console.log('Found activity:', activity);
                        
                        // åˆ›å»ºæ–°çš„æ—¥ç¨‹äº‹ä»¶
                        const eventData = {
                            activity_id: parseInt(activityId),
                            event_date: date,
                            time_slot: parseInt(timeSlot),
                            goal: '',
                            notes: '',
                            status: 'planned'
                        };
                        
                        console.log('Creating event:', eventData);
                        
                        const result = await this.apiCall('/events/', {
                            method: 'POST',
                            body: JSON.stringify(eventData)
                        });
                        
                        console.log('Event created:', result);
                        
                        // åˆ·æ–°æ•°æ®
                        console.log('Reloading week schedule after successful drop...');
                        await this.loadWeekSchedule();
                        
                        // é‡æ–°æ¸²æŸ“ç½‘æ ¼
                        const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                        if (gridContainer) {
                            gridContainer.innerHTML = this.renderFullWeekGrid();
                            console.log('Week grid re-rendered after drop');

                            // åªé‡æ–°åˆå§‹åŒ–æ—¶é—´æ§½çš„æ‹–æ‹½åŠŸèƒ½ï¼Œä¸å½±å“æ´»åŠ¨æ± 
                            setTimeout(() => {
                                this.initTimeSlotsDragAndDrop();
                                // ç¡®ä¿æ´»åŠ¨æ± çŠ¶æ€æ­£å¸¸
                                this.verifyActivityPoolState();
                            }, 100);
                        }
                        
                        // æ‹–æ‹½æˆåŠŸï¼Œä¸è‡ªåŠ¨æ‰“å¼€ç¼–è¾‘æ¡†
                        // ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨ç‚¹å‡»æ—¶é—´æ§½ä¸­çš„äº‹ä»¶æ¥ç¼–è¾‘
                        
                        console.log('=== DROP HANDLER SUCCESS ===');
                        
                    } catch (error) {
                        console.error('=== DROP HANDLER ERROR ===');
                        console.error('å¤„ç†æ‹–æ‹½å¤±è´¥:', error);
                        console.error('Error details:', {
                            name: error.name,
                            message: error.message,
                            stack: error.stack
                        });
                        alert('åˆ›å»ºæ—¥ç¨‹å¤±è´¥: ' + error.message);
                    }
                },
                
                // æ±‡æ€»è§†å›¾æ¸²æŸ“
                renderActivityTree() {
                    if (!this.activities.length) return '<p class="text-muted">æš‚æ— æ´»åŠ¨</p>';
                    
                    const renderNode = (activity, level = 0) => {
                        let html = `
                            <div class="mb-2" style="margin-left: ${level * 20}px;">
                                <div class="d-flex justify-content-between align-items-center border-bottom pb-2">
                                    <div>
                                        <strong>${activity.name}</strong>
                                        ${activity.description ? `<br><small class="text-muted">${activity.description}</small>` : ''}
                                    </div>
                                    <div class="text-end">
                                        <button class="btn btn-outline-danger btn-sm" 
                                                onclick="deleteActivity(${activity.id})">
                                            åˆ é™¤
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        if (activity.children && activity.children.length > 0) {
                            activity.children.forEach(child => {
                                html += renderNode(child, level + 1);
                            });
                        }
                        
                        return html;
                    };
                    
                    return this.activities.map(activity => renderNode(activity)).join('');
                },
                
                // å¸¦ç»Ÿè®¡ä¿¡æ¯çš„æ±‡æ€»è§†å›¾æ¸²æŸ“
                renderActivityTreeWithStats() {
                    if (!this.activities.length) return '<p class="text-muted">æš‚æ— æ´»åŠ¨</p>';
                    
                    const renderNode = (activity, level = 0) => {
                        const stats = this.activityStats[activity.id] || {};
                        const totalEvents = stats.total_events || 0;
                        const completedEvents = stats.completed_events || 0;
                        const completionRate = stats.completion_rate || 0;
                        
                        let html = `
                            <div class="mb-3" style="margin-left: ${level * 20}px;">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">${activity.name}</h6>
                                                ${activity.description ? `<p class="text-muted small mb-2">${activity.description}</p>` : ''}
                                                
                                                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                                                <div class="row text-center mb-2">
                                                    <div class="col-4">
                                                        <small class="text-muted d-block">æ€»å®‰æ’</small>
                                                        <strong class="text-primary">${totalEvents}</strong>
                                                    </div>
                                                    <div class="col-4">
                                                        <small class="text-muted d-block">å·²å®Œæˆ</small>
                                                        <strong class="text-success">${completedEvents}</strong>
                                                    </div>
                                                    <div class="col-4">
                                                        <small class="text-muted d-block">å®Œæˆç‡</small>
                                                        <strong class="text-warning">${Math.round(completionRate * 100)}%</strong>
                                                    </div>
                                                </div>
                                                
                                                <!-- Goal åˆ—è¡¨ -->
                                                ${this.renderActivityGoals(stats)}
                                            </div>
                                            <div class="text-end">
                                                <button class="btn btn-outline-primary btn-sm me-2" 
                                                        onclick="window.laeAppInstance.editActivity(${activity.id})">
                                                    ç¼–è¾‘
                                                </button>
                                                <button class="btn btn-outline-danger btn-sm" 
                                                        onclick="deleteActivity(${activity.id})">
                                                    åˆ é™¤
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        if (activity.children && activity.children.length > 0) {
                            activity.children.forEach(child => {
                                html += renderNode(child, level + 1);
                            });
                        }
                        
                        return html;
                    };
                    
                    return this.activities.map(activity => renderNode(activity)).join('');
                },
                
                // æ¸²æŸ“æ´»åŠ¨çš„Goalåˆ—è¡¨
                renderActivityGoals(stats) {
                    if (!stats.sub_activities || !stats.sub_activities.length) {
                        return '<small class="text-muted">æš‚æ— ç›®æ ‡è®°å½•</small>';
                    }
                    
                    let html = '<div class="mt-2"><small class="text-muted d-block mb-1">æœ€è¿‘ç›®æ ‡:</small>';
                    
                    // æ˜¾ç¤ºæœ€è¿‘çš„å‡ ä¸ªgoals
                    let goalCount = 0;
                    for (const subActivity of stats.sub_activities) {
                        if (subActivity.goals && subActivity.goals.length > 0) {
                            for (const goal of subActivity.goals.slice(-3)) { // åªæ˜¾ç¤ºæœ€è¿‘3ä¸ª
                                if (goalCount >= 5) break; // æœ€å¤šæ˜¾ç¤º5ä¸ª
                                
                                const statusColor = goal.status === 'completed' ? 'success' : 'secondary';
                                const statusIcon = goal.status === 'completed' ? 'âœ“' : 'â—‹';
                                
                                html += `
                                    <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                                        <small><span class="text-${statusColor}">${statusIcon}</span> ${goal.goal}</small>
                                        <small class="text-muted">${goal.date}</small>
                                    </div>
                                `;
                                goalCount++;
                            }
                        }
                        if (goalCount >= 5) break;
                    }
                    
                    html += '</div>';
                    return goalCount > 0 ? html : '<small class="text-muted">æš‚æ— ç›®æ ‡è®°å½•</small>';
                },
                
                // å®Œæ•´å‘¨è§†å›¾ç½‘æ ¼æ¸²æŸ“ï¼ˆåŒ…å«æ ‡é¢˜è¡Œå’Œæ‰€æœ‰æ—¶é—´æ§½ï¼‰
                renderFullWeekGrid() {
                    if (!this.timeSlots.length || !this.weekDates.length) {
                        return '<p class="text-muted">åŠ è½½ä¸­...</p>';
                    }
                    
                    let html = '';
                    
                    console.log('Rendering full week grid:', {
                        timeSlots: this.timeSlots.length,
                        weekDates: this.weekDates.length,
                        totalElements: (this.timeSlots.length + 1) * 8 // (5+1)è¡Œ Ã— 8åˆ—
                    });
                    
                    // 1. ç”Ÿæˆæ ‡é¢˜è¡Œï¼ˆ8ä¸ªå…ƒç´ ï¼š1ä¸ª"æ—¶é—´"æ ‡é¢˜ + 7ä¸ªæ—¥æœŸæ ‡é¢˜ï¼‰
                    html += '<div class="week-header">æ—¶é—´</div>';
                    for (const day of this.weekDates) {
                        const date = new Date(day);
                        const weekday = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'][date.getDay() === 0 ? 6 : date.getDay() - 1];
                        const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
                        html += `
                            <div class="week-header">
                                <div>${weekday}</div>
                                <div>${dateStr}</div>
                            </div>
                        `;
                    }
                    
                    // 2. ä¸ºæ¯ä¸ªæ—¶é—´æ®µç”Ÿæˆä¸€è¡Œï¼ˆ8ä¸ªå…ƒç´ ï¼š1ä¸ªæ—¶é—´æ ‡ç­¾ + 7ä¸ªæ—¶é—´æ§½ï¼‰
                    for (const slot of this.timeSlots) {
                        // æ—¶é—´æ ‡ç­¾ï¼ˆç¬¬ä¸€åˆ—ï¼‰
                        html += `<div class="time-label">${slot.name}</div>`;
                        
                        // è¯¥æ—¶é—´æ®µçš„7ä¸ªæ—¶é—´æ§½ï¼ˆå‘¨ä¸€åˆ°å‘¨æ—¥ï¼‰
                        for (const day of this.weekDates) {
                            const event = this.getScheduledEvent(day, slot.value);
                            const occupiedClass = event ? 'occupied' : '';
                            
                            html += `
                                <div class="time-slot p-2 ${occupiedClass}" 
                                     data-date="${day}" 
                                     data-time-slot="${slot.value}"
                                     onclick="window.laeAppInstance.editScheduledEvent('${day}', ${slot.value})">
                            `;
                            
                            if (event) {
                                html += `
                                    <div class="scheduled-event activity-card"
                                         data-activity-id="${event.activity_id}"
                                         data-event-id="${event.id}">
                                        <div class="fw-bold mb-1" style="font-size: 0.85rem; line-height: 1.2;">${event.activity_name || ''}</div>
                                        ${event.goal ? `<div class="mb-1" style="font-size: 0.75rem; color: #666; line-height: 1.3;">${event.goal}</div>` : ''}
                                        ${event.notes ? `<div style="font-size: 0.7rem; color: #888; line-height: 1.2;">å¤‡æ³¨: ${event.notes}</div>` : ''}
                                    </div>
                                `;
                            }
                            
                            html += '</div>';
                        }
                    }
                    
                    console.log('Generated full grid HTML, total elements:', (html.match(/<div/g) || []).length);
                    return html;
                },
                
                // æ¸²æŸ“æ´»åŠ¨æ± 
                renderActivityPool() {
                    if (!this.flatActivities.length) {
                        return '<p class="text-muted">æš‚æ— æ´»åŠ¨</p>';
                    }

                    return this.flatActivities.map(activity => `
                        <div class="activity-card card mb-2" data-activity-id="${activity.id}">
                            <div class="card-body py-2 px-3">
                                <div class="fw-bold" style="font-size: 0.875rem;">${activity.name}</div>
                                <small class="text-muted">${activity.description || ''}</small>
                            </div>
                        </div>
                    `).join('');
                },

                // ä¿ç•™åŸå‡½æ•°ä»¥å¤‡ç”¨
                renderWeekGrid() {
                    return this.renderFullWeekGrid();
                },
                
                // æ–°å¢ï¼šåˆ·æ–°æ´»åŠ¨æ± æ–¹æ³•
                refreshActivityPool() {
                    console.log('Refreshing activity pool...');
                    const activityPool = document.getElementById('activity-pool');
                    if (!activityPool) {
                        console.error('Activity pool not found');
                        return;
                    }

                    // é”€æ¯ç°æœ‰çš„ Sortable å®ä¾‹
                    if (activityPool.sortableInstance) {
                        activityPool.sortableInstance.destroy();
                        activityPool.sortableInstance = null;
                    }
                    activityPool.classList.remove('sortable-initialized');

                    // è§¦å‘Alpine.jsé‡æ–°æ¸²æŸ“æ´»åŠ¨æ± ï¼ˆx-htmlä¼šè‡ªåŠ¨é‡æ–°æ¸²æŸ“ï¼‰
                    console.log('Triggering Alpine.js re-render for activity pool');

                    // ç­‰å¾…Alpine.jsé‡æ–°æ¸²æŸ“å®Œæˆï¼Œç„¶åé‡æ–°åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
                    this.$nextTick(() => {
                        console.log('Activity pool re-rendered, re-initializing drag and drop');
                        this.initActivityPoolDragAndDrop();
                    });
                },

                // æ–°å¢ï¼šéªŒè¯æ‹–æ‹½ç›®æ ‡æœ‰æ•ˆæ€§
                validateDropTarget(targetElement, targetRect) {
                    // æ£€æŸ¥åŸºæœ¬æœ‰æ•ˆæ€§
                    if (!targetElement || !targetElement.classList.contains('time-slot')) {
                        return false;
                    }

                    // æ£€æŸ¥å…ƒç´ æ˜¯å¦å¯è§å’Œæœ‰è¾¹ç•Œ
                    if (targetRect.width === 0 || targetRect.height === 0) {
                        console.warn('ç›®æ ‡å…ƒç´ è¾¹ç•Œä¸º0');
                        return false;
                    }

                    // æ£€æŸ¥å…ƒç´ æ˜¯å¦åœ¨è§†å£å†…
                    if (targetRect.left === 0 && targetRect.top === 0 &&
                        targetRect.right === 0 && targetRect.bottom === 0) {
                        console.warn('ç›®æ ‡å…ƒç´ ä½ç½®å…¨ä¸º0');
                        return false;
                    }

                    // æ£€æŸ¥CSSæ˜¾ç¤ºçŠ¶æ€
                    const computedStyle = window.getComputedStyle(targetElement);
                    if (computedStyle.display === 'none' || computedStyle.visibility === 'hidden') {
                        console.warn('ç›®æ ‡å…ƒç´ è¢«éšè—');
                        return false;
                    }

                    return true;
                },

                // æ–°å¢ï¼šæ ¹æ®é¼ æ ‡ä½ç½®æ‰¾åˆ°æœ€è¿‘çš„æœ‰æ•ˆæ—¶é—´æ§½
                findNearestValidTimeSlot(mouseEvent) {
                    if (!mouseEvent) {
                        console.warn('æ²¡æœ‰é¼ æ ‡äº‹ä»¶ä¿¡æ¯');
                        return null;
                    }

                    const mouseX = mouseEvent.clientX || mouseEvent.pageX;
                    const mouseY = mouseEvent.clientY || mouseEvent.pageY;

                    console.log('é¼ æ ‡ä½ç½®:', { x: mouseX, y: mouseY });

                    // è·å–æ‰€æœ‰æœ‰æ•ˆçš„æ—¶é—´æ§½
                    const timeSlots = Array.from(document.querySelectorAll('.time-slot')).filter(slot => {
                        const rect = slot.getBoundingClientRect();
                        return this.validateDropTarget(slot, rect);
                    });

                    console.log('æ‰¾åˆ°æœ‰æ•ˆæ—¶é—´æ§½æ•°é‡:', timeSlots.length);

                    if (timeSlots.length === 0) {
                        return null;
                    }

                    // æ‰¾åˆ°è·ç¦»é¼ æ ‡æœ€è¿‘çš„æ—¶é—´æ§½
                    let nearestSlot = null;
                    let minDistance = Infinity;

                    timeSlots.forEach(slot => {
                        const rect = slot.getBoundingClientRect();
                        const centerX = rect.left + rect.width / 2;
                        const centerY = rect.top + rect.height / 2;

                        const distance = Math.sqrt(
                            Math.pow(mouseX - centerX, 2) + Math.pow(mouseY - centerY, 2)
                        );

                        if (distance < minDistance) {
                            minDistance = distance;
                            nearestSlot = slot;
                        }
                    });

                    console.log('æœ€è¿‘æ—¶é—´æ§½è·ç¦»:', minDistance);
                    return nearestSlot;
                },

                // æ–°å¢ï¼šéªŒè¯æ´»åŠ¨æ± çŠ¶æ€
                verifyActivityPoolState() {
                    console.log('Verifying activity pool state...');
                    const activityPool = document.getElementById('activity-pool');
                    if (!activityPool) {
                        console.error('Activity pool not found during verification');
                        return;
                    }

                    const currentCards = activityPool.querySelectorAll('.activity-card');
                    const expectedCount = this.flatActivities.length;

                    console.log('Activity pool verification:', {
                        currentCards: currentCards.length,
                        expectedCount: expectedCount,
                        isInitialized: activityPool.classList.contains('sortable-initialized')
                    });

                    // å¦‚æœå¡ç‰‡æ•°é‡ä¸åŒ¹é…æˆ–è€…æ²¡æœ‰åˆå§‹åŒ–ï¼Œåˆ·æ–°æ´»åŠ¨æ± 
                    if (currentCards.length !== expectedCount || !activityPool.classList.contains('sortable-initialized')) {
                        console.warn('Activity pool state incorrect, refreshing...');
                        this.refreshActivityPool();
                    } else {
                        console.log('Activity pool state verified - all good');
                    }
                },

                // æ–°å¢ï¼šä»…åˆå§‹åŒ–æ´»åŠ¨æ± çš„æ‹–æ‹½åŠŸèƒ½
                initActivityPoolDragAndDrop() {
                    console.log('Initializing activity pool drag and drop...');
                    const activityPool = document.getElementById('activity-pool');
                    if (!activityPool || activityPool.classList.contains('sortable-initialized')) {
                        console.log('Activity pool already initialized or not found');
                        return;
                    }

                    const self = this;

                    activityPool.sortableInstance = Sortable.create(activityPool, {
                        group: {
                            name: 'activities',
                            pull: 'clone', // ç¡®ä¿æ˜¯å…‹éš†æ¨¡å¼
                            put: function(to, from) {
                                // åªå…è®¸ä»time-slotæ‹–æ‹½å›æ´»åŠ¨æ± ï¼ˆåˆ é™¤åŠŸèƒ½ï¼‰
                                return from.classList && from.classList.contains('time-slot');
                            }
                        },
                        sort: false, // æ´»åŠ¨æ± å†…ä¸å…è®¸æ’åº
                        animation: 200,
                        ghostClass: 'sortable-ghost',
                        chosenClass: 'sortable-chosen',
                        dragClass: 'sortable-drag',
                        // å…³é”®ï¼šç¡®ä¿å…‹éš†è¡Œä¸ºæ­£ç¡®
                        onClone: function(evt) {
                            console.log('Activity cloned from pool:', evt.clone);
                            const originalId = evt.item.getAttribute('data-activity-id');
                            if (originalId) {
                                evt.clone.setAttribute('data-activity-id', originalId);
                            }
                        },
                        // ä»æ´»åŠ¨æ± å¼€å§‹æ‹–æ‹½æ—¶
                        onStart: function(evt) {
                            console.log('Drag started from activity pool:', evt.item.getAttribute('data-activity-id'));
                            evt.item.classList.add('dragging-from-pool');
                        },
                        // æ‹–æ‹½ç»“æŸæ—¶çš„æ¸…ç†å’Œæ¢å¤
                        onEnd: function(evt) {
                            console.log('Drag ended from activity pool');

                            // æ¸…ç†æ ‡è®°
                            if (evt.item) {
                                evt.item.classList.remove('dragging-from-pool');
                            }

                            // æ£€æŸ¥æ´»åŠ¨æ± çŠ¶æ€
                            const currentCards = activityPool.querySelectorAll('.activity-card');
                            console.log('Activity pool cards after drag:', currentCards.length, 'Expected:', self.flatActivities.length);

                            // å¦‚æœå¡ç‰‡æ•°é‡ä¸åŒ¹é…ï¼Œå¼ºåˆ¶åˆ·æ–°
                            if (currentCards.length !== self.flatActivities.length) {
                                console.warn('Activity pool cards count mismatch, forcing refresh');
                                setTimeout(() => {
                                    self.refreshActivityPool();
                                }, 100);
                            }
                        },
                        // å¤„ç†åˆ é™¤æ“ä½œï¼ˆä»æ—¶é—´æ§½æ‹–å›æ´»åŠ¨æ± ï¼‰
                        onAdd: function(evt) {
                            console.log('Item dropped back to activity pool - deleting event');
                            evt.item.remove();
                            // åˆ é™¤æ“ä½œç”±æ—¶é—´æ§½çš„ onRemove å¤„ç†
                        }
                    });

                    activityPool.classList.add('sortable-initialized');
                    console.log('Activity pool sortable initialized successfully');
                },

                // å·¥å…·æ–¹æ³•
                getCurrentDateString() {
                    return this.currentDate.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        weekday: 'long'
                    });
                },
                
                getWeekTitle() {
                    if (this.weekDates.length === 0) return '';
                    const start = new Date(this.weekDates[0]);
                    const end = new Date(this.weekDates[6]);
                    return `${start.getMonth() + 1}æœˆ${start.getDate()}æ—¥ - ${end.getMonth() + 1}æœˆ${end.getDate()}æ—¥`;
                },
                
                getMonthTitle() {
                    return `${this.currentYear}å¹´${this.currentMonth}æœˆ`;
                },
                
                // æœˆè§†å›¾ç›¸å…³æ–¹æ³•
                previousMonth() {
                    this.currentMonth--;
                    if (this.currentMonth < 1) {
                        this.currentMonth = 12;
                        this.currentYear--;
                    }
                    this.loadMonthSchedule();
                },
                
                nextMonth() {
                    this.currentMonth++;
                    if (this.currentMonth > 12) {
                        this.currentMonth = 1;
                        this.currentYear++;
                    }
                    this.loadMonthSchedule();
                },
                
                async loadMonthSchedule() {
                    try {
                        console.log(`Loading month schedule for ${this.currentYear}-${this.currentMonth}`);
                        
                        // æ¸²æŸ“æœˆå†ï¼ˆç°åœ¨ç›´æ¥åœ¨renderMonthCalendarä¸­åŠ è½½æ•°æ®ï¼‰
                        await this.renderMonthCalendar();
                        
                        console.log('Month schedule loaded and rendered');
                    } catch (error) {
                        console.error('åŠ è½½æœˆæ—¥ç¨‹å¤±è´¥:', error);
                        const monthCalendarContainer = document.getElementById('month-calendar');
                        if (monthCalendarContainer) {
                            monthCalendarContainer.innerHTML = '<p class="text-danger">åŠ è½½æœˆè§†å›¾å¤±è´¥</p>';
                        }
                    }
                },
                
                // æ±‡æ€»è§†å›¾ç›¸å…³æ–¹æ³•
                async initSummaryData() {
                    console.log('Initializing summary data...');
                    await this.generateAvailableMonths();
                    await this.loadSummaryStatistics();
                    await this.loadActivityStatistics();
                },
                
                generateAvailableMonths() {
                    // ç”Ÿæˆå¯é€‰æ‹©çš„æœˆä»½åˆ—è¡¨ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼ŒåŸºäºå½“å‰æ—¥æœŸï¼‰
                    const now = new Date();
                    const months = [];
                    
                    // æ·»åŠ å½“å‰æœˆå’Œå‰é¢å‡ ä¸ªæœˆ
                    for (let i = 2; i >= 0; i--) {
                        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                        months.push({
                            value: `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`,
                            label: `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ`
                        });
                    }
                    
                    this.availableMonths = months;
                    console.log('Available months:', this.availableMonths);
                },
                
                async loadSummaryStatistics() {
                    try {
                        console.log('Loading summary statistics for month:', this.summaryMonth);
                        let endpoint = '/statistics/summary';
                        
                        // å¦‚æœé€‰æ‹©äº†ç‰¹å®šæœˆä»½ï¼Œæ·»åŠ æŸ¥è¯¢å‚æ•°ï¼ˆå‡è®¾åç«¯æ”¯æŒï¼‰
                        if (this.summaryMonth) {
                            endpoint += `?month=${this.summaryMonth}`;
                        }
                        
                        this.summaryStats = await this.apiCall(endpoint);
                        console.log('Summary statistics loaded:', this.summaryStats);
                    } catch (error) {
                        console.error('Failed to load summary statistics:', error);
                        this.summaryStats = {
                            total_activities: 0,
                            total_events: 0,
                            completed_events: 0,
                            completion_rate: 0
                        };
                    }
                },
                
                async loadActivityStatistics() {
                    try {
                        console.log('Loading activity statistics...');
                        this.activityStats = {};
                        
                        // ä¸ºæ¯ä¸ªæ´»åŠ¨åŠ è½½ç»Ÿè®¡æ•°æ®
                        for (const activity of this.flatActivities) {
                            const stats = await this.apiCall(`/statistics/activities/${activity.id}/statistics`);
                            this.activityStats[activity.id] = stats;
                            console.log(`Stats for ${activity.name}:`, stats);
                        }
                    } catch (error) {
                        console.error('Failed to load activity statistics:', error);
                        this.activityStats = {};
                    }
                },
                
                formatWeekday(dateString) {
                    const date = new Date(dateString);
                    return ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'][date.getDay() === 0 ? 6 : date.getDay() - 1];
                },
                
                formatDate(dateString) {
                    const date = new Date(dateString);
                    return `${date.getMonth() + 1}/${date.getDate()}`;
                },
                
                // æœˆå†æ¸²æŸ“ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼Œæ˜¾ç¤ºäº‹ä»¶æ•°é‡ï¼‰
                async renderMonthCalendar() {
                    try {
                        // é‡æ–°åŠ è½½æœˆæ•°æ®ä»¥è·å–å®Œæ•´çš„å¤©æ•°ä¿¡æ¯
                        const data = await this.apiCall(`/calendar/month/${this.currentYear}/${this.currentMonth}`);
                        
                        if (!data.days || data.days.length === 0) {
                            const monthCalendarContainer = document.getElementById('month-calendar');
                            if (monthCalendarContainer) {
                                monthCalendarContainer.innerHTML = '<p class="text-muted">æ— æ³•åŠ è½½æœˆè§†å›¾æ•°æ®</p>';
                            }
                            return;
                        }
                        
                        const firstDay = new Date(this.currentYear, this.currentMonth - 1, 1);
                        const lastDay = new Date(this.currentYear, this.currentMonth, 0);
                        
                        // è®¡ç®—æœˆå†åº”è¯¥ä»å“ªä¸€å¤©å¼€å§‹ï¼ˆå‘¨ä¸€ï¼‰
                        const startDate = new Date(firstDay);
                        const dayOfWeek = firstDay.getDay() === 0 ? 7 : firstDay.getDay();
                        startDate.setDate(firstDay.getDate() - dayOfWeek + 1);
                        
                        // è®¡ç®—æœˆå†åº”è¯¥åˆ°å“ªä¸€å¤©ç»“æŸï¼ˆç¡®ä¿å®Œæ•´çš„å‘¨ï¼‰
                        const endDate = new Date(lastDay);
                        const endDayOfWeek = lastDay.getDay() === 0 ? 7 : lastDay.getDay();
                        endDate.setDate(lastDay.getDate() + (7 - endDayOfWeek));
                        
                        // åˆ›å»ºæ—¥æœŸåˆ°äº‹ä»¶æ•°é‡çš„æ˜ å°„
                        const dayEventsMap = {};
                        data.days.forEach(day => {
                            dayEventsMap[day.date] = {
                                event_count: day.event_count,
                                is_today: day.is_today
                            };
                        });
                        
                        let html = '';
                        let currentDate = new Date(startDate);
                        
                        // æŒ‰å‘¨æ¸²æŸ“
                        while (currentDate <= endDate) {
                            html += '<div class="row mb-1">';
                            
                            // ä¸€å‘¨7å¤©
                            for (let i = 0; i < 7; i++) {
                                const dateStr = currentDate.toISOString().split('T')[0];
                                const dayData = dayEventsMap[dateStr] || { event_count: 0, is_today: false };
                                const isCurrentMonth = currentDate.getMonth() === this.currentMonth - 1;
                                
                                let cellClass = 'col border p-2';
                                if (!isCurrentMonth) {
                                    cellClass += ' text-muted bg-light';
                                }
                                if (dayData.is_today) {
                                    cellClass += ' bg-warning bg-opacity-25 fw-bold';
                                }
                                
                                html += `<div class="${cellClass}" style="min-height: 100px;">`;
                                html += `<div class="fw-bold">${currentDate.getDate()}</div>`;
                                
                                // æ˜¾ç¤ºäº‹ä»¶æ•°é‡
                                if (dayData.event_count > 0) {
                                    html += `
                                        <div class="mt-2">
                                            <span class="badge bg-primary">${dayData.event_count} ä¸ªæ—¥ç¨‹</span>
                                        </div>
                                    `;
                                }
                                
                                html += '</div>';
                                
                                // ç§»åŠ¨åˆ°ä¸‹ä¸€å¤©
                                currentDate.setDate(currentDate.getDate() + 1);
                            }
                            
                            html += '</div>';
                        }
                        
                        // æ›´æ–°DOM
                        const monthCalendarContainer = document.getElementById('month-calendar');
                        if (monthCalendarContainer) {
                            monthCalendarContainer.innerHTML = html;
                        }
                    } catch (error) {
                        console.error('æ¸²æŸ“æœˆå†å¤±è´¥:', error);
                        const monthCalendarContainer = document.getElementById('month-calendar');
                        if (monthCalendarContainer) {
                            monthCalendarContainer.innerHTML = '<p class="text-danger">åŠ è½½æœˆè§†å›¾å¤±è´¥</p>';
                        }
                    }
                },
                
                // è·å–æ—¶é—´æ§½åç§°çš„è¾…åŠ©æ–¹æ³•
                getTimeSlotName(timeSlotValue) {
                    const slot = this.timeSlots.find(s => s.value === timeSlotValue);
                    return slot ? slot.name.replace('ç¬¬1æ—¶æ®µ', '1').replace('ç¬¬2æ—¶æ®µ', '2').replace('æ—¶æ®µ', '') : `æ—¶æ®µ${timeSlotValue}`;
                }
            }
        }

        // å…¨å±€è¾…åŠ©å‡½æ•°
        async function deleteActivity(activityId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ´»åŠ¨å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰ç›¸å…³çš„æ—¥ç¨‹å®‰æ’ã€‚')) {
                try {
                    await fetch(`/api/activities/${activityId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    // åˆ·æ–°é¡µé¢
                    location.reload();
                } catch (error) {
                    console.error('åˆ é™¤æ´»åŠ¨å¤±è´¥:', error);
                    alert('åˆ é™¤å¤±è´¥');
                }
            }
        }
    </script>
</body>
</html>