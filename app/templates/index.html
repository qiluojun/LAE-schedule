<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAE - ‰∏™‰∫∫Êó•Á®ã‰∏é‰∏ªÊîØÁ∫øÁÆ°ÁêÜÁ≥ªÁªü v16 Summary Stats</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.0/dist/cdn.min.js"></script>
    <!-- SortableJS -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <style>
        .time-slot {
            min-height: 80px;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            background-color: #f8f9fa;
            transition: background-color 0.2s;
        }
        .time-slot:hover {
            background-color: #e9ecef;
        }
        .time-slot.occupied {
            background-color: #d4edda;
        }
        .activity-card {
            cursor: grab;
            transition: transform 0.2s;
        }
        .activity-card:hover {
            transform: translateY(-2px);
        }
        .activity-card:active {
            cursor: grabbing;
        }
        .sortable-chosen {
            opacity: 0.8;
            transform: rotate(3deg);
        }
        .sortable-drag {
            opacity: 0.8;
            transform: rotate(5deg);
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }
        .sortable-ghost {
            opacity: 0.4;
            background: #e3f2fd;
            border: 2px dashed #2196f3;
        }
        .time-slot.sortable-over {
            background-color: #e8f5e8;
            border-color: #4caf50;
            transform: scale(1.02);
        }
        .scheduled-event {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 0.25rem;
            padding: 0.5rem;
            margin: 0.25rem 0;
            cursor: pointer;
        }
        .scheduled-event:hover {
            background-color: #fff2a8;
        }
        .activity-pool {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 1rem;
            background-color: #f8f9fa;
        }
        .week-grid {
            display: grid;
            grid-template-columns: auto repeat(7, 1fr);
            gap: 1px;
            background-color: #dee2e6;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .week-header {
            background-color: #6c757d;
            color: white;
            text-align: center;
            padding: 0.5rem;
            font-weight: bold;
        }
        .time-label {
            background-color: #495057;
            color: white;
            text-align: center;
            padding: 0.75rem 0.5rem;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div x-data="laeApp()" class="container-fluid">
        <!-- ÂØºËà™Ê†è -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-3">
            <div class="container-fluid">
                <span class="navbar-brand">LAE - Êó•Á®ãÁÆ°ÁêÜÁ≥ªÁªü</span>
                
                <!-- ËßÜÂõæÂàáÊç¢ÊåâÈíÆ -->
                <div class="navbar-nav me-auto">
                    <button 
                        class="nav-link btn btn-link"
                        :class="{ 'active text-warning': currentView === 'summary' }"
                        @click="switchView('summary')"
                    >
                        Ê±áÊÄªËßÜÂõæ
                    </button>
                    <button 
                        class="nav-link btn btn-link"
                        :class="{ 'active text-warning': currentView === 'week' }"
                        @click="switchView('week')"
                    >
                        Âë®ËßÜÂõæ
                    </button>
                    <button 
                        class="nav-link btn btn-link"
                        :class="{ 'active text-warning': currentView === 'month' }"
                        @click="switchView('month')"
                    >
                        ÊúàËßÜÂõæ
                    </button>
                </div>
                
                <!-- ÂΩìÂâçÊó•ÊúüÊòæÁ§∫ -->
                <div class="navbar-text text-light">
                    <span x-text="getCurrentDateString()"></span>
                </div>
            </div>
        </nav>

        <!-- Ê±áÊÄªËßÜÂõæ -->
        <div x-show="currentView === 'summary'" class="row">
            <!-- ÁªüËÆ°‰ª™Ë°®Êùø -->
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Êï∞ÊçÆÁªüËÆ°</h5>
                        <div class="d-flex align-items-center">
                            <select class="form-select form-select-sm me-2" x-model="summaryMonth" @change="loadSummaryStatistics()">
                                <option value="">ÂÖ®ÈÉ®Êó∂Èó¥</option>
                                <template x-for="month in availableMonths" :key="month.value">
                                    <option :value="month.value" x-text="month.label"></option>
                                </template>
                            </select>
                            <button class="btn btn-outline-primary btn-sm" @click="loadSummaryStatistics()">
                                üìä Âà∑Êñ∞ÁªüËÆ°
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row" x-show="summaryStats">
                            <div class="col-md-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <h4 x-text="summaryStats?.total_events || 0"></h4>
                                        <p class="mb-0">ÊÄªÂÆâÊéíÊ¨°Êï∞</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h4 x-text="summaryStats?.completed_events || 0"></h4>
                                        <p class="mb-0">Â∑≤ÂÆåÊàêÊ¨°Êï∞</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning text-white">
                                    <div class="card-body text-center">
                                        <h4 x-text="Math.round((summaryStats?.completion_rate || 0) * 100) + '%'"></h4>
                                        <p class="mb-0">ÂÆåÊàêÁéá</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h4 x-text="summaryStats?.total_activities || 0"></h4>
                                        <p class="mb-0">Ê¥ªÂä®ÊÄªÊï∞</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ê¥ªÂä®ÁÆ°ÁêÜ -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Ê¥ªÂä®ÁÆ°ÁêÜ</h5>
                        <button class="btn btn-primary btn-sm" @click="showNewActivityModal = true">
                            + Êñ∞Âª∫Ê¥ªÂä®
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="activity-tree" class="mt-3">
                            <!-- Ê¥ªÂä®Ê†ëÂ∞ÜÂú®ËøôÈáåÊ∏≤Êüì -->
                            <div x-html="renderActivityTreeWithStats()"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Âë®ËßÜÂõæ -->
        <div x-show="currentView === 'week'" class="row">
            <!-- Ê¥ªÂä®Ê±† -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Ê¥ªÂä®Âç°ÁâáÊ±†</h6>
                    </div>
                    <div class="card-body">
                        <div class="activity-pool" id="activity-pool">
                            <template x-for="activity in flatActivities" :key="activity.id">
                                <div class="activity-card card mb-2" 
                                     :data-activity-id="activity.id">
                                    <div class="card-body py-2 px-3">
                                        <div class="fw-bold" style="font-size: 0.875rem;" x-text="activity.name"></div>
                                        <small class="text-muted" x-text="activity.description || ''"></small>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Âë®Êó•Á®ãÁΩëÊ†º -->
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <button class="btn btn-outline-primary btn-sm" @click="previousWeek()">
                                ‚Äπ ‰∏ä‰∏ÄÂë®
                            </button>
                            <span class="mx-3 fw-bold" x-text="getWeekTitle()"></span>
                            <button class="btn btn-outline-primary btn-sm" @click="nextWeek()">
                                ‰∏ã‰∏ÄÂë® ‚Ä∫
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="week-grid" id="week-grid" x-html="renderFullWeekGrid()">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÊúàËßÜÂõæ -->
        <div x-show="currentView === 'month'">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <button class="btn btn-outline-primary btn-sm" @click="previousMonth()">
                            ‚Äπ ‰∏ä‰∏™Êúà
                        </button>
                        <span class="mx-3 fw-bold" x-text="getMonthTitle()"></span>
                        <button class="btn btn-outline-primary btn-sm" @click="nextMonth()">
                            ‰∏ã‰∏™Êúà ‚Ä∫
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row text-center fw-bold mb-2">
                        <div class="col">Âë®‰∏Ä</div>
                        <div class="col">Âë®‰∫å</div>
                        <div class="col">Âë®‰∏â</div>
                        <div class="col">Âë®Âõõ</div>
                        <div class="col">Âë®‰∫î</div>
                        <div class="col">Âë®ÂÖ≠</div>
                        <div class="col">Âë®Êó•</div>
                    </div>
                    <div id="month-calendar">
                        <!-- ÊúàÂéÜÂ∞ÜÂú®ËøôÈáåÊ∏≤Êüì -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Êñ∞Âª∫Ê¥ªÂä®Ê®°ÊÄÅÊ°Ü -->
        <div x-show="showNewActivityModal" class="modal" :class="{ 'd-block': showNewActivityModal }" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Êñ∞Âª∫Ê¥ªÂä®</h5>
                        <button type="button" class="btn-close" @click="showNewActivityModal = false"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="createActivity()">
                            <div class="mb-3">
                                <label class="form-label">Ê¥ªÂä®ÂêçÁß∞</label>
                                <input type="text" class="form-control" x-model="newActivity.name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Áà∂Ê¥ªÂä®</label>
                                <select class="form-control" x-model="newActivity.parent_id">
                                    <option value="">Êó†ÔºàÈ°∂Á∫ßÊ¥ªÂä®Ôºâ</option>
                                    <template x-for="activity in flatActivities" :key="activity.id">
                                        <option :value="activity.id" x-text="activity.name"></option>
                                    </template>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ÊèèËø∞</label>
                                <textarea class="form-control" rows="3" x-model="newActivity.description"></textarea>
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-secondary me-2" @click="showNewActivityModal = false">ÂèñÊ∂à</button>
                                <button type="submit" class="btn btn-primary">ÂàõÂª∫</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÁºñËæëÊ¥ªÂä®Ê®°ÊÄÅÊ°Ü -->
        <div x-show="showEditActivityModal" class="modal" :class="{ 'd-block': showEditActivityModal }" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ÁºñËæëÊ¥ªÂä®</h5>
                        <button type="button" class="btn-close" @click="showEditActivityModal = false"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="updateActivity()">
                            <div class="mb-3">
                                <label class="form-label">Ê¥ªÂä®ÂêçÁß∞</label>
                                <input type="text" class="form-control" x-model="editingActivity.name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ÊèèËø∞</label>
                                <textarea class="form-control" rows="3" x-model="editingActivity.description"></textarea>
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-secondary me-2" @click="showEditActivityModal = false">ÂèñÊ∂à</button>
                                <button type="submit" class="btn btn-primary">‰øùÂ≠ò</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÁºñËæëÊó•Á®ãÊ®°ÊÄÅÊ°Ü - Âè™Âú®Âë®ËßÜÂõæ‰∏≠ÊòæÁ§∫ -->
        <div x-show="showEditEventModal && currentView === 'week'" class="modal" :class="{ 'd-block': showEditEventModal && currentView === 'week' }" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ÁºñËæëÊó•Á®ã</h5>
                        <button type="button" class="btn-close" @click="forceCloseModal()"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="saveScheduledEvent()">
                            <div class="mb-3">
                                <label class="form-label">Êó•ÊúüÊó∂Èó¥</label>
                                <div class="row">
                                    <div class="col-8">
                                        <input type="date" class="form-control" x-model="editingEvent.event_date" required readonly>
                                    </div>
                                    <div class="col-4">
                                        <select class="form-control" x-model="editingEvent.time_slot" required>
                                            <template x-for="slot in timeSlots" :key="slot.value">
                                                <option :value="slot.value" x-text="slot.name"></option>
                                            </template>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3" x-show="editingEvent.activity_name">
                                <label class="form-label">Ê¥ªÂä®</label>
                                <input type="text" class="form-control" :value="editingEvent.activity_name" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ÁõÆÊ†á</label>
                                <input type="text" class="form-control" x-model="editingEvent.goal" placeholder="Êú¨Ê¨°Ë¶ÅËææÊàêÁöÑÂÖ∑‰ΩìÁõÆÊ†á">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Â§áÊ≥®</label>
                                <textarea class="form-control" rows="3" x-model="editingEvent.notes" placeholder="È¢ùÂ§ñÂ§áÊ≥®‰ø°ÊÅØ"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Áä∂ÊÄÅ</label>
                                <select class="form-control" x-model="editingEvent.status">
                                    <option value="planned">ËÆ°Âàí‰∏≠</option>
                                    <option value="completed">Â∑≤ÂÆåÊàê</option>
                                </select>
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-danger me-2" @click="deleteScheduledEvent()" x-show="editingEvent.id">Âà†Èô§</button>
                                <button type="button" class="btn btn-secondary me-2" @click="forceCloseModal()">ÂèñÊ∂à</button>
                                <button type="submit" class="btn btn-primary">‰øùÂ≠ò</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Áõ¥Êé•ÂµåÂÖ•JavaScript‰ª£Á†Å‰ª•ÈÅøÂÖçË∑ØÂæÑÈóÆÈ¢ò
        function laeApp() {
            return {
                // ÂΩìÂâçËßÜÂõæÁä∂ÊÄÅ
                currentView: 'week',
                
                // Êó•ÊúüÁä∂ÊÄÅ
                currentDate: new Date(),
                currentWeekStart: null,
                currentMonth: new Date().getMonth() + 1,
                currentYear: new Date().getFullYear(),
                
                // Êï∞ÊçÆÁä∂ÊÄÅ
                activities: [],
                flatActivities: [],
                weekSchedule: {},
                monthSchedule: {},
                
                // Ê±áÊÄªËßÜÂõæÊï∞ÊçÆ
                summaryStats: null,
                summaryMonth: '',
                availableMonths: [],
                activityStats: {},
                
                // Êó∂Èó¥ÊßΩÈÖçÁΩÆ
                timeSlots: [
                    { value: 21, name: '‰∏äÂçàÁ¨¨1Êó∂ÊÆµ' },
                    { value: 22, name: '‰∏äÂçàÁ¨¨2Êó∂ÊÆµ' },
                    { value: 51, name: '‰∏ãÂçàÁ¨¨1Êó∂ÊÆµ' },
                    { value: 52, name: '‰∏ãÂçàÁ¨¨2Êó∂ÊÆµ' },
                    { value: 71, name: 'Êôö‰∏äÊó∂ÊÆµ' }
                ],
                
                // Ê®°ÊÄÅÊ°ÜÁä∂ÊÄÅ
                showNewActivityModal: false,
                showEditActivityModal: false,
                showEditEventModal: false,
                
                // Ë°®ÂçïÊï∞ÊçÆ
                newActivity: {
                    name: '',
                    parent_id: '',
                    description: ''
                },
                
                editingActivity: {
                    id: null,
                    name: '',
                    description: ''
                },
                
                editingEvent: {
                    id: null,
                    activity_id: null,
                    activity_name: '',
                    event_date: '',
                    time_slot: 21,
                    goal: '',
                    notes: '',
                    status: 'planned'
                },
                
                // Âë®Êï∞ÊçÆ
                weekDates: [],
                
                // Âº∫Âà∂ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                forceCloseModal() {
                    console.log('Force closing modal');
                    console.log('Before reset - showEditEventModal:', this.showEditEventModal);
                    console.log('Before reset - currentView:', this.currentView);
                    
                    this.showEditEventModal = false;
                    this.showNewActivityModal = false;
                    this.showEditActivityModal = false;
                    
                    console.log('After reset - showEditEventModal:', this.showEditEventModal);
                    console.log('Modal condition check:', this.showEditEventModal && this.currentView === 'week');
                    
                    // ÈáçÁΩÆÁºñËæë‰∫ã‰ª∂Êï∞ÊçÆ
                    this.editingEvent = {
                        id: null,
                        activity_id: null,
                        activity_name: '',
                        event_date: '',
                        time_slot: 21,
                        goal: '',
                        notes: '',
                        status: 'planned'
                    };
                    
                    // ÈáçÁΩÆÁºñËæëÊ¥ªÂä®Êï∞ÊçÆ
                    this.editingActivity = {
                        id: null,
                        name: '',
                        description: ''
                    };
                },
                
                // ÂàùÂßãÂåñ
                async init() {
                    console.log('Initializing LAE App... v9 - Debug Enhanced');
                    console.log('Initial view:', this.currentView);
                    console.log('Time slots configuration:', this.timeSlots);
                    
                    // ÂàõÂª∫ÂÖ®Â±ÄÂºïÁî®‰ª•‰æøHTML onclickËÆøÈóÆ
                    window.laeAppInstance = this;
                    
                    // Âº∫Âà∂ÈáçÁΩÆÊâÄÊúâÊ®°ÊÄÅÊ°ÜÁä∂ÊÄÅ
                    this.forceCloseModal();
                    
                    await this.loadActivities();
                    console.log('Activities loaded, count:', this.flatActivities.length);
                    
                    this.updateWeekDates();
                    console.log('Week dates updated:', this.weekDates);
                    
                    // Ê†πÊçÆÂΩìÂâçËßÜÂõæÂä†ËΩΩÊï∞ÊçÆ
                    if (this.currentView === 'week') {
                        await this.loadWeekSchedule();
                    } else if (this.currentView === 'month') {
                        await this.loadMonthSchedule();
                    } else if (this.currentView === 'summary') {
                        await this.initSummaryData();
                    }
                    
                    // Á°Æ‰øùDOMÊ∏≤ÊüìÂÆåÊàêÂêéÂàùÂßãÂåñÊãñÊãΩÂäüËÉΩ
                    this.$nextTick(() => {
                        console.log('DOM updated, initializing drag and drop in 300ms...');
                        
                        // Â¶ÇÊûúÊòØÂë®ËßÜÂõæÔºåÊâãÂä®Ê∏≤ÊüìÁΩëÊ†º
                        if (this.currentView === 'week') {
                            const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                            if (gridContainer) {
                                gridContainer.innerHTML = this.renderFullWeekGrid();
                                console.log('Week grid manually rendered');
                            }
                        }
                        
                        setTimeout(() => {
                            this.initDragAndDrop();
                        }, 300);
                    });
                },
                
                // APIË∞ÉÁî®ÊñπÊ≥ï
                async apiCall(endpoint, options = {}) {
                    try {
                        const response = await fetch(`/api${endpoint}`, {
                            headers: {
                                'Content-Type': 'application/json',
                                ...options.headers
                            },
                            ...options
                        });
                        
                        if (!response.ok) {
                            throw new Error(`APIÈîôËØØ: ${response.status}`);
                        }
                        
                        return await response.json();
                    } catch (error) {
                        console.error('APIË∞ÉÁî®Â§±Ë¥•:', error);
                        alert('Êìç‰ΩúÂ§±Ë¥•: ' + error.message);
                        throw error;
                    }
                },
                
                // Âä†ËΩΩÊ¥ªÂä®Êï∞ÊçÆ
                async loadActivities() {
                    try {
                        this.activities = await this.apiCall('/activities/tree');
                        this.flatActivities = await this.apiCall('/activities/');
                        console.log('Activities loaded:', this.flatActivities.length);
                    } catch (error) {
                        console.error('Âä†ËΩΩÊ¥ªÂä®Â§±Ë¥•:', error);
                    }
                },
                
                // ÂàõÂª∫Êñ∞Ê¥ªÂä®
                async createActivity() {
                    try {
                        const activityData = {
                            name: this.newActivity.name,
                            description: this.newActivity.description || null,
                            parent_id: this.newActivity.parent_id || null
                        };
                        
                        await this.apiCall('/activities/', {
                            method: 'POST',
                            body: JSON.stringify(activityData)
                        });
                        
                        // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
                        await this.loadActivities();
                        
                        // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°ÜÂπ∂ÈáçÁΩÆË°®Âçï
                        this.showNewActivityModal = false;
                        this.newActivity = { name: '', parent_id: '', description: '' };
                        
                        // Â¶ÇÊûúÂú®Ê±áÊÄªËßÜÂõæÔºåÈáçÊñ∞Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆ
                        if (this.currentView === 'summary') {
                            await this.initSummaryData();
                        }
                        
                    } catch (error) {
                        console.error('ÂàõÂª∫Ê¥ªÂä®Â§±Ë¥•:', error);
                    }
                },
                
                // ÁºñËæëÊ¥ªÂä®
                editActivity(activityId) {
                    const activity = this.flatActivities.find(a => a.id === activityId);
                    if (!activity) {
                        console.error('Activity not found:', activityId);
                        return;
                    }
                    
                    this.editingActivity = {
                        id: activity.id,
                        name: activity.name,
                        description: activity.description || ''
                    };
                    
                    this.showEditActivityModal = true;
                },
                
                // Êõ¥Êñ∞Ê¥ªÂä®
                async updateActivity() {
                    try {
                        const activityData = {
                            name: this.editingActivity.name,
                            description: this.editingActivity.description || null
                        };
                        
                        await this.apiCall(`/activities/${this.editingActivity.id}`, {
                            method: 'PUT',
                            body: JSON.stringify(activityData)
                        });
                        
                        // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
                        await this.loadActivities();
                        
                        // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°ÜÂπ∂ÈáçÁΩÆË°®Âçï
                        this.showEditActivityModal = false;
                        this.editingActivity = { id: null, name: '', description: '' };
                        
                        // Â¶ÇÊûúÂú®Ê±áÊÄªËßÜÂõæÔºåÈáçÊñ∞Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆ
                        if (this.currentView === 'summary') {
                            await this.initSummaryData();
                        }
                        
                    } catch (error) {
                        console.error('Êõ¥Êñ∞Ê¥ªÂä®Â§±Ë¥•:', error);
                    }
                },
                
                // ËßÜÂõæÂàáÊç¢
                async switchView(view) {
                    console.log('Switching from', this.currentView, 'to', view);
                    this.currentView = view;
                    
                    // ÂàáÊç¢ËßÜÂõæÊó∂Ê∏ÖÁêÜÊâÄÊúâÊ®°ÊÄÅÊ°ÜÁä∂ÊÄÅ
                    this.showNewActivityModal = false;
                    this.showEditActivityModal = false;
                    this.showEditEventModal = false;
                    
                    if (view === 'week') {
                        console.log('Entering week view...');
                        console.log('Current week dates:', this.weekDates);
                        console.log('Time slots:', this.timeSlots);
                        
                        await this.loadWeekSchedule();
                        
                        // Âº∫Âà∂ÈáçÊñ∞Ê∏≤ÊüìÁΩëÊ†º
                        this.$nextTick(() => {
                            // ÊâãÂä®Ëß¶ÂèëÈáçÊñ∞Ê∏≤Êüì
                            const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                            if (gridContainer) {
                                gridContainer.innerHTML = this.renderFullWeekGrid();
                            }
                            
                            console.log('Week view DOM updated, checking elements...');
                            console.log('Activity pool element:', document.getElementById('activity-pool'));
                            console.log('Week grid element:', document.getElementById('week-grid'));
                            console.log('Time slot elements:', document.querySelectorAll('.time-slot').length);
                            
                            setTimeout(() => {
                                this.initDragAndDrop();
                            }, 200);
                        });
                    } else if (view === 'month') {
                        await this.loadMonthSchedule();
                    } else if (view === 'summary') {
                        await this.initSummaryData();
                    }
                },
                
                // Âë®ËßÜÂõæÁõ∏ÂÖ≥ÊñπÊ≥ï
                updateWeekDates() {
                    const start = new Date(this.currentDate);
                    start.setDate(start.getDate() - start.getDay() + 1); // Ëé∑ÂèñÂë®‰∏Ä
                    this.currentWeekStart = new Date(start);
                    
                    this.weekDates = [];
                    for (let i = 0; i < 7; i++) {
                        const date = new Date(start);
                        date.setDate(start.getDate() + i);
                        this.weekDates.push(date.toISOString().split('T')[0]);
                    }
                },
                
                async loadWeekSchedule() {
                    try {
                        const targetDate = this.weekDates[0]; // Âë®‰∏Ä
                        console.log('Loading week schedule for:', targetDate);
                        const data = await this.apiCall(`/calendar/week/${targetDate}`);
                        
                        // ËΩ¨Êç¢Êï∞ÊçÆÊ†ºÂºè‰ª•‰æøÊü•Êâæ
                        this.weekSchedule = {};
                        data.schedule.forEach(day => {
                            this.weekSchedule[day.date] = day.slots;
                        });
                        console.log('Week schedule loaded:', this.weekSchedule);
                        console.log('Schedule data structure:', data);
                    } catch (error) {
                        console.error('Âä†ËΩΩÂë®Êó•Á®ãÂ§±Ë¥•:', error);
                        // Âç≥‰ΩøÂä†ËΩΩÂ§±Ë¥•‰πüË¶ÅÂàùÂßãÂåñÁ©∫ÁöÑÂë®Êó•Á®ãÂØπË±°
                        this.weekSchedule = {};
                    }
                },
                
                getScheduledEvent(date, timeSlot) {
                    return this.weekSchedule[date]?.[timeSlot] || null;
                },
                
                previousWeek() {
                    this.currentDate.setDate(this.currentDate.getDate() - 7);
                    this.updateWeekDates();
                    this.loadWeekSchedule();
                },
                
                nextWeek() {
                    this.currentDate.setDate(this.currentDate.getDate() + 7);
                    this.updateWeekDates();
                    this.loadWeekSchedule();
                },
                
                // Êó•Á®ãÁºñËæë
                editScheduledEvent(date, timeSlot) {
                    console.log('Editing event for:', date, timeSlot, 'Current view:', this.currentView);
                    
                    // Âè™Âú®Âë®ËßÜÂõæ‰∏≠ÂÖÅËÆ∏ÁºñËæë
                    if (this.currentView !== 'week') {
                        console.log('Edit event modal blocked - not in week view');
                        return;
                    }
                    
                    const event = this.getScheduledEvent(date, timeSlot);
                    
                    if (event) {
                        // ÁºñËæëÁé∞Êúâ‰∫ã‰ª∂
                        this.editingEvent = {
                            id: event.id,
                            activity_id: event.activity_id,
                            activity_name: event.activity_name,
                            event_date: date,
                            time_slot: timeSlot,
                            goal: event.goal || '',
                            notes: event.notes || '',
                            status: event.status
                        };
                    } else {
                        // ÂàõÂª∫Êñ∞‰∫ã‰ª∂Ôºà‰ΩÜÈúÄË¶ÅÂÖàÈÄâÊã©Ê¥ªÂä®Ôºâ
                        this.editingEvent = {
                            id: null,
                            activity_id: null,
                            activity_name: '',
                            event_date: date,
                            time_slot: timeSlot,
                            goal: '',
                            notes: '',
                            status: 'planned'
                        };
                    }
                    
                    this.showEditEventModal = true;
                },
                
                async saveScheduledEvent() {
                    try {
                        if (!this.editingEvent.activity_id) {
                            alert('ËØ∑ÂÖàÊãñÊãΩÊ¥ªÂä®Âà∞Êó∂Èó¥ÊßΩ‰∏≠');
                            return;
                        }
                        
                        const eventData = {
                            activity_id: this.editingEvent.activity_id,
                            event_date: this.editingEvent.event_date,
                            time_slot: this.editingEvent.time_slot,
                            goal: this.editingEvent.goal || null,
                            notes: this.editingEvent.notes || null,
                            status: this.editingEvent.status
                        };
                        
                        if (this.editingEvent.id) {
                            // Êõ¥Êñ∞Áé∞Êúâ‰∫ã‰ª∂
                            await this.apiCall(`/events/${this.editingEvent.id}`, {
                                method: 'PUT',
                                body: JSON.stringify(eventData)
                            });
                        } else {
                            // ÂàõÂª∫Êñ∞‰∫ã‰ª∂
                            await this.apiCall('/events/', {
                                method: 'POST',
                                body: JSON.stringify(eventData)
                            });
                        }
                        
                        // Âà∑Êñ∞Êï∞ÊçÆ
                        await this.loadWeekSchedule();
                        this.forceCloseModal();
                        
                    } catch (error) {
                        console.error('‰øùÂ≠òÊó•Á®ãÂ§±Ë¥•:', error);
                    }
                },
                
                async deleteScheduledEvent() {
                    if (!this.editingEvent.id) return;
                    
                    if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Êó•Á®ãÂêóÔºü')) {
                        try {
                            await this.apiCall(`/events/${this.editingEvent.id}`, {
                                method: 'DELETE'
                            });
                            
                            await this.loadWeekSchedule();
                            this.forceCloseModal();
                        } catch (error) {
                            console.error('Âà†Èô§Êó•Á®ãÂ§±Ë¥•:', error);
                        }
                    }
                },
                
                // ÊãñÊãΩÂäüËÉΩÂàùÂßãÂåñ
                initDragAndDrop() {
                    console.log('Initializing drag and drop...', 'Current view:', this.currentView);
                    
                    // Âè™Âú®Âë®ËßÜÂõæ‰∏≠ÂàùÂßãÂåñÊãñÊãΩÂäüËÉΩ
                    if (this.currentView !== 'week') {
                        console.log('Drag and drop skipped - not in week view');
                        return;
                    }
                    
                    const self = this; // ‰øùÂ≠òAlpine.jsÂÆû‰æãÂºïÁî®
                    
                    // Âè™Ê∏ÖÁêÜÊó∂Èó¥ÊßΩÁöÑSortableÂÆû‰æãÔºå‰øùÁïôÊ¥ªÂä®Ê±†ÁöÑÂÆû‰æã
                    document.querySelectorAll('.time-slot.sortable-initialized').forEach(el => {
                        if (el.sortableInstance) {
                            el.sortableInstance.destroy();
                        }
                        el.classList.remove('sortable-initialized');
                    });
                    
                    console.log('Cleaned up time slot sortable instances');
                    
                    // ÂàùÂßãÂåñÊ¥ªÂä®Ê±†ÁöÑÊãñÊãΩ
                    const activityPool = document.getElementById('activity-pool');
                    if (activityPool && !activityPool.classList.contains('sortable-initialized')) {
                        activityPool.sortableInstance = Sortable.create(activityPool, {
                            group: {
                                name: 'activities',
                                pull: 'clone', // ‰ªéÊ¥ªÂä®Ê±†ÊãñÊãΩÊó∂ÂàõÂª∫ÂâØÊú¨
                                put: false     // ‰∏çÂÖÅËÆ∏ÂÖ∂‰ªñÂÖÉÁ¥†ÊãñÂÖ•Ê¥ªÂä®Ê±†
                            },
                            sort: false, // Ê¥ªÂä®Ê±†ÂÜÖ‰∏çÂÖÅËÆ∏ÊéíÂ∫è
                            animation: 200,
                            ghostClass: 'sortable-ghost',
                            chosenClass: 'sortable-chosen',
                            dragClass: 'sortable-drag',
                            // Á°Æ‰øùÂÖãÈöÜÊó∂‰øùÁïôÂéüÂßãÊï∞ÊçÆ
                            onClone: function(evt) {
                                console.log('Activity cloned from pool:', evt.clone);
                                // Á°Æ‰øùÂÖãÈöÜÁöÑÂÖÉÁ¥†‰øùÁïôdataÂ±ûÊÄß
                                const originalId = evt.item.getAttribute('data-activity-id');
                                if (originalId) {
                                    evt.clone.setAttribute('data-activity-id', originalId);
                                }
                            }
                        });
                        activityPool.classList.add('sortable-initialized');
                        console.log('Activity pool sortable initialized');
                    }
                    
                    // ÂàùÂßãÂåñÊó∂Èó¥ÊßΩÁöÑÊãñÊãΩÊé•Êî∂
                    const timeSlots = document.querySelectorAll('.time-slot');
                    console.log('Found time slots:', timeSlots.length);
                    
                    timeSlots.forEach((slot, index) => {
                        if (!slot.classList.contains('sortable-initialized')) {
                            console.log(`Initializing time slot ${index}:`, {
                                date: slot.getAttribute('data-date'),
                                timeSlot: slot.getAttribute('data-time-slot')
                            });
                            
                            slot.sortableInstance = Sortable.create(slot, {
                                group: {
                                    name: 'activities',
                                    pull: true,  // ÂÖÅËÆ∏‰ªéÊó∂Èó¥ÊßΩÊãñÂá∫ÔºàÁî®‰∫éÂà†Èô§ÊàñÁßªÂä®Ôºâ
                                    put: true    // ÂÖÅËÆ∏ÊãñÂÖ•Êó∂Èó¥ÊßΩ
                                },
                                animation: 200,
                                ghostClass: 'sortable-ghost',
                                chosenClass: 'sortable-chosen',
                                dragClass: 'sortable-drag',
                                // ÂΩì‰ªéÊ¥ªÂä®Ê±†ÊãñÊãΩÂà∞Êó∂Èó¥ÊßΩ
                                onAdd: function(evt) {
                                    console.log('Drop event triggered on slot:', evt.to);
                                    const activityId = evt.item.getAttribute('data-activity-id');
                                    const date = evt.to.getAttribute('data-date');
                                    const timeSlot = parseInt(evt.to.getAttribute('data-time-slot'));
                                    
                                    console.log('Drop details:', { activityId, date, timeSlot, fromPool: evt.from.id === 'activity-pool' });
                                    
                                    if (!activityId || !date || !timeSlot) {
                                        console.error('Missing required drop data');
                                        evt.item.remove();
                                        return;
                                    }
                                    
                                    // Á´ãÂç≥ÁßªÈô§ÊãñÊãΩÁöÑ‰∏¥Êó∂ÂÖÉÁ¥†
                                    evt.item.remove();
                                    
                                    // Â§ÑÁêÜÊãñÊãΩ‰∫ã‰ª∂
                                    self.handleDrop(activityId, date, timeSlot);
                                },
                                // ÂΩì‰ªéÊó∂Èó¥ÊßΩÊãñÊãΩÂÖÉÁ¥†Âá∫ÂéªÊó∂ÔºàÂà†Èô§ÂäüËÉΩÔºâ
                                onRemove: function(evt) {
                                    console.log('Item removed from time slot');
                                    // Â¶ÇÊûúÊãñÊãΩÂà∞Ê¥ªÂä®Ê±†ÊàñÁ©∫ÁôΩÂå∫ÂüüÔºåËßÜ‰∏∫Âà†Èô§Êìç‰Ωú
                                    if (evt.to.id === 'activity-pool' || !evt.to.classList.contains('time-slot')) {
                                        const date = evt.from.getAttribute('data-date');
                                        const timeSlot = parseInt(evt.from.getAttribute('data-time-slot'));
                                        console.log('Deleting event at:', date, timeSlot);
                                        // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†Âà†Èô§‰∫ã‰ª∂ÁöÑÈÄªËæë
                                    }
                                }
                            });
                            slot.classList.add('sortable-initialized');
                        }
                    });
                    
                    console.log('Drag and drop initialization completed');
                },
                
                // Âè™ÂàùÂßãÂåñÊó∂Èó¥ÊßΩÁöÑÊãñÊãΩÂäüËÉΩÔºàÁî®‰∫éÂä®ÊÄÅÈáçÊñ∞ÂàùÂßãÂåñÔºâ
                initTimeSlotsDragAndDrop() {
                    if (this.currentView !== 'week') {
                        return;
                    }
                    
                    const self = this;
                    
                    // Ê∏ÖÁêÜÊó∂Èó¥ÊßΩÁöÑSortableÂÆû‰æã
                    document.querySelectorAll('.time-slot.sortable-initialized').forEach(el => {
                        if (el.sortableInstance) {
                            el.sortableInstance.destroy();
                        }
                        el.classList.remove('sortable-initialized');
                    });
                    
                    // ÈáçÊñ∞ÂàùÂßãÂåñÊó∂Èó¥ÊßΩÁöÑÊãñÊãΩÊé•Êî∂
                    const timeSlots = document.querySelectorAll('.time-slot');
                    console.log('Re-initializing time slots:', timeSlots.length);
                    
                    timeSlots.forEach((slot, index) => {
                        if (!slot.classList.contains('sortable-initialized')) {
                            slot.sortableInstance = Sortable.create(slot, {
                                group: {
                                    name: 'activities',
                                    pull: true,
                                    put: true
                                },
                                animation: 200,
                                ghostClass: 'sortable-ghost',
                                chosenClass: 'sortable-chosen',
                                dragClass: 'sortable-drag',
                                onAdd: function(evt) {
                                    console.log('Drop event triggered on slot:', evt.to);
                                    const activityId = evt.item.getAttribute('data-activity-id');
                                    const date = evt.to.getAttribute('data-date');
                                    const timeSlot = parseInt(evt.to.getAttribute('data-time-slot'));
                                    
                                    console.log('Drop details:', { activityId, date, timeSlot, fromPool: evt.from.id === 'activity-pool' });
                                    
                                    if (!activityId || !date || !timeSlot) {
                                        console.error('Missing required drop data');
                                        evt.item.remove();
                                        return;
                                    }
                                    
                                    evt.item.remove();
                                    self.handleDrop(activityId, date, timeSlot);
                                },
                                onRemove: function(evt) {
                                    console.log('Item removed from time slot');
                                    if (evt.to.id === 'activity-pool' || !evt.to.classList.contains('time-slot')) {
                                        const date = evt.from.getAttribute('data-date');
                                        const timeSlot = parseInt(evt.from.getAttribute('data-time-slot'));
                                        console.log('Deleting event at:', date, timeSlot);
                                    }
                                }
                            });
                            slot.classList.add('sortable-initialized');
                        }
                    });
                    
                    console.log('Time slots drag and drop re-initialization completed');
                },
                
                async handleDrop(activityId, date, timeSlot) {
                    try {
                        console.log('=== DROP HANDLER START ===');
                        console.log('Handling drop:', { activityId, date, timeSlot });
                        console.log('Type check:', typeof activityId, typeof date, typeof timeSlot);
                        
                        // È™åËØÅËæìÂÖ•ÂèÇÊï∞
                        if (!activityId || !date || !timeSlot) {
                            console.error('Invalid drop parameters:', { activityId, date, timeSlot });
                            alert('ÊãñÊãΩÂèÇÊï∞ÈîôËØØÔºåËØ∑ÈáçËØï');
                            return;
                        }
                        
                        // Ê£ÄÊü•ÊòØÂê¶Â∑≤Êúâ‰∫ã‰ª∂
                        const existing = this.getScheduledEvent(date, timeSlot);
                        console.log('Existing event check:', existing);
                        if (existing) {
                            alert('ËØ•Êó∂Èó¥ÊßΩÂ∑≤ÊúâÂÆâÊéíÔºåËØ∑ÈÄâÊã©ÂÖ∂‰ªñÊó∂Èó¥ÊàñÂÖàÂà†Èô§Áé∞ÊúâÂÆâÊéí');
                            return;
                        }
                        
                        // ÊâæÂà∞Ê¥ªÂä®‰ø°ÊÅØ
                        console.log('Searching for activity with ID:', activityId, 'in:', this.flatActivities.length, 'activities');
                        const activity = this.flatActivities.find(a => a.id == activityId);
                        console.log('Activity search result:', activity);
                        if (!activity) {
                            console.error('Activity not found:', activityId);
                            console.error('Available activities:', this.flatActivities.map(a => ({ id: a.id, name: a.name })));
                            alert('Êú™ÊâæÂà∞Ê¥ªÂä®‰ø°ÊÅØÔºåID: ' + activityId);
                            return;
                        }
                        
                        console.log('Found activity:', activity);
                        
                        // ÂàõÂª∫Êñ∞ÁöÑÊó•Á®ã‰∫ã‰ª∂
                        const eventData = {
                            activity_id: parseInt(activityId),
                            event_date: date,
                            time_slot: parseInt(timeSlot),
                            goal: '',
                            notes: '',
                            status: 'planned'
                        };
                        
                        console.log('Creating event:', eventData);
                        
                        const result = await this.apiCall('/events/', {
                            method: 'POST',
                            body: JSON.stringify(eventData)
                        });
                        
                        console.log('Event created:', result);
                        
                        // Âà∑Êñ∞Êï∞ÊçÆ
                        console.log('Reloading week schedule after successful drop...');
                        await this.loadWeekSchedule();
                        
                        // ÈáçÊñ∞Ê∏≤ÊüìÁΩëÊ†º
                        const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                        if (gridContainer) {
                            gridContainer.innerHTML = this.renderFullWeekGrid();
                            console.log('Week grid re-rendered after drop');
                            
                            // Âè™ÈáçÊñ∞ÂàùÂßãÂåñÊó∂Èó¥ÊßΩÁöÑÊãñÊãΩÂäüËÉΩÔºå‰∏çÂΩ±ÂìçÊ¥ªÂä®Ê±†
                            setTimeout(() => {
                                this.initTimeSlotsDragAndDrop();
                            }, 100);
                        }
                        
                        // ÊãñÊãΩÊàêÂäüÔºå‰∏çËá™Âä®ÊâìÂºÄÁºñËæëÊ°Ü
                        // Áî®Êà∑ÂèØ‰ª•ÊâãÂä®ÁÇπÂáªÊó∂Èó¥ÊßΩ‰∏≠ÁöÑ‰∫ã‰ª∂Êù•ÁºñËæë
                        
                        console.log('=== DROP HANDLER SUCCESS ===');
                        
                    } catch (error) {
                        console.error('=== DROP HANDLER ERROR ===');
                        console.error('Â§ÑÁêÜÊãñÊãΩÂ§±Ë¥•:', error);
                        console.error('Error details:', {
                            name: error.name,
                            message: error.message,
                            stack: error.stack
                        });
                        alert('ÂàõÂª∫Êó•Á®ãÂ§±Ë¥•: ' + error.message);
                    }
                },
                
                // Ê±áÊÄªËßÜÂõæÊ∏≤Êüì
                renderActivityTree() {
                    if (!this.activities.length) return '<p class="text-muted">ÊöÇÊó†Ê¥ªÂä®</p>';
                    
                    const renderNode = (activity, level = 0) => {
                        let html = `
                            <div class="mb-2" style="margin-left: ${level * 20}px;">
                                <div class="d-flex justify-content-between align-items-center border-bottom pb-2">
                                    <div>
                                        <strong>${activity.name}</strong>
                                        ${activity.description ? `<br><small class="text-muted">${activity.description}</small>` : ''}
                                    </div>
                                    <div class="text-end">
                                        <button class="btn btn-outline-danger btn-sm" 
                                                onclick="deleteActivity(${activity.id})">
                                            Âà†Èô§
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        if (activity.children && activity.children.length > 0) {
                            activity.children.forEach(child => {
                                html += renderNode(child, level + 1);
                            });
                        }
                        
                        return html;
                    };
                    
                    return this.activities.map(activity => renderNode(activity)).join('');
                },
                
                // Â∏¶ÁªüËÆ°‰ø°ÊÅØÁöÑÊ±áÊÄªËßÜÂõæÊ∏≤Êüì
                renderActivityTreeWithStats() {
                    if (!this.activities.length) return '<p class="text-muted">ÊöÇÊó†Ê¥ªÂä®</p>';
                    
                    const renderNode = (activity, level = 0) => {
                        const stats = this.activityStats[activity.id] || {};
                        const totalEvents = stats.total_events || 0;
                        const completedEvents = stats.completed_events || 0;
                        const completionRate = stats.completion_rate || 0;
                        
                        let html = `
                            <div class="mb-3" style="margin-left: ${level * 20}px;">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">${activity.name}</h6>
                                                ${activity.description ? `<p class="text-muted small mb-2">${activity.description}</p>` : ''}
                                                
                                                <!-- ÁªüËÆ°‰ø°ÊÅØ -->
                                                <div class="row text-center mb-2">
                                                    <div class="col-4">
                                                        <small class="text-muted d-block">ÊÄªÂÆâÊéí</small>
                                                        <strong class="text-primary">${totalEvents}</strong>
                                                    </div>
                                                    <div class="col-4">
                                                        <small class="text-muted d-block">Â∑≤ÂÆåÊàê</small>
                                                        <strong class="text-success">${completedEvents}</strong>
                                                    </div>
                                                    <div class="col-4">
                                                        <small class="text-muted d-block">ÂÆåÊàêÁéá</small>
                                                        <strong class="text-warning">${Math.round(completionRate * 100)}%</strong>
                                                    </div>
                                                </div>
                                                
                                                <!-- Goal ÂàóË°® -->
                                                ${this.renderActivityGoals(stats)}
                                            </div>
                                            <div class="text-end">
                                                <button class="btn btn-outline-primary btn-sm me-2" 
                                                        onclick="window.laeAppInstance.editActivity(${activity.id})">
                                                    ÁºñËæë
                                                </button>
                                                <button class="btn btn-outline-danger btn-sm" 
                                                        onclick="deleteActivity(${activity.id})">
                                                    Âà†Èô§
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        if (activity.children && activity.children.length > 0) {
                            activity.children.forEach(child => {
                                html += renderNode(child, level + 1);
                            });
                        }
                        
                        return html;
                    };
                    
                    return this.activities.map(activity => renderNode(activity)).join('');
                },
                
                // Ê∏≤ÊüìÊ¥ªÂä®ÁöÑGoalÂàóË°®
                renderActivityGoals(stats) {
                    if (!stats.sub_activities || !stats.sub_activities.length) {
                        return '<small class="text-muted">ÊöÇÊó†ÁõÆÊ†áËÆ∞ÂΩï</small>';
                    }
                    
                    let html = '<div class="mt-2"><small class="text-muted d-block mb-1">ÊúÄËøëÁõÆÊ†á:</small>';
                    
                    // ÊòæÁ§∫ÊúÄËøëÁöÑÂá†‰∏™goals
                    let goalCount = 0;
                    for (const subActivity of stats.sub_activities) {
                        if (subActivity.goals && subActivity.goals.length > 0) {
                            for (const goal of subActivity.goals.slice(-3)) { // Âè™ÊòæÁ§∫ÊúÄËøë3‰∏™
                                if (goalCount >= 5) break; // ÊúÄÂ§öÊòæÁ§∫5‰∏™
                                
                                const statusColor = goal.status === 'completed' ? 'success' : 'secondary';
                                const statusIcon = goal.status === 'completed' ? '‚úì' : '‚óã';
                                
                                html += `
                                    <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                                        <small><span class="text-${statusColor}">${statusIcon}</span> ${goal.goal}</small>
                                        <small class="text-muted">${goal.date}</small>
                                    </div>
                                `;
                                goalCount++;
                            }
                        }
                        if (goalCount >= 5) break;
                    }
                    
                    html += '</div>';
                    return goalCount > 0 ? html : '<small class="text-muted">ÊöÇÊó†ÁõÆÊ†áËÆ∞ÂΩï</small>';
                },
                
                // ÂÆåÊï¥Âë®ËßÜÂõæÁΩëÊ†ºÊ∏≤ÊüìÔºàÂåÖÂê´Ê†áÈ¢òË°åÂíåÊâÄÊúâÊó∂Èó¥ÊßΩÔºâ
                renderFullWeekGrid() {
                    if (!this.timeSlots.length || !this.weekDates.length) {
                        return '<p class="text-muted">Âä†ËΩΩ‰∏≠...</p>';
                    }
                    
                    let html = '';
                    
                    console.log('Rendering full week grid:', {
                        timeSlots: this.timeSlots.length,
                        weekDates: this.weekDates.length,
                        totalElements: (this.timeSlots.length + 1) * 8 // (5+1)Ë°å √ó 8Âàó
                    });
                    
                    // 1. ÁîüÊàêÊ†áÈ¢òË°åÔºà8‰∏™ÂÖÉÁ¥†Ôºö1‰∏™"Êó∂Èó¥"Ê†áÈ¢ò + 7‰∏™Êó•ÊúüÊ†áÈ¢òÔºâ
                    html += '<div class="week-header">Êó∂Èó¥</div>';
                    for (const day of this.weekDates) {
                        const date = new Date(day);
                        const weekday = ['Âë®‰∏Ä', 'Âë®‰∫å', 'Âë®‰∏â', 'Âë®Âõõ', 'Âë®‰∫î', 'Âë®ÂÖ≠', 'Âë®Êó•'][date.getDay() === 0 ? 6 : date.getDay() - 1];
                        const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
                        html += `
                            <div class="week-header">
                                <div>${weekday}</div>
                                <div>${dateStr}</div>
                            </div>
                        `;
                    }
                    
                    // 2. ‰∏∫ÊØè‰∏™Êó∂Èó¥ÊÆµÁîüÊàê‰∏ÄË°åÔºà8‰∏™ÂÖÉÁ¥†Ôºö1‰∏™Êó∂Èó¥Ê†áÁ≠æ + 7‰∏™Êó∂Èó¥ÊßΩÔºâ
                    for (const slot of this.timeSlots) {
                        // Êó∂Èó¥Ê†áÁ≠æÔºàÁ¨¨‰∏ÄÂàóÔºâ
                        html += `<div class="time-label">${slot.name}</div>`;
                        
                        // ËØ•Êó∂Èó¥ÊÆµÁöÑ7‰∏™Êó∂Èó¥ÊßΩÔºàÂë®‰∏ÄÂà∞Âë®Êó•Ôºâ
                        for (const day of this.weekDates) {
                            const event = this.getScheduledEvent(day, slot.value);
                            const occupiedClass = event ? 'occupied' : '';
                            
                            html += `
                                <div class="time-slot p-2 ${occupiedClass}" 
                                     data-date="${day}" 
                                     data-time-slot="${slot.value}"
                                     onclick="window.laeAppInstance.editScheduledEvent('${day}', ${slot.value})">
                            `;
                            
                            if (event) {
                                html += `
                                    <div class="scheduled-event">
                                        <div class="fw-bold" style="font-size: 0.75rem;">${event.activity_name || ''}</div>
                                        <div style="font-size: 0.7rem; color: #666;">${event.goal || ''}</div>
                                        ${event.notes ? `<div style="font-size: 0.65rem; color: #888;">Â§áÊ≥®: ${event.notes}</div>` : ''}
                                    </div>
                                `;
                            }
                            
                            html += '</div>';
                        }
                    }
                    
                    console.log('Generated full grid HTML, total elements:', (html.match(/<div/g) || []).length);
                    return html;
                },
                
                // ‰øùÁïôÂéüÂáΩÊï∞‰ª•Â§áÁî®
                renderWeekGrid() {
                    return this.renderFullWeekGrid();
                },
                
                // Â∑•ÂÖ∑ÊñπÊ≥ï
                getCurrentDateString() {
                    return this.currentDate.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        weekday: 'long'
                    });
                },
                
                getWeekTitle() {
                    if (this.weekDates.length === 0) return '';
                    const start = new Date(this.weekDates[0]);
                    const end = new Date(this.weekDates[6]);
                    return `${start.getMonth() + 1}Êúà${start.getDate()}Êó• - ${end.getMonth() + 1}Êúà${end.getDate()}Êó•`;
                },
                
                getMonthTitle() {
                    return `${this.currentYear}Âπ¥${this.currentMonth}Êúà`;
                },
                
                // ÊúàËßÜÂõæÁõ∏ÂÖ≥ÊñπÊ≥ï
                previousMonth() {
                    this.currentMonth--;
                    if (this.currentMonth < 1) {
                        this.currentMonth = 12;
                        this.currentYear--;
                    }
                    this.loadMonthSchedule();
                },
                
                nextMonth() {
                    this.currentMonth++;
                    if (this.currentMonth > 12) {
                        this.currentMonth = 1;
                        this.currentYear++;
                    }
                    this.loadMonthSchedule();
                },
                
                async loadMonthSchedule() {
                    try {
                        console.log(`Loading month schedule for ${this.currentYear}-${this.currentMonth}`);
                        
                        // Ê∏≤ÊüìÊúàÂéÜÔºàÁé∞Âú®Áõ¥Êé•Âú®renderMonthCalendar‰∏≠Âä†ËΩΩÊï∞ÊçÆÔºâ
                        await this.renderMonthCalendar();
                        
                        console.log('Month schedule loaded and rendered');
                    } catch (error) {
                        console.error('Âä†ËΩΩÊúàÊó•Á®ãÂ§±Ë¥•:', error);
                        const monthCalendarContainer = document.getElementById('month-calendar');
                        if (monthCalendarContainer) {
                            monthCalendarContainer.innerHTML = '<p class="text-danger">Âä†ËΩΩÊúàËßÜÂõæÂ§±Ë¥•</p>';
                        }
                    }
                },
                
                // Ê±áÊÄªËßÜÂõæÁõ∏ÂÖ≥ÊñπÊ≥ï
                async initSummaryData() {
                    console.log('Initializing summary data...');
                    await this.generateAvailableMonths();
                    await this.loadSummaryStatistics();
                    await this.loadActivityStatistics();
                },
                
                generateAvailableMonths() {
                    // ÁîüÊàêÂèØÈÄâÊã©ÁöÑÊúà‰ªΩÂàóË°®ÔºàÁÆÄÂåñÁâàÊú¨ÔºåÂü∫‰∫éÂΩìÂâçÊó•ÊúüÔºâ
                    const now = new Date();
                    const months = [];
                    
                    // Ê∑ªÂä†ÂΩìÂâçÊúàÂíåÂâçÈù¢Âá†‰∏™Êúà
                    for (let i = 2; i >= 0; i--) {
                        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                        months.push({
                            value: `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`,
                            label: `${date.getFullYear()}Âπ¥${date.getMonth() + 1}Êúà`
                        });
                    }
                    
                    this.availableMonths = months;
                    console.log('Available months:', this.availableMonths);
                },
                
                async loadSummaryStatistics() {
                    try {
                        console.log('Loading summary statistics for month:', this.summaryMonth);
                        let endpoint = '/statistics/summary';
                        
                        // Â¶ÇÊûúÈÄâÊã©‰∫ÜÁâπÂÆöÊúà‰ªΩÔºåÊ∑ªÂä†Êü•ËØ¢ÂèÇÊï∞ÔºàÂÅáËÆæÂêéÁ´ØÊîØÊåÅÔºâ
                        if (this.summaryMonth) {
                            endpoint += `?month=${this.summaryMonth}`;
                        }
                        
                        this.summaryStats = await this.apiCall(endpoint);
                        console.log('Summary statistics loaded:', this.summaryStats);
                    } catch (error) {
                        console.error('Failed to load summary statistics:', error);
                        this.summaryStats = {
                            total_activities: 0,
                            total_events: 0,
                            completed_events: 0,
                            completion_rate: 0
                        };
                    }
                },
                
                async loadActivityStatistics() {
                    try {
                        console.log('Loading activity statistics...');
                        this.activityStats = {};
                        
                        // ‰∏∫ÊØè‰∏™Ê¥ªÂä®Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆ
                        for (const activity of this.flatActivities) {
                            const stats = await this.apiCall(`/statistics/activities/${activity.id}/statistics`);
                            this.activityStats[activity.id] = stats;
                            console.log(`Stats for ${activity.name}:`, stats);
                        }
                    } catch (error) {
                        console.error('Failed to load activity statistics:', error);
                        this.activityStats = {};
                    }
                },
                
                formatWeekday(dateString) {
                    const date = new Date(dateString);
                    return ['Âë®‰∏Ä', 'Âë®‰∫å', 'Âë®‰∏â', 'Âë®Âõõ', 'Âë®‰∫î', 'Âë®ÂÖ≠', 'Âë®Êó•'][date.getDay() === 0 ? 6 : date.getDay() - 1];
                },
                
                formatDate(dateString) {
                    const date = new Date(dateString);
                    return `${date.getMonth() + 1}/${date.getDate()}`;
                },
                
                // ÊúàÂéÜÊ∏≤ÊüìÔºàÁÆÄÂåñÁâàÊú¨ÔºåÊòæÁ§∫‰∫ã‰ª∂Êï∞ÈáèÔºâ
                async renderMonthCalendar() {
                    try {
                        // ÈáçÊñ∞Âä†ËΩΩÊúàÊï∞ÊçÆ‰ª•Ëé∑ÂèñÂÆåÊï¥ÁöÑÂ§©Êï∞‰ø°ÊÅØ
                        const data = await this.apiCall(`/calendar/month/${this.currentYear}/${this.currentMonth}`);
                        
                        if (!data.days || data.days.length === 0) {
                            const monthCalendarContainer = document.getElementById('month-calendar');
                            if (monthCalendarContainer) {
                                monthCalendarContainer.innerHTML = '<p class="text-muted">Êó†Ê≥ïÂä†ËΩΩÊúàËßÜÂõæÊï∞ÊçÆ</p>';
                            }
                            return;
                        }
                        
                        const firstDay = new Date(this.currentYear, this.currentMonth - 1, 1);
                        const lastDay = new Date(this.currentYear, this.currentMonth, 0);
                        
                        // ËÆ°ÁÆóÊúàÂéÜÂ∫îËØ•‰ªéÂì™‰∏ÄÂ§©ÂºÄÂßãÔºàÂë®‰∏ÄÔºâ
                        const startDate = new Date(firstDay);
                        const dayOfWeek = firstDay.getDay() === 0 ? 7 : firstDay.getDay();
                        startDate.setDate(firstDay.getDate() - dayOfWeek + 1);
                        
                        // ËÆ°ÁÆóÊúàÂéÜÂ∫îËØ•Âà∞Âì™‰∏ÄÂ§©ÁªìÊùüÔºàÁ°Æ‰øùÂÆåÊï¥ÁöÑÂë®Ôºâ
                        const endDate = new Date(lastDay);
                        const endDayOfWeek = lastDay.getDay() === 0 ? 7 : lastDay.getDay();
                        endDate.setDate(lastDay.getDate() + (7 - endDayOfWeek));
                        
                        // ÂàõÂª∫Êó•ÊúüÂà∞‰∫ã‰ª∂Êï∞ÈáèÁöÑÊò†Â∞Ñ
                        const dayEventsMap = {};
                        data.days.forEach(day => {
                            dayEventsMap[day.date] = {
                                event_count: day.event_count,
                                is_today: day.is_today
                            };
                        });
                        
                        let html = '';
                        let currentDate = new Date(startDate);
                        
                        // ÊåâÂë®Ê∏≤Êüì
                        while (currentDate <= endDate) {
                            html += '<div class="row mb-1">';
                            
                            // ‰∏ÄÂë®7Â§©
                            for (let i = 0; i < 7; i++) {
                                const dateStr = currentDate.toISOString().split('T')[0];
                                const dayData = dayEventsMap[dateStr] || { event_count: 0, is_today: false };
                                const isCurrentMonth = currentDate.getMonth() === this.currentMonth - 1;
                                
                                let cellClass = 'col border p-2';
                                if (!isCurrentMonth) {
                                    cellClass += ' text-muted bg-light';
                                }
                                if (dayData.is_today) {
                                    cellClass += ' bg-warning bg-opacity-25 fw-bold';
                                }
                                
                                html += `<div class="${cellClass}" style="min-height: 100px;">`;
                                html += `<div class="fw-bold">${currentDate.getDate()}</div>`;
                                
                                // ÊòæÁ§∫‰∫ã‰ª∂Êï∞Èáè
                                if (dayData.event_count > 0) {
                                    html += `
                                        <div class="mt-2">
                                            <span class="badge bg-primary">${dayData.event_count} ‰∏™Êó•Á®ã</span>
                                        </div>
                                    `;
                                }
                                
                                html += '</div>';
                                
                                // ÁßªÂä®Âà∞‰∏ã‰∏ÄÂ§©
                                currentDate.setDate(currentDate.getDate() + 1);
                            }
                            
                            html += '</div>';
                        }
                        
                        // Êõ¥Êñ∞DOM
                        const monthCalendarContainer = document.getElementById('month-calendar');
                        if (monthCalendarContainer) {
                            monthCalendarContainer.innerHTML = html;
                        }
                    } catch (error) {
                        console.error('Ê∏≤ÊüìÊúàÂéÜÂ§±Ë¥•:', error);
                        const monthCalendarContainer = document.getElementById('month-calendar');
                        if (monthCalendarContainer) {
                            monthCalendarContainer.innerHTML = '<p class="text-danger">Âä†ËΩΩÊúàËßÜÂõæÂ§±Ë¥•</p>';
                        }
                    }
                },
                
                // Ëé∑ÂèñÊó∂Èó¥ÊßΩÂêçÁß∞ÁöÑËæÖÂä©ÊñπÊ≥ï
                getTimeSlotName(timeSlotValue) {
                    const slot = this.timeSlots.find(s => s.value === timeSlotValue);
                    return slot ? slot.name.replace('Á¨¨1Êó∂ÊÆµ', '1').replace('Á¨¨2Êó∂ÊÆµ', '2').replace('Êó∂ÊÆµ', '') : `Êó∂ÊÆµ${timeSlotValue}`;
                }
            }
        }

        // ÂÖ®Â±ÄËæÖÂä©ÂáΩÊï∞
        async function deleteActivity(activityId) {
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Ê¥ªÂä®ÂêóÔºüËøôÂ∞ÜÂà†Èô§ÊâÄÊúâÁõ∏ÂÖ≥ÁöÑÊó•Á®ãÂÆâÊéí„ÄÇ')) {
                try {
                    await fetch(`/api/activities/${activityId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    // Âà∑Êñ∞È°µÈù¢
                    location.reload();
                } catch (error) {
                    console.error('Âà†Èô§Ê¥ªÂä®Â§±Ë¥•:', error);
                    alert('Âà†Èô§Â§±Ë¥•');
                }
            }
        }
    </script>
</body>
</html>