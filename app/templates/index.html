<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAE - 个人日程与主支线管理系统 v16 Summary Stats</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.0/dist/cdn.min.js"></script>
    <!-- SortableJS -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <style>
        .time-slot {
            min-height: 120px;
            border: 2px solid #dee2e6;
            border-radius: 0.375rem;
            background-color: #f8f9fa;
            transition: background-color 0.2s, transform 0.1s, border-color 0.2s;
            padding: 8px;
            position: relative;
        }
        .time-slot:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }
        .time-slot.occupied {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        .activity-card {
            cursor: grab;
            transition: transform 0.2s;
        }
        .activity-card:hover {
            transform: translateY(-2px);
        }
        .activity-card:active {
            cursor: grabbing;
        }
        .sortable-chosen {
            opacity: 0.8;
            transform: rotate(3deg);
        }
        .sortable-drag {
            opacity: 0.8;
            transform: rotate(5deg);
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }
        .sortable-ghost {
            opacity: 0.4;
            background: #e3f2fd;
            border: 2px dashed #2196f3;
        }

        /* V3 拖拽样式 */
        .sortable-ghost-v3 {
            opacity: 0.3;
            background: rgba(33, 150, 243, 0.1);
            border: 2px dashed #2196f3;
            transform: scale(1.05);
        }
        .sortable-chosen-v3 {
            opacity: 0.8;
            transform: scale(1.02) rotate(1deg);
            z-index: 1000;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        .sortable-drag-v3 {
            opacity: 0.9;
            transform: rotate(3deg);
            box-shadow: 0 12px 30px rgba(0,0,0,0.4);
        }
        .sortable-fallback-v3 {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #2196f3;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        /* 吸附指示器样式 */
        .snap-indicator {
            position: absolute;
            left: 80px; /* 对齐到网格区域 */
            right: 0;
            height: 2px;
            background: #ff5722;
            z-index: 2000;
            display: none;
            pointer-events: none;
            box-shadow: 0 0 10px rgba(255, 87, 34, 0.6);
        }
        .snap-indicator.active {
            display: block;
            animation: snapPulse 0.3s ease-in-out;
        }
        @keyframes snapPulse {
            0% { opacity: 0.5; transform: scaleY(0.5); }
            50% { opacity: 1; transform: scaleY(1.5); }
            100% { opacity: 0.8; transform: scaleY(1); }
        }
        .time-slot.sortable-over {
            background-color: #e8f5e8;
            border-color: #4caf50;
            border-width: 3px;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        .day-column-v3.sortable-over,
        .day-column-v3-over {
            background-color: rgba(33, 150, 243, 0.1);
            box-shadow: inset 0 0 15px rgba(33, 150, 243, 0.3);
            border: 2px dashed #2196f3;
        }
        .scheduled-event {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin: 0.25rem 0;
            cursor: pointer;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .scheduled-event:hover {
            background-color: #fff2a8;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .activity-pool {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 1rem;
            background-color: #f8f9fa;
        }

        /* 层级池样式 v2.1 */
        .hierarchical-pool {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 0.75rem;
            background-color: #f8f9fa;
        }

        .tree-node {
            margin-bottom: 0.25rem;
        }

        .tree-node-content {
            display: flex;
            align-items: center;
            padding: 0.375rem 0.5rem;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 0.375rem;
            cursor: grab;
            transition: all 0.2s;
            user-select: none; /* 防止文本选择干扰拖拽 */
        }

        .tree-node-content:hover {
            background-color: #e3f2fd;
            border-color: #90caf9;
            transform: translateY(-1px);
        }

        .tree-node-content:active {
            cursor: grabbing;
        }

        .tree-node-content * {
            pointer-events: none; /* 子元素不拦截拖拽事件 */
        }

        /* v2.1 选择模式样式 */
        .tree-node-content.selectable {
            cursor: pointer;
        }

        .tree-node-content.selectable:hover {
            background-color: #fff3cd;
            border-color: #ffc107;
        }

        .tree-node-content.selected {
            background-color: #d4edda !important;
            border-color: #28a745 !important;
            border-width: 2px;
        }

        .tree-node-content.tree-node-selected {
            background-color: #e3f2fd !important;
            border: 2px solid #2196f3 !important;
            font-weight: bold;
        }

        .tree-node-content.tree-node-selected:hover {
            background-color: #bbdefb !important;
        }

        .tree-node-content.selectable * {
            pointer-events: none; /* 保持子元素不拦截点击事件 */
        }

        .tree-toggle {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.5rem;
            border: none;
            background: none;
            font-size: 12px;
            font-weight: bold;
            color: #6c757d;
            cursor: pointer;
            transition: transform 0.2s;
            pointer-events: auto; /* 恢复折叠按钮的点击事件 */
        }

        .tree-toggle.expanded {
            transform: rotate(90deg);
        }

        .tree-toggle:hover {
            color: #495057;
        }

        .tree-node-label {
            flex: 1;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .tree-node-description {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 0.125rem;
        }

        .tree-children {
            margin-left: 1.5rem;
            padding-left: 0.5rem;
            border-left: 2px solid #e9ecef;
        }

        .tree-children.collapsed {
            display: none;
        }

        /* Schedule时间条样式 */
        .schedule-timeline-container {
            display: grid;
            grid-template-columns: auto repeat(7, 1fr);
            gap: 8px;
            background-color: #f8f9fa;
            border-radius: 0.5rem 0.5rem 0 0;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-bottom: 1px solid #dee2e6;
            min-height: 120px;
            position: relative;
        }

        /* 月视图Schedule时间条样式 */
        .schedule-bars-container {
            position: absolute;
            top: 25px;
            left: 4px;
            right: 4px;
            z-index: 10;
        }

        .month-schedule-bar {
            height: 16px;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: 500;
            color: white;
            margin-bottom: 1px;
            width: 100%;
            transition: all 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .month-schedule-bar:hover {
            transform: scale(1.05);
            opacity: 1 !important;
            z-index: 20;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .schedule-timeline-label {
            background-color: #6c757d;
            color: white;
            padding: 8px;
            border-radius: 0.25rem;
            text-align: center;
            font-weight: bold;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .schedule-timeline-day {
            position: relative;
            min-height: 96px;
            border-radius: 0.25rem;
            background-color: white;
            border: 1px solid #e9ecef;
            padding: 4px;
        }

        .schedule-bar {
            position: relative;
            height: 20px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 500;
            color: white;
            margin-bottom: 2px;
            width: 100%;
            transition: all 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 0 6px;
            margin-bottom: 2px;
            width: 100%;
        }

        .schedule-bar:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* 预定义的颜色系统 */
        .schedule-color-0 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .schedule-color-1 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .schedule-color-2 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .schedule-color-3 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .schedule-color-4 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .schedule-color-5 { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .schedule-color-6 { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
        .schedule-color-7 { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); }
        .week-grid {
            display: grid;
            grid-template-columns: auto repeat(7, 1fr);
            gap: 8px;
            background-color: transparent;
            border-radius: 0.5rem;
            padding: 12px;
            border: 2px solid #dee2e6;
        }
        .week-header {
            background-color: #6c757d;
            color: white;
            text-align: center;
            padding: 0.5rem;
            font-weight: bold;
            border-radius: 0.375rem;
            border: 2px solid #6c757d;
        }
        .time-label {
            background-color: #495057;
            color: white;
            text-align: center;
            padding: 1rem 0.5rem;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 120px;
            border-radius: 0.375rem;
            border: 2px solid #495057;
        }

        /* ========== V3.0 动态画布UI系统 ========== */

        /* V3 微网格容器 */
        .week-canvas-v3 {
            position: relative;
            background-color: #fafafa;
            border: 2px solid #dee2e6;
            border-radius: 0.5rem;
            margin: 1rem 0;
            overflow: auto;
            min-height: 400px;
            max-height: 70vh;
        }

        /* 画布网格容器 */
        .canvas-grid-container {
            display: flex;
            position: relative;
            width: 100%;
            height: 100%;
        }

        /* 时间轴样式 */
        .time-axis-v3 {
            width: 80px;
            background-color: #f8f9fa;
            border-right: 2px solid #495057;
            position: relative;
            flex-shrink: 0;
            z-index: 5;
            transform: translateY(3px); /* 简单向下偏移3px */
        }

        /* 日期标题行 */
        .day-headers-row {
            position: absolute;
            top: 0;
            left: 80px; /* 保持与时间轴宽度一致的偏移 */
            right: 0;
            height: 50px;
            display: flex;
            background-color: #6c757d;
            z-index: 10;
        }

        /* 天列容器 */
        .days-container {
            flex: 1;
            display: flex;
            position: relative;
            margin-left: 0px; /* 移除左边距，避免与时间轴宽度重复偏移 */
            margin-top: 50px;
            height: calc(100% - 50px); /* 减去标题高度 */
            min-height: calc(100vh - 200px); /* 确保足够高度 */
        }

        /* 网格线层 */
        .grid-lines-layer {
            position: absolute;
            top: 50px;
            left: 80px;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 1;
        }

        /* 小时标记 */
        .hour-marker {
            position: absolute;
            left: 0;
            right: 0;
            height: 60px; /* 6个10分钟格的高度 */
            border-bottom: 2px solid #495057;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            color: #495057;
            background-color: rgba(248, 249, 250, 0.9);
        }

        /* 标题空白格子 */
        .hour-marker.header-spacer {
            background-color: #f8f9fa;
            border-bottom: none;
            border-right: 2px solid #495057;
        }

        /* 10分钟网格线 - 细线 */
        .grid-line-10min {
            position: absolute;
            left: 0;
            right: 0;
            width: 100%;
            height: 1px;
            background-color: #e9ecef;
            pointer-events: none;
        }

        /* 小时网格线 - 粗线 */
        .grid-line-hour {
            position: absolute;
            left: 0;
            right: 0;
            width: 100%;
            height: 2px;
            background-color: #495057;
            pointer-events: none;
        }

        /* 日期列 */
        .day-column-v3 {
            flex: 1;
            position: relative;
            border-right: 1px solid #dee2e6;
            background-color: transparent;
            min-height: calc(100vh - 150px); /* 确保足够高度 */
            height: 100%; /* 强制填满容器高度 */
        }

        .day-column-v3:last-child {
            border-right: none;
        }

        /* 日期标题 */
        .day-header-v3 {
            flex: 1;
            background-color: #6c757d;
            color: white;
            text-align: center;
            padding: 0.5rem;
            font-weight: bold;
            font-size: 0.875rem;
            border-right: 1px solid #495057;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: pre-line;
        }

        .day-header-v3:last-child {
            border-right: none;
        }

        /* V3 动态卡片样式 */
        .task-card-v3 {
            position: absolute;
            left: 4px;
            right: 4px;
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #ffc107;
            border-radius: 6px;
            padding: 8px;
            cursor: grab;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 0.75rem;
            z-index: 5;
            overflow: hidden;
            min-height: 20px; /* 最小2个网格单位 */
        }

        .task-card-v3:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            z-index: 6;
        }

        .task-card-v3:active {
            cursor: grabbing;
        }

        /* 精确任务特殊样式 */
        .task-card-v3.precise {
            background: linear-gradient(135deg, #d4edda 0%, #a8e6cf 100%);
            border-color: #28a745;
        }

        .task-card-v3.precise::before {
            content: "⏰";
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 0.6rem;
        }

        /* 并行任务样式 */
        .task-card-v3.parallel {
            left: 50%; /* 右半部分 */
            right: 4px;
        }

        .task-card-v3.parallel-left {
            right: 50%; /* 左半部分 */
        }

        /* 待定区域 */
        .pending-area-v3 {
            grid-column: 1 / -1;
            background-color: #f1f3f4;
            border-bottom: 2px solid #dee2e6;
            padding: 1rem;
            min-height: 80px;
            position: relative;
        }

        .pending-card-v3 {
            display: inline-block;
            background-color: #e9ecef;
            border: 1px solid #adb5bd;
            border-radius: 4px;
            padding: 6px 12px;
            margin: 4px;
            cursor: grab;
            font-size: 0.75rem;
            max-width: 150px;
            height: 32px;
            line-height: 20px;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }

        /* 拖拽吸附指示器 */
        .snap-indicator {
            position: absolute;
            left: 80px;
            right: 0;
            height: 2px;
            background-color: #007bff;
            z-index: 15;
            opacity: 0;
            transition: opacity 0.1s ease;
        }

        .snap-indicator.active {
            opacity: 1;
        }

        /* V3智能吸附增强 */
        .v3-snap-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #007bff, #00d4aa);
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.15s ease;
            box-shadow: 0 0 6px rgba(0, 123, 255, 0.6);
        }

        .v3-snap-line.active {
            opacity: 0.9;
        }

        .v3-snap-tooltip {
            position: absolute;
            left: 50%;
            top: -25px;
            transform: translateX(-50%);
            background: rgba(0, 123, 255, 0.9);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.15s ease;
        }

        .v3-snap-tooltip.active {
            opacity: 1;
        }

        /* 网格切换按钮 */
        .grid-toggle-v3 {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 20;
            background-color: rgba(255,255,255,0.9);
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
        }

        /* 滚动条样式 */
        .week-canvas-v3::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .week-canvas-v3::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .week-canvas-v3::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .week-canvas-v3::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* 响应式适配 */
        @media (max-width: 768px) {
            .week-canvas-v3 {
                grid-template-columns: 60px repeat(7, 1fr);
                font-size: 0.7rem;
            }

            .time-axis-v3 {
                grid-template-columns: 60px;
            }

            .task-card-v3 {
                font-size: 0.7rem;
                padding: 6px;
            }
        }
    </style>
</head>
<body>
    <div x-data="laeApp()" class="container-fluid">
        <!-- 导航栏 -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-3">
            <div class="container-fluid">
                <span class="navbar-brand">LAE - 日程管理系统</span>
                
                <!-- 视图切换按钮 -->
                <div class="navbar-nav me-auto">
                    <button 
                        class="nav-link btn btn-link"
                        :class="{ 'active text-warning': currentView === 'summary' }"
                        @click="switchView('summary')"
                    >
                        汇总视图
                    </button>
                    <button 
                        class="nav-link btn btn-link"
                        :class="{ 'active text-warning': currentView === 'week' }"
                        @click="switchView('week')"
                    >
                        周视图
                    </button>
                    <button 
                        class="nav-link btn btn-link"
                        :class="{ 'active text-warning': currentView === 'month' }"
                        @click="switchView('month')"
                    >
                        月视图
                    </button>
                </div>
                
                <!-- 当前日期显示 -->
                <div class="navbar-text text-light">
                    <span x-text="getCurrentDateString()"></span>
                </div>
            </div>
        </nav>

        <!-- 汇总视图 -->
        <div x-show="currentView === 'summary'" class="row">
            <!-- 统计仪表板 -->
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">数据统计</h5>
                        <div class="d-flex align-items-center">
                            <select class="form-select form-select-sm me-2" x-model="summaryMonth" @change="loadSummaryStatistics()">
                                <option value="">全部时间</option>
                                <template x-for="month in availableMonths" :key="month.value">
                                    <option :value="month.value" x-text="month.label"></option>
                                </template>
                            </select>
                            <button class="btn btn-outline-primary btn-sm" @click="loadSummaryStatistics()">
                                📊 刷新统计
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row" x-show="summaryStats">
                            <div class="col-md-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <h4 x-text="summaryStats?.total_events || 0"></h4>
                                        <p class="mb-0">总安排次数</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h4 x-text="summaryStats?.completed_events || 0"></h4>
                                        <p class="mb-0">已完成次数</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning text-white">
                                    <div class="card-body text-center">
                                        <h4 x-text="Math.round((summaryStats?.completion_rate || 0) * 100) + '%'"></h4>
                                        <p class="mb-0">完成率</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h4 x-text="summaryStats?.total_activities || 0"></h4>
                                        <p class="mb-0">活动总数</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- v2.0 双轴矩阵管理 -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">🎯 领域管理 (Domains)</h5>
                        <button class="btn btn-primary btn-sm" @click="showNewDomainModal = true">
                            + 新建领域
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="domain-tree" class="mt-3">
                            <!-- 领域树将在这里渲染 -->
                            <div x-html="renderDomainTree()"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">⚡ 活动类型管理 (Activity Types)</h5>
                        <button class="btn btn-success btn-sm" @click="showNewActivityTypeModal = true">
                            + 新建类型
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="activity-type-tree" class="mt-3">
                            <!-- 活动类型树将在这里渲染 -->
                            <div x-html="renderActivityTypeTree()"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 周视图 -->
        <div x-show="currentView === 'week'" class="row">
            <!-- v2.1 智能侧边栏 (选择模式) -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">🎯 智能侧边栏</h6>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button"
                                        class="btn"
                                        :class="sidebarMode === 'domain' ? 'btn-primary' : 'btn-outline-primary'"
                                        @click="setSidebarMode('domain')">
                                    领域
                                </button>
                                <button type="button"
                                        class="btn"
                                        :class="sidebarMode === 'type' ? 'btn-primary' : 'btn-outline-primary'"
                                        @click="setSidebarMode('type')">
                                    类型
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- 当前选中状态显示 -->
                        <div class="alert alert-success small mb-3" x-show="selectedNode.id">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>已选中:</strong> <span x-text="selectedNode.name"></span>
                                    <div class="small text-muted" x-text="selectedNode.type === 'domain' ? '🎯 领域' : '⚡ 类型'"></div>
                                </div>
                                <button class="btn btn-sm btn-outline-secondary" @click="clearSelectedNode()">清除</button>
                            </div>
                        </div>

                        <!-- 使用说明 -->
                        <div class="alert alert-info small mb-3" x-show="!selectedNode.id">
                            💡 <strong>使用方式</strong>：<br>
                            1. 点击下方节点选中<br>
                            2. 然后点击右侧空白时间槽创建事件
                        </div>

                        <!-- Domain 视图 -->
                        <div x-show="sidebarMode === 'domain'" class="selection-panel" x-html="renderSelectionDomainTree()">
                        </div>

                        <!-- ActivityType 视图 -->
                        <div x-show="sidebarMode === 'type'" class="selection-panel" x-html="renderSelectionTypeTree()">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 周日程网格 -->
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <button class="btn btn-outline-primary btn-sm" @click="previousWeek()">
                                ‹ 上一周
                            </button>
                            <span class="mx-3 fw-bold" x-text="getWeekTitle()"></span>
                            <button class="btn btn-outline-primary btn-sm" @click="nextWeek()">
                                下一周 ›
                            </button>
                        </div>

                        <!-- V3模式切换按钮 -->
                        <div class="d-flex align-items-center">
                            <label class="form-check-label me-2">画布模式:</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox"
                                       x-model="isV3Mode" @change="switchGridMode()">
                                <label class="form-check-label" x-text="isV3Mode ? 'V3动态画布' : 'V2经典网格'"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <!-- V2经典模式 -->
                        <template x-if="!isV3Mode">
                            <div>
                                <!-- Schedule时间条区域 -->
                                <div class="schedule-timeline-container" id="schedule-timeline" x-html="renderScheduleTimeline()">
                                </div>
                                <!-- V2周视图网格 -->
                                <div class="week-grid" id="week-grid" x-html="renderFullWeekGrid()">
                                </div>
                            </div>
                        </template>

                        <!-- V3动态画布模式 -->
                        <template x-if="isV3Mode">
                            <div>
                                <!-- V3画布容器 -->
                                <div class="position-relative">
                                    <!-- 控制面板 -->
                                    <div class="grid-toggle-v3">
                                        <button class="btn btn-sm btn-outline-secondary me-2" @click="isV3Mode = false">
                                            ← 返回V2
                                        </button>
                                        <div class="d-flex align-items-center">
                                            <label class="form-label me-2 mb-0">缩放:</label>
                                            <button class="btn btn-sm btn-outline-primary me-1" @click="adjustZoom(-0.25)" :disabled="v3ZoomLevel <= 0.5">-</button>
                                            <span class="mx-2" x-text="Math.round(v3ZoomLevel * 100) + '%'"></span>
                                            <button class="btn btn-sm btn-outline-primary" @click="adjustZoom(0.25)" :disabled="v3ZoomLevel >= 2.0">+</button>
                                        </div>
                                    </div>

                                    <!-- 待定区域 -->
                                    <div class="pending-area-v3">
                                        <h6 class="mb-2">📋 待定任务</h6>
                                        <div id="pending-cards-v3" x-html="renderPendingCards()">
                                        </div>
                                    </div>

                                    <!-- V3微网格画布 -->
                                    <div class="week-canvas-v3" id="week-canvas-v3"
                                         :style="`height: ${getCanvasHeight()}px;`">

                                        <!-- 网格容器 -->
                                        <div class="canvas-grid-container">
                                            <!-- 时间轴 -->
                                            <div class="time-axis-v3" x-html="renderTimeAxis()">
                                            </div>

                                            <!-- 日期标题行 -->
                                            <div class="day-headers-row">
                                                <template x-for="(day, index) in weekDates" :key="day">
                                                    <div class="day-header-v3" x-text="getDayHeaderV3(day)">
                                                    </div>
                                                </template>
                                            </div>

                                            <!-- 7天列容器 -->
                                            <div class="days-container">
                                                <template x-for="(day, index) in weekDates" :key="day">
                                                    <div class="day-column-v3" @click="handleV3GridClick($event, day)">
                                                        <!-- 当天的任务卡片 -->
                                                        <div x-html="renderDayCardsV3(day)">
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>

                                            <!-- 网格线层 -->
                                            <div class="grid-lines-layer" x-html="renderGridLines()">
                                            </div>

                                            <!-- 吸附指示器 -->
                                            <div class="snap-indicator" id="snap-indicator" :style="`top: ${snapIndicatorY}px`">
                                            </div>

                                            <!-- V3专用吸附指示器 -->
                                            <div class="v3-snap-line" id="v3-snap-line" x-show="v3SnapIndicator.visible"
                                                 :style="`top: ${v3SnapIndicator.y}px`">
                                                <div class="v3-snap-tooltip" x-text="v3SnapIndicator.tooltip"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- 月视图 -->
        <div x-show="currentView === 'month'">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <button class="btn btn-outline-primary btn-sm" @click="previousMonth()">
                            ‹ 上个月
                        </button>
                        <span class="mx-3 fw-bold" x-text="getMonthTitle()"></span>
                        <button class="btn btn-outline-primary btn-sm" @click="nextMonth()">
                            下个月 ›
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row text-center fw-bold mb-2">
                        <div class="col">周一</div>
                        <div class="col">周二</div>
                        <div class="col">周三</div>
                        <div class="col">周四</div>
                        <div class="col">周五</div>
                        <div class="col">周六</div>
                        <div class="col">周日</div>
                    </div>
                    <div id="month-calendar">
                        <!-- 月历将在这里渲染 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- v2.1 新建事件模态框 (双轴矩阵) -->
        <div x-show="showNewEventModal" class="modal" :class="{ 'd-block': showNewEventModal }" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">✨ 新建事件 (双轴矩阵)</h5>
                        <button type="button" class="btn-close" @click="showNewEventModal = false"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="createNewEvent()">
                            <!-- 基本信息 -->
                            <div class="row mb-3">
                                <div class="col-8">
                                    <label class="form-label">📅 日期</label>
                                    <input type="date" class="form-control" x-model="newEvent.event_date" required readonly>
                                </div>
                                <div class="col-4">
                                    <label class="form-label">⏰ 时间槽 (自动计算)</label>
                                    <input type="text" class="form-control"
                                           x-bind:value="getTimeSlotDisplay(newEvent.start_time)"
                                           readonly style="background-color: #f8f9fa;"
                                           x-text="console.log('Time slot display value:', getTimeSlotDisplay(newEvent.start_time))">
                                    <input type="hidden" x-model="newEvent.time_slot">
                                </div>
                            </div>

                            <!-- V3.0 时长和精确时间设置 -->
                            <div x-show="isV3Mode" class="card mb-3" style="border-left: 4px solid #007bff;">
                                <div class="card-body py-2">
                                    <h6 class="card-title mb-2">🎯 V3 动态画布设置</h6>

                                    <div class="row mb-2">
                                        <div class="col-4">
                                            <label class="form-label">🕐 起始时间</label>
                                            <input type="time" class="form-control" x-model="newEvent.start_time"
                                                   @input="updateTimeSlot()">
                                        </div>
                                        <div class="col-4">
                                            <label class="form-label">⏱️ 预计时长 (分钟)</label>
                                            <input type="number" class="form-control" x-model="newEvent.duration"
                                                   min="10" max="480" step="10" value="60"
                                                   placeholder="60">
                                        </div>
                                        <div class="col-4">
                                            <div class="form-check mt-4">
                                                <input class="form-check-input" type="checkbox"
                                                       x-model="newEvent.is_precise" id="preciseTimeCheck">
                                                <label class="form-check-label" for="preciseTimeCheck">
                                                    🎯 精确时间
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 结束时间显示 -->
                                    <div class="row">
                                        <div class="col-12">
                                            <label class="form-label">🏁 结束时间 (计算得出)</label>
                                            <input type="text" class="form-control"
                                                   x-bind:value="calculateEndTime(newEvent.start_time, newEvent.duration)"
                                                   readonly style="background-color: #f8f9fa;">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 事件名称 -->
                            <div class="mb-3">
                                <label class="form-label">📝 事件名称 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" x-model="newEvent.name"
                                       placeholder="描述你要做的具体事情" required>
                            </div>

                            <!-- 双轴矩阵选择 -->
                            <div class="row mb-3">
                                <div class="col-6">
                                    <label class="form-label">🎯 领域 (为了什么)</label>
                                    <select class="form-control" x-model="newEvent.domain_id">
                                        <option value="">未指定领域</option>
                                        <template x-for="domain in flatDomains" :key="domain.id">
                                            <option :value="domain.id" x-text="domain.name"></option>
                                        </template>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">⚡ 类型 (做什么性质)</label>
                                    <select class="form-control" x-model="newEvent.activity_type_id">
                                        <option value="">未指定类型</option>
                                        <template x-for="type in flatActivityTypes" :key="type.id">
                                            <option :value="type.id" x-text="type.name"></option>
                                        </template>
                                    </select>
                                </div>
                            </div>

                            <!-- 关联日程 -->
                            <div class="mb-3" x-show="newEvent.domain_id">
                                <label class="form-label">📋 关联日程 (可选)</label>
                                <select class="form-control" x-model="newEvent.schedule_id">
                                    <option value="">无关联日程</option>
                                    <template x-for="schedule in getSchedulesForDomain(newEvent.domain_id)" :key="schedule.id">
                                        <option :value="schedule.id" x-text="schedule.name"></option>
                                    </template>
                                </select>
                            </div>

                            <!-- 备注 -->
                            <div class="mb-3">
                                <label class="form-label">📋 备注</label>
                                <textarea class="form-control" rows="2" x-model="newEvent.notes"
                                          placeholder="任何额外信息..."></textarea>
                            </div>

                            <div class="text-end">
                                <button type="button" class="btn btn-secondary me-2" @click="showNewEventModal = false">取消</button>
                                <button type="submit" class="btn btn-primary">✨ 创建事件</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 新建活动模态框 -->
        <div x-show="showNewActivityModal" class="modal" :class="{ 'd-block': showNewActivityModal }" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">新建活动</h5>
                        <button type="button" class="btn-close" @click="showNewActivityModal = false"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="createActivity()">
                            <div class="mb-3">
                                <label class="form-label">活动名称</label>
                                <input type="text" class="form-control" x-model="newActivity.name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">父活动</label>
                                <select class="form-control" x-model="newActivity.parent_id">
                                    <option value="">无（顶级活动）</option>
                                    <template x-for="activity in flatActivities" :key="activity.id">
                                        <option :value="activity.id" x-text="activity.name"></option>
                                    </template>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">描述</label>
                                <textarea class="form-control" rows="3" x-model="newActivity.description"></textarea>
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-secondary me-2" @click="showNewActivityModal = false">取消</button>
                                <button type="submit" class="btn btn-primary">创建</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 编辑活动模态框 -->
        <div x-show="showEditActivityModal" class="modal" :class="{ 'd-block': showEditActivityModal }" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">编辑活动</h5>
                        <button type="button" class="btn-close" @click="showEditActivityModal = false"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="updateActivity()">
                            <div class="mb-3">
                                <label class="form-label">活动名称</label>
                                <input type="text" class="form-control" x-model="editingActivity.name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">描述</label>
                                <textarea class="form-control" rows="3" x-model="editingActivity.description"></textarea>
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-secondary me-2" @click="showEditActivityModal = false">取消</button>
                                <button type="submit" class="btn btn-primary">保存</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- v2.1 编辑事件模态框 (双轴矩阵) - 只在周视图中显示 -->
        <div x-show="showEditEventModal && currentView === 'week'" class="modal" :class="{ 'd-block': showEditEventModal && currentView === 'week' }" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">📝 编辑事件 (双轴矩阵)</h5>
                        <button type="button" class="btn-close" @click="forceCloseModal()"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="saveEditedEvent()">
                            <!-- 基本信息 -->
                            <div class="row mb-3">
                                <div class="col-8">
                                    <label class="form-label">📅 日期</label>
                                    <input type="date" class="form-control" x-model="editingEvent.event_date" required readonly>
                                </div>
                                <div class="col-4">
                                    <label class="form-label">⏰ 时间槽 (自动计算)</label>
                                    <input type="text" class="form-control"
                                           x-bind:value="getTimeSlotDisplay(editingEvent.start_time)"
                                           readonly style="background-color: #f8f9fa;">
                                    <input type="hidden" x-model="editingEvent.time_slot">
                                </div>
                            </div>

                            <!-- 事件名称 -->
                            <div class="mb-3">
                                <label class="form-label">📝 事件名称 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" x-model="editingEvent.name"
                                       placeholder="描述你要做的具体事情" required>
                            </div>

                            <!-- V3.0 时长和精确时间设置 (编辑模式) -->
                            <div x-show="isV3Mode" class="card mb-3" style="border-left: 4px solid #28a745;">
                                <div class="card-body py-2">
                                    <h6 class="card-title mb-2">🔧 V3 动态画布设置</h6>

                                    <div class="row mb-2">
                                        <div class="col-4">
                                            <label class="form-label">🕐 起始时间</label>
                                            <input type="time" class="form-control" x-model="editingEvent.start_time"
                                                   @input="updateEditingTimeSlot()">
                                        </div>
                                        <div class="col-4">
                                            <label class="form-label">⏱️ 预计时长 (分钟)</label>
                                            <input type="number" class="form-control" x-model="editingEvent.duration"
                                                   min="10" max="480" step="10">
                                        </div>
                                        <div class="col-4">
                                            <div class="form-check mt-4">
                                                <input class="form-check-input" type="checkbox"
                                                       x-model="editingEvent.is_precise" id="editPreciseTimeCheck">
                                                <label class="form-check-label" for="editPreciseTimeCheck">
                                                    🎯 精确时间
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 结束时间显示 -->
                                    <div class="row">
                                        <div class="col-12">
                                            <label class="form-label">🏁 结束时间 (计算得出)</label>
                                            <input type="text" class="form-control"
                                                   x-bind:value="calculateEndTime(editingEvent.start_time, editingEvent.duration)"
                                                   readonly style="background-color: #f8f9fa;">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 双轴矩阵选择 -->
                            <div class="row mb-3">
                                <div class="col-6">
                                    <label class="form-label">🎯 领域 (为了什么)</label>
                                    <select class="form-control" x-model="editingEvent.domain_id">
                                        <option value="">未指定领域</option>
                                        <template x-for="domain in flatDomains" :key="domain.id">
                                            <option :value="domain.id" x-text="domain.name"></option>
                                        </template>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">⚡ 类型 (做什么性质)</label>
                                    <select class="form-control" x-model="editingEvent.activity_type_id">
                                        <option value="">未指定类型</option>
                                        <template x-for="type in flatActivityTypes" :key="type.id">
                                            <option :value="type.id" x-text="type.name"></option>
                                        </template>
                                    </select>
                                </div>
                            </div>

                            <!-- 关联日程 -->
                            <div class="mb-3" x-show="editingEvent.domain_id">
                                <label class="form-label">📋 关联日程 (可选)</label>
                                <select class="form-control" x-model="editingEvent.schedule_id">
                                    <option value="">无关联日程</option>
                                    <template x-for="schedule in getSchedulesForDomain(editingEvent.domain_id)" :key="schedule.id">
                                        <option :value="schedule.id" x-text="schedule.name"></option>
                                    </template>
                                </select>
                            </div>

                            <!-- v1兼容：目标字段 -->
                            <div class="mb-3" x-show="editingEvent.goal || editingEvent.activity_name">
                                <label class="form-label">🎯 目标 (v1兼容)</label>
                                <input type="text" class="form-control" x-model="editingEvent.goal"
                                       placeholder="本次要达成的具体目标">
                                <div class="form-text text-muted" x-show="editingEvent.activity_name">
                                    原活动：<span x-text="editingEvent.activity_name"></span>
                                </div>
                            </div>

                            <!-- 备注 -->
                            <div class="mb-3">
                                <label class="form-label">📋 备注</label>
                                <textarea class="form-control" rows="2" x-model="editingEvent.notes"
                                          placeholder="任何额外信息..."></textarea>
                            </div>

                            <!-- 状态 -->
                            <div class="mb-3">
                                <label class="form-label">📊 状态</label>
                                <select class="form-control" x-model="editingEvent.status">
                                    <option value="planned">📋 计划中</option>
                                    <option value="completed">✅ 已完成</option>
                                </select>
                            </div>

                            <div class="text-end">
                                <button type="button" class="btn btn-danger me-2" @click="deleteEditedEvent()" x-show="editingEvent.id">🗑️ 删除</button>
                                <button type="button" class="btn btn-secondary me-2" @click="forceCloseModal()">取消</button>
                                <button type="submit" class="btn btn-primary">💾 保存修改</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- v2.0 新建Domain模态框 -->
        <div x-show="showNewDomainModal" class="modal" :class="{ 'd-block': showNewDomainModal }" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">🎯 新建领域</h5>
                        <button type="button" class="btn-close" @click="showNewDomainModal = false"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="createDomain()">
                            <div class="mb-3">
                                <label class="form-label">领域名称</label>
                                <input type="text" class="form-control" x-model="newDomain.name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">父领域（可选）</label>
                                <select class="form-control" x-model="newDomain.parent_id">
                                    <option value="">根级领域</option>
                                    <template x-for="domain in flatDomains" :key="domain.id">
                                        <option :value="domain.id" x-text="domain.name"></option>
                                    </template>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">领域描述</label>
                                <textarea class="form-control" x-model="newDomain.description" rows="3"></textarea>
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-secondary me-2" @click="showNewDomainModal = false">取消</button>
                                <button type="submit" class="btn btn-primary">创建</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- v2.0 新建ActivityType模态框 -->
        <div x-show="showNewActivityTypeModal" class="modal" :class="{ 'd-block': showNewActivityTypeModal }" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">⚡ 新建活动类型</h5>
                        <button type="button" class="btn-close" @click="showNewActivityTypeModal = false"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="createActivityType()">
                            <div class="mb-3">
                                <label class="form-label">类型名称</label>
                                <input type="text" class="form-control" x-model="newActivityType.name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">父类型（可选）</label>
                                <select class="form-control" x-model="newActivityType.parent_id">
                                    <option value="">根级类型</option>
                                    <template x-for="type in flatActivityTypes" :key="type.id">
                                        <option :value="type.id" x-text="type.name"></option>
                                    </template>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">类型描述</label>
                                <textarea class="form-control" x-model="newActivityType.description" rows="3"></textarea>
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-secondary me-2" @click="showNewActivityTypeModal = false">取消</button>
                                <button type="submit" class="btn btn-success">创建</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- v2.0 编辑Domain模态框 -->
        <div x-show="showEditDomainModal" class="modal" :class="{ 'd-block': showEditDomainModal }" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">🎯 编辑领域</h5>
                        <button type="button" class="btn-close" @click="showEditDomainModal = false"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="updateDomain()">
                            <div class="mb-3">
                                <label class="form-label">领域名称</label>
                                <input type="text" class="form-control" x-model="editingDomain.name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">父领域（可选）</label>
                                <select class="form-control" x-model="editingDomain.parent_id">
                                    <option value="">根级领域</option>
                                    <template x-for="domain in flatDomains" :key="domain.id">
                                        <option :value="domain.id" x-text="domain.name" :disabled="domain.id === editingDomain.id"></option>
                                    </template>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">领域描述</label>
                                <textarea class="form-control" x-model="editingDomain.description" rows="3"></textarea>
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-secondary me-2" @click="showEditDomainModal = false">取消</button>
                                <button type="submit" class="btn btn-primary">更新</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Schedule管理模态框 -->
        <div x-show="showScheduleManageModal" class="modal" :class="{ 'd-block': showScheduleManageModal }" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">📅 管理日程 - <span x-text="currentDomainName"></span></h5>
                        <button type="button" class="btn-close" @click="closeScheduleManageModal()"></button>
                    </div>
                    <div class="modal-body">
                        <!-- 新建Schedule按钮 -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">现有日程</h6>
                            <button class="btn btn-primary btn-sm" @click="showNewScheduleForm = true">+ 新建日程</button>
                        </div>

                        <!-- 新建Schedule表单 -->
                        <div x-show="showNewScheduleForm" class="card mb-3">
                            <div class="card-body">
                                <form @submit.prevent="createSchedule()">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="mb-3">
                                                <label class="form-label">日程名称</label>
                                                <input type="text" class="form-control" x-model="newSchedule.name" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">起始日期</label>
                                                <input type="datetime-local" class="form-control" x-model="newSchedule.start_date">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">截止日期</label>
                                                <input type="datetime-local" class="form-control" x-model="newSchedule.deadline">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">描述</label>
                                        <textarea class="form-control" x-model="newSchedule.description" rows="2"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">状态</label>
                                        <select class="form-select" x-model="newSchedule.status">
                                            <option value="ongoing">进行中</option>
                                            <option value="completed">已完成</option>
                                            <option value="paused">已暂停</option>
                                            <option value="cancelled">已取消</option>
                                        </select>
                                    </div>
                                    <div class="text-end">
                                        <button type="button" class="btn btn-secondary me-2" @click="showNewScheduleForm = false">取消</button>
                                        <button type="submit" class="btn btn-primary">创建</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Schedule列表 -->
                        <div class="schedule-list">
                            <template x-for="schedule in currentDomainSchedules" :key="schedule.id">
                                <div class="card mb-2">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="card-title mb-1" x-text="schedule.name"></h6>
                                                <p class="card-text text-muted mb-1" x-text="schedule.description || '无描述'"></p>
                                                <div class="d-flex align-items-center flex-wrap">
                                                    <span class="badge me-2 mb-1" :class="{
                                                        'bg-primary': schedule.status === 'ongoing',
                                                        'bg-success': schedule.status === 'completed',
                                                        'bg-warning': schedule.status === 'paused',
                                                        'bg-danger': schedule.status === 'cancelled'
                                                    }" x-text="getStatusText(schedule.status)"></span>
                                                    <small class="text-muted me-3 mb-1" x-show="schedule.start_date">
                                                        起始: <span x-text="formatDateTime(schedule.start_date)"></span>
                                                    </small>
                                                    <small class="text-muted mb-1" x-show="schedule.deadline">
                                                        截止: <span x-text="formatDateTime(schedule.deadline)"></span>
                                                    </small>
                                                </div>
                                            </div>
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-outline-primary" @click="editSchedule(schedule)">编辑</button>
                                                <button class="btn btn-sm btn-outline-danger" @click="deleteSchedule(schedule.id)">删除</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            <div x-show="!currentDomainSchedules.length" class="text-center text-muted py-4">
                                <p>该领域暂无日程</p>
                                <button class="btn btn-outline-primary btn-sm" @click="showNewScheduleForm = true">创建第一个日程</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 编辑Schedule模态框 -->
        <div x-show="showEditScheduleModal" class="modal" :class="{ 'd-block': showEditScheduleModal }" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">📅 编辑日程</h5>
                        <button type="button" class="btn-close" @click="showEditScheduleModal = false"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="updateSchedule()">
                            <div class="mb-3">
                                <label class="form-label">日程名称</label>
                                <input type="text" class="form-control" x-model="editingSchedule.name" required>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">起始日期</label>
                                        <input type="datetime-local" class="form-control" x-model="editingSchedule.start_date">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">截止日期</label>
                                        <input type="datetime-local" class="form-control" x-model="editingSchedule.deadline">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">描述</label>
                                <textarea class="form-control" x-model="editingSchedule.description" rows="3"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">状态</label>
                                <select class="form-select" x-model="editingSchedule.status">
                                    <option value="ongoing">进行中</option>
                                    <option value="completed">已完成</option>
                                    <option value="paused">已暂停</option>
                                    <option value="cancelled">已取消</option>
                                </select>
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-secondary me-2" @click="showEditScheduleModal = false">取消</button>
                                <button type="submit" class="btn btn-primary">更新</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- v2.0 编辑ActivityType模态框 -->
        <div x-show="showEditActivityTypeModal" class="modal" :class="{ 'd-block': showEditActivityTypeModal }" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">⚡ 编辑活动类型</h5>
                        <button type="button" class="btn-close" @click="showEditActivityTypeModal = false"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="updateActivityType()">
                            <div class="mb-3">
                                <label class="form-label">类型名称</label>
                                <input type="text" class="form-control" x-model="editingActivityType.name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">父类型（可选）</label>
                                <select class="form-control" x-model="editingActivityType.parent_id">
                                    <option value="">根级类型</option>
                                    <template x-for="type in flatActivityTypes" :key="type.id">
                                        <option :value="type.id" x-text="type.name" :disabled="type.id === editingActivityType.id"></option>
                                    </template>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">类型描述</label>
                                <textarea class="form-control" x-model="editingActivityType.description" rows="3"></textarea>
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-secondary me-2" @click="showEditActivityTypeModal = false">取消</button>
                                <button type="submit" class="btn btn-success">更新</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 直接嵌入JavaScript代码以避免路径问题
        function laeApp() {
            return {
                // 当前视图状态
                currentView: 'week',
                
                // 日期状态
                currentDate: new Date(),
                currentWeekStart: null,
                currentMonth: new Date().getMonth() + 1,
                currentYear: new Date().getFullYear(),
                
                // 数据状态
                activities: [],
                flatActivities: [],
                weekSchedule: {},
                monthSchedule: {},

                // 用于强制触发Alpine.js重新渲染的辅助变量
                refreshTrigger: 0,

                // V3.0 动态画布模式
                isV3Mode: false, // 是否启用V3模式
                gridSnapSize: 10, // 网格吸附大小(分钟)
                canvasScrollTop: 0, // 画布滚动位置
                snapIndicatorY: 0, // 吸附指示器位置
                v3SnapIndicator: { // V3专用吸附指示器
                    visible: false,
                    y: 0,
                    tooltip: ''
                },

                // V3 拖拽状态
                isDragging: false,
                draggedEventId: null,
                dropProcessing: false, // 防止重复处理drop事件
                lastSnapTime: null, // 保存最后吸附的时间
                v3TimeStart: 7, // V3开始时间(小时) - 7:00
                v3TimeEnd: 23, // V3结束时间(小时) - 23:00
                v3ZoomLevel: 1.0, // V3缩放级别 (0.5 - 2.0)
                
                // 汇总视图数据
                summaryStats: null,
                summaryMonth: '',
                availableMonths: [],
                activityStats: {},
                
                // 时间槽配置
                timeSlots: [
                    { value: 21, name: '上午第1时段' },
                    { value: 22, name: '上午第2时段' },
                    { value: 51, name: '下午第1时段' },
                    { value: 52, name: '下午第2时段' },
                    { value: 71, name: '晚上时段' }
                ],
                
                // 模态框状态
                showNewActivityModal: false,
                showEditActivityModal: false,
                showEditEventModal: false,
                // v2.1 新建事件模态框
                showNewEventModal: false,
                // v2.0 新增模态框状态
                showNewDomainModal: false,
                showNewActivityTypeModal: false,
                showEditDomainModal: false,
                showEditActivityTypeModal: false,
                // Schedule管理模态框状态
                showScheduleManageModal: false,
                showEditScheduleModal: false,
                showNewScheduleForm: false,

                // v2.0 数据状态
                domains: [],
                flatDomains: [],
                activityTypes: [],
                flatActivityTypes: [],
                domainScheduleCounts: {},  // 存储每个Domain的Schedule数量
                weeklySchedules: [],  // 当前周的Schedule数据

                // v2.1 侧边栏状态
                sidebarMode: 'domain', // 'domain' or 'type'
                domainTree: [],
                typeTree: [],
                collapsedNodes: new Set(), // 存储折叠的节点ID
                selectedNode: { // 当前选中的节点
                    id: null,
                    name: '',
                    type: '', // 'domain' or 'type'
                    description: ''
                },
                // V3 侧边栏选择状态
                selectedDomainId: null,
                selectedActivityTypeId: null,

                // 表单数据
                newActivity: {
                    name: '',
                    parent_id: '',
                    description: ''
                },
                // v2.1 新建事件表单数据
                newEvent: {
                    name: '',
                    event_date: '',
                    time_slot: '',
                    domain_id: '',
                    activity_type_id: '',
                    schedule_id: '',
                    notes: '',
                    // V3.0 新字段
                    duration: 60,
                    start_time: null,
                    is_precise: false,
                    canvas_position_y: 0
                },
                // v2.0 新增表单数据
                newDomain: {
                    name: '',
                    parent_id: '',
                    description: ''
                },
                newActivityType: {
                    name: '',
                    parent_id: '',
                    description: ''
                },

                // v2.0 编辑表单数据
                editingDomain: {
                    id: null,
                    name: '',
                    parent_id: '',
                    description: ''
                },
                editingActivityType: {
                    id: null,
                    name: '',
                    parent_id: '',
                    description: ''
                },

                // Schedule管理数据
                currentDomainId: null,
                currentDomainName: '',
                currentDomainSchedules: [],
                newSchedule: {
                    name: '',
                    description: '',
                    start_date: '',
                    deadline: '',
                    status: 'ongoing'
                },
                editingSchedule: {
                    id: null,
                    name: '',
                    description: '',
                    start_date: '',
                    deadline: '',
                    status: 'ongoing'
                },

                editingActivity: {
                    id: null,
                    name: '',
                    description: ''
                },
                
                editingEvent: {
                    id: null,
                    activity_id: null,
                    activity_name: '',
                    event_date: '',
                    time_slot: 21,
                    goal: '',
                    notes: '',
                    status: 'planned'
                },
                
                // 周数据
                weekDates: [],
                
                // 强制关闭模态框
                forceCloseModal() {
                    console.log('Force closing modal');
                    console.log('Before reset - showEditEventModal:', this.showEditEventModal);
                    console.log('Before reset - currentView:', this.currentView);

                    this.showEditEventModal = false;
                    this.showNewActivityModal = false;
                    this.showEditActivityModal = false;
                    // v2.1 新建事件模态框重置
                    this.showNewEventModal = false;
                    // v2.0 新增模态框重置
                    this.showNewDomainModal = false;
                    this.showNewActivityTypeModal = false;
                    this.showEditDomainModal = false;
                    this.showEditActivityTypeModal = false;
                    // Schedule模态框重置
                    this.showScheduleManageModal = false;
                    this.showEditScheduleModal = false;
                    this.showNewScheduleForm = false;
                    
                    console.log('After reset - showEditEventModal:', this.showEditEventModal);
                    console.log('Modal condition check:', this.showEditEventModal && this.currentView === 'week');
                    
                    // 重置编辑事件数据
                    this.editingEvent = {
                        id: null,
                        activity_id: null,
                        activity_name: '',
                        event_date: '',
                        time_slot: 21,
                        goal: '',
                        notes: '',
                        status: 'planned'
                    };
                    
                    // 重置编辑活动数据
                    this.editingActivity = {
                        id: null,
                        name: '',
                        description: ''
                    };
                },
                
                // 初始化
                async init() {
                    console.log('Initializing LAE App... v9 - Debug Enhanced');
                    console.log('Initial view:', this.currentView);
                    console.log('Time slots configuration:', this.timeSlots);
                    
                    // 创建全局引用以便HTML onclick访问
                    window.laeAppInstance = this;
                    
                    // 强制重置所有模态框状态
                    this.forceCloseModal();
                    
                    // 暂时跳过v1.0 activities加载，避免500错误
                    // await this.loadActivities();
                    console.log('Skipping v1.0 activities for now');

                    // v2.0 数据加载
                    await this.loadDomains();
                    console.log('Domains loaded, count:', this.domains.length);

                    await this.loadActivityTypes();
                    console.log('ActivityTypes loaded, count:', this.activityTypes.length);

                    // v2.1 侧边栏初始化
                    await this.loadDomainTree();
                    console.log('Domain tree loaded for sidebar');

                    this.updateWeekDates();
                    console.log('Week dates updated:', this.weekDates);
                    
                    // 根据当前视图加载数据
                    if (this.currentView === 'week') {
                        await this.loadWeekSchedule();
                    } else if (this.currentView === 'month') {
                        await this.loadMonthSchedule();
                    } else if (this.currentView === 'summary') {
                        await this.initSummaryData();
                    }
                    
                    // 确保DOM渲染完成后初始化拖拽功能
                    this.$nextTick(() => {
                        console.log('DOM updated, initializing drag and drop in 300ms...');
                        
                        // 如果是周视图，手动渲染网格和时间条
                        if (this.currentView === 'week') {
                            this.rerenderWeekView();
                            console.log('Week view manually rendered');
                        }
                        
                        setTimeout(() => {
                            this.initDragAndDrop();
                            // v2.1 不再需要侧边栏拖拽初始化（改为选择+点击模式）
                        }, 300);
                    });
                },
                
                // API调用方法
                async apiCall(endpoint, options = {}) {
                    try {
                        console.log('🌐 API调用:', {
                            endpoint,
                            method: options.method || 'GET',
                            body: options.body
                        });

                        const response = await fetch(`/api${endpoint}`, {
                            headers: {
                                'Content-Type': 'application/json',
                                ...options.headers
                            },
                            ...options
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('❌ API错误详情:', {
                                status: response.status,
                                statusText: response.statusText,
                                url: response.url,
                                errorBody: errorText
                            });
                            throw new Error(`API错误: ${response.status} - ${errorText}`);
                        }

                        const result = await response.json();
                        console.log('✅ API成功:', result);
                        return result;
                    } catch (error) {
                        console.error('API调用失败:', error);
                        alert('操作失败: ' + error.message);
                        throw error;
                    }
                },
                
                // 加载活动数据
                async loadActivities() {
                    try {
                        this.activities = await this.apiCall('/activities/tree');
                        this.flatActivities = await this.apiCall('/activities/');
                        console.log('Activities loaded:', this.flatActivities.length);
                    } catch (error) {
                        console.error('加载活动失败:', error);
                    }
                },
                
                // 创建新活动
                async createActivity() {
                    try {
                        const activityData = {
                            name: this.newActivity.name,
                            description: this.newActivity.description || null,
                            parent_id: this.newActivity.parent_id || null
                        };
                        
                        await this.apiCall('/activities/', {
                            method: 'POST',
                            body: JSON.stringify(activityData)
                        });
                        
                        // 重新加载数据
                        await this.loadActivities();
                        
                        // 关闭模态框并重置表单
                        this.showNewActivityModal = false;
                        this.newActivity = { name: '', parent_id: '', description: '' };
                        
                        // 如果在汇总视图，重新加载统计数据
                        if (this.currentView === 'summary') {
                            await this.initSummaryData();
                        }
                        
                    } catch (error) {
                        console.error('创建活动失败:', error);
                    }
                },

                // v2.0 CRUD 方法
                async createDomain() {
                    try {
                        const domainData = {
                            name: this.newDomain.name,
                            description: this.newDomain.description || null,
                            parent_id: this.newDomain.parent_id || null
                        };

                        const response = await fetch('/api/domains/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(domainData)
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        console.log('✅ Domain created successfully');
                        this.showNewDomainModal = false;
                        this.newDomain = { name: '', parent_id: '', description: '' };

                        // 重新加载domains数据
                        await this.loadDomains();

                    } catch (error) {
                        console.error('创建领域失败:', error);
                        alert('创建领域失败: ' + error.message);
                    }
                },

                async updateDomain() {
                    try {
                        const domainData = {
                            name: this.editingDomain.name,
                            description: this.editingDomain.description || null,
                            parent_id: this.editingDomain.parent_id || null
                        };

                        const response = await fetch(`/api/domains/${this.editingDomain.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(domainData)
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        console.log('✅ Domain updated successfully');
                        this.showEditDomainModal = false;

                        // 重新加载domains数据
                        await this.loadDomains();

                    } catch (error) {
                        console.error('更新领域失败:', error);
                        alert('更新领域失败: ' + error.message);
                    }
                },

                async createActivityType() {
                    try {
                        const typeData = {
                            name: this.newActivityType.name,
                            description: this.newActivityType.description || null,
                            parent_id: this.newActivityType.parent_id || null
                        };

                        const response = await fetch('/api/activity-types/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(typeData)
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        console.log('✅ ActivityType created successfully');
                        this.showNewActivityTypeModal = false;
                        this.newActivityType = { name: '', parent_id: '', description: '' };

                        // 重新加载activity types数据
                        await this.loadActivityTypes();

                    } catch (error) {
                        console.error('创建活动类型失败:', error);
                        alert('创建活动类型失败: ' + error.message);
                    }
                },

                // v2.1 创建新事件（双轴矩阵）
                async createNewEvent() {
                    try {
                        if (!this.newEvent.name.trim()) {
                            alert('请输入事件名称');
                            return;
                        }

                        const eventData = {
                            name: this.newEvent.name.trim(),
                            event_date: this.newEvent.event_date,
                            time_slot: parseInt(this.newEvent.time_slot),
                            domain_id: this.newEvent.domain_id && this.newEvent.domain_id !== '' ? parseInt(this.newEvent.domain_id) : null,
                            activity_type_id: this.newEvent.activity_type_id && this.newEvent.activity_type_id !== '' ? parseInt(this.newEvent.activity_type_id) : null,
                            schedule_id: this.newEvent.schedule_id && this.newEvent.schedule_id !== '' ? parseInt(this.newEvent.schedule_id) : null,
                            notes: this.newEvent.notes || '',
                            status: 'planned',
                            // V3.0 新字段支持
                            duration: this.newEvent.duration ? parseInt(this.newEvent.duration) : 60,
                            start_time: this.newEvent.start_time ? this.formatTimeForAPI(this.newEvent.start_time) : null,
                            is_precise: !!this.newEvent.is_precise,
                            canvas_position_y: this.newEvent.canvas_position_y || 0
                        };

                        console.log('🎯 Creating new event with data:', eventData);

                        const response = await fetch('/api/events/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(eventData)
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            console.error('🚨 API Error Details:', errorData);

                            // 处理422验证错误的详细信息
                            if (response.status === 422 && errorData.detail) {
                                let errorMsg = '验证错误:\n';
                                if (Array.isArray(errorData.detail)) {
                                    errorData.detail.forEach(err => {
                                        errorMsg += `- ${err.loc?.join('.') || 'unknown'}: ${err.msg}\n`;
                                    });
                                } else {
                                    errorMsg += JSON.stringify(errorData.detail, null, 2);
                                }
                                throw new Error(errorMsg);
                            }

                            throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.detail || JSON.stringify(errorData)}`);
                        }

                        const createdEvent = await response.json();
                        console.log('✅ Event created successfully:', createdEvent);

                        // 关闭模态框并重置表单
                        this.showNewEventModal = false;
                        this.newEvent = {
                            name: '',
                            event_date: '',
                            time_slot: '',
                            domain_id: '',
                            activity_type_id: '',
                            schedule_id: '',
                            notes: '',
                            // V3.0 新字段
                            duration: 60,
                            start_time: null,
                            is_precise: false,
                            canvas_position_y: 0
                        };

                        // 重新加载周数据
                        await this.loadWeekSchedule();

                        // v2.1 改进：保留选中状态以便快速批量创建
                        console.log('✅ Event created, keeping selected node for batch creation');

                    } catch (error) {
                        console.error('❌ 创建事件失败:', error);
                        alert('创建事件失败: ' + error.message);
                    }
                },

                // 获取指定领域的日程列表
                getSchedulesForDomain(domainId) {
                    if (!domainId) return [];
                    // 这里需要实现获取schedules的逻辑
                    // 暂时返回空数组，后续可以加载schedules数据
                    return [];
                },

                async updateActivityType() {
                    try {
                        const typeData = {
                            name: this.editingActivityType.name,
                            description: this.editingActivityType.description || null,
                            parent_id: this.editingActivityType.parent_id || null
                        };

                        const response = await fetch(`/api/activity-types/${this.editingActivityType.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(typeData)
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        console.log('✅ ActivityType updated successfully');
                        this.showEditActivityTypeModal = false;

                        // 重新加载activity types数据
                        await this.loadActivityTypes();

                    } catch (error) {
                        console.error('更新活动类型失败:', error);
                        alert('更新活动类型失败: ' + error.message);
                    }
                },

                editDomain(domainId) {
                    const domain = this.domains.find(d => d.id === domainId);
                    if (!domain) {
                        console.error('Domain not found:', domainId);
                        return;
                    }

                    this.editingDomain = {
                        id: domain.id,
                        name: domain.name,
                        description: domain.description || '',
                        parent_id: domain.parent_id
                    };
                    this.showEditDomainModal = true;
                },

                async deleteDomain(domainId) {
                    if (confirm('确定要删除这个领域吗？这将同时删除所有子领域。')) {
                        try {
                            const response = await fetch(`/api/domains/${domainId}`, {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json',
                                }
                            });

                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }

                            console.log('✅ Domain deleted successfully');

                            // 重新加载domains数据
                            await this.loadDomains();

                        } catch (error) {
                            console.error('删除领域失败:', error);
                            alert('删除领域失败: ' + error.message);
                        }
                    }
                },

                // ===== Schedule管理功能 =====
                async manageSchedules(domainId) {
                    const domain = this.domains.find(d => d.id === domainId);
                    if (!domain) {
                        console.error('Domain not found:', domainId);
                        return;
                    }

                    this.currentDomainId = domainId;
                    this.currentDomainName = domain.name;
                    this.showScheduleManageModal = true;

                    // 加载该Domain的Schedules
                    await this.loadDomainSchedules(domainId);
                },

                async loadDomainSchedules(domainId) {
                    try {
                        console.log('📅 Loading schedules for domain:', domainId);
                        const response = await fetch(`/api/schedules/?domain_id=${domainId}`);
                        if (!response.ok) throw new Error('Failed to load schedules');

                        this.currentDomainSchedules = await response.json();
                        console.log('✅ Domain schedules loaded:', this.currentDomainSchedules.length, 'schedules');
                    } catch (error) {
                        console.error('❌ Error loading domain schedules:', error);
                        this.currentDomainSchedules = [];
                    }
                },

                closeScheduleManageModal() {
                    this.showScheduleManageModal = false;
                    this.showNewScheduleForm = false;
                    this.currentDomainId = null;
                    this.currentDomainName = '';
                    this.currentDomainSchedules = [];
                    this.newSchedule = {
                        name: '',
                        description: '',
                        start_date: '',
                        deadline: '',
                        status: 'ongoing'
                    };
                    // 重新加载Schedule数量以更新显示
                    this.loadDomainScheduleCounts();
                },

                async createSchedule() {
                    try {
                        const scheduleData = {
                            domain_id: this.currentDomainId,
                            name: this.newSchedule.name,
                            description: this.newSchedule.description || null,
                            start_date: this.newSchedule.start_date || null,
                            deadline: this.newSchedule.deadline || null,
                            status: this.newSchedule.status
                        };

                        const response = await fetch('/api/schedules/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(scheduleData)
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        console.log('✅ Schedule created successfully');
                        this.showNewScheduleForm = false;
                        this.newSchedule = {
                            name: '',
                            description: '',
                            start_date: '',
                            deadline: '',
                            status: 'ongoing'
                        };

                        // 重新加载该Domain的Schedules
                        await this.loadDomainSchedules(this.currentDomainId);

                    } catch (error) {
                        console.error('创建日程失败:', error);
                        alert('创建日程失败: ' + error.message);
                    }
                },

                editSchedule(schedule) {
                    this.editingSchedule = {
                        id: schedule.id,
                        name: schedule.name,
                        description: schedule.description || '',
                        start_date: schedule.start_date ? this.formatDateTimeForInput(schedule.start_date) : '',
                        deadline: schedule.deadline ? this.formatDateTimeForInput(schedule.deadline) : '',
                        status: schedule.status
                    };
                    this.showEditScheduleModal = true;
                },

                async updateSchedule() {
                    try {
                        const scheduleData = {
                            name: this.editingSchedule.name,
                            description: this.editingSchedule.description || null,
                            start_date: this.editingSchedule.start_date || null,
                            deadline: this.editingSchedule.deadline || null,
                            status: this.editingSchedule.status
                        };

                        const response = await fetch(`/api/schedules/${this.editingSchedule.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(scheduleData)
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        console.log('✅ Schedule updated successfully');
                        this.showEditScheduleModal = false;

                        // 重新加载该Domain的Schedules
                        await this.loadDomainSchedules(this.currentDomainId);

                    } catch (error) {
                        console.error('更新日程失败:', error);
                        alert('更新日程失败: ' + error.message);
                    }
                },

                async deleteSchedule(scheduleId) {
                    if (confirm('确定要删除这个日程吗？')) {
                        try {
                            const response = await fetch(`/api/schedules/${scheduleId}`, {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json',
                                }
                            });

                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }

                            console.log('✅ Schedule deleted successfully');

                            // 重新加载该Domain的Schedules
                            await this.loadDomainSchedules(this.currentDomainId);

                        } catch (error) {
                            console.error('删除日程失败:', error);
                            alert('删除日程失败: ' + error.message);
                        }
                    }
                },

                // Schedule辅助函数
                getStatusText(status) {
                    const statusMap = {
                        'ongoing': '进行中',
                        'completed': '已完成',
                        'paused': '已暂停',
                        'cancelled': '已取消'
                    };
                    return statusMap[status] || status;
                },

                formatDateTime(dateTimeStr) {
                    if (!dateTimeStr) return '';
                    const date = new Date(dateTimeStr);
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                },

                formatDateTimeForInput(dateTimeStr) {
                    if (!dateTimeStr) return '';
                    const date = new Date(dateTimeStr);
                    return date.toISOString().slice(0, 16); // 格式: YYYY-MM-DDTHH:mm
                },

                // 加载所有Domain的Schedule数量
                async loadDomainScheduleCounts() {
                    try {
                        console.log('📊 Loading domain schedule counts...');
                        const response = await fetch('/api/schedules/');
                        if (!response.ok) throw new Error('Failed to load schedules');

                        const allSchedules = await response.json();

                        // 统计每个Domain的Schedule数量
                        this.domainScheduleCounts = {};
                        allSchedules.forEach(schedule => {
                            const domainId = schedule.domain_id;
                            this.domainScheduleCounts[domainId] = (this.domainScheduleCounts[domainId] || 0) + 1;
                        });

                        console.log('✅ Domain schedule counts loaded:', this.domainScheduleCounts);
                    } catch (error) {
                        console.error('❌ Error loading domain schedule counts:', error);
                        this.domainScheduleCounts = {};
                    }
                },

                // 获取指定Domain的Schedule数量
                getDomainScheduleCount(domainId) {
                    return this.domainScheduleCounts[domainId] || 0;
                },

                // 加载当前周的Schedule数据
                async loadWeeklySchedules() {
                    try {
                        console.log('📅 Loading weekly schedules...');

                        // 计算当前周的开始和结束日期
                        const startDate = new Date(this.currentWeekStart);
                        const endDate = new Date(this.currentWeekStart);
                        endDate.setDate(endDate.getDate() + 6); // 周日

                        const startStr = startDate.toISOString().split('T')[0];
                        const endStr = endDate.toISOString().split('T')[0];

                        console.log('Week range:', startStr, 'to', endStr);

                        const response = await fetch(`/api/schedules/?start_date=${startStr}&end_date=${endStr}`);
                        if (!response.ok) throw new Error('Failed to load weekly schedules');

                        this.weeklySchedules = await response.json();
                        console.log('✅ Weekly schedules loaded:', this.weeklySchedules.length, 'schedules');
                    } catch (error) {
                        console.error('❌ Error loading weekly schedules:', error);
                        this.weeklySchedules = [];
                    }
                },

                editActivityType(typeId) {
                    const activityType = this.activityTypes.find(t => t.id === typeId);
                    if (!activityType) {
                        console.error('ActivityType not found:', typeId);
                        return;
                    }

                    this.editingActivityType = {
                        id: activityType.id,
                        name: activityType.name,
                        description: activityType.description || '',
                        parent_id: activityType.parent_id
                    };
                    this.showEditActivityTypeModal = true;
                },

                async deleteActivityType(typeId) {
                    if (confirm('确定要删除这个活动类型吗？这将同时删除所有子类型。')) {
                        try {
                            const response = await fetch(`/api/activity-types/${typeId}`, {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json',
                                }
                            });

                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }

                            console.log('✅ ActivityType deleted successfully');

                            // 重新加载activity types数据
                            await this.loadActivityTypes();

                        } catch (error) {
                            console.error('删除活动类型失败:', error);
                            alert('删除活动类型失败: ' + error.message);
                        }
                    }
                },

                // 加载v2.0数据
                async loadDomains() {
                    try {
                        const response = await fetch('/api/domains/');
                        if (response.ok) {
                            this.domains = await response.json();
                            this.flatDomains = [...this.domains];
                            console.log('✅ Domains loaded:', this.domains.length);
                        } else {
                            console.warn('⚠️  Failed to load domains, using fallback');
                            this.domains = [];
                            this.flatDomains = [];
                        }
                    } catch (error) {
                        console.error('❌ Error loading domains:', error);
                        this.domains = [];
                        this.flatDomains = [];
                    }
                },

                async loadActivityTypes() {
                    try {
                        const response = await fetch('/api/activity-types/');
                        if (response.ok) {
                            this.activityTypes = await response.json();
                            this.flatActivityTypes = [...this.activityTypes];
                            console.log('✅ ActivityTypes loaded:', this.activityTypes.length);
                        } else {
                            console.warn('⚠️  Failed to load activity types, using fallback');
                            this.activityTypes = [];
                            this.flatActivityTypes = [];
                        }
                    } catch (error) {
                        console.error('❌ Error loading activity types:', error);
                        this.activityTypes = [];
                        this.flatActivityTypes = [];
                    }
                },

                // 编辑活动 (v1.0保留)
                editActivity(activityId) {
                    const activity = this.flatActivities.find(a => a.id === activityId);
                    if (!activity) {
                        console.error('Activity not found:', activityId);
                        return;
                    }
                    
                    this.editingActivity = {
                        id: activity.id,
                        name: activity.name,
                        description: activity.description || ''
                    };
                    
                    this.showEditActivityModal = true;
                },
                
                // 更新活动
                async updateActivity() {
                    try {
                        const activityData = {
                            name: this.editingActivity.name,
                            description: this.editingActivity.description || null
                        };
                        
                        await this.apiCall(`/activities/${this.editingActivity.id}`, {
                            method: 'PUT',
                            body: JSON.stringify(activityData)
                        });
                        
                        // 重新加载数据
                        await this.loadActivities();
                        
                        // 关闭模态框并重置表单
                        this.showEditActivityModal = false;
                        this.editingActivity = { id: null, name: '', description: '' };
                        
                        // 如果在汇总视图，重新加载统计数据
                        if (this.currentView === 'summary') {
                            await this.initSummaryData();
                        }
                        
                    } catch (error) {
                        console.error('更新活动失败:', error);
                    }
                },
                
                // 视图切换
                async switchView(view) {
                    console.log('Switching from', this.currentView, 'to', view);
                    this.currentView = view;
                    
                    // 切换视图时清理所有模态框状态
                    this.showNewActivityModal = false;
                    this.showEditActivityModal = false;
                    this.showEditEventModal = false;
                    
                    if (view === 'week') {
                        console.log('Entering week view...');
                        console.log('Current week dates:', this.weekDates);
                        console.log('Time slots:', this.timeSlots);
                        
                        await this.loadWeekSchedule();
                        
                        // 强制重新渲染网格和时间条
                        this.$nextTick(() => {
                            // 手动触发重新渲染
                            this.rerenderWeekView();
                            
                            console.log('Week view DOM updated, checking elements...');
                            console.log('Activity pool element:', document.getElementById('activity-pool'));
                            console.log('Week grid element:', document.getElementById('week-grid'));
                            console.log('Time slot elements:', document.querySelectorAll('.time-slot').length);
                            
                            setTimeout(() => {
                                this.initDragAndDrop();
                            }, 200);
                        });
                    } else if (view === 'month') {
                        await this.loadMonthSchedule();
                    } else if (view === 'summary') {
                        await this.initSummaryData();
                    }
                },
                
                // 周视图相关方法
                updateWeekDates() {
                    const start = new Date(this.currentDate);
                    start.setDate(start.getDate() - start.getDay() + 1); // 获取周一
                    this.currentWeekStart = new Date(start);
                    
                    this.weekDates = [];
                    for (let i = 0; i < 7; i++) {
                        const date = new Date(start);
                        date.setDate(start.getDate() + i);
                        this.weekDates.push(date.toISOString().split('T')[0]);
                    }
                },
                
                async loadWeekSchedule() {
                    try {
                        const targetDate = this.weekDates[0]; // 周一
                        console.log('Loading week schedule for:', targetDate);
                        const data = await this.apiCall(`/calendar/week/${targetDate}`);

                        // 转换数据格式以便查找
                        this.weekSchedule = {};
                        data.schedule.forEach(day => {
                            this.weekSchedule[day.date] = day.slots;
                        });
                        console.log('Week schedule loaded:', this.weekSchedule);
                        console.log('Schedule data structure:', data);

                        // 同时加载当前周的Schedule时间条数据
                        await this.loadWeeklySchedules();

                        // 在V3模式下重新初始化拖拽功能
                        if (this.isV3Mode) {
                            this.$nextTick(() => {
                                setTimeout(() => {
                                    this.initV3DragAndDrop();
                                    console.log('🔄 重新初始化V3拖拽功能');
                                }, 100);
                            });
                        }
                    } catch (error) {
                        console.error('加载周日程失败:', error);
                        // 即使加载失败也要初始化空的周日程对象
                        this.weekSchedule = {};
                    }
                },
                
                getScheduledEvent(date, timeSlot) {
                    return this.weekSchedule[date]?.[timeSlot] || null;
                },
                
                async previousWeek() {
                    console.log('⬅️ 切换到上一周');
                    this.currentDate.setDate(this.currentDate.getDate() - 7);
                    this.updateWeekDates();
                    await this.loadWeekSchedule();

                    // 确保切换周后重新初始化拖拽功能
                    this.$nextTick(() => {
                        this.rerenderWeekView();
                        console.log('周数据切换后重新渲染网格和时间条');

                        setTimeout(() => {
                            this.initDragAndDrop();
                            console.log('周数据切换后重新初始化拖拽');
                        }, 200);
                    });
                },

                async nextWeek() {
                    console.log('➡️ 切换到下一周');
                    this.currentDate.setDate(this.currentDate.getDate() + 7);
                    this.updateWeekDates();
                    await this.loadWeekSchedule();

                    // 确保切换周后重新初始化拖拽功能
                    this.$nextTick(() => {
                        this.rerenderWeekView();
                        console.log('周数据切换后重新渲染网格和时间条');

                        setTimeout(() => {
                            this.initDragAndDrop();
                            console.log('周数据切换后重新初始化拖拽');
                        }, 200);
                    });
                },
                
                // v2.1 点击时间槽处理（选择+点击模式）
                handleTimeSlotClick(date, timeSlot) {
                    console.log('🎯 Time slot clicked:', date, timeSlot, 'Selected node:', this.selectedNode);

                    // 只在周视图中允许操作
                    if (this.currentView !== 'week') {
                        console.log('Time slot click blocked - not in week view');
                        return;
                    }

                    const existingEvent = this.getScheduledEvent(date, timeSlot);

                    if (existingEvent) {
                        // 编辑现有事件 - 使用旧的编辑模态框
                        this.editExistingEvent(date, timeSlot, existingEvent);
                    } else if (this.selectedNode.id) {
                        // 有选中节点 - 使用新的创建模态框
                        this.createEventWithSelectedNode(date, timeSlot);
                    } else {
                        // 没有选中节点 - 使用新的创建模态框
                        this.createEventFromBlank(date, timeSlot);
                    }
                },

                // 编辑现有事件
                editExistingEvent(date, timeSlot, event) {
                    console.log('📝 Editing existing event:', event);
                    this.editingEvent = {
                        id: event.id,
                        activity_id: event.activity_id,
                        activity_name: event.activity_name,
                        event_date: date,
                        time_slot: timeSlot,
                        // v2.1 新字段
                        name: event.name || event.activity_name || '',
                        domain_id: event.domain_id ? String(event.domain_id) : '',
                        activity_type_id: event.activity_type_id ? String(event.activity_type_id) : '',
                        schedule_id: event.schedule_id ? String(event.schedule_id) : '',
                        // v1 兼容字段
                        goal: event.goal || '',
                        notes: event.notes || '',
                        status: event.status || 'planned'
                    };
                    this.showEditEventModal = true;
                },

                // 基于选中节点创建事件
                createEventWithSelectedNode(date, timeSlot) {
                    console.log('✨ Creating event with selected node:', this.selectedNode);
                    this.newEvent = {
                        name: this.selectedNode.name, // 🎯 自动填入选中节点名称
                        event_date: date,
                        time_slot: timeSlot,
                        domain_id: this.selectedNode.type === 'domain' ? this.selectedNode.id : '',
                        activity_type_id: this.selectedNode.type === 'type' ? this.selectedNode.id : '',
                        schedule_id: '',
                        notes: ''
                    };
                    this.showNewEventModal = true;
                },

                // 从空白创建事件
                createEventFromBlank(date, timeSlot) {
                    console.log('📄 Creating event from blank');
                    this.newEvent = {
                        name: '',
                        event_date: date,
                        time_slot: timeSlot,
                        domain_id: '',
                        activity_type_id: '',
                        schedule_id: '',
                        notes: ''
                    };
                    this.showNewEventModal = true;
                },

                // 保持向后兼容的旧方法
                editScheduledEvent(date, timeSlot) {
                    // 重定向到新的处理方法
                    this.handleTimeSlotClick(date, timeSlot);
                },
                
                async saveScheduledEvent() {
                    try {
                        if (!this.editingEvent.activity_id) {
                            alert('请先拖拽活动到时间槽中');
                            return;
                        }
                        
                        const eventData = {
                            activity_id: this.editingEvent.activity_id,
                            event_date: this.editingEvent.event_date,
                            time_slot: this.editingEvent.time_slot,
                            goal: this.editingEvent.goal || null,
                            notes: this.editingEvent.notes || null,
                            status: this.editingEvent.status
                        };
                        
                        if (this.editingEvent.id) {
                            // 更新现有事件
                            await this.apiCall(`/events/${this.editingEvent.id}`, {
                                method: 'PUT',
                                body: JSON.stringify(eventData)
                            });
                        } else {
                            // 创建新事件
                            await this.apiCall('/events/', {
                                method: 'POST',
                                body: JSON.stringify(eventData)
                            });
                        }
                        
                        // 刷新数据
                        await this.loadWeekSchedule();
                        this.forceCloseModal();
                        
                    } catch (error) {
                        console.error('保存日程失败:', error);
                    }
                },
                
                async deleteScheduledEvent() {
                    if (!this.editingEvent.id) return;
                    
                    if (confirm('确定要删除这个日程吗？')) {
                        try {
                            await this.apiCall(`/events/${this.editingEvent.id}`, {
                                method: 'DELETE'
                            });
                            
                            await this.loadWeekSchedule();
                            this.forceCloseModal();
                        } catch (error) {
                            console.error('删除日程失败:', error);
                        }
                    }
                },

                // v2.1 保存编辑的事件 (双轴矩阵)
                async saveEditedEvent() {
                    try {
                        if (!this.editingEvent.name.trim()) {
                            alert('请输入事件名称');
                            return;
                        }

                        // 确保time_slot是有效值，如果无效则根据start_time重新计算
                        let timeSlot = this.editingEvent.time_slot;
                        if (!timeSlot || ![21, 22, 51, 52, 71].includes(parseInt(timeSlot))) {
                            if (this.editingEvent.start_time) {
                                timeSlot = this.getTimeSlotFromTime(this.editingEvent.start_time);
                                console.log('🔧 Recalculated time_slot from start_time:', this.editingEvent.start_time, '->', timeSlot);
                            } else {
                                timeSlot = 21; // 默认值
                                console.log('🔧 Using default time_slot:', timeSlot);
                            }
                        }

                        console.log('📝 Updating event with time_slot:', timeSlot);

                        const eventData = {
                            name: this.editingEvent.name.trim(),
                            event_date: this.editingEvent.event_date,
                            time_slot: parseInt(timeSlot),
                            domain_id: this.editingEvent.domain_id && this.editingEvent.domain_id !== '' ? parseInt(this.editingEvent.domain_id) : null,
                            activity_type_id: this.editingEvent.activity_type_id && this.editingEvent.activity_type_id !== '' ? parseInt(this.editingEvent.activity_type_id) : null,
                            schedule_id: this.editingEvent.schedule_id && this.editingEvent.schedule_id !== '' ? parseInt(this.editingEvent.schedule_id) : null,
                            notes: this.editingEvent.notes || '',
                            status: this.editingEvent.status || 'planned',
                            // v1 兼容字段
                            goal: this.editingEvent.goal || '',
                            // V3.0 新字段支持
                            duration: this.editingEvent.duration ? parseInt(this.editingEvent.duration) : 60,
                            start_time: this.editingEvent.start_time ? this.formatTimeForAPI(this.editingEvent.start_time) : null,
                            is_precise: !!this.editingEvent.is_precise,
                            canvas_position_y: this.editingEvent.canvas_position_y || 0
                        };

                        console.log('📝 Updating event with data:', eventData);

                        const response = await fetch(`/api/events/${this.editingEvent.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(eventData)
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.detail || 'Unknown error'}`);
                        }

                        console.log('✅ Event updated successfully');

                        // 关闭模态框并重新加载数据
                        this.forceCloseModal();
                        await this.loadWeekSchedule();

                        // 重新渲染网格
                        const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                        if (gridContainer) {
                            gridContainer.innerHTML = this.renderFullWeekGrid();
                            setTimeout(() => { this.initTimeSlotsDragAndDrop(); }, 100);
                        }

                    } catch (error) {
                        console.error('❌ 更新事件失败:', error);
                        alert('更新事件失败: ' + error.message);
                    }
                },

                // v2.1 删除编辑的事件
                async deleteEditedEvent() {
                    if (!this.editingEvent.id) return;

                    if (confirm('确定要删除这个事件吗？')) {
                        try {
                            console.log('🗑️ Deleting event:', this.editingEvent.id);

                            const response = await fetch(`/api/events/${this.editingEvent.id}`, {
                                method: 'DELETE'
                            });

                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }

                            console.log('✅ Event deleted successfully');

                            // 关闭模态框并重新加载数据
                            this.forceCloseModal();
                            await this.loadWeekSchedule();

                            // 重新渲染网格
                            const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                            if (gridContainer) {
                                gridContainer.innerHTML = this.renderFullWeekGrid();
                                setTimeout(() => { this.initTimeSlotsDragAndDrop(); }, 100);
                            }

                        } catch (error) {
                            console.error('❌ 删除事件失败:', error);
                            alert('删除事件失败: ' + error.message);
                        }
                    }
                },

                // 拖拽功能初始化
                initDragAndDrop() {
                    console.log('Initializing drag and drop...', 'Current view:', this.currentView);
                    
                    // 只在周视图中初始化拖拽功能
                    if (this.currentView !== 'week') {
                        console.log('Drag and drop skipped - not in week view');
                        return;
                    }
                    
                    const self = this; // 保存Alpine.js实例引用
                    
                    // 只清理时间槽的Sortable实例，保留活动池的实例
                    document.querySelectorAll('.time-slot.sortable-initialized').forEach(el => {
                        if (el.sortableInstance) {
                            el.sortableInstance.destroy();
                        }
                        el.classList.remove('sortable-initialized');
                    });
                    
                    console.log('Cleaned up time slot sortable instances');
                    
                    // v2.1: 不再需要活动池拖拽，改为选择+点击模式
                    // this.initActivityPoolDragAndDrop();
                    
                    // 初始化时间槽的拖拽接收
                    const timeSlots = document.querySelectorAll('.time-slot');
                    console.log('Found time slots:', timeSlots.length);
                    
                    timeSlots.forEach((slot, index) => {
                        if (!slot.classList.contains('sortable-initialized')) {
                            console.log(`Initializing time slot ${index}:`, {
                                date: slot.getAttribute('data-date'),
                                timeSlot: slot.getAttribute('data-time-slot')
                            });
                            
                            slot.sortableInstance = Sortable.create(slot, {
                                group: {
                                    name: 'activities',
                                    pull: true,  // 允许从时间槽拖出（用于删除或移动）
                                    put: true    // 允许拖入时间槽
                                },
                                animation: 200,
                                ghostClass: 'sortable-ghost',
                                chosenClass: 'sortable-chosen',
                                dragClass: 'sortable-drag',
                                // 提高拖拽判断精度的参数
                                tolerance: 'pointer', // 使用鼠标指针位置判断，而不是元素中心
                                forceAutoScrollFallback: false, // 禁用自动滚动避免位置计算错误
                                fallbackTolerance: 5, // 设置容差为5px，提高精度
                                // 当拖拽到时间槽（包括移动现有事件）
                                onAdd: function(evt) {
                                    console.log('Drop event triggered on slot:', evt.to);
                                    const activityId = evt.item.getAttribute('data-activity-id');
                                    const eventId = evt.item.getAttribute('data-event-id');
                                    const eventName = evt.item.getAttribute('data-event-name');
                                    const domainId = evt.item.getAttribute('data-domain-id');
                                    const activityTypeId = evt.item.getAttribute('data-activity-type-id');
                                    const date = evt.to.getAttribute('data-date');
                                    const timeSlot = parseInt(evt.to.getAttribute('data-time-slot'));
                                    const fromPool = evt.from.id === 'activity-pool';
                                    const fromTimeSlot = evt.from.classList.contains('time-slot');

                                    // 详细的拖拽判断调试信息
                                    const targetRect = evt.to.getBoundingClientRect();
                                    const isValidTarget = self.validateDropTarget(evt.to, targetRect);

                                    console.log('🎯 拖拽位置判断详情:', {
                                        目标槽位: `${date} ${timeSlot}`,
                                        目标元素: evt.to,
                                        目标元素标签: evt.to.tagName,
                                        目标元素类名: evt.to.className,
                                        目标元素ID: evt.to.id,
                                        目标元素可见性: window.getComputedStyle(evt.to).display,
                                        目标元素透明度: window.getComputedStyle(evt.to).opacity,
                                        目标元素边界: {
                                            left: targetRect.left,
                                            right: targetRect.right,
                                            top: targetRect.top,
                                            bottom: targetRect.bottom,
                                            width: targetRect.width,
                                            height: targetRect.height
                                        },
                                        目标有效性: isValidTarget ? '✅ 有效' : '❌ 无效',
                                        拖拽源: fromPool ? '活动池' : '时间槽',
                                        活动ID: activityId,
                                        所有时间槽元素数量: document.querySelectorAll('.time-slot').length,
                                        当前时间槽是否存在: document.querySelector(`[data-date="${date}"][data-time-slot="${timeSlot}"]`) !== null
                                    });

                                    // 验证目标元素有效性
                                    if (!isValidTarget) {
                                        console.warn('⚠️ 检测到无效目标元素，尝试重新定位...');

                                        // 尝试找到最近的有效时间槽
                                        const validTarget = self.findNearestValidTimeSlot(evt.originalEvent);
                                        if (validTarget) {
                                            console.log('🔄 重定向到有效目标:', validTarget);
                                            // 更新目标数据
                                            evt.to = validTarget;
                                            const newDate = validTarget.getAttribute('data-date');
                                            const newTimeSlot = parseInt(validTarget.getAttribute('data-time-slot'));

                                            console.log('🎯 重定向后的目标:', {
                                                原目标: `${date} ${timeSlot}`,
                                                新目标: `${newDate} ${newTimeSlot}`
                                            });

                                            // 使用新的目标数据
                                            if (fromTimeSlot) {
                                                self.handleMoveEvent(activityId, evt.from.getAttribute('data-date'),
                                                    parseInt(evt.from.getAttribute('data-time-slot')), newDate, newTimeSlot);
                                            } else {
                                                self.handleDrop(activityId, newDate, newTimeSlot);
                                            }
                                        } else {
                                            console.error('❌ 找不到有效的目标时间槽');
                                            evt.item.remove();
                                        }
                                        return;
                                    }

                                    console.log('🎯 Drop details:', {
                                        activityId, eventId, eventName, domainId, activityTypeId,
                                        date, timeSlot, fromPool, fromTimeSlot,
                                        fromElement: evt.from.id || evt.from.className
                                    });

                                    // v2.1兼容性：检查是否有有效的拖拽数据
                                    const hasActivityId = activityId && activityId !== '';
                                    const hasEventId = eventId && eventId !== '';
                                    const hasEventName = eventName && eventName !== '';

                                    if ((!hasActivityId && !hasEventId) || !date || !timeSlot) {
                                        console.error('❌ Missing required drop data:', {
                                            hasActivityId, hasEventId, hasEventName, date, timeSlot
                                        });
                                        evt.item.remove();
                                        return;
                                    }

                                    // 立即移除拖拽的临时元素
                                    evt.item.remove();

                                    // 如果是从其他时间槽移动过来的，需要先删除原有事件
                                    if (fromTimeSlot) {
                                        const originalDate = evt.from.getAttribute('data-date');
                                        const originalTimeSlot = parseInt(evt.from.getAttribute('data-time-slot'));
                                        console.log('🔄 Moving event from time slot:', originalDate, originalTimeSlot);

                                        if (hasEventId) {
                                            // v2.1事件移动：使用事件ID
                                            self.handleMoveEventV2(eventId, originalDate, originalTimeSlot, date, timeSlot);
                                        } else {
                                            // v1事件移动：使用活动ID
                                            self.handleMoveEvent(activityId, originalDate, originalTimeSlot, date, timeSlot);
                                        }
                                    } else {
                                        // 从活动池拖拽，创建新事件（仅v1兼容）
                                        if (hasActivityId) {
                                            self.handleDrop(activityId, date, timeSlot);
                                        } else {
                                            console.warn('⚠️ 尝试从活动池拖拽v2.1事件，这不应该发生');
                                        }
                                    }
                                },
                                // 当从时间槽拖拽元素出去时
                                onRemove: function(evt) {
                                    console.log('Item removed from time slot:', {
                                        from: evt.from,
                                        to: evt.to,
                                        toId: evt.to.id,
                                        toClass: evt.to.className
                                    });

                                    // 如果拖拽到活动池，视为删除操作
                                    if (evt.to.id === 'activity-pool') {
                                        const date = evt.from.getAttribute('data-date');
                                        const timeSlot = parseInt(evt.from.getAttribute('data-time-slot'));
                                        const eventId = evt.item.getAttribute('data-event-id');

                                        console.log('Deleting event by drag to pool:', { date, timeSlot, eventId });

                                        if (eventId) {
                                            self.deleteEventById(eventId);
                                        } else {
                                            // 备用删除方法：根据日期和时间槽查找并删除
                                            self.deleteEventByDateSlot(date, timeSlot);
                                        }
                                    }
                                    // 如果是移动到其他时间槽，onAdd会处理
                                }
                            });
                            slot.classList.add('sortable-initialized');
                        }
                    });
                    
                    console.log('Drag and drop initialization completed');
                },
                
                // 只初始化时间槽的拖拽功能（用于动态重新初始化）
                initTimeSlotsDragAndDrop() {
                    if (this.currentView !== 'week') {
                        return;
                    }

                    console.log('Re-initializing time slots drag and drop...');
                    const self = this;

                    // 更彻底的清理时间槽的Sortable实例
                    document.querySelectorAll('.time-slot').forEach(el => {
                        if (el.sortableInstance) {
                            console.log('Destroying existing sortable instance for time slot');
                            try {
                                el.sortableInstance.destroy();
                            } catch (e) {
                                console.warn('Error destroying sortable instance:', e);
                            }
                            el.sortableInstance = null;
                        }
                        el.classList.remove('sortable-initialized');

                        // 清理可能残留的拖拽相关的CSS类
                        el.classList.remove('sortable-chosen', 'sortable-drag', 'sortable-ghost', 'sortable-over');
                    });

                    // 等待一帧来确保DOM完全清理
                    requestAnimationFrame(() => {
                        // 重新初始化时间槽的拖拽接收
                        const timeSlots = document.querySelectorAll('.time-slot');
                        console.log('Re-initializing time slots:', timeSlots.length);

                        timeSlots.forEach((slot, index) => {
                            if (!slot.classList.contains('sortable-initialized')) {
                                slot.sortableInstance = Sortable.create(slot, {
                                    group: {
                                        name: 'activities',
                                        pull: true,
                                        put: true
                                    },
                                    animation: 200,
                                    ghostClass: 'sortable-ghost',
                                    chosenClass: 'sortable-chosen',
                                    dragClass: 'sortable-drag',
                                    // 提高拖拽判断精度的参数
                                    tolerance: 'pointer', // 使用鼠标指针位置判断，而不是元素中心
                                    forceAutoScrollFallback: false, // 禁用自动滚动避免位置计算错误
                                    fallbackTolerance: 5, // 设置容差为5px，提高精度
                                    onAdd: function(evt) {
                                        console.log('Drop event triggered on slot:', evt.to);

                                        // 检测拖拽源类型
                                        const activityId = evt.item.getAttribute('data-activity-id');
                                        const nodeType = evt.item.getAttribute('data-node-type'); // domain 或 type
                                        const nodeId = evt.item.getAttribute('data-node-id');
                                        const nodeName = evt.item.getAttribute('data-node-name');

                                        const date = evt.to.getAttribute('data-date');
                                        const timeSlot = parseInt(evt.to.getAttribute('data-time-slot'));
                                        const fromPool = evt.from.id === 'activity-pool';
                                        const fromSidebar = evt.from.id === 'domain-pool' || evt.from.id === 'type-pool';
                                        const fromTimeSlot = evt.from.classList.contains('time-slot');

                                        console.log('🎯 拖拽源检测:', {
                                            来源类型: fromSidebar ? '侧边栏' : (fromPool ? '活动池' : '时间槽'),
                                            activityId,
                                            nodeType,
                                            nodeId,
                                            nodeName,
                                            目标: `${date} ${timeSlot}`
                                        });

                                        // 详细的拖拽判断调试信息
                                        const targetRect = evt.to.getBoundingClientRect();
                                        const isValidTarget = self.validateDropTarget(evt.to, targetRect);

                                        console.log('🎯 拖拽位置判断详情:', {
                                            目标槽位: `${date} ${timeSlot}`,
                                            目标有效性: isValidTarget ? '✅ 有效' : '❌ 无效',
                                            目标元素: evt.to,
                                            目标元素标签: evt.to.tagName,
                                            目标元素类名: evt.to.className,
                                            目标元素ID: evt.to.id,
                                            目标元素可见性: window.getComputedStyle(evt.to).display,
                                            目标元素透明度: window.getComputedStyle(evt.to).opacity,
                                            目标元素边界: {
                                                left: targetRect.left,
                                                right: targetRect.right,
                                                top: targetRect.top,
                                                bottom: targetRect.bottom,
                                                width: targetRect.width,
                                                height: targetRect.height
                                            },
                                            拖拽源: fromPool ? '活动池' : '时间槽',
                                            活动ID: activityId,
                                            所有时间槽元素数量: document.querySelectorAll('.time-slot').length,
                                            当前时间槽是否存在: document.querySelector(`[data-date="${date}"][data-time-slot="${timeSlot}"]`) !== null
                                        });

                                        // 验证目标元素有效性
                                        if (!isValidTarget) {
                                            console.warn('⚠️ 检测到无效目标元素，尝试重新定位...');

                                            // 尝试找到最近的有效时间槽
                                            const validTarget = self.findNearestValidTimeSlot(evt.originalEvent);
                                            if (validTarget) {
                                                console.log('🔄 重定向到有效目标:', validTarget);
                                                const newDate = validTarget.getAttribute('data-date');
                                                const newTimeSlot = parseInt(validTarget.getAttribute('data-time-slot'));

                                                console.log('🎯 重定向后的目标:', {
                                                    原目标: `${date} ${timeSlot}`,
                                                    新目标: `${newDate} ${newTimeSlot}`
                                                });

                                                evt.item.remove();

                                                // 使用新的目标数据
                                                if (fromTimeSlot) {
                                                    self.handleMoveEvent(activityId, evt.from.getAttribute('data-date'),
                                                        parseInt(evt.from.getAttribute('data-time-slot')), newDate, newTimeSlot);
                                                } else {
                                                    self.handleDrop(activityId, newDate, newTimeSlot);
                                                }
                                            } else {
                                                console.error('❌ 找不到有效的目标时间槽');
                                                evt.item.remove();
                                            }
                                            return;
                                        }

                                        console.log('Drop details:', {
                                            activityId, date, timeSlot,
                                            fromPool, fromTimeSlot,
                                            fromElement: evt.from.id || evt.from.className
                                        });

                                        // 验证必要数据
                                        if (fromSidebar) {
                                            // 侧边栏拖拽：需要nodeType, nodeId, nodeName
                                            if (!nodeType || !nodeId || !nodeName || !date || !timeSlot) {
                                                console.error('Missing required sidebar drop data:', {
                                                    nodeType, nodeId, nodeName, date, timeSlot
                                                });
                                                evt.item.remove();
                                                return;
                                            }
                                        } else {
                                            // 活动池/时间槽拖拽：需要activityId
                                            if (!activityId || !date || !timeSlot) {
                                                console.error('Missing required drop data');
                                                evt.item.remove();
                                                return;
                                            }
                                        }

                                        evt.item.remove();

                                        // 处理不同来源的拖拽
                                        if (fromSidebar) {
                                            // 从侧边栏拖拽，创建基于domain/type的事件
                                            console.log('🎯 Processing sidebar drop');
                                            self.handleSidebarDrop(nodeType, nodeId, nodeName, date, timeSlot);
                                        } else if (fromTimeSlot) {
                                            // 从其他时间槽移动过来的，需要先删除原有事件
                                            const originalDate = evt.from.getAttribute('data-date');
                                            const originalTimeSlot = parseInt(evt.from.getAttribute('data-time-slot'));
                                            console.log('Moving from time slot:', originalDate, originalTimeSlot);

                                            // 处理移动事件（先删除原事件，再创建新事件）
                                            self.handleMoveEvent(activityId, originalDate, originalTimeSlot, date, timeSlot);
                                        } else {
                                            // 从活动池拖拽，创建新事件
                                            self.handleDrop(activityId, date, timeSlot);
                                        }
                                    },
                                    onRemove: function(evt) {
                                        console.log('Item removed from time slot:', {
                                            from: evt.from,
                                            to: evt.to,
                                            toId: evt.to.id,
                                            toClass: evt.to.className
                                        });

                                        // 如果拖拽到活动池，视为删除操作
                                        if (evt.to.id === 'activity-pool') {
                                            const date = evt.from.getAttribute('data-date');
                                            const timeSlot = parseInt(evt.from.getAttribute('data-time-slot'));
                                            const eventId = evt.item.getAttribute('data-event-id');

                                            console.log('Deleting event by drag to pool:', { date, timeSlot, eventId });

                                            if (eventId) {
                                                self.deleteEventById(eventId);
                                            } else {
                                                // 备用删除方法：根据日期和时间槽查找并删除
                                                self.deleteEventByDateSlot(date, timeSlot);
                                            }
                                        }
                                        // 如果是移动到其他时间槽，onAdd会处理
                                    }
                                });
                                slot.classList.add('sortable-initialized');
                            }
                        });

                        console.log('Time slots drag and drop re-initialization completed');
                    });
                },
                
                // 新增：处理事件移动（从一个时间槽移动到另一个时间槽）
                async handleMoveEvent(activityId, fromDate, fromTimeSlot, toDate, toTimeSlot) {
                    try {
                        console.log('=== MOVE EVENT HANDLER START ===');
                        console.log('Moving event:', {
                            activityId,
                            from: { date: fromDate, timeSlot: fromTimeSlot },
                            to: { date: toDate, timeSlot: toTimeSlot }
                        });

                        // 检查目标时间槽是否已被占用
                        const targetEvent = this.getScheduledEvent(toDate, toTimeSlot);
                        if (targetEvent) {
                            alert('目标时间槽已有安排，无法移动');
                            // 重新渲染网格以恢复原状
                            await this.loadWeekSchedule();
                            const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                            if (gridContainer) {
                                gridContainer.innerHTML = this.renderFullWeekGrid();
                                setTimeout(() => {
                                    this.initTimeSlotsDragAndDrop();
                                }, 100);
                            }
                            return;
                        }

                        // 找到原事件
                        const originalEvent = this.getScheduledEvent(fromDate, fromTimeSlot);
                        if (!originalEvent) {
                            console.error('Original event not found');
                            alert('找不到原始事件');
                            return;
                        }

                        console.log('Original event found:', originalEvent);

                        // 更新事件的日期和时间槽
                        const updateData = {
                            activity_id: parseInt(activityId),
                            event_date: toDate,
                            time_slot: parseInt(toTimeSlot),
                            goal: originalEvent.goal || '',
                            notes: originalEvent.notes || '',
                            status: originalEvent.status || 'planned'
                        };

                        console.log('Updating event with data:', updateData);

                        const result = await this.apiCall(`/events/${originalEvent.id}`, {
                            method: 'PUT',
                            body: JSON.stringify(updateData)
                        });

                        console.log('Event moved successfully:', result);

                        // 刷新数据和重新渲染
                        await this.loadWeekSchedule();
                        const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                        if (gridContainer) {
                            gridContainer.innerHTML = this.renderFullWeekGrid();
                            console.log('Week grid re-rendered after move');

                            setTimeout(() => {
                                this.initTimeSlotsDragAndDrop();
                                // 确保活动池状态正常
                                this.verifyActivityPoolState();
                            }, 100);
                        }

                        console.log('=== MOVE EVENT HANDLER SUCCESS ===');

                    } catch (error) {
                        console.error('=== MOVE EVENT HANDLER ERROR ===');
                        console.error('移动事件失败:', error);
                        alert('移动事件失败: ' + error.message);

                        // 重新渲染网格以恢复原状
                        await this.loadWeekSchedule();
                        const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                        if (gridContainer) {
                            gridContainer.innerHTML = this.renderFullWeekGrid();
                            setTimeout(() => {
                                this.initTimeSlotsDragAndDrop();
                            }, 100);
                        }
                    }
                },

                // v2.1 新增：处理v2.1事件的移动（基于事件ID）
                async handleMoveEventV2(eventId, fromDate, fromTimeSlot, toDate, toTimeSlot) {
                    try {
                        console.log('🔄 === MOVE EVENT V2 HANDLER START ===');
                        console.log('Moving v2.1 event:', {
                            eventId,
                            from: { date: fromDate, timeSlot: fromTimeSlot },
                            to: { date: toDate, timeSlot: toTimeSlot }
                        });

                        // 检查目标时间槽是否已被占用
                        const targetEvent = this.getScheduledEvent(toDate, toTimeSlot);
                        if (targetEvent) {
                            alert('目标时间槽已有安排，无法移动');
                            await this.loadWeekSchedule();
                            const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                            if (gridContainer) {
                                gridContainer.innerHTML = this.renderFullWeekGrid();
                                setTimeout(() => { this.initTimeSlotsDragAndDrop(); }, 100);
                            }
                            return;
                        }

                        // 找到原事件
                        const originalEvent = this.getScheduledEvent(fromDate, fromTimeSlot);
                        if (!originalEvent) {
                            console.error('❌ Original event not found');
                            alert('找不到原始事件');
                            return;
                        }

                        console.log('✅ Original event found:', originalEvent);

                        // 更新事件的日期和时间槽
                        const updateData = {
                            event_date: toDate,
                            time_slot: parseInt(toTimeSlot),
                            name: originalEvent.name || originalEvent.activity_name || '',
                            domain_id: originalEvent.domain_id || null,
                            activity_type_id: originalEvent.activity_type_id || null,
                            schedule_id: originalEvent.schedule_id || null,
                            notes: originalEvent.notes || '',
                            status: originalEvent.status || 'planned'
                        };

                        console.log('🎯 Updating event with data:', updateData);

                        const response = await fetch(`/api/events/${eventId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(updateData)
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.detail || 'Unknown error'}`);
                        }

                        console.log('✅ Event moved successfully');

                        // 刷新数据和重新渲染
                        await this.loadWeekSchedule();
                        const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                        if (gridContainer) {
                            gridContainer.innerHTML = this.renderFullWeekGrid();
                            console.log('Week grid re-rendered after v2.1 move');

                            setTimeout(() => {
                                this.initTimeSlotsDragAndDrop();
                            }, 100);
                        }

                        console.log('🔄 === MOVE EVENT V2 HANDLER SUCCESS ===');

                    } catch (error) {
                        console.error('🔄 === MOVE EVENT V2 HANDLER ERROR ===');
                        console.error('❌ 移动v2.1事件失败:', error);
                        alert('移动事件失败: ' + error.message);

                        // 重新渲染网格以恢复原状
                        await this.loadWeekSchedule();
                        const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                        if (gridContainer) {
                            gridContainer.innerHTML = this.renderFullWeekGrid();
                            setTimeout(() => { this.initTimeSlotsDragAndDrop(); }, 100);
                        }
                    }
                },

                // 新增：通过事件ID删除事件
                async deleteEventById(eventId) {
                    try {
                        console.log('Deleting event by ID:', eventId);

                        await this.apiCall(`/events/${eventId}`, {
                            method: 'DELETE'
                        });

                        console.log('Event deleted successfully');

                        // 刷新数据和重新渲染
                        await this.loadWeekSchedule();
                        const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                        if (gridContainer) {
                            gridContainer.innerHTML = this.renderFullWeekGrid();
                            setTimeout(() => {
                                this.initTimeSlotsDragAndDrop();
                                // 确保活动池状态正常
                                this.verifyActivityPoolState();
                            }, 100);
                        }

                    } catch (error) {
                        console.error('删除事件失败:', error);
                        alert('删除事件失败: ' + error.message);
                    }
                },

                // 新增：通过日期和时间槽删除事件
                async deleteEventByDateSlot(date, timeSlot) {
                    try {
                        console.log('Deleting event by date/slot:', { date, timeSlot });

                        const event = this.getScheduledEvent(date, timeSlot);
                        if (!event) {
                            console.log('No event found at specified slot');
                            return;
                        }

                        await this.deleteEventById(event.id);

                    } catch (error) {
                        console.error('按日期时间槽删除事件失败:', error);
                        alert('删除事件失败: ' + error.message);
                    }
                },

                // v2.1 新增：处理从侧边栏拖拽创建事件
                async handleSidebarDrop(nodeType, nodeId, nodeName, date, timeSlot) {
                    try {
                        console.log('🎯 === SIDEBAR DROP HANDLER START ===');
                        console.log('处理侧边栏拖拽:', { nodeType, nodeId, nodeName, date, timeSlot });

                        // 验证输入参数
                        if (!nodeType || !nodeId || !nodeName || !date || !timeSlot) {
                            console.error('Invalid sidebar drop parameters:', { nodeType, nodeId, nodeName, date, timeSlot });
                            alert('侧边栏拖拽参数错误，请重试');
                            return;
                        }

                        // 检查是否已有事件
                        const existing = this.getScheduledEvent(date, timeSlot);
                        console.log('现有事件检查:', existing);
                        if (existing) {
                            alert('该时间槽已有安排，请选择其他时间或先删除现有安排');
                            return;
                        }

                        // 弹出目标输入框，让用户为这个domain/type设置具体目标
                        const goal = prompt(
                            `为「${nodeName}」设置具体目标：\n\n请输入你在 ${date} ${this.getTimeSlotName(timeSlot)} 要完成的具体任务或目标`,
                            nodeName // 默认值为节点名称
                        );

                        if (goal === null) {
                            console.log('用户取消了目标设置');
                            return;
                        }

                        if (!goal.trim()) {
                            alert('请输入具体的目标或任务');
                            return;
                        }

                        // 准备事件数据
                        let eventData = {
                            event_date: date,
                            time_slot: timeSlot,
                            goal: goal.trim(),
                            status: 'scheduled',
                            notes: `来源：${nodeType === 'domain' ? '领域' : '类型'} - ${nodeName}`
                        };

                        // 根据nodeType设置相应的字段
                        if (nodeType === 'domain') {
                            eventData.domain_id = parseInt(nodeId);
                        } else if (nodeType === 'type') {
                            eventData.activity_type_id = parseInt(nodeId);
                        }

                        console.log('准备创建事件数据:', eventData);

                        // 调用API创建事件
                        const response = await fetch('/api/scheduled-events/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(eventData)
                        });

                        console.log('API响应状态:', response.status);

                        if (!response.ok) {
                            const error = await response.text();
                            console.error('创建事件失败:', error);
                            throw new Error(`创建事件失败 (${response.status}): ${error}`);
                        }

                        const newEvent = await response.json();
                        console.log('✅ 事件创建成功:', newEvent);

                        // 刷新周视图数据
                        await this.loadWeekSchedule();
                        console.log('🔄 周视图数据已刷新');

                        // 显示成功消息
                        console.log(`✨ 成功为「${nodeName}」创建了计划：${goal}`);

                    } catch (error) {
                        console.error('❌ 侧边栏拖拽创建事件失败:', error);
                        alert('创建事件失败: ' + error.message);
                    }
                },

                async handleDrop(activityId, date, timeSlot) {
                    try {
                        console.log('=== DROP HANDLER START ===');
                        console.log('Handling drop:', { activityId, date, timeSlot });
                        console.log('Type check:', typeof activityId, typeof date, typeof timeSlot);
                        
                        // 验证输入参数
                        if (!activityId || !date || !timeSlot) {
                            console.error('Invalid drop parameters:', { activityId, date, timeSlot });
                            alert('拖拽参数错误，请重试');
                            return;
                        }
                        
                        // 检查是否已有事件
                        const existing = this.getScheduledEvent(date, timeSlot);
                        console.log('Existing event check:', existing);
                        if (existing) {
                            alert('该时间槽已有安排，请选择其他时间或先删除现有安排');
                            return;
                        }
                        
                        // 找到活动信息
                        console.log('Searching for activity with ID:', activityId, 'in:', this.flatActivities.length, 'activities');
                        const activity = this.flatActivities.find(a => a.id == activityId);
                        console.log('Activity search result:', activity);
                        if (!activity) {
                            console.error('Activity not found:', activityId);
                            console.error('Available activities:', this.flatActivities.map(a => ({ id: a.id, name: a.name })));
                            alert('未找到活动信息，ID: ' + activityId);
                            return;
                        }
                        
                        console.log('Found activity:', activity);
                        
                        // 创建新的日程事件
                        const eventData = {
                            activity_id: parseInt(activityId),
                            event_date: date,
                            time_slot: parseInt(timeSlot),
                            goal: '',
                            notes: '',
                            status: 'planned'
                        };
                        
                        console.log('Creating event:', eventData);
                        
                        const result = await this.apiCall('/events/', {
                            method: 'POST',
                            body: JSON.stringify(eventData)
                        });
                        
                        console.log('Event created:', result);
                        
                        // 刷新数据
                        console.log('Reloading week schedule after successful drop...');
                        await this.loadWeekSchedule();
                        
                        // 重新渲染网格
                        const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                        if (gridContainer) {
                            gridContainer.innerHTML = this.renderFullWeekGrid();
                            console.log('Week grid re-rendered after drop');

                            // 只重新初始化时间槽的拖拽功能，不影响活动池
                            setTimeout(() => {
                                this.initTimeSlotsDragAndDrop();
                                // 确保活动池状态正常
                                this.verifyActivityPoolState();
                            }, 100);
                        }
                        
                        // 拖拽成功，不自动打开编辑框
                        // 用户可以手动点击时间槽中的事件来编辑
                        
                        console.log('=== DROP HANDLER SUCCESS ===');
                        
                    } catch (error) {
                        console.error('=== DROP HANDLER ERROR ===');
                        console.error('处理拖拽失败:', error);
                        console.error('Error details:', {
                            name: error.name,
                            message: error.message,
                            stack: error.stack
                        });
                        alert('创建日程失败: ' + error.message);
                    }
                },

                // v2.0 渲染方法
                renderDomainTree() {
                    if (!this.domains.length) return '<p class="text-muted">暂无领域，<a href="#" @click="showNewDomainModal = true">点击创建</a></p>';

                    const renderNode = (domain, level = 0) => {
                        const children = this.domains.filter(d => d.parent_id === domain.id);
                        const scheduleCount = this.getDomainScheduleCount(domain.id);
                        let html = `
                            <div class="mb-2" style="margin-left: ${level * 20}px;">
                                <div class="d-flex justify-content-between align-items-center border-start border-primary border-3 ps-2 py-1">
                                    <div>
                                        <strong>${domain.name}</strong>
                                        ${scheduleCount > 0 ? `<span class="badge bg-info ms-2">${scheduleCount} 日程</span>` : ''}
                                        ${domain.description ? `<br><small class="text-muted">${domain.description}</small>` : ''}
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-info me-1" @click="manageSchedules(${domain.id})" title="管理日程">📅</button>
                                        <button class="btn btn-sm btn-outline-primary me-1" @click="editDomain(${domain.id})">编辑</button>
                                        <button class="btn btn-sm btn-outline-danger" @click="deleteDomain(${domain.id})">删除</button>
                                    </div>
                                </div>
                        `;

                        children.forEach(child => {
                            html += renderNode(child, level + 1);
                        });

                        html += '</div>';
                        return html;
                    };

                    return this.domains.filter(d => !d.parent_id).map(domain => renderNode(domain)).join('');
                },

                renderActivityTypeTree() {
                    if (!this.activityTypes.length) return '<p class="text-muted">暂无活动类型，<a href="#" @click="showNewActivityTypeModal = true">点击创建</a></p>';

                    const renderNode = (type, level = 0) => {
                        const children = this.activityTypes.filter(t => t.parent_id === type.id);
                        let html = `
                            <div class="mb-2" style="margin-left: ${level * 20}px;">
                                <div class="d-flex justify-content-between align-items-center border-start border-success border-3 ps-2 py-1">
                                    <div>
                                        <strong>${type.name}</strong>
                                        ${type.description ? `<br><small class="text-muted">${type.description}</small>` : ''}
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-success me-1" @click="editActivityType(${type.id})">编辑</button>
                                        <button class="btn btn-sm btn-outline-danger" @click="deleteActivityType(${type.id})">删除</button>
                                    </div>
                                </div>
                        `;

                        children.forEach(child => {
                            html += renderNode(child, level + 1);
                        });

                        html += '</div>';
                        return html;
                    };

                    return this.activityTypes.filter(t => !t.parent_id).map(type => renderNode(type)).join('');
                },

                // 汇总视图渲染 (v1.0保留)
                renderActivityTree() {
                    if (!this.activities.length) return '<p class="text-muted">暂无活动</p>';
                    
                    const renderNode = (activity, level = 0) => {
                        let html = `
                            <div class="mb-2" style="margin-left: ${level * 20}px;">
                                <div class="d-flex justify-content-between align-items-center border-bottom pb-2">
                                    <div>
                                        <strong>${activity.name}</strong>
                                        ${activity.description ? `<br><small class="text-muted">${activity.description}</small>` : ''}
                                    </div>
                                    <div class="text-end">
                                        <button class="btn btn-outline-danger btn-sm" 
                                                onclick="deleteActivity(${activity.id})">
                                            删除
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        if (activity.children && activity.children.length > 0) {
                            activity.children.forEach(child => {
                                html += renderNode(child, level + 1);
                            });
                        }
                        
                        return html;
                    };
                    
                    return this.activities.map(activity => renderNode(activity)).join('');
                },
                
                // 带统计信息的汇总视图渲染
                renderActivityTreeWithStats() {
                    if (!this.activities.length) return '<p class="text-muted">暂无活动</p>';
                    
                    const renderNode = (activity, level = 0) => {
                        const stats = this.activityStats[activity.id] || {};
                        const totalEvents = stats.total_events || 0;
                        const completedEvents = stats.completed_events || 0;
                        const completionRate = stats.completion_rate || 0;
                        
                        let html = `
                            <div class="mb-3" style="margin-left: ${level * 20}px;">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">${activity.name}</h6>
                                                ${activity.description ? `<p class="text-muted small mb-2">${activity.description}</p>` : ''}
                                                
                                                <!-- 统计信息 -->
                                                <div class="row text-center mb-2">
                                                    <div class="col-4">
                                                        <small class="text-muted d-block">总安排</small>
                                                        <strong class="text-primary">${totalEvents}</strong>
                                                    </div>
                                                    <div class="col-4">
                                                        <small class="text-muted d-block">已完成</small>
                                                        <strong class="text-success">${completedEvents}</strong>
                                                    </div>
                                                    <div class="col-4">
                                                        <small class="text-muted d-block">完成率</small>
                                                        <strong class="text-warning">${Math.round(completionRate * 100)}%</strong>
                                                    </div>
                                                </div>
                                                
                                                <!-- Goal 列表 -->
                                                ${this.renderActivityGoals(stats)}
                                            </div>
                                            <div class="text-end">
                                                <button class="btn btn-outline-primary btn-sm me-2" 
                                                        onclick="window.laeAppInstance.editActivity(${activity.id})">
                                                    编辑
                                                </button>
                                                <button class="btn btn-outline-danger btn-sm" 
                                                        onclick="deleteActivity(${activity.id})">
                                                    删除
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        if (activity.children && activity.children.length > 0) {
                            activity.children.forEach(child => {
                                html += renderNode(child, level + 1);
                            });
                        }
                        
                        return html;
                    };
                    
                    return this.activities.map(activity => renderNode(activity)).join('');
                },
                
                // 渲染活动的Goal列表
                renderActivityGoals(stats) {
                    if (!stats.sub_activities || !stats.sub_activities.length) {
                        return '<small class="text-muted">暂无目标记录</small>';
                    }
                    
                    let html = '<div class="mt-2"><small class="text-muted d-block mb-1">最近目标:</small>';
                    
                    // 显示最近的几个goals
                    let goalCount = 0;
                    for (const subActivity of stats.sub_activities) {
                        if (subActivity.goals && subActivity.goals.length > 0) {
                            for (const goal of subActivity.goals.slice(-3)) { // 只显示最近3个
                                if (goalCount >= 5) break; // 最多显示5个
                                
                                const statusColor = goal.status === 'completed' ? 'success' : 'secondary';
                                const statusIcon = goal.status === 'completed' ? '✓' : '○';
                                
                                html += `
                                    <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                                        <small><span class="text-${statusColor}">${statusIcon}</span> ${goal.goal}</small>
                                        <small class="text-muted">${goal.date}</small>
                                    </div>
                                `;
                                goalCount++;
                            }
                        }
                        if (goalCount >= 5) break;
                    }
                    
                    html += '</div>';
                    return goalCount > 0 ? html : '<small class="text-muted">暂无目标记录</small>';
                },
                
                // 渲染Schedule时间条
                renderScheduleTimeline() {
                    console.log('🔍 renderScheduleTimeline called');
                    console.log('weekDates:', this.weekDates);
                    console.log('weeklySchedules:', this.weeklySchedules);

                    if (!this.weekDates || !this.weekDates.length) {
                        console.log('⚠️ weekDates not ready, showing loading message');
                        return '<div class="schedule-timeline-label">日程</div><div class="text-muted p-3">加载中...</div>';
                    }

                    let html = '';

                    // 标题列
                    html += '<div class="schedule-timeline-label">日程</div>';

                    // 为每一天创建时间条容器
                    this.weekDates.forEach((dateStr, dayIndex) => {
                        html += `<div class="schedule-timeline-day" data-date="${dateStr}">`;

                        // 计算当天的Schedule时间条
                        const daySchedules = this.getSchedulesForDay(new Date(dateStr), dayIndex);
                        daySchedules.forEach((schedule, scheduleIndex) => {
                            const colorClass = `schedule-color-${schedule.id % 8}`;
                            const isSpanningSchedule = this.isScheduleSpanningMultipleDays(schedule);
                            const spanInfo = isSpanningSchedule ? this.getScheduleSpanInfo(schedule, new Date(dateStr)) : null;

                            html += `
                                <div class="schedule-bar ${colorClass}"
                                     data-schedule-id="${schedule.id}"
                                     title="${this.getScheduleTooltipText(schedule, spanInfo)}"
                                     @click="editScheduleFromTimeline(${schedule.id})"
                                     @mouseenter="$event.target.style.transform = 'scale(1.02)'"
                                     @mouseleave="$event.target.style.transform = 'scale(1)'">
                                    ${this.getScheduleDisplayText(schedule, spanInfo)}
                                </div>
                            `;
                        });

                        html += '</div>';
                    });

                    return html;
                },

                // 获取指定日期的Schedule数据
                getSchedulesForDay(date, dayIndex) {
                    const dateStr = date.toISOString().split('T')[0];
                    const daySchedules = [];

                    this.weeklySchedules.forEach(schedule => {
                        const startDate = schedule.start_date ? new Date(schedule.start_date) : null;
                        const endDate = schedule.deadline ? new Date(schedule.deadline) : null;

                        // 检查Schedule是否跨越这一天
                        if (this.scheduleSpansDay(schedule, date)) {
                            daySchedules.push({
                                ...schedule,
                                sortKey: endDate ? endDate.getTime() : (startDate ? startDate.getTime() : 0)
                            });
                        }
                    });

                    // 按截止时间排序，实现垂直堆叠
                    daySchedules.sort((a, b) => a.sortKey - b.sortKey);

                    return daySchedules;
                },

                // 检查Schedule是否跨越指定日期
                scheduleSpansDay(schedule, date) {
                    const targetDate = new Date(date);
                    targetDate.setHours(0, 0, 0, 0);

                    const startDate = schedule.start_date ? new Date(schedule.start_date) : null;
                    const endDate = schedule.deadline ? new Date(schedule.deadline) : null;

                    if (startDate) startDate.setHours(0, 0, 0, 0);
                    if (endDate) endDate.setHours(0, 0, 0, 0);

                    // 如果只有deadline，检查是否在当天或之前
                    if (!startDate && endDate) {
                        return targetDate <= endDate;
                    }

                    // 如果只有start_date，检查是否在当天或之后
                    if (startDate && !endDate) {
                        return targetDate >= startDate;
                    }

                    // 如果都有，检查是否在范围内
                    if (startDate && endDate) {
                        return targetDate >= startDate && targetDate <= endDate;
                    }

                    return false;
                },

                // 检查Schedule是否跨越多天
                isScheduleSpanningMultipleDays(schedule) {
                    const startDate = schedule.start_date ? new Date(schedule.start_date) : null;
                    const endDate = schedule.deadline ? new Date(schedule.deadline) : null;

                    if (!startDate || !endDate) return false;

                    const diffDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                    return diffDays > 0;
                },

                // 获取Schedule在特定日期的跨越信息
                getScheduleSpanInfo(schedule, currentDate) {
                    const startDate = schedule.start_date ? new Date(schedule.start_date) : null;
                    const endDate = schedule.deadline ? new Date(schedule.deadline) : null;
                    const weekStart = new Date(this.currentWeekStart);
                    const weekEnd = new Date(this.currentWeekStart);
                    weekEnd.setDate(weekEnd.getDate() + 6);

                    if (!startDate || !endDate) return null;

                    startDate.setHours(0, 0, 0, 0);
                    endDate.setHours(0, 0, 0, 0);
                    currentDate.setHours(0, 0, 0, 0);
                    weekStart.setHours(0, 0, 0, 0);
                    weekEnd.setHours(0, 0, 0, 0);

                    // 修正：只有真正的起始/结束点才显示三角形标识
                    const isActualFirstDay = currentDate.getTime() === startDate.getTime();
                    const isActualLastDay = currentDate.getTime() === endDate.getTime();
                    const isFirstDayInWeek = currentDate.getTime() === Math.max(startDate.getTime(), weekStart.getTime()) && isActualFirstDay;
                    const isLastDayInWeek = currentDate.getTime() === Math.min(endDate.getTime(), weekEnd.getTime()) && isActualLastDay;
                    const isMiddleDay = currentDate > startDate && currentDate < endDate;

                    return {
                        isFirstDay: isFirstDayInWeek,
                        isLastDay: isLastDayInWeek,
                        isMiddleDay: isMiddleDay,
                        totalDays: Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1
                    };
                },

                // 获取Schedule显示文本
                getScheduleDisplayText(schedule, spanInfo) {
                    if (!spanInfo) {
                        return schedule.name;
                    }

                    if (spanInfo.isFirstDay) {
                        return `◀ ${schedule.name}`;
                    } else if (spanInfo.isLastDay) {
                        return `${schedule.name} ▶`;
                    } else if (spanInfo.isMiddleDay) {
                        return `── ${schedule.name} ──`;
                    }

                    return schedule.name;
                },

                // 获取Schedule的详细tooltip文本
                getScheduleTooltipText(schedule, spanInfo) {
                    let tooltip = `${schedule.name}\n`;

                    if (schedule.start_date) {
                        tooltip += `开始: ${this.formatFullDate(schedule.start_date)}\n`;
                    }

                    if (schedule.deadline) {
                        tooltip += `截止: ${this.formatFullDate(schedule.deadline)}\n`;
                    }

                    if (schedule.description) {
                        tooltip += `说明: ${schedule.description}\n`;
                    }

                    if (spanInfo) {
                        if (spanInfo.isFirstDay) {
                            tooltip += `状态: 跨天日程开始`;
                        } else if (spanInfo.isLastDay) {
                            tooltip += `状态: 跨天日程结束`;
                        } else if (spanInfo.isMiddleDay) {
                            tooltip += `状态: 跨天日程进行中`;
                        }
                    } else {
                        tooltip += `状态: 单日日程`;
                    }

                    tooltip += `\n点击编辑`;
                    return tooltip;
                },

                // 格式化完整日期显示
                formatFullDate(dateStr) {
                    if (!dateStr) return '无';
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                },

                // 从时间条编辑Schedule
                async editScheduleFromTimeline(scheduleId) {
                    try {
                        console.log('Editing schedule from timeline:', scheduleId);
                        const response = await fetch(`/api/schedules/${scheduleId}`);
                        if (!response.ok) throw new Error('Failed to load schedule');

                        const schedule = await response.json();
                        this.editSchedule(schedule);
                    } catch (error) {
                        console.error('Error editing schedule from timeline:', error);
                        alert('无法编辑日程: ' + error.message);
                    }
                },

                // 格式化日期显示
                formatDate(dateStr) {
                    if (!dateStr) return '无';
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('zh-CN', {
                        month: '2-digit',
                        day: '2-digit'
                    });
                },

                // 重新渲染周视图（包括网格和时间条）
                rerenderWeekView() {
                    const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                    const timelineContainer = document.querySelector('[x-html="renderScheduleTimeline()"]');

                    if (gridContainer) {
                        gridContainer.innerHTML = this.renderFullWeekGrid();
                    }

                    if (timelineContainer) {
                        timelineContainer.innerHTML = this.renderScheduleTimeline();
                    }
                },

                // 完整周视图网格渲染（包含标题行和所有时间槽）
                renderFullWeekGrid() {
                    if (!this.timeSlots.length || !this.weekDates.length) {
                        return '<p class="text-muted">加载中...</p>';
                    }
                    
                    let html = '';
                    
                    console.log('Rendering full week grid:', {
                        timeSlots: this.timeSlots.length,
                        weekDates: this.weekDates.length,
                        totalElements: (this.timeSlots.length + 1) * 8 // (5+1)行 × 8列
                    });
                    
                    // 1. 生成标题行（8个元素：1个"时间"标题 + 7个日期标题）
                    html += '<div class="week-header">时间</div>';
                    for (const day of this.weekDates) {
                        const date = new Date(day);
                        const weekday = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'][date.getDay() === 0 ? 6 : date.getDay() - 1];
                        const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
                        html += `
                            <div class="week-header">
                                <div>${weekday}</div>
                                <div>${dateStr}</div>
                            </div>
                        `;
                    }
                    
                    // 2. 为每个时间段生成一行（8个元素：1个时间标签 + 7个时间槽）
                    for (const slot of this.timeSlots) {
                        // 时间标签（第一列）
                        html += `<div class="time-label">${slot.name}</div>`;
                        
                        // 该时间段的7个时间槽（周一到周日）
                        for (const day of this.weekDates) {
                            const event = this.getScheduledEvent(day, slot.value);
                            const occupiedClass = event ? 'occupied' : '';
                            
                            html += `
                                <div class="time-slot p-2 ${occupiedClass}" 
                                     data-date="${day}" 
                                     data-time-slot="${slot.value}"
                                     onclick="window.laeAppInstance.editScheduledEvent('${day}', ${slot.value})">
                            `;
                            
                            if (event) {
                                html += `
                                    <div class="scheduled-event activity-card"
                                         data-activity-id="${event.activity_id || ''}"
                                         data-event-id="${event.id}"
                                         data-event-name="${event.name || event.activity_name || ''}"
                                         data-domain-id="${event.domain_id || ''}"
                                         data-activity-type-id="${event.activity_type_id || ''}"
                                        <div class="fw-bold mb-1" style="font-size: 0.85rem; line-height: 1.2;">${event.name || event.activity_name || ''}</div>
                                        ${event.goal ? `<div class="mb-1" style="font-size: 0.75rem; color: #666; line-height: 1.3;">${event.goal}</div>` : ''}
                                        ${event.notes ? `<div style="font-size: 0.7rem; color: #888; line-height: 1.2;">备注: ${event.notes}</div>` : ''}
                                    </div>
                                `;
                            }
                            
                            html += '</div>';
                        }
                    }
                    
                    console.log('Generated full grid HTML, total elements:', (html.match(/<div/g) || []).length);
                    return html;
                },
                
                // 渲染活动池
                renderActivityPool() {
                    if (!this.flatActivities.length) {
                        return '<p class="text-muted">暂无活动</p>';
                    }

                    return this.flatActivities.map(activity => `
                        <div class="activity-card card mb-2" data-activity-id="${activity.id}">
                            <div class="card-body py-2 px-3">
                                <div class="fw-bold" style="font-size: 0.875rem;">${activity.name}</div>
                                <small class="text-muted">${activity.description || ''}</small>
                            </div>
                        </div>
                    `).join('');
                },

                // 保留原函数以备用
                renderWeekGrid() {
                    return this.renderFullWeekGrid();
                },

                // ========== V3.0 动态画布方法 ==========

                // 切换网格模式
                switchGridMode() {
                    console.log('🔄 Switching grid mode to:', this.isV3Mode ? 'V3' : 'V2');

                    // 重新初始化相应的拖拽功能
                    this.$nextTick(() => {
                        if (this.isV3Mode) {
                            this.initV3DragAndDrop();
                            this.scrollToCurrentTime();
                        } else {
                            this.initDragAndDrop();
                        }
                    });
                },

                // 渲染时间轴
                renderTimeAxis() {
                    let html = '';

                    const hours = this.v3TimeEnd - this.v3TimeStart + 1; // 修复：17小时（包含23:00）
                    const gridHeight = hours * 6 * 10 * this.v3ZoomLevel; // 17小时 × 6格/小时 × 10px × 缩放
                    const headerHeight = 50; // 日期标题行高度

                    // 添加空白标题格子，与日期标题行对齐
                    html += `
                        <div class="hour-marker header-spacer" style="top: 0px; height: ${headerHeight}px;">
                            <!-- 空白标题区域 -->
                        </div>
                    `;

                    // 现在小时标记从header下方开始，与网格对齐
                    for (let hour = this.v3TimeStart; hour <= this.v3TimeEnd; hour++) {
                        const relativeHour = hour - this.v3TimeStart;
                        const top = headerHeight + (relativeHour * 60 * this.v3ZoomLevel);
                        html += `
                            <div class="hour-marker" style="top: ${top}px; height: ${60 * this.v3ZoomLevel}px;">
                                ${hour.toString().padStart(2, '0')}:00
                            </div>
                        `;
                    }

                    return html;
                },

                // 渲染网格线
                renderGridLines() {
                    let html = '';

                    // 修复：7:00-23:00实际是17小时（包含23:00这个完整小时）
                    const hours = this.v3TimeEnd - this.v3TimeStart + 1; // 7到23包含23，应该是17小时
                    const totalGrids = hours * 6; // 17小时 × 6格/小时 = 102个10分钟格

                    for (let i = 0; i <= totalGrids; i++) {
                        const top = i * 10 * this.v3ZoomLevel; // 每个网格10px × 缩放
                        const isHourLine = i % 6 === 0; // 每6个网格是一小时

                        html += `
                            <div class="${isHourLine ? 'grid-line-hour' : 'grid-line-10min'}"
                                 style="top: ${top}px;">
                            </div>
                        `;
                    }

                    return html;
                },

                // 渲染日期标题
                getDayHeaderV3(day) {
                    const date = new Date(day);
                    const weekday = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'][date.getDay() === 0 ? 6 : date.getDay() - 1];
                    const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
                    return `${weekday}\n${dateStr}`;
                },

                // 渲染单天的任务卡片
                renderDayCardsV3(day) {
                    try {
                        let html = '';

                        // 获取该日期的所有事件
                        const dayData = this.weekSchedule[day];
                        if (!dayData) {
                            console.log('No events for day:', day);
                            return ''; // 返回空字符串而不是undefined
                        }

                        const events = Object.values(dayData);
                        // console.log(`Rendering ${events.length} events for ${day}`);

                        events.forEach(event => {
                            try {
                                if (event && event.id) { // 添加null和id检查
                                    const cardHtml = this.renderTaskCardV3(event);
                                    if (cardHtml) {
                                        html += cardHtml;
                                    }
                                } else {
                                    // 静默跳过null事件，避免控制台噪音
                                }
                            } catch (error) {
                                console.error('Error rendering card for event:', event, error);
                            }
                        });

                        return html;
                    } catch (error) {
                        console.error('Error in renderDayCardsV3:', error);
                        return ''; // 确保始终返回字符串
                    }
                },

                // 渲染单个任务卡片
                renderTaskCardV3(event) {
                    console.log('🎯 Rendering card for event:', event.id, 'start_time:', event.start_time, 'time_slot:', event.time_slot);

                    // 安全获取duration，处理null/undefined情况
                    const duration = (event.duration !== null && event.duration !== undefined) ? event.duration : 60;
                    const heightPx = Math.max((duration / 10) * 10 * this.v3ZoomLevel, 20 * this.v3ZoomLevel); // 最小20px × 缩放

                    // 计算位置 - 优先使用start_time，回退到time_slot
                    let topPx = 0;
                    let timeForCalculation = null;

                    if (event.start_time && event.start_time !== 'None' && event.start_time !== null) {
                        // 有起始时间 - 直接解析start_time（精确和模糊都有start_time）
                        console.log('🕐 Using start_time for position:', event.start_time);
                        timeForCalculation = event.start_time;
                        const [hours, minutes] = event.start_time.split(':').map(Number);
                        const totalMinutes = hours * 60 + minutes;
                        const relativeMinutes = totalMinutes - (this.v3TimeStart * 60); // 相对于7:00的分钟数
                        topPx = Math.max(0, (relativeMinutes / 10) * 10 * this.v3ZoomLevel); // 转换为网格单位并缩放
                        console.log('🎯 Calculated position:', { totalMinutes, relativeMinutes, topPx });
                    } else {
                        // 回退到time_slot（兼容旧数据）
                        console.log('🕐 Using time_slot for position:', event.time_slot);
                        const slotTimes = {
                            21: 8 * 60,   // 上午第1时段: 8:00
                            22: 10 * 60,  // 上午第2时段: 10:00
                            51: 14 * 60,  // 下午第1时段: 14:00
                            52: 16 * 60,  // 下午第2时段: 16:00
                            71: 19 * 60   // 晚上时段: 19:00
                        };
                        const totalMinutes = slotTimes[event.time_slot] || (8 * 60);
                        const relativeMinutes = totalMinutes - (this.v3TimeStart * 60);
                        topPx = Math.max(0, (relativeMinutes / 10) * 10 * this.v3ZoomLevel);

                        // 为了调试，计算等效的start_time
                        const hours = Math.floor(totalMinutes / 60);
                        const minutes = totalMinutes % 60;
                        timeForCalculation = hours + ':' + minutes.toString().padStart(2, '0');
                        console.log('🎯 Time slot', event.time_slot, 'converted to time:', timeForCalculation);
                    }

                    // 并行任务位置调整
                    const parallelClass = event.canvas_position_y > 0 ? 'parallel' : '';
                    const preciseClass = event.is_precise ? 'precise' : '';

                    console.log('🎯 Final render - topPx:', topPx, 'heightPx:', heightPx, 'timeForCalculation:', timeForCalculation);

                    return `
                        <div class="task-card-v3 ${preciseClass} ${parallelClass}"
                             style="top: ${topPx}px; height: ${heightPx}px;"
                             data-event-id="${event.id}"
                             data-duration="${duration}"
                             onclick="window.laeAppInstance.editEventV3(${event.id}); event.stopPropagation(); return false;">
                            <div class="task-card-title">
                                ${event.name || event.activity_name || '未命名任务'}
                            </div>
                            <div class="task-card-meta">
                                ${timeForCalculation || '未设置时间'}
                                ${event.is_precise ? ' (精确)' : ' (10分钟精度)'}
                                (${duration}min)
                            </div>
                        </div>
                    `;
                },

                // 渲染待定卡片
                renderPendingCards() {
                    // 暂时返回示例卡片
                    return `
                        <div class="pending-card-v3" data-task="sample1">
                            示例任务1
                        </div>
                        <div class="pending-card-v3" data-task="sample2">
                            示例任务2
                        </div>
                    `;
                },

                // 滚动到当前时间
                scrollToCurrentTime() {
                    const canvas = document.getElementById('week-canvas-v3');
                    if (canvas) {
                        const now = new Date();
                        const currentMinutes = now.getHours() * 60 + now.getMinutes();
                        const scrollTop = Math.max(0, (currentMinutes / 10 * 10) - 200); // 当前时间往上200px
                        canvas.scrollTop = scrollTop;
                    }
                },

                // 计算时间吸附
                snapToGrid(mouseY) {
                    const canvas = document.getElementById('week-canvas-v3');
                    if (!canvas) return 0;

                    const canvasRect = canvas.getBoundingClientRect();
                    // 减去header高度(60px)，得到相对于网格内容区域的位置
                    const relativeY = mouseY - canvasRect.top - 60 + canvas.scrollTop;

                    // 吸附到最近的10分钟网格单位
                    const gridUnit = 10 * this.v3ZoomLevel;
                    const snapY = Math.max(0, Math.round(relativeY / gridUnit) * gridUnit);

                    // console.log('🧭 吸附计算调试:', { snapY: snapY });

                    // 更新吸附指示器位置（需要加回header偏移用于显示）
                    this.snapIndicatorY = snapY;
                    this.showSnapIndicator(snapY + 60); // 显示时加回header偏移

                    return snapY;
                },

                // 显示吸附指示器
                showSnapIndicator(y) {
                    const indicator = document.querySelector('.snap-indicator');
                    if (indicator) {
                        indicator.style.display = 'block';
                        indicator.style.top = y + 'px';
                        indicator.classList.add('active');
                    }
                },

                // 隐藏吸附指示器
                hideSnapIndicator() {
                    const indicator = document.querySelector('.snap-indicator');
                    if (indicator) {
                        indicator.style.display = 'none';
                        indicator.classList.remove('active');
                    }
                },

                // 计算拖拽放置位置
                calculateDropPosition(evt) {
                    try {
                        // 获取放置目标的日期列
                        const dayColumn = evt.to.closest('.day-column-v3');
                        if (!dayColumn) {
                            console.error('❌ Not dropped in a valid day column');
                            return null;
                        }

                        // 获取日期（基于鼠标水平位置）
                        // 确保只计算day-column-v3元素的索引
                        const daysContainer = dayColumn.parentElement;
                        const dayColumns = daysContainer.querySelectorAll('.day-column-v3');
                        const dayIndex = Array.from(dayColumns).indexOf(dayColumn);

                        const startDate = new Date(this.currentWeekStart);
                        startDate.setDate(startDate.getDate() + dayIndex);
                        const dateStr = startDate.toISOString().split('T')[0];

                        // console.log('🗓️ 位置计算:', { dayIndex, dateStr });

                        // 直接使用蓝线指示器的位置（竖直位置）
                        const snappedY = this.snapIndicatorY;

                        // 直接计算蓝线对应的时间 - 修复时间计算逻辑
                        // snappedY是像素值，需要转换为分钟
                        // 每10分钟在画布上对应 10 * this.v3ZoomLevel 像素
                        const minutesFromStart = Math.round(snappedY / (10 * this.v3ZoomLevel)) * 10;
                        const dropHour = this.v3TimeStart + Math.floor(minutesFromStart / 60);
                        const dropMinute = minutesFromStart % 60;

                        console.log('⏰ 拖拽目标时间:', `${dropHour}:${dropMinute.toString().padStart(2, '0')}`);

                        const startTime = dropHour + ':' + dropMinute.toString().padStart(2, '0');
                        const timeSlot = this.getTimeSlotFromTime(startTime);

                        // 计算并行位置的Y坐标(用于并行任务)
                        const canvasY = this.calculateCanvasPositionY(dateStr, startTime);

                        // console.log('📍 简化位置计算:', { 蓝线位置: snappedY, 计算时间: startTime, 目标日期: dateStr });

                        return {
                            date: dateStr,
                            startTime: startTime,
                            timeSlot: timeSlot,
                            canvasY: canvasY
                        };

                    } catch (error) {
                        console.error('❌ Error calculating drop position:', error);
                        return null;
                    }
                },

                // 计算并行位置的Y坐标
                calculateCanvasPositionY(date, startTime) {
                    // 检查该时间段是否已经有任务
                    const existingTasks = this.getTasksAtTimeSlot(date, startTime);

                    // 如果没有冲突，返回0
                    if (existingTasks.length === 0) {
                        return 0;
                    }

                    // 如果有冲突，计算下一个可用的Y位置
                    const maxY = Math.max(...existingTasks.map(task => task.canvas_position_y || 0));
                    return maxY + 1;
                },

                // 获取指定时间段的任务
                getTasksAtTimeSlot(date, startTime) {
                    const tasks = [];

                    // 遍历当前周的所有任务
                    for (const day in this.weekSchedule) {
                        if (day === date) {
                            for (const slotKey in this.weekSchedule[day]) {
                                const event = this.weekSchedule[day][slotKey];
                                if (event && event.start_time) {
                                    // 检查时间重叠
                                    if (this.isTimeOverlap(event.start_time, event.duration || 60, startTime, 60)) {
                                        tasks.push(event);
                                    }
                                }
                            }
                        }
                    }

                    return tasks;
                },

                // 检查时间重叠
                isTimeOverlap(startTime1, duration1, startTime2, duration2) {
                    const [h1, m1] = startTime1.split(':').map(Number);
                    const [h2, m2] = startTime2.split(':').map(Number);

                    const start1 = h1 * 60 + m1;
                    const end1 = start1 + duration1;
                    const start2 = h2 * 60 + m2;
                    const end2 = start2 + duration2;

                    return !(end1 <= start2 || end2 <= start1);
                },

                // 更新内存中的事件数据
                updateEventInMemory(updatedEvent) {
                    console.log('🔄 Updating event in memory:', updatedEvent.id);

                    // 先从原位置移除事件
                    for (const day in this.weekSchedule) {
                        for (const slotKey in this.weekSchedule[day]) {
                            const event = this.weekSchedule[day][slotKey];
                            if (event && event.id === updatedEvent.id) {
                                delete this.weekSchedule[day][slotKey];
                                break;
                            }
                        }
                    }

                    // 添加到新位置
                    const date = updatedEvent.event_date;
                    const timeSlot = updatedEvent.time_slot;

                    if (!this.weekSchedule[date]) {
                        this.weekSchedule[date] = {};
                    }

                    this.weekSchedule[date][timeSlot] = updatedEvent;
                    console.log('✅ Event updated in memory:', { date, timeSlot, eventId: updatedEvent.id });
                },

                // 重新渲染单个卡片
                renderSingleCardV3(event, domElement) {
                    console.log('🎨 Re-rendering single card:', event.id);

                    try {
                        // 检查DOM元素是否有效
                        if (!domElement || !domElement.style) {
                            console.error('❌ Invalid DOM element passed to renderSingleCardV3:', domElement);
                            console.log('🔄 Falling back to full reload...');
                            this.loadWeekSchedule();
                            return;
                        }

                        // 更新DOM元素的事件数据
                        domElement.eventData = event;

                        // 重新计算位置
                        const duration = event.duration || 60;
                        const heightPx = Math.max((duration / 10) * 10 * this.v3ZoomLevel, 20 * this.v3ZoomLevel);

                        let topPx = 0;
                        if (event.start_time) {
                            const [hours, minutes] = event.start_time.split(':').map(Number);
                            const totalMinutes = hours * 60 + minutes;
                            const relativeMinutes = totalMinutes - (this.v3TimeStart * 60);
                            topPx = Math.max(0, (relativeMinutes / 10) * 10 * this.v3ZoomLevel);
                        }

                        // 更新样式
                        domElement.style.top = topPx + 'px';
                        domElement.style.height = heightPx + 'px';

                        // 更新卡片内容（如果需要）
                        const nameElement = domElement.querySelector('.task-card-title');
                        if (nameElement && event.name) {
                            nameElement.textContent = event.name;
                        }

                        console.log('✅ Single card re-rendered:', { eventId: event.id, topPx, heightPx });

                    } catch (error) {
                        console.error('❌ Error re-rendering single card:', error);
                        // 如果单个重新渲染失败，回退到完整重新加载
                        this.loadWeekSchedule();
                    }
                },

                // V3拖拽初始化
                initV3DragAndDrop() {
                    console.log('🎯 Initializing V3 drag and drop...');

                    // 初始化简化的原生拖拽系统
                    this.initV3NativeDrag();

                    // 初始化待定区域拖拽
                    this.initV3PendingAreaDrag();
                },

                // 初始化V3原生拖拽系统
                initV3NativeDrag() {
                    const self = this;

                    // 为每个卡片添加原生拖拽事件（只处理未初始化的卡片）
                    const cards = document.querySelectorAll('.task-card-v3:not([data-drag-initialized])');
                    console.log('🎯 Initializing drag for', cards.length, 'new V3 cards');

                    cards.forEach(card => {
                        // 标记为已初始化
                        card.setAttribute('data-drag-initialized', 'true');

                        // 设置为可拖拽
                        card.draggable = true;
                        card.style.cursor = 'grab';

                        card.addEventListener('dragstart', function(e) {
                            console.log('🎯 V3 native drag started for card:', card.dataset.eventId);

                            self.isDragging = true;
                            self.draggedEventId = card.dataset.eventId;

                            // 设置拖拽数据
                            e.dataTransfer.setData('text/plain', card.dataset.eventId);
                            e.dataTransfer.effectAllowed = 'move';

                            // 创建完全透明的拖拽图像，隐藏预览效果
                            const emptyImg = new Image();
                            emptyImg.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAUEBAAAACwAAAAAAQABAAACAkQBADs=';
                            e.dataTransfer.setDragImage(emptyImg, 0, 0);

                            // 视觉反馈 - 原卡片半透明
                            card.style.opacity = '0.3';
                            card.style.cursor = 'grabbing';
                        });

                        card.addEventListener('dragend', function(e) {
                            console.log('🎯 V3 native drag ended');

                            self.isDragging = false;
                            self.draggedEventId = null;
                            self.hideSnapIndicator();

                            // 恢复视觉效果
                            card.style.opacity = '1';
                            card.style.cursor = 'grab';
                        });
                    });

                    // 为每个日期列设置放置目标
                    const dayColumns = document.querySelectorAll('.day-column-v3');
                    dayColumns.forEach((column, index) => {
                        column.addEventListener('dragover', function(e) {
                            e.preventDefault();
                            e.dataTransfer.dropEffect = 'move';

                            // 实时更新吸附指示器，基于鼠标位置
                            self.snapToGrid(e.clientY);

                            // 视觉反馈
                            column.classList.add('day-column-v3-over');
                        });

                        column.addEventListener('dragleave', function(e) {
                            column.classList.remove('day-column-v3-over');
                        });

                        column.addEventListener('drop', function(e) {
                            e.preventDefault();
                            column.classList.remove('day-column-v3-over');

                            // 防止重复处理
                            if (self.dropProcessing) {
                                console.log('🚫 Drop already processing in drop event, ignoring');
                                return;
                            }

                            const eventId = e.dataTransfer.getData('text/plain');
                            if (eventId && self.draggedEventId === eventId) {
                                console.log('🎯 Card dropped in column', index, 'eventId:', eventId);

                                // 模拟Sortable事件对象
                                const mockEvt = {
                                    item: { getAttribute: () => eventId },
                                    to: column,
                                    originalEvent: e
                                };

                                self.handleV3CardDrop(mockEvt);
                            }
                        });
                    });
                },

                // 初始化V3侧边栏拖拽
                initV3SidebarDrag() {
                    // 初始化Domain侧边栏
                    const domainPool = document.getElementById('domain-pool-v3');
                    if (domainPool && !domainPool.sortableInstance) {
                        domainPool.sortableInstance = Sortable.create(domainPool, {
                            group: {
                                name: 'v3-sidebar',
                                pull: 'clone',
                                put: false
                            },
                            sort: false,
                            animation: 150,

                            onEnd: (evt) => {
                                // 从侧边栏拖拽到网格的逻辑
                                if (evt.to.classList.contains('day-column-v3')) {
                                    this.handleSidebarToGridDrop(evt);
                                }
                            }
                        });
                    }

                    // 初始化ActivityType侧边栏
                    const typePool = document.getElementById('type-pool-v3');
                    if (typePool && !typePool.sortableInstance) {
                        typePool.sortableInstance = Sortable.create(typePool, {
                            group: {
                                name: 'v3-sidebar',
                                pull: 'clone',
                                put: false
                            },
                            sort: false,
                            animation: 150,

                            onEnd: (evt) => {
                                if (evt.to.classList.contains('day-column-v3')) {
                                    this.handleSidebarToGridDrop(evt);
                                }
                            }
                        });
                    }
                },

                // 处理侧边栏到网格的拖拽
                handleSidebarToGridDrop(evt) {
                    console.log('🎯 Sidebar to grid drop', evt);

                    // 获取节点信息
                    const nodeId = evt.item.getAttribute('data-node-id');
                    const nodeName = evt.item.getAttribute('data-node-name');
                    const nodeType = evt.item.getAttribute('data-node-type');

                    if (nodeId && nodeName && nodeType) {
                        // 设置选中节点
                        this.selectedNode = {
                            id: parseInt(nodeId),
                            name: nodeName,
                            type: nodeType
                        };

                        // 计算放置位置
                        const dropPosition = this.calculateDropPosition(evt);
                        if (dropPosition) {
                            // 自动创建事件
                            this.createEventFromDrop(dropPosition);
                        }
                    }
                },

                // 从拖拽位置创建事件
                async createEventFromDrop(dropPosition) {
                    const eventData = {
                        name: this.selectedNode.name,
                        event_date: dropPosition.date,
                        time_slot: dropPosition.timeSlot,
                        domain_id: this.selectedNode.type === 'domain' ? this.selectedNode.id : null,
                        activity_type_id: this.selectedNode.type === 'type' ? this.selectedNode.id : null,
                        schedule_id: null,
                        notes: '',
                        status: 'planned',
                        // V3 字段
                        duration: 60,
                        start_time: this.formatTimeForAPI(dropPosition.startTime),
                        is_precise: false,
                        canvas_position_y: dropPosition.canvasY
                    };

                    try {
                        const response = await fetch('/api/events/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(eventData)
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        console.log('✅ Event created from sidebar drop');
                        await this.loadWeekSchedule();

                    } catch (error) {
                        console.error('❌ Error creating event from drop:', error);
                        alert('创建事件失败: ' + error.message);
                    }
                },


                // 初始化V3待定区域拖拽
                initV3PendingAreaDrag() {
                    const pendingArea = document.getElementById('pending-cards-v3');

                    if (pendingArea && !pendingArea.sortableInstance) {
                        pendingArea.sortableInstance = Sortable.create(pendingArea, {
                            group: 'v3-tasks',
                            animation: 150,

                            onEnd: (evt) => {
                                console.log('V3 pending drag end');
                                this.handleV3PendingDrop(evt);
                            }
                        });
                    }
                },

                // 处理V3卡片拖拽结束
                async handleV3CardDrop(evt) {
                    // 防止重复触发
                    if (this.dropProcessing) {
                        console.log('🚫 Drop already processing, ignoring duplicate');
                        return;
                    }
                    this.dropProcessing = true;

                    console.log('🎯 Handling V3 card drop', evt);

                    try {
                        // 获取被拖拽的卡片信息
                        const draggedElement = evt.item;
                        const eventId = draggedElement.getAttribute('data-event-id');

                        if (!eventId) {
                            console.error('❌ No event ID found on dragged element');
                            return;
                        }

                        // 计算新的位置信息
                        const newPosition = this.calculateDropPosition(evt);
                        if (!newPosition) {
                            console.error('❌ Could not calculate drop position');
                            return;
                        }

                        console.log('📍 Calculated new position:', newPosition);

                        // 更新事件数据
                        const updateData = {
                            event_date: newPosition.date,
                            time_slot: newPosition.timeSlot,
                            start_time: this.formatTimeForAPI(newPosition.startTime),
                            canvas_position_y: newPosition.canvasY
                        };

                        // 发送API请求更新事件
                        console.log('📤 Sending update data:', updateData);
                        const response = await fetch(`/api/events/${eventId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(updateData)
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('❌ API Error Details:', {
                                status: response.status,
                                statusText: response.statusText,
                                body: errorText
                            });
                            throw new Error(`HTTP error! status: ${response.status}, details: ${errorText}`);
                        }

                        console.log('✅ Event updated successfully');

                        // 调试信息：检查事件数据
                        console.log('🔍 Debug info:', {
                            eventId: eventId,
                            'evt.item': evt.item,
                            'evt.item.eventData': evt.item.eventData,
                            'domElement': evt.item
                        });

                        // 直接更新内存中的事件数据，避免重新加载导致卡片消失
                        const updatedEvent = {
                            ...evt.item.eventData,
                            id: eventId, // 确保使用正确的事件ID
                            event_date: newPosition.date,
                            start_time: newPosition.startTime,
                            time_slot: newPosition.timeSlot,
                            canvas_position_y: newPosition.canvasY
                        };

                        // 更新内存中的事件
                        this.updateEventInMemory(updatedEvent);

                        // 只重新渲染这个特定的卡片，而不是整个周视图
                        this.renderSingleCardV3(updatedEvent, evt.item);

                        // 隐藏吸附指示器
                        this.hideSnapIndicator();

                    } catch (error) {
                        console.error('❌ Error handling V3 card drop:', error);
                        alert('移动卡片失败: ' + error.message);

                        // 恢复原位置
                        await this.loadWeekSchedule();
                    } finally {
                        // 重置防抖标志
                        this.dropProcessing = false;
                    }
                },

                // 处理V3待定区域拖拽结束
                async handleV3PendingDrop(evt) {
                    console.log('🎯 Handling V3 pending drop', evt);

                    try {
                        // 获取被拖拽的卡片信息
                        const draggedElement = evt.item;
                        const eventId = draggedElement.getAttribute('data-event-id');

                        if (eventId) {
                            // 从网格拖拽到待定区域 - 移除时间信息
                            const updateData = {
                                start_time: null,
                                is_precise: false,
                                canvas_position_y: 0
                            };

                            const response = await fetch(`/api/events/${eventId}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(updateData)
                            });

                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }

                            console.log('✅ Event moved to pending area');
                            await this.loadWeekSchedule();
                        } else {
                            // 待定区域内的重新排序
                            console.log('📋 Reordered pending cards');
                        }

                    } catch (error) {
                        console.error('❌ Error handling V3 pending drop:', error);
                        alert('移动到待定区域失败: ' + error.message);
                        await this.loadWeekSchedule();
                    }
                },

                // 编辑V3任务
                editEventV3(eventId) {
                    console.log('🎯 Editing V3 event:', eventId);

                    // 找到要编辑的事件
                    let eventToEdit = null;
                    for (const day in this.weekSchedule) {
                        for (const slotKey in this.weekSchedule[day]) {
                            const event = this.weekSchedule[day][slotKey];
                            if (event && event.id === eventId) { // 添加null检查
                                eventToEdit = event;
                                break;
                            }
                        }
                        if (eventToEdit) break;
                    }

                    if (!eventToEdit) {
                        console.error('Event not found:', eventId);
                        return;
                    }

                    // 确保time_slot有效，如果无效则根据start_time重新计算
                    let validTimeSlot = eventToEdit.time_slot;
                    if (!validTimeSlot || ![21, 22, 51, 52, 71].includes(parseInt(validTimeSlot))) {
                        if (eventToEdit.start_time) {
                            validTimeSlot = this.getTimeSlotFromTime(eventToEdit.start_time);
                            console.log('🔧 Fixed invalid time_slot for editing, calculated from start_time:', eventToEdit.start_time, '->', validTimeSlot);
                        } else {
                            validTimeSlot = 21; // 默认值
                            console.log('🔧 Fixed invalid time_slot for editing, using default:', validTimeSlot);
                        }
                    }

                    // 设置编辑模式的数据
                    this.editingEvent = {
                        id: eventToEdit.id,
                        name: eventToEdit.name || '',
                        event_date: eventToEdit.event_date,
                        time_slot: validTimeSlot,
                        domain_id: eventToEdit.domain_id || '',
                        activity_type_id: eventToEdit.activity_type_id || '',
                        schedule_id: eventToEdit.schedule_id || '',
                        notes: eventToEdit.notes || '',
                        // V3 字段
                        duration: eventToEdit.duration || 60,
                        start_time: eventToEdit.start_time || null,
                        is_precise: eventToEdit.is_precise || false,
                        canvas_position_y: eventToEdit.canvas_position_y || 0
                    };

                    this.showEditEventModal = true;
                },

                // 格式化时间为API格式
                formatTimeForAPI(timeStr) {
                    if (!timeStr || timeStr === 'None' || timeStr === null) {
                        return null;
                    }

                    // 如果是简单的HH:MM格式，转换为HH:MM:SS
                    if (timeStr.split(':').length === 2) {
                        return timeStr + ':00';
                    }

                    return timeStr;
                },

                // V3网格点击处理
                handleV3GridClick(event, day) {
                    console.log('🎯 V3 Grid clicked:', day, event);

                    // 确保不是卡片点击事件 - 检查整个事件路径
                    if (event.target.closest('.task-card-v3')) {
                        console.log('🚫 Clicked on task card, ignoring grid click');
                        return;
                    }

                    // 计算点击位置对应的时间
                    const rect = event.currentTarget.getBoundingClientRect();
                    const canvasRect = document.getElementById('week-canvas-v3').getBoundingClientRect();
                    const relativeY = event.clientY - canvasRect.top - 60; // 减去header高度

                    // 计算对应的时间（吸附到10分钟网格）- 修复时间计算
                    const minutesFromStart = Math.max(0, Math.round(relativeY / (10 * this.v3ZoomLevel)) * 10);
                    const clickHour = this.v3TimeStart + Math.floor(minutesFromStart / 60);
                    const clickMinute = minutesFromStart % 60;

                    console.log('🎯 Calculated time:', clickHour + ':' + clickMinute.toString().padStart(2, '0'));

                    // 计算起始时间 - 模糊和精确卡片都有起始时间，只是精度不同
                    const startTimeStr = clickHour + ':' + clickMinute.toString().padStart(2, '0');

                    console.log('🎯 Selected node for V3 creation:', this.selectedNode);

                    // 根据是否有选中节点决定创建方式（采用V2的逻辑）
                    if (this.selectedNode.id) {
                        // 有选中节点 - 自动填入信息
                        this.newEvent = {
                            name: this.selectedNode.name, // 🎯 自动填入选中节点名称
                            event_date: day,
                            time_slot: this.getTimeSlotFromTime(startTimeStr),
                            domain_id: this.selectedNode.type === 'domain' ? this.selectedNode.id : '',
                            activity_type_id: this.selectedNode.type === 'type' ? this.selectedNode.id : '',
                            schedule_id: '',
                            notes: '',
                            // V3 新字段
                            duration: 60,
                            start_time: startTimeStr,
                            is_precise: false,
                            canvas_position_y: 0
                        };
                        console.log('✨ Created V3 event with selected node:', this.selectedNode.name);
                    } else {
                        // 没有选中节点 - 空白创建
                        this.newEvent = {
                            name: '',
                            event_date: day,
                            time_slot: this.getTimeSlotFromTime(startTimeStr),
                            domain_id: '',
                            activity_type_id: '',
                            schedule_id: '',
                            notes: '',
                            // V3 新字段
                            duration: 60,
                            start_time: startTimeStr,
                            is_precise: false,
                            canvas_position_y: 0
                        };
                        console.log('📄 Created V3 event from blank');
                    }

                    this.showNewEventModal = true;
                },

                // 根据小时获取对应的时间槽
                getTimeSlotFromHour(hour) {
                    if (hour >= 7 && hour < 10) return 21; // 上午第1时段
                    if (hour >= 10 && hour < 13) return 22; // 上午第2时段
                    if (hour >= 13 && hour < 16) return 51; // 下午第1时段
                    if (hour >= 16 && hour < 19) return 52; // 下午第2时段
                    if (hour >= 19 && hour <= 23) return 71; // 晚上时段
                    return 21; // 默认
                },

                // 根据时间字符串获取对应的时间槽
                getTimeSlotFromTime(timeStr) {
                    if (!timeStr) return 21;

                    const [hours] = timeStr.split(':').map(Number);
                    return this.getTimeSlotFromHour(hours);
                },

                // 获取时间槽的显示名称
                getTimeSlotDisplay(timeStr) {
                    console.log('🎯 getTimeSlotDisplay called with:', timeStr);

                    if (!timeStr || timeStr === 'None' || timeStr === null) {
                        console.log('🎯 No time string, returning "未设置"');
                        return '未设置';
                    }

                    const timeSlot = this.getTimeSlotFromTime(timeStr);
                    console.log('🎯 Calculated time slot:', timeSlot);

                    const timeSlotNames = {
                        21: "上午第1时段 (7-10点)",
                        22: "上午第2时段 (10-13点)",
                        51: "下午第1时段 (13-16点)",
                        52: "下午第2时段 (16-19点)",
                        71: "晚上时段 (19-23点)"
                    };

                    const result = timeSlotNames[timeSlot] || `时段${timeSlot}`;
                    console.log('🎯 Time slot display result:', result);
                    return result;
                },

                // 更新时间槽（当起始时间改变时调用）
                updateTimeSlot() {
                    console.log('🕐 updateTimeSlot called, start_time:', this.newEvent.start_time);
                    if (this.newEvent.start_time) {
                        const oldTimeSlot = this.newEvent.time_slot;
                        this.newEvent.time_slot = this.getTimeSlotFromTime(this.newEvent.start_time);
                        console.log('🕐 Updated time slot from', oldTimeSlot, 'to:', this.newEvent.time_slot, 'for time:', this.newEvent.start_time);
                    } else {
                        console.log('🕐 No start_time set, keeping current time_slot:', this.newEvent.time_slot);
                    }
                },

                // 更新编辑事件的时间槽
                updateEditingTimeSlot() {
                    if (this.editingEvent.start_time) {
                        this.editingEvent.time_slot = this.getTimeSlotFromTime(this.editingEvent.start_time);
                        console.log('🔧 Updated editing time slot to:', this.editingEvent.time_slot, 'for time:', this.editingEvent.start_time);
                    }
                },

                // 计算结束时间
                calculateEndTime(startTime, duration) {
                    if (!startTime || !duration) return '';

                    const [hours, minutes] = startTime.split(':').map(Number);
                    const totalMinutes = hours * 60 + minutes + parseInt(duration);
                    const endHours = Math.floor(totalMinutes / 60);
                    const endMinutes = totalMinutes % 60;

                    return endHours.toString().padStart(2, '0') + ':' + endMinutes.toString().padStart(2, '0');
                },

                // V3智能吸附系统
                snapToV3Grid(mouseY, canvasRect) {
                    // 计算相对于画布的Y坐标
                    const relativeY = mouseY - canvasRect.top - 60; // 减去header高度

                    // 吸附到最近的10分钟网格
                    const gridUnit = 10 * this.v3ZoomLevel; // 10分钟网格的像素高度
                    const snappedY = Math.round(relativeY / gridUnit) * gridUnit;

                    // 转换为时间 - 修复时间计算
                    const minutesFromStart = Math.round(snappedY / (10 * this.v3ZoomLevel)) * 10;
                    const hour = this.v3TimeStart + Math.floor(minutesFromStart / 60);
                    const minute = minutesFromStart % 60;

                    // 确保在有效时间范围内
                    if (hour < this.v3TimeStart || hour > this.v3TimeEnd) {
                        return null;
                    }

                    return {
                        y: snappedY + 60, // 加回header高度
                        time: hour.toString().padStart(2, '0') + ':' + minute.toString().padStart(2, '0'),
                        hour: hour,
                        minute: minute
                    };
                },

                // 显示V3吸附指示器
                showV3SnapIndicator(snapData) {
                    if (!snapData) {
                        this.v3SnapIndicator.visible = false;
                        return;
                    }

                    this.v3SnapIndicator.visible = true;
                    this.v3SnapIndicator.y = snapData.y;
                    this.v3SnapIndicator.tooltip = `📍 ${snapData.time}`;
                },

                // 隐藏V3吸附指示器
                hideV3SnapIndicator() {
                    this.v3SnapIndicator.visible = false;
                },

                // 清理拖拽实例
                cleanupDragInstances() {
                    // 清理所有现有的sortable实例
                    document.querySelectorAll('.sortable-initialized').forEach(el => {
                        if (el.sortableInstance) {
                            el.sortableInstance.destroy();
                        }
                        el.classList.remove('sortable-initialized');
                    });
                },

                // 缩放控制
                adjustZoom(delta) {
                    const newZoom = this.v3ZoomLevel + delta;
                    if (newZoom >= 0.5 && newZoom <= 2.0) {
                        this.v3ZoomLevel = newZoom;
                        console.log('🔍 V3 zoom adjusted to:', Math.round(newZoom * 100) + '%');

                        // 重新渲染画布
                        this.$nextTick(() => {
                            this.rerenderV3Canvas();
                        });
                    }
                },

                // 计算画布高度
                getCanvasHeight() {
                    const hours = this.v3TimeEnd - this.v3TimeStart + 1; // 修复：17小时（包含23:00）
                    return (hours * 60 * this.v3ZoomLevel) + 60; // 17小时 × 60px/小时 × 缩放 + 顶部padding
                },

                // 重新渲染V3画布
                rerenderV3Canvas() {
                    if (!this.isV3Mode) return;

                    const timeAxisContainer = document.querySelector('[x-html="renderTimeAxis()"]');
                    const gridLinesContainer = document.querySelector('[x-html="renderGridLines()"]');

                    if (timeAxisContainer) {
                        timeAxisContainer.innerHTML = this.renderTimeAxis();
                    }

                    if (gridLinesContainer) {
                        gridLinesContainer.innerHTML = this.renderGridLines();
                    }

                    // 重新渲染所有日期列的卡片
                    this.weekDates.forEach(day => {
                        const dayCardContainer = document.querySelector(`[x-html="renderDayCardsV3('${day}')"]`);
                        if (dayCardContainer) {
                            dayCardContainer.innerHTML = this.renderDayCardsV3(day);
                        }
                    });

                    console.log('🎨 V3 canvas re-rendered with zoom:', this.v3ZoomLevel);

                    // 重新初始化拖拽功能（缩放后卡片需要重新绑定事件）
                    this.$nextTick(() => {
                        this.initV3DragAndDrop();
                    });
                },
                
                // 新增：刷新活动池方法
                refreshActivityPool() {
                    console.log('Refreshing activity pool...');
                    const activityPool = document.getElementById('activity-pool');
                    if (!activityPool) {
                        console.error('Activity pool not found');
                        return;
                    }

                    // 销毁现有的 Sortable 实例
                    if (activityPool.sortableInstance) {
                        activityPool.sortableInstance.destroy();
                        activityPool.sortableInstance = null;
                    }
                    activityPool.classList.remove('sortable-initialized');

                    // 触发Alpine.js重新渲染活动池（x-html会自动重新渲染）
                    console.log('Triggering Alpine.js re-render for activity pool');

                    // 等待Alpine.js重新渲染完成，然后重新初始化拖拽功能
                    this.$nextTick(() => {
                        console.log('Activity pool re-rendered, re-initializing drag and drop');
                        this.initActivityPoolDragAndDrop();
                    });
                },

                // 新增：验证拖拽目标有效性
                validateDropTarget(targetElement, targetRect) {
                    // 检查基本有效性
                    if (!targetElement || !targetElement.classList.contains('time-slot')) {
                        return false;
                    }

                    // 检查元素是否可见和有边界
                    if (targetRect.width === 0 || targetRect.height === 0) {
                        console.warn('目标元素边界为0');
                        return false;
                    }

                    // 检查元素是否在视口内
                    if (targetRect.left === 0 && targetRect.top === 0 &&
                        targetRect.right === 0 && targetRect.bottom === 0) {
                        console.warn('目标元素位置全为0');
                        return false;
                    }

                    // 检查CSS显示状态
                    const computedStyle = window.getComputedStyle(targetElement);
                    if (computedStyle.display === 'none' || computedStyle.visibility === 'hidden') {
                        console.warn('目标元素被隐藏');
                        return false;
                    }

                    return true;
                },

                // 新增：根据鼠标位置找到最近的有效时间槽
                findNearestValidTimeSlot(mouseEvent) {
                    if (!mouseEvent) {
                        console.warn('没有鼠标事件信息');
                        return null;
                    }

                    const mouseX = mouseEvent.clientX || mouseEvent.pageX;
                    const mouseY = mouseEvent.clientY || mouseEvent.pageY;

                    console.log('鼠标位置:', { x: mouseX, y: mouseY });

                    // 获取所有有效的时间槽
                    const timeSlots = Array.from(document.querySelectorAll('.time-slot')).filter(slot => {
                        const rect = slot.getBoundingClientRect();
                        return this.validateDropTarget(slot, rect);
                    });

                    console.log('找到有效时间槽数量:', timeSlots.length);

                    if (timeSlots.length === 0) {
                        return null;
                    }

                    // 找到距离鼠标最近的时间槽
                    let nearestSlot = null;
                    let minDistance = Infinity;

                    timeSlots.forEach(slot => {
                        const rect = slot.getBoundingClientRect();
                        const centerX = rect.left + rect.width / 2;
                        const centerY = rect.top + rect.height / 2;

                        const distance = Math.sqrt(
                            Math.pow(mouseX - centerX, 2) + Math.pow(mouseY - centerY, 2)
                        );

                        if (distance < minDistance) {
                            minDistance = distance;
                            nearestSlot = slot;
                        }
                    });

                    console.log('最近时间槽距离:', minDistance);
                    return nearestSlot;
                },

                // 新增：验证活动池状态
                verifyActivityPoolState() {
                    console.log('Verifying activity pool state...');
                    const activityPool = document.getElementById('activity-pool');
                    if (!activityPool) {
                        console.error('Activity pool not found during verification');
                        return;
                    }

                    const currentCards = activityPool.querySelectorAll('.activity-card');
                    const expectedCount = this.flatActivities.length;

                    console.log('Activity pool verification:', {
                        currentCards: currentCards.length,
                        expectedCount: expectedCount,
                        isInitialized: activityPool.classList.contains('sortable-initialized')
                    });

                    // 如果卡片数量不匹配或者没有初始化，刷新活动池
                    if (currentCards.length !== expectedCount || !activityPool.classList.contains('sortable-initialized')) {
                        console.warn('Activity pool state incorrect, refreshing...');
                        this.refreshActivityPool();
                    } else {
                        console.log('Activity pool state verified - all good');
                    }
                },

                // 新增：仅初始化活动池的拖拽功能
                initActivityPoolDragAndDrop() {
                    console.log('Initializing activity pool drag and drop...');
                    const activityPool = document.getElementById('activity-pool');
                    if (!activityPool || activityPool.classList.contains('sortable-initialized')) {
                        console.log('Activity pool already initialized or not found');
                        return;
                    }

                    const self = this;

                    activityPool.sortableInstance = Sortable.create(activityPool, {
                        group: {
                            name: 'activities',
                            pull: 'clone', // 确保是克隆模式
                            put: function(to, from) {
                                // 只允许从time-slot拖拽回活动池（删除功能）
                                return from.classList && from.classList.contains('time-slot');
                            }
                        },
                        sort: false, // 活动池内不允许排序
                        animation: 200,
                        ghostClass: 'sortable-ghost',
                        chosenClass: 'sortable-chosen',
                        dragClass: 'sortable-drag',
                        // 关键：确保克隆行为正确
                        onClone: function(evt) {
                            console.log('Activity cloned from pool:', evt.clone);
                            const originalId = evt.item.getAttribute('data-activity-id');
                            if (originalId) {
                                evt.clone.setAttribute('data-activity-id', originalId);
                            }
                        },
                        // 从活动池开始拖拽时
                        onStart: function(evt) {
                            console.log('Drag started from activity pool:', evt.item.getAttribute('data-activity-id'));
                            evt.item.classList.add('dragging-from-pool');
                        },
                        // 拖拽结束时的清理和恢复
                        onEnd: function(evt) {
                            console.log('Drag ended from activity pool');

                            // 清理标记
                            if (evt.item) {
                                evt.item.classList.remove('dragging-from-pool');
                            }

                            // 检查活动池状态
                            const currentCards = activityPool.querySelectorAll('.activity-card');
                            console.log('Activity pool cards after drag:', currentCards.length, 'Expected:', self.flatActivities.length);

                            // 如果卡片数量不匹配，强制刷新
                            if (currentCards.length !== self.flatActivities.length) {
                                console.warn('Activity pool cards count mismatch, forcing refresh');
                                setTimeout(() => {
                                    self.refreshActivityPool();
                                }, 100);
                            }
                        },
                        // 处理删除操作（从时间槽拖回活动池）
                        onAdd: function(evt) {
                            console.log('Item dropped back to activity pool - deleting event');
                            evt.item.remove();
                            // 删除操作由时间槽的 onRemove 处理
                        }
                    });

                    activityPool.classList.add('sortable-initialized');
                    console.log('Activity pool sortable initialized successfully');
                },

                // =============================================================================
                // 侧边栏功能 v2.1 (交互革命)
                // =============================================================================

                // 设置侧边栏模式
                setSidebarMode(mode) {
                    console.log('🔄 Setting sidebar mode to:', mode);
                    this.sidebarMode = mode;

                    // 加载相应的数据
                    if (mode === 'domain') {
                        this.loadDomainTree();
                    } else if (mode === 'type') {
                        this.loadTypeTree();
                    }

                    // 清除当前选中节点（切换模式时）
                    if (this.selectedNode.id && this.selectedNode.type !== mode) {
                        console.log('🔄 Clearing selected node due to mode switch');
                        this.clearSelectedNode();
                    }
                },

                // 加载Domain层级树数据
                async loadDomainTree() {
                    try {
                        console.log('📂 Loading domain tree...');
                        const response = await fetch('/api/domains/tree');
                        if (!response.ok) throw new Error('Failed to load domain tree');

                        this.domainTree = await response.json();
                        console.log('✅ Domain tree loaded:', this.domainTree.length, 'root nodes');

                        // 等待DOM更新后重新初始化拖拽
                        this.$nextTick(() => {
                            setTimeout(() => {
                                console.log('🔄 Re-initializing drag after domain tree load...');
                                // v2.1 不再需要拖拽初始化
                            }, 50);
                        });
                    } catch (error) {
                        console.error('❌ Error loading domain tree:', error);
                        this.domainTree = [];
                    }
                },

                // 加载ActivityType层级树数据
                async loadTypeTree() {
                    try {
                        console.log('🏷️ Loading activity type tree...');
                        const response = await fetch('/api/activity-types/tree');
                        if (!response.ok) throw new Error('Failed to load activity type tree');

                        this.typeTree = await response.json();
                        console.log('✅ Activity type tree loaded:', this.typeTree.length, 'root nodes');

                        // 等待DOM更新后重新初始化拖拽
                        this.$nextTick(() => {
                            setTimeout(() => {
                                console.log('🔄 Re-initializing drag after type tree load...');
                                // v2.1 不再需要拖拽初始化
                            }, 50);
                        });
                    } catch (error) {
                        console.error('❌ Error loading activity type tree:', error);
                        this.typeTree = [];
                    }
                },

                // 渲染选择面板Domain树（v2.1专用，点击选择）
                renderSelectionDomainTree() {
                    if (!this.domainTree.length) {
                        return '<p class="text-muted">暂无领域数据</p>';
                    }
                    return this.renderSelectionTreeNodes(this.domainTree, 'domain');
                },

                // 渲染选择面板ActivityType树（v2.1专用，点击选择）
                renderSelectionTypeTree() {
                    if (!this.typeTree.length) {
                        return '<p class="text-muted">暂无类型数据</p>';
                    }
                    return this.renderSelectionTreeNodes(this.typeTree, 'type');
                },

                // 渲染树节点的递归方法
                renderTreeNodes(nodes, nodeType) {
                    return nodes.map(node => {
                        const hasChildren = node.children && node.children.length > 0;
                        const isCollapsed = this.collapsedNodes.has(`${nodeType}-${node.id}`);
                        const toggleIcon = hasChildren ? (isCollapsed ? '▶' : '▼') : '';
                        const nodeKey = `${nodeType}-${node.id}`;

                        // 检查是否被选中（使用V2兼容的selectedNode方式）
                        const isSelected = this.selectedNode.id === node.id && this.selectedNode.type === nodeType;
                        const selectedClass = isSelected ? 'tree-node-selected' : '';

                        let html = `
                            <div class="tree-node">
                                <div class="tree-node-content draggable ${selectedClass}"
                                     data-node-type="${nodeType}"
                                     data-node-id="${node.id}"
                                     data-node-name="${node.name}"
                                     onclick="window.laeAppInstance.selectNode('${nodeType}', ${node.id}, '${node.name}'); event.stopPropagation();">
                                    ${hasChildren ?
                                        `<button class="tree-toggle ${isCollapsed ? '' : 'expanded'}"
                                                onclick="window.laeAppInstance.toggleNode('${nodeKey}'); event.stopPropagation();">
                                            ${toggleIcon}
                                        </button>` :
                                        `<div style="width: 16px; margin-right: 0.5rem;"></div>`
                                    }
                                    <div style="flex: 1;">
                                        <div class="tree-node-label">${node.name}</div>
                                        ${node.description ?
                                            `<div class="tree-node-description">${node.description}</div>` :
                                            ''
                                        }
                                    </div>
                                </div>
                        `;

                        if (hasChildren && !isCollapsed) {
                            html += `
                                <div class="tree-children">
                                    ${this.renderTreeNodes(node.children, nodeType)}
                                </div>
                            `;
                        }

                        html += '</div>';
                        return html;
                    }).join('');
                },

                // 切换节点展开/折叠状态
                toggleNode(nodeKey) {
                    console.log('🔄 Toggling node:', nodeKey);

                    if (this.collapsedNodes.has(nodeKey)) {
                        this.collapsedNodes.delete(nodeKey);
                        console.log('📂 Expanded node:', nodeKey);
                    } else {
                        this.collapsedNodes.add(nodeKey);
                        console.log('📁 Collapsed node:', nodeKey);
                    }

                    // 触发重新渲染
                    this.refreshTrigger++;
                },

                // 选择侧边栏节点 - V3版本，兼容V2的selectedNode系统
                selectNode(nodeType, nodeId, nodeName) {
                    console.log('🎯 V3 Selecting node:', nodeType, nodeId, nodeName);

                    // 如果点击的是已选中的节点，则取消选择
                    if (this.selectedNode.id === nodeId && this.selectedNode.type === nodeType) {
                        this.selectedNode = { id: null, name: '', type: '', description: '' };
                        this.selectedDomainId = null;
                        this.selectedActivityTypeId = null;
                        console.log('🎯 Deselected node');
                    } else {
                        // 选中新节点，同时更新V2兼容字段和V3专用字段
                        this.selectedNode = {
                            id: nodeId,
                            name: nodeName,
                            type: nodeType,
                            description: ''
                        };

                        if (nodeType === 'domain') {
                            this.selectedDomainId = nodeId;
                            this.selectedActivityTypeId = null;
                        } else if (nodeType === 'type') {
                            this.selectedActivityTypeId = nodeId;
                            this.selectedDomainId = null;
                        }

                        console.log('🎯 Selected node:', this.selectedNode);
                    }

                    // 触发重新渲染以更新选中状态样式
                    this.refreshTrigger++;
                },

                // 渲染选择树节点的递归方法（可点击选择）
                renderSelectionTreeNodes(nodes, nodeType) {
                    return nodes.map(node => {
                        const hasChildren = node.children && node.children.length > 0;
                        const isCollapsed = this.collapsedNodes.has(`${nodeType}-${node.id}`);
                        const toggleIcon = hasChildren ? (isCollapsed ? '▶' : '▼') : '';
                        const nodeKey = `${nodeType}-${node.id}`;
                        const isSelected = this.selectedNode.id === node.id && this.selectedNode.type === nodeType;

                        let html = `
                            <div class="tree-node">
                                <div class="tree-node-content selectable ${isSelected ? 'selected' : ''}"
                                     onclick="window.laeAppInstance.selectNode('${nodeType}', ${node.id}, '${node.name.replace(/'/g, "\\'")}', '${(node.description || '').replace(/'/g, "\\'")}')">
                                    ${hasChildren ?
                                        `<button class="tree-toggle ${isCollapsed ? '' : 'expanded'}"
                                                onclick="event.stopPropagation(); window.laeAppInstance.toggleNode('${nodeKey}')">
                                            ${toggleIcon}
                                        </button>` :
                                        `<div style="width: 16px; margin-right: 0.5rem;"></div>`
                                    }
                                    <div style="flex: 1;">
                                        <div class="tree-node-label">
                                            ${isSelected ? '<strong>✓ ' + node.name + '</strong>' : node.name}
                                        </div>
                                        ${node.description ?
                                            `<div class="tree-node-description">${node.description}</div>` :
                                            ''
                                        }
                                    </div>
                                </div>
                        `;

                        if (hasChildren && !isCollapsed) {
                            html += `
                                <div class="tree-children">
                                    ${this.renderSelectionTreeNodes(node.children, nodeType)}
                                </div>
                            `;
                        }

                        html += '</div>';
                        return html;
                    }).join('');
                },

                // 选中节点
                selectNode(nodeType, nodeId, nodeName, nodeDescription) {
                    console.log('🎯 Selecting node:', { nodeType, nodeId, nodeName });
                    this.selectedNode = {
                        id: nodeId,
                        name: nodeName,
                        type: nodeType,
                        description: nodeDescription || ''
                    };
                    // 触发重新渲染以更新选中状态
                    this.refreshTrigger++;
                },

                // 清除选中节点
                clearSelectedNode() {
                    console.log('🔄 Clearing selected node');
                    this.selectedNode = {
                        id: null,
                        name: '',
                        type: '',
                        description: ''
                    };
                    // 触发重新渲染
                    this.refreshTrigger++;
                },

                // 初始化侧边栏拖拽功能
                initSidebarDragAndDrop() {
                    console.log('🎯 Initializing sidebar drag and drop...');

                    // 只在周视图中初始化侧边栏拖拽功能
                    if (this.currentView !== 'week') {
                        console.log('Sidebar drag and drop skipped - not in week view');
                        return;
                    }

                    const domainPool = document.getElementById('domain-pool');
                    const typePool = document.getElementById('type-pool');

                    console.log('🎯 Sidebar elements found:', {
                        domainPool: !!domainPool,
                        typePool: !!typePool,
                        domainPoolVisible: domainPool ? !domainPool.hidden : false,
                        typePoolVisible: typePool ? !typePool.hidden : false
                    });

                    if (domainPool) {
                        console.log('🎯 Initializing domain pool drag...');
                        this.initPoolDragAndDrop(domainPool, 'domain');
                    } else {
                        console.warn('⚠️ Domain pool not found');
                    }

                    if (typePool) {
                        console.log('🎯 Initializing type pool drag...');
                        this.initPoolDragAndDrop(typePool, 'type');
                    } else {
                        console.warn('⚠️ Type pool not found');
                    }
                },

                // 为特定池初始化拖拽功能
                initPoolDragAndDrop(poolElement, poolType) {
                    if (poolElement.sortableInstance) {
                        poolElement.sortableInstance.destroy();
                    }

                    const self = this;

                    // 添加测试点击事件监听器
                    poolElement.addEventListener('mousedown', function(e) {
                        console.log('🖱️ Mouse down on pool element:', {
                            target: e.target,
                            className: e.target.className,
                            tagName: e.target.tagName,
                            closest_draggable: e.target.closest('.tree-node-content')
                        });
                    });

                    poolElement.sortableInstance = Sortable.create(poolElement, {
                        group: {
                            name: 'activities',
                            pull: 'clone'
                        },
                        sort: false,
                        // 明确指定只拖拽.tree-node-content元素
                        draggable: '.tree-node-content',
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        chosenClass: 'sortable-chosen',
                        onStart: function(evt) {
                            console.log('🎯 Starting drag from', poolType, 'pool');
                            console.log('🎯 Dragging item:', {
                                nodeType: evt.item.getAttribute('data-node-type'),
                                nodeId: evt.item.getAttribute('data-node-id'),
                                nodeName: evt.item.getAttribute('data-node-name'),
                                element: evt.item,
                                elementClass: evt.item.className,
                                parentElement: evt.item.parentElement
                            });
                        },
                        onEnd: function(evt) {
                            console.log('🎯 Drag ended from', poolType, 'pool');
                            // 清理克隆元素
                            if (evt.clone && evt.clone !== evt.item) {
                                evt.clone.remove();
                            }
                        }
                    });

                    console.log('✅', poolType, 'pool drag initialized');
                },

                // =============================================================================
                // 工具方法
                getCurrentDateString() {
                    return this.currentDate.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        weekday: 'long'
                    });
                },
                
                getWeekTitle() {
                    if (this.weekDates.length === 0) return '';
                    const start = new Date(this.weekDates[0]);
                    const end = new Date(this.weekDates[6]);
                    return `${start.getMonth() + 1}月${start.getDate()}日 - ${end.getMonth() + 1}月${end.getDate()}日`;
                },
                
                getMonthTitle() {
                    return `${this.currentYear}年${this.currentMonth}月`;
                },
                
                // 月视图相关方法
                previousMonth() {
                    this.currentMonth--;
                    if (this.currentMonth < 1) {
                        this.currentMonth = 12;
                        this.currentYear--;
                    }
                    this.loadMonthSchedule();
                },
                
                nextMonth() {
                    this.currentMonth++;
                    if (this.currentMonth > 12) {
                        this.currentMonth = 1;
                        this.currentYear++;
                    }
                    this.loadMonthSchedule();
                },
                
                async loadMonthSchedule() {
                    try {
                        console.log(`Loading month schedule for ${this.currentYear}-${this.currentMonth}`);
                        
                        // 渲染月历（现在直接在renderMonthCalendar中加载数据）
                        await this.renderMonthCalendar();
                        
                        console.log('Month schedule loaded and rendered');
                    } catch (error) {
                        console.error('加载月日程失败:', error);
                        const monthCalendarContainer = document.getElementById('month-calendar');
                        if (monthCalendarContainer) {
                            monthCalendarContainer.innerHTML = '<p class="text-danger">加载月视图失败</p>';
                        }
                    }
                },
                
                // 汇总视图相关方法
                async initSummaryData() {
                    console.log('Initializing summary data...');
                    await this.generateAvailableMonths();
                    await this.loadSummaryStatistics();
                    await this.loadActivityStatistics();
                    await this.loadDomainScheduleCounts();  // 加载Domain的Schedule数量
                },
                
                generateAvailableMonths() {
                    // 生成可选择的月份列表（简化版本，基于当前日期）
                    const now = new Date();
                    const months = [];
                    
                    // 添加当前月和前面几个月
                    for (let i = 2; i >= 0; i--) {
                        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                        months.push({
                            value: `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`,
                            label: `${date.getFullYear()}年${date.getMonth() + 1}月`
                        });
                    }
                    
                    this.availableMonths = months;
                    console.log('Available months:', this.availableMonths);
                },
                
                async loadSummaryStatistics() {
                    try {
                        console.log('Loading summary statistics for month:', this.summaryMonth);
                        let endpoint = '/statistics/summary';
                        
                        // 如果选择了特定月份，添加查询参数（假设后端支持）
                        if (this.summaryMonth) {
                            endpoint += `?month=${this.summaryMonth}`;
                        }
                        
                        this.summaryStats = await this.apiCall(endpoint);
                        console.log('Summary statistics loaded:', this.summaryStats);
                    } catch (error) {
                        console.error('Failed to load summary statistics:', error);
                        this.summaryStats = {
                            total_activities: 0,
                            total_events: 0,
                            completed_events: 0,
                            completion_rate: 0
                        };
                    }
                },
                
                async loadActivityStatistics() {
                    try {
                        console.log('Loading activity statistics...');
                        this.activityStats = {};
                        
                        // 为每个活动加载统计数据
                        for (const activity of this.flatActivities) {
                            const stats = await this.apiCall(`/statistics/activities/${activity.id}/statistics`);
                            this.activityStats[activity.id] = stats;
                            console.log(`Stats for ${activity.name}:`, stats);
                        }
                    } catch (error) {
                        console.error('Failed to load activity statistics:', error);
                        this.activityStats = {};
                    }
                },
                
                formatWeekday(dateString) {
                    const date = new Date(dateString);
                    return ['周一', '周二', '周三', '周四', '周五', '周六', '周日'][date.getDay() === 0 ? 6 : date.getDay() - 1];
                },
                
                formatDate(dateString) {
                    const date = new Date(dateString);
                    return `${date.getMonth() + 1}/${date.getDate()}`;
                },
                
                // 月历渲染（简化版本，显示事件数量）
                async renderMonthCalendar() {
                    try {
                        // 重新加载月数据以获取完整的天数信息
                        const data = await this.apiCall(`/calendar/month/${this.currentYear}/${this.currentMonth}`);
                        
                        if (!data.days || data.days.length === 0) {
                            const monthCalendarContainer = document.getElementById('month-calendar');
                            if (monthCalendarContainer) {
                                monthCalendarContainer.innerHTML = '<p class="text-muted">无法加载月视图数据</p>';
                            }
                            return;
                        }
                        
                        const firstDay = new Date(this.currentYear, this.currentMonth - 1, 1);
                        const lastDay = new Date(this.currentYear, this.currentMonth, 0);
                        
                        // 计算月历应该从哪一天开始（周一）
                        const startDate = new Date(firstDay);
                        const dayOfWeek = firstDay.getDay() === 0 ? 7 : firstDay.getDay();
                        startDate.setDate(firstDay.getDate() - dayOfWeek + 1);
                        
                        // 计算月历应该到哪一天结束（确保完整的周）
                        const endDate = new Date(lastDay);
                        const endDayOfWeek = lastDay.getDay() === 0 ? 7 : lastDay.getDay();
                        endDate.setDate(lastDay.getDate() + (7 - endDayOfWeek));
                        
                        // 创建日期到事件数量的映射
                        const dayEventsMap = {};
                        data.days.forEach(day => {
                            dayEventsMap[day.date] = {
                                event_count: day.event_count,
                                is_today: day.is_today
                            };
                        });

                        // 保存Schedule数据供渲染使用
                        this.monthSchedules = data.schedules || [];
                        
                        let html = '';
                        let currentDate = new Date(startDate);
                        
                        // 按周渲染
                        while (currentDate <= endDate) {
                            html += '<div class="row mb-1">';
                            
                            // 一周7天
                            for (let i = 0; i < 7; i++) {
                                const dateStr = currentDate.toISOString().split('T')[0];
                                const dayData = dayEventsMap[dateStr] || { event_count: 0, is_today: false };
                                const isCurrentMonth = currentDate.getMonth() === this.currentMonth - 1;
                                
                                let cellClass = 'col border p-2';
                                if (!isCurrentMonth) {
                                    cellClass += ' text-muted bg-light';
                                }
                                if (dayData.is_today) {
                                    cellClass += ' bg-warning bg-opacity-25 fw-bold';
                                }
                                
                                html += `<div class="${cellClass}" style="min-height: 100px; position: relative;">`;
                                html += `<div class="fw-bold">${currentDate.getDate()}</div>`;

                                // 显示事件数量（底层）
                                if (dayData.event_count > 0) {
                                    html += `
                                        <div class="mt-2">
                                            <span class="badge bg-primary">${dayData.event_count} 个日程</span>
                                        </div>
                                    `;
                                }

                                // 渲染Schedule时间条（顶层，半透明）
                                const dayScheduleBars = this.getMonthScheduleBarsForDay(currentDate);
                                if (dayScheduleBars.length > 0) {
                                    html += '<div class="schedule-bars-container">';
                                    dayScheduleBars.forEach(bar => {
                                        html += `
                                            <div class="month-schedule-bar schedule-color-${bar.id % 8}"
                                                 data-schedule-id="${bar.id}"
                                                 title="${bar.name}${bar.tooltip}"
                                                 style="opacity: 0.8;"
                                                 onclick="window.laeAppInstance.editScheduleFromTimeline(${bar.id})">
                                                ${bar.displayText}
                                            </div>
                                        `;
                                    });
                                    html += '</div>';
                                }

                                html += '</div>';
                                
                                // 移动到下一天
                                currentDate.setDate(currentDate.getDate() + 1);
                            }
                            
                            html += '</div>';
                        }
                        
                        // 更新DOM
                        const monthCalendarContainer = document.getElementById('month-calendar');
                        if (monthCalendarContainer) {
                            monthCalendarContainer.innerHTML = html;
                        }
                    } catch (error) {
                        console.error('渲染月历失败:', error);
                        const monthCalendarContainer = document.getElementById('month-calendar');
                        if (monthCalendarContainer) {
                            monthCalendarContainer.innerHTML = '<p class="text-danger">加载月视图失败</p>';
                        }
                    }
                },

                // 获取指定日期的月视图Schedule时间条
                getMonthScheduleBarsForDay(date) {
                    if (!this.monthSchedules) return [];

                    const targetDate = new Date(date);
                    targetDate.setHours(0, 0, 0, 0);
                    const bars = [];

                    this.monthSchedules.forEach(schedule => {
                        if (this.scheduleSpansDay(schedule, targetDate)) {
                            const spanInfo = this.getMonthScheduleSpanInfo(schedule, targetDate);
                            bars.push({
                                id: schedule.id,
                                name: schedule.name,
                                displayText: this.getMonthScheduleDisplayText(schedule, spanInfo),
                                tooltip: `\n开始: ${this.formatFullDate(schedule.start_date)}\n截止: ${this.formatFullDate(schedule.deadline)}`
                            });
                        }
                    });

                    // 按截止时间排序
                    bars.sort((a, b) => {
                        const aDeadline = this.monthSchedules.find(s => s.id === a.id)?.deadline;
                        const bDeadline = this.monthSchedules.find(s => s.id === b.id)?.deadline;
                        if (!aDeadline && !bDeadline) return 0;
                        if (!aDeadline) return 1;
                        if (!bDeadline) return -1;
                        return new Date(aDeadline) - new Date(bDeadline);
                    });

                    return bars;
                },

                // 获取月视图Schedule跨越信息
                getMonthScheduleSpanInfo(schedule, currentDate) {
                    const startDate = schedule.start_date ? new Date(schedule.start_date) : null;
                    const endDate = schedule.deadline ? new Date(schedule.deadline) : null;

                    if (!startDate || !endDate) return null;

                    startDate.setHours(0, 0, 0, 0);
                    endDate.setHours(0, 0, 0, 0);
                    currentDate.setHours(0, 0, 0, 0);

                    const isFirstDay = currentDate.getTime() === startDate.getTime();
                    const isLastDay = currentDate.getTime() === endDate.getTime();
                    const isMiddleDay = currentDate > startDate && currentDate < endDate;

                    return {
                        isFirstDay,
                        isLastDay,
                        isMiddleDay,
                        totalDays: Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1
                    };
                },

                // 获取月视图Schedule显示文本
                getMonthScheduleDisplayText(schedule, spanInfo) {
                    if (!spanInfo) {
                        return schedule.name.length > 8 ? schedule.name.substring(0, 8) + '...' : schedule.name;
                    }

                    const shortName = schedule.name.length > 6 ? schedule.name.substring(0, 6) + '...' : schedule.name;

                    if (spanInfo.isFirstDay) {
                        return `◀${shortName}`;
                    } else if (spanInfo.isLastDay) {
                        return `${shortName}▶`;
                    } else if (spanInfo.isMiddleDay) {
                        return `──${shortName}──`;
                    }

                    return shortName;
                },

                // 获取时间槽名称的辅助方法
                getTimeSlotName(timeSlotValue) {
                    const slot = this.timeSlots.find(s => s.value === timeSlotValue);
                    return slot ? slot.name.replace('第1时段', '1').replace('第2时段', '2').replace('时段', '') : `时段${timeSlotValue}`;
                },

                // 格式化时间为API标准格式
                formatTimeForAPI(timeString) {
                    if (!timeString) return null;

                    console.log('🕐 Formatting time for API:', timeString, 'length:', timeString.length);

                    // 确保时间格式为HH:MM:SS（API期望的格式）
                    if (timeString.length === 4 || timeString.length === 5) { // "8:40" or "08:40" -> "08:40:00"
                        const [hours, minutes] = timeString.split(':');
                        const formatted = hours.padStart(2, '0') + ':' + minutes.padStart(2, '0') + ':00';
                        console.log('🕐 Formatted result:', formatted);
                        return formatted;
                    } else if (timeString.length === 8) { // "08:40:00" 已经是正确格式
                        console.log('🕐 Already in correct format:', timeString);
                        return timeString;
                    }

                    console.warn('🚨 Unexpected time format:', timeString, 'length:', timeString.length);
                    return timeString;
                }
            }
        }

        // 全局辅助函数
        async function deleteActivity(activityId) {
            if (confirm('确定要删除这个活动吗？这将删除所有相关的日程安排。')) {
                try {
                    await fetch(`/api/activities/${activityId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    // 刷新页面
                    location.reload();
                } catch (error) {
                    console.error('删除活动失败:', error);
                    alert('删除失败');
                }
            }
        }
    </script>
</body>
</html>