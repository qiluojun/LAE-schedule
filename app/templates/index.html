<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAE - ä¸ªäººæ—¥ç¨‹ä¸ä¸»æ”¯çº¿ç®¡ç†ç³»ç»Ÿ v16 Summary Stats</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.0/dist/cdn.min.js"></script>
    <!-- SortableJS -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <style>
        .time-slot {
            min-height: 120px;
            border: 2px solid #dee2e6;
            border-radius: 0.375rem;
            background-color: #f8f9fa;
            transition: background-color 0.2s, transform 0.1s, border-color 0.2s;
            padding: 8px;
            position: relative;
        }
        .time-slot:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }
        .time-slot.occupied {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        .activity-card {
            cursor: grab;
            transition: transform 0.2s;
        }
        .activity-card:hover {
            transform: translateY(-2px);
        }
        .activity-card:active {
            cursor: grabbing;
        }
        .sortable-chosen {
            opacity: 0.8;
            transform: rotate(3deg);
        }
        .sortable-drag {
            opacity: 0.8;
            transform: rotate(5deg);
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }
        .sortable-ghost {
            opacity: 0.4;
            background: #e3f2fd;
            border: 2px dashed #2196f3;
        }

        /* V3 æ‹–æ‹½æ ·å¼ */
        .sortable-ghost-v3 {
            opacity: 0.3;
            background: rgba(33, 150, 243, 0.1);
            border: 2px dashed #2196f3;
            transform: scale(1.05);
        }
        .sortable-chosen-v3 {
            opacity: 0.8;
            transform: scale(1.02) rotate(1deg);
            z-index: 1000;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        .sortable-drag-v3 {
            opacity: 0.9;
            transform: rotate(3deg);
            box-shadow: 0 12px 30px rgba(0,0,0,0.4);
        }
        .sortable-fallback-v3 {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #2196f3;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        /* å¸é™„æŒ‡ç¤ºå™¨æ ·å¼ */
        .snap-indicator {
            position: absolute;
            left: 80px; /* å¯¹é½åˆ°ç½‘æ ¼åŒºåŸŸ */
            right: 0;
            height: 2px;
            background: #ff5722;
            z-index: 2000;
            display: none;
            pointer-events: none;
            box-shadow: 0 0 10px rgba(255, 87, 34, 0.6);
        }
        .snap-indicator.active {
            display: block;
            animation: snapPulse 0.3s ease-in-out;
        }
        @keyframes snapPulse {
            0% { opacity: 0.5; transform: scaleY(0.5); }
            50% { opacity: 1; transform: scaleY(1.5); }
            100% { opacity: 0.8; transform: scaleY(1); }
        }
        .time-slot.sortable-over {
            background-color: #e8f5e8;
            border-color: #4caf50;
            border-width: 3px;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        .day-column-v3.sortable-over,
        .day-column-v3-over {
            background-color: rgba(33, 150, 243, 0.1);
            box-shadow: inset 0 0 15px rgba(33, 150, 243, 0.3);
            border: 2px dashed #2196f3;
        }
        .scheduled-event {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin: 0.25rem 0;
            cursor: pointer;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .scheduled-event:hover {
            background-color: #fff2a8;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .activity-pool {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 1rem;
            background-color: #f8f9fa;
        }

        /* å±‚çº§æ± æ ·å¼ v2.1 */
        .hierarchical-pool {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 0.75rem;
            background-color: #f8f9fa;
        }

        .tree-node {
            margin-bottom: 0.25rem;
        }

        .tree-node-content {
            display: flex;
            align-items: center;
            padding: 0.375rem 0.5rem;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 0.375rem;
            cursor: grab;
            transition: all 0.2s;
            user-select: none; /* é˜²æ­¢æ–‡æœ¬é€‰æ‹©å¹²æ‰°æ‹–æ‹½ */
        }

        .tree-node-content:hover {
            background-color: #e3f2fd;
            border-color: #90caf9;
            transform: translateY(-1px);
        }

        .tree-node-content:active {
            cursor: grabbing;
        }

        .tree-node-content * {
            pointer-events: none; /* å­å…ƒç´ ä¸æ‹¦æˆªæ‹–æ‹½äº‹ä»¶ */
        }

        /* v2.1 é€‰æ‹©æ¨¡å¼æ ·å¼ */
        .tree-node-content.selectable {
            cursor: pointer;
        }

        .tree-node-content.selectable:hover {
            background-color: #fff3cd;
            border-color: #ffc107;
        }

        .tree-node-content.selected {
            background-color: #d4edda !important;
            border-color: #28a745 !important;
            border-width: 2px;
        }

        .tree-node-content.tree-node-selected {
            background-color: #e3f2fd !important;
            border: 2px solid #2196f3 !important;
            font-weight: bold;
        }

        .tree-node-content.tree-node-selected:hover {
            background-color: #bbdefb !important;
        }

        .tree-node-content.selectable * {
            pointer-events: none; /* ä¿æŒå­å…ƒç´ ä¸æ‹¦æˆªç‚¹å‡»äº‹ä»¶ */
        }

        .tree-toggle {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.5rem;
            border: none;
            background: none;
            font-size: 12px;
            font-weight: bold;
            color: #6c757d;
            cursor: pointer;
            transition: transform 0.2s;
            pointer-events: auto; /* æ¢å¤æŠ˜å æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ */
        }

        .tree-toggle.expanded {
            transform: rotate(90deg);
        }

        .tree-toggle:hover {
            color: #495057;
        }

        .tree-node-label {
            flex: 1;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .tree-node-description {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 0.125rem;
        }

        .tree-children {
            margin-left: 1.5rem;
            padding-left: 0.5rem;
            border-left: 2px solid #e9ecef;
        }

        .tree-children.collapsed {
            display: none;
        }

        /* Scheduleæ—¶é—´æ¡æ ·å¼ */
        .schedule-timeline-container {
            display: grid;
            grid-template-columns: auto repeat(7, 1fr);
            gap: 8px;
            background-color: #f8f9fa;
            border-radius: 0.5rem 0.5rem 0 0;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-bottom: 1px solid #dee2e6;
            min-height: 120px;
            position: relative;
        }

        /* æœˆè§†å›¾Scheduleæ—¶é—´æ¡æ ·å¼ */
        .schedule-bars-container {
            position: absolute;
            top: 25px;
            left: 4px;
            right: 4px;
            z-index: 10;
        }

        .month-schedule-bar {
            height: 16px;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: 500;
            color: white;
            margin-bottom: 1px;
            width: 100%;
            transition: all 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .month-schedule-bar:hover {
            transform: scale(1.05);
            opacity: 1 !important;
            z-index: 20;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .schedule-timeline-label {
            background-color: #6c757d;
            color: white;
            padding: 8px;
            border-radius: 0.25rem;
            text-align: center;
            font-weight: bold;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .schedule-timeline-day {
            position: relative;
            min-height: 96px;
            border-radius: 0.25rem;
            background-color: white;
            border: 1px solid #e9ecef;
            padding: 4px;
        }

        .schedule-bar {
            position: relative;
            height: 20px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 500;
            color: white;
            margin-bottom: 2px;
            width: 100%;
            transition: all 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 0 6px;
            margin-bottom: 2px;
            width: 100%;
        }

        .schedule-bar:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* é¢„å®šä¹‰çš„é¢œè‰²ç³»ç»Ÿ */
        .schedule-color-0 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .schedule-color-1 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .schedule-color-2 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .schedule-color-3 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .schedule-color-4 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .schedule-color-5 { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .schedule-color-6 { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
        .schedule-color-7 { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); }
        .week-grid {
            display: grid;
            grid-template-columns: auto repeat(7, 1fr);
            gap: 8px;
            background-color: transparent;
            border-radius: 0.5rem;
            padding: 12px;
            border: 2px solid #dee2e6;
        }
        .week-header {
            background-color: #6c757d;
            color: white;
            text-align: center;
            padding: 0.5rem;
            font-weight: bold;
            border-radius: 0.375rem;
            border: 2px solid #6c757d;
        }
        .time-label {
            background-color: #495057;
            color: white;
            text-align: center;
            padding: 1rem 0.5rem;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 120px;
            border-radius: 0.375rem;
            border: 2px solid #495057;
        }

        /* ========== V3.0 åŠ¨æ€ç”»å¸ƒUIç³»ç»Ÿ ========== */

        /* V3 å¾®ç½‘æ ¼å®¹å™¨ */
        .week-canvas-v3 {
            position: relative;
            background-color: #fafafa;
            border: 2px solid #dee2e6;
            border-radius: 0.5rem;
            margin: 1rem 0;
            overflow: auto;
            min-height: 400px;
            max-height: 70vh;
        }

        /* ç”»å¸ƒç½‘æ ¼å®¹å™¨ */
        .canvas-grid-container {
            display: flex;
            position: relative;
            width: 100%;
            height: 100%;
        }

        /* æ—¶é—´è½´æ ·å¼ */
        .time-axis-v3 {
            width: 80px;
            background-color: #f8f9fa;
            border-right: 2px solid #495057;
            position: relative;
            flex-shrink: 0;
            z-index: 5;
            transform: translateY(3px); /* ç®€å•å‘ä¸‹åç§»3px */
        }

        /* æ—¥æœŸæ ‡é¢˜è¡Œ */
        .day-headers-row {
            position: absolute;
            top: 0;
            left: 80px; /* ä¿æŒä¸æ—¶é—´è½´å®½åº¦ä¸€è‡´çš„åç§» */
            right: 0;
            height: 50px;
            display: flex;
            background-color: #6c757d;
            z-index: 10;
        }

        /* å¤©åˆ—å®¹å™¨ */
        .days-container {
            flex: 1;
            display: flex;
            position: relative;
            margin-left: 0px; /* ç§»é™¤å·¦è¾¹è·ï¼Œé¿å…ä¸æ—¶é—´è½´å®½åº¦é‡å¤åç§» */
            margin-top: 50px;
            height: calc(100% - 50px); /* å‡å»æ ‡é¢˜é«˜åº¦ */
            min-height: calc(100vh - 200px); /* ç¡®ä¿è¶³å¤Ÿé«˜åº¦ */
        }

        /* ç½‘æ ¼çº¿å±‚ */
        .grid-lines-layer {
            position: absolute;
            top: 50px;
            left: 80px;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 1;
        }

        /* å°æ—¶æ ‡è®° */
        .hour-marker {
            position: absolute;
            left: 0;
            right: 0;
            height: 60px; /* 6ä¸ª10åˆ†é’Ÿæ ¼çš„é«˜åº¦ */
            border-bottom: 2px solid #495057;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            color: #495057;
            background-color: rgba(248, 249, 250, 0.9);
        }

        /* æ ‡é¢˜ç©ºç™½æ ¼å­ */
        .hour-marker.header-spacer {
            background-color: #f8f9fa;
            border-bottom: none;
            border-right: 2px solid #495057;
        }

        /* 10åˆ†é’Ÿç½‘æ ¼çº¿ - ç»†çº¿ */
        .grid-line-10min {
            position: absolute;
            left: 0;
            right: 0;
            width: 100%;
            height: 1px;
            background-color: #e9ecef;
            pointer-events: none;
        }

        /* å°æ—¶ç½‘æ ¼çº¿ - ç²—çº¿ */
        .grid-line-hour {
            position: absolute;
            left: 0;
            right: 0;
            width: 100%;
            height: 2px;
            background-color: #495057;
            pointer-events: none;
        }

        /* æ—¥æœŸåˆ— */
        .day-column-v3 {
            flex: 1;
            position: relative;
            border-right: 1px solid #dee2e6;
            background-color: transparent;
            min-height: calc(100vh - 150px); /* ç¡®ä¿è¶³å¤Ÿé«˜åº¦ */
            height: 100%; /* å¼ºåˆ¶å¡«æ»¡å®¹å™¨é«˜åº¦ */
        }

        .day-column-v3:last-child {
            border-right: none;
        }

        /* æ—¥æœŸæ ‡é¢˜ */
        .day-header-v3 {
            flex: 1;
            background-color: #6c757d;
            color: white;
            text-align: center;
            padding: 0.5rem;
            font-weight: bold;
            font-size: 0.875rem;
            border-right: 1px solid #495057;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: pre-line;
        }

        .day-header-v3:last-child {
            border-right: none;
        }

        /* V3 åŠ¨æ€å¡ç‰‡æ ·å¼ */
        .task-card-v3 {
            position: absolute;
            left: 4px;
            right: 4px;
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #ffc107;
            border-radius: 6px;
            padding: 8px;
            cursor: grab;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 0.75rem;
            z-index: 5;
            overflow: hidden;
            min-height: 20px; /* æœ€å°2ä¸ªç½‘æ ¼å•ä½ */
        }

        .task-card-v3:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            z-index: 6;
        }

        .task-card-v3:active {
            cursor: grabbing;
        }

        /* ç²¾ç¡®ä»»åŠ¡ç‰¹æ®Šæ ·å¼ */
        .task-card-v3.precise {
            background: linear-gradient(135deg, #d4edda 0%, #a8e6cf 100%);
            border-color: #28a745;
        }

        .task-card-v3.precise::before {
            content: "â°";
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 0.6rem;
        }

        /* å¹¶è¡Œä»»åŠ¡æ ·å¼ */
        .task-card-v3.parallel {
            left: 50%; /* å³åŠéƒ¨åˆ† */
            right: 4px;
        }

        .task-card-v3.parallel-left {
            right: 50%; /* å·¦åŠéƒ¨åˆ† */
        }

        /* å¾…å®šåŒºåŸŸ */
        .pending-area-v3 {
            grid-column: 1 / -1;
            background-color: #f1f3f4;
            border-bottom: 2px solid #dee2e6;
            padding: 1rem;
            min-height: 80px;
            position: relative;
        }

        .pending-card-v3 {
            display: inline-block;
            background-color: #e9ecef;
            border: 1px solid #adb5bd;
            border-radius: 4px;
            padding: 6px 12px;
            margin: 4px;
            cursor: grab;
            font-size: 0.75rem;
            max-width: 150px;
            height: 32px;
            line-height: 20px;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }

        /* æ‹–æ‹½å¸é™„æŒ‡ç¤ºå™¨ */
        .snap-indicator {
            position: absolute;
            left: 80px;
            right: 0;
            height: 2px;
            background-color: #007bff;
            z-index: 15;
            opacity: 0;
            transition: opacity 0.1s ease;
        }

        .snap-indicator.active {
            opacity: 1;
        }

        /* V3æ™ºèƒ½å¸é™„å¢å¼º */
        .v3-snap-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #007bff, #00d4aa);
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.15s ease;
            box-shadow: 0 0 6px rgba(0, 123, 255, 0.6);
        }

        .v3-snap-line.active {
            opacity: 0.9;
        }

        .v3-snap-tooltip {
            position: absolute;
            left: 50%;
            top: -25px;
            transform: translateX(-50%);
            background: rgba(0, 123, 255, 0.9);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.15s ease;
        }

        .v3-snap-tooltip.active {
            opacity: 1;
        }

        /* ç½‘æ ¼åˆ‡æ¢æŒ‰é’® */
        .grid-toggle-v3 {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 20;
            background-color: rgba(255,255,255,0.9);
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .week-canvas-v3::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .week-canvas-v3::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .week-canvas-v3::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .week-canvas-v3::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* å“åº”å¼é€‚é… */
        @media (max-width: 768px) {
            .week-canvas-v3 {
                grid-template-columns: 60px repeat(7, 1fr);
                font-size: 0.7rem;
            }

            .time-axis-v3 {
                grid-template-columns: 60px;
            }

            .task-card-v3 {
                font-size: 0.7rem;
                padding: 6px;
            }
        }
    </style>
</head>
<body>
    <div x-data="laeApp()" class="container-fluid">
        <!-- å¯¼èˆªæ  -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-3">
            <div class="container-fluid">
                <span class="navbar-brand">LAE - æ—¥ç¨‹ç®¡ç†ç³»ç»Ÿ</span>
                
                <!-- è§†å›¾åˆ‡æ¢æŒ‰é’® -->
                <div class="navbar-nav me-auto">
                    <button 
                        class="nav-link btn btn-link"
                        :class="{ 'active text-warning': currentView === 'summary' }"
                        @click="switchView('summary')"
                    >
                        æ±‡æ€»è§†å›¾
                    </button>
                    <button 
                        class="nav-link btn btn-link"
                        :class="{ 'active text-warning': currentView === 'week' }"
                        @click="switchView('week')"
                    >
                        å‘¨è§†å›¾
                    </button>
                    <button 
                        class="nav-link btn btn-link"
                        :class="{ 'active text-warning': currentView === 'month' }"
                        @click="switchView('month')"
                    >
                        æœˆè§†å›¾
                    </button>
                </div>
                
                <!-- å½“å‰æ—¥æœŸæ˜¾ç¤º -->
                <div class="navbar-text text-light">
                    <span x-text="getCurrentDateString()"></span>
                </div>
            </div>
        </nav>

        <!-- æ±‡æ€»è§†å›¾ -->
        <div x-show="currentView === 'summary'" class="row">
            <!-- ç»Ÿè®¡ä»ªè¡¨æ¿ -->
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">æ•°æ®ç»Ÿè®¡</h5>
                        <div class="d-flex align-items-center">
                            <select class="form-select form-select-sm me-2" x-model="summaryMonth" @change="loadSummaryStatistics()">
                                <option value="">å…¨éƒ¨æ—¶é—´</option>
                                <template x-for="month in availableMonths" :key="month.value">
                                    <option :value="month.value" x-text="month.label"></option>
                                </template>
                            </select>
                            <button class="btn btn-outline-primary btn-sm" @click="loadSummaryStatistics()">
                                ğŸ“Š åˆ·æ–°ç»Ÿè®¡
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row" x-show="summaryStats">
                            <div class="col-md-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <h4 x-text="summaryStats?.total_events || 0"></h4>
                                        <p class="mb-0">æ€»å®‰æ’æ¬¡æ•°</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h4 x-text="summaryStats?.completed_events || 0"></h4>
                                        <p class="mb-0">å·²å®Œæˆæ¬¡æ•°</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning text-white">
                                    <div class="card-body text-center">
                                        <h4 x-text="Math.round((summaryStats?.completion_rate || 0) * 100) + '%'"></h4>
                                        <p class="mb-0">å®Œæˆç‡</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h4 x-text="summaryStats?.total_activities || 0"></h4>
                                        <p class="mb-0">æ´»åŠ¨æ€»æ•°</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- v2.0 åŒè½´çŸ©é˜µç®¡ç† -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">ğŸ¯ é¢†åŸŸç®¡ç† (Domains)</h5>
                        <button class="btn btn-primary btn-sm" @click="showNewDomainModal = true">
                            + æ–°å»ºé¢†åŸŸ
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="domain-tree" class="mt-3">
                            <!-- é¢†åŸŸæ ‘å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
                            <div x-html="renderDomainTree()"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">âš¡ æ´»åŠ¨ç±»å‹ç®¡ç† (Activity Types)</h5>
                        <button class="btn btn-success btn-sm" @click="showNewActivityTypeModal = true">
                            + æ–°å»ºç±»å‹
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="activity-type-tree" class="mt-3">
                            <!-- æ´»åŠ¨ç±»å‹æ ‘å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
                            <div x-html="renderActivityTypeTree()"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å‘¨è§†å›¾ -->
        <div x-show="currentView === 'week'" class="row">
            <!-- v2.1 æ™ºèƒ½ä¾§è¾¹æ  (é€‰æ‹©æ¨¡å¼) -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">ğŸ¯ æ™ºèƒ½ä¾§è¾¹æ </h6>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button"
                                        class="btn"
                                        :class="sidebarMode === 'domain' ? 'btn-primary' : 'btn-outline-primary'"
                                        @click="setSidebarMode('domain')">
                                    é¢†åŸŸ
                                </button>
                                <button type="button"
                                        class="btn"
                                        :class="sidebarMode === 'type' ? 'btn-primary' : 'btn-outline-primary'"
                                        @click="setSidebarMode('type')">
                                    ç±»å‹
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- å½“å‰é€‰ä¸­çŠ¶æ€æ˜¾ç¤º -->
                        <div class="alert alert-success small mb-3" x-show="selectedNode.id">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>å·²é€‰ä¸­:</strong> <span x-text="selectedNode.name"></span>
                                    <div class="small text-muted" x-text="selectedNode.type === 'domain' ? 'ğŸ¯ é¢†åŸŸ' : 'âš¡ ç±»å‹'"></div>
                                </div>
                                <button class="btn btn-sm btn-outline-secondary" @click="clearSelectedNode()">æ¸…é™¤</button>
                            </div>
                        </div>

                        <!-- ä½¿ç”¨è¯´æ˜ -->
                        <div class="alert alert-info small mb-3" x-show="!selectedNode.id">
                            ğŸ’¡ <strong>ä½¿ç”¨æ–¹å¼</strong>ï¼š<br>
                            1. ç‚¹å‡»ä¸‹æ–¹èŠ‚ç‚¹é€‰ä¸­<br>
                            2. ç„¶åç‚¹å‡»å³ä¾§ç©ºç™½æ—¶é—´æ§½åˆ›å»ºäº‹ä»¶
                        </div>

                        <!-- Domain è§†å›¾ -->
                        <div x-show="sidebarMode === 'domain'" class="selection-panel" x-html="renderSelectionDomainTree()">
                        </div>

                        <!-- ActivityType è§†å›¾ -->
                        <div x-show="sidebarMode === 'type'" class="selection-panel" x-html="renderSelectionTypeTree()">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å‘¨æ—¥ç¨‹ç½‘æ ¼ -->
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <button class="btn btn-outline-primary btn-sm" @click="previousWeek()">
                                â€¹ ä¸Šä¸€å‘¨
                            </button>
                            <span class="mx-3 fw-bold" x-text="getWeekTitle()"></span>
                            <button class="btn btn-outline-primary btn-sm" @click="nextWeek()">
                                ä¸‹ä¸€å‘¨ â€º
                            </button>
                        </div>

                        <!-- V3æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
                        <div class="d-flex align-items-center">
                            <label class="form-check-label me-2">ç”»å¸ƒæ¨¡å¼:</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox"
                                       x-model="isV3Mode" @change="switchGridMode()">
                                <label class="form-check-label" x-text="isV3Mode ? 'V3åŠ¨æ€ç”»å¸ƒ' : 'V2ç»å…¸ç½‘æ ¼'"></label>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <!-- V2ç»å…¸æ¨¡å¼ -->
                        <template x-if="!isV3Mode">
                            <div>
                                <!-- Scheduleæ—¶é—´æ¡åŒºåŸŸ -->
                                <div class="schedule-timeline-container" id="schedule-timeline" x-html="renderScheduleTimeline()">
                                </div>
                                <!-- V2å‘¨è§†å›¾ç½‘æ ¼ -->
                                <div class="week-grid" id="week-grid" x-html="renderFullWeekGrid()">
                                </div>
                            </div>
                        </template>

                        <!-- V3åŠ¨æ€ç”»å¸ƒæ¨¡å¼ -->
                        <template x-if="isV3Mode">
                            <div>
                                <!-- V3ç”»å¸ƒå®¹å™¨ -->
                                <div class="position-relative">
                                    <!-- æ§åˆ¶é¢æ¿ -->
                                    <div class="grid-toggle-v3">
                                        <button class="btn btn-sm btn-outline-secondary me-2" @click="isV3Mode = false">
                                            â† è¿”å›V2
                                        </button>
                                        <div class="d-flex align-items-center">
                                            <label class="form-label me-2 mb-0">ç¼©æ”¾:</label>
                                            <button class="btn btn-sm btn-outline-primary me-1" @click="adjustZoom(-0.25)" :disabled="v3ZoomLevel <= 0.5">-</button>
                                            <span class="mx-2" x-text="Math.round(v3ZoomLevel * 100) + '%'"></span>
                                            <button class="btn btn-sm btn-outline-primary" @click="adjustZoom(0.25)" :disabled="v3ZoomLevel >= 2.0">+</button>
                                        </div>
                                    </div>

                                    <!-- å¾…å®šåŒºåŸŸ -->
                                    <div class="pending-area-v3">
                                        <h6 class="mb-2">ğŸ“‹ å¾…å®šä»»åŠ¡</h6>
                                        <div id="pending-cards-v3" x-html="renderPendingCards()">
                                        </div>
                                    </div>

                                    <!-- V3å¾®ç½‘æ ¼ç”»å¸ƒ -->
                                    <div class="week-canvas-v3" id="week-canvas-v3"
                                         :style="`height: ${getCanvasHeight()}px;`">

                                        <!-- ç½‘æ ¼å®¹å™¨ -->
                                        <div class="canvas-grid-container">
                                            <!-- æ—¶é—´è½´ -->
                                            <div class="time-axis-v3" x-html="renderTimeAxis()">
                                            </div>

                                            <!-- æ—¥æœŸæ ‡é¢˜è¡Œ -->
                                            <div class="day-headers-row">
                                                <template x-for="(day, index) in weekDates" :key="day">
                                                    <div class="day-header-v3" x-text="getDayHeaderV3(day)">
                                                    </div>
                                                </template>
                                            </div>

                                            <!-- 7å¤©åˆ—å®¹å™¨ -->
                                            <div class="days-container">
                                                <template x-for="(day, index) in weekDates" :key="day">
                                                    <div class="day-column-v3" @click="handleV3GridClick($event, day)">
                                                        <!-- å½“å¤©çš„ä»»åŠ¡å¡ç‰‡ -->
                                                        <div x-html="renderDayCardsV3(day)">
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>

                                            <!-- ç½‘æ ¼çº¿å±‚ -->
                                            <div class="grid-lines-layer" x-html="renderGridLines()">
                                            </div>

                                            <!-- å¸é™„æŒ‡ç¤ºå™¨ -->
                                            <div class="snap-indicator" id="snap-indicator" :style="`top: ${snapIndicatorY}px`">
                                            </div>

                                            <!-- V3ä¸“ç”¨å¸é™„æŒ‡ç¤ºå™¨ -->
                                            <div class="v3-snap-line" id="v3-snap-line" x-show="v3SnapIndicator.visible"
                                                 :style="`top: ${v3SnapIndicator.y}px`">
                                                <div class="v3-snap-tooltip" x-text="v3SnapIndicator.tooltip"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- æœˆè§†å›¾ -->
        <div x-show="currentView === 'month'">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <button class="btn btn-outline-primary btn-sm" @click="previousMonth()">
                            â€¹ ä¸Šä¸ªæœˆ
                        </button>
                        <span class="mx-3 fw-bold" x-text="getMonthTitle()"></span>
                        <button class="btn btn-outline-primary btn-sm" @click="nextMonth()">
                            ä¸‹ä¸ªæœˆ â€º
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row text-center fw-bold mb-2">
                        <div class="col">å‘¨ä¸€</div>
                        <div class="col">å‘¨äºŒ</div>
                        <div class="col">å‘¨ä¸‰</div>
                        <div class="col">å‘¨å››</div>
                        <div class="col">å‘¨äº”</div>
                        <div class="col">å‘¨å…­</div>
                        <div class="col">å‘¨æ—¥</div>
                    </div>
                    <div id="month-calendar">
                        <!-- æœˆå†å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- v2.1 æ–°å»ºäº‹ä»¶æ¨¡æ€æ¡† (åŒè½´çŸ©é˜µ) -->
        <div x-show="showNewEventModal" class="modal" :class="{ 'd-block': showNewEventModal }" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">âœ¨ æ–°å»ºäº‹ä»¶ (åŒè½´çŸ©é˜µ)</h5>
                        <button type="button" class="btn-close" @click="showNewEventModal = false"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="createNewEvent()">
                            <!-- åŸºæœ¬ä¿¡æ¯ -->
                            <div class="row mb-3">
                                <div class="col-8">
                                    <label class="form-label">ğŸ“… æ—¥æœŸ</label>
                                    <input type="date" class="form-control" x-model="newEvent.event_date" required readonly>
                                </div>
                                <div class="col-4">
                                    <label class="form-label">â° æ—¶é—´æ§½ (è‡ªåŠ¨è®¡ç®—)</label>
                                    <input type="text" class="form-control"
                                           x-bind:value="getTimeSlotDisplay(newEvent.start_time)"
                                           readonly style="background-color: #f8f9fa;"
                                           x-text="console.log('Time slot display value:', getTimeSlotDisplay(newEvent.start_time))">
                                    <input type="hidden" x-model="newEvent.time_slot">
                                </div>
                            </div>

                            <!-- V3.0 æ—¶é•¿å’Œç²¾ç¡®æ—¶é—´è®¾ç½® -->
                            <div x-show="isV3Mode" class="card mb-3" style="border-left: 4px solid #007bff;">
                                <div class="card-body py-2">
                                    <h6 class="card-title mb-2">ğŸ¯ V3 åŠ¨æ€ç”»å¸ƒè®¾ç½®</h6>

                                    <div class="row mb-2">
                                        <div class="col-4">
                                            <label class="form-label">ğŸ• èµ·å§‹æ—¶é—´</label>
                                            <input type="time" class="form-control" x-model="newEvent.start_time"
                                                   @input="updateTimeSlot()">
                                        </div>
                                        <div class="col-4">
                                            <label class="form-label">â±ï¸ é¢„è®¡æ—¶é•¿ (åˆ†é’Ÿ)</label>
                                            <input type="number" class="form-control" x-model="newEvent.duration"
                                                   min="10" max="480" step="10" value="60"
                                                   placeholder="60">
                                        </div>
                                        <div class="col-4">
                                            <div class="form-check mt-4">
                                                <input class="form-check-input" type="checkbox"
                                                       x-model="newEvent.is_precise" id="preciseTimeCheck">
                                                <label class="form-check-label" for="preciseTimeCheck">
                                                    ğŸ¯ ç²¾ç¡®æ—¶é—´
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ç»“æŸæ—¶é—´æ˜¾ç¤º -->
                                    <div class="row">
                                        <div class="col-12">
                                            <label class="form-label">ğŸ ç»“æŸæ—¶é—´ (è®¡ç®—å¾—å‡º)</label>
                                            <input type="text" class="form-control"
                                                   x-bind:value="calculateEndTime(newEvent.start_time, newEvent.duration)"
                                                   readonly style="background-color: #f8f9fa;">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- äº‹ä»¶åç§° -->
                            <div class="mb-3">
                                <label class="form-label">ğŸ“ äº‹ä»¶åç§° <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" x-model="newEvent.name"
                                       placeholder="æè¿°ä½ è¦åšçš„å…·ä½“äº‹æƒ…" required>
                            </div>

                            <!-- åŒè½´çŸ©é˜µé€‰æ‹© -->
                            <div class="row mb-3">
                                <div class="col-6">
                                    <label class="form-label">ğŸ¯ é¢†åŸŸ (ä¸ºäº†ä»€ä¹ˆ)</label>
                                    <select class="form-control" x-model="newEvent.domain_id">
                                        <option value="">æœªæŒ‡å®šé¢†åŸŸ</option>
                                        <template x-for="domain in flatDomains" :key="domain.id">
                                            <option :value="domain.id" x-text="domain.name"></option>
                                        </template>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">âš¡ ç±»å‹ (åšä»€ä¹ˆæ€§è´¨)</label>
                                    <select class="form-control" x-model="newEvent.activity_type_id">
                                        <option value="">æœªæŒ‡å®šç±»å‹</option>
                                        <template x-for="type in flatActivityTypes" :key="type.id">
                                            <option :value="type.id" x-text="type.name"></option>
                                        </template>
                                    </select>
                                </div>
                            </div>

                            <!-- å…³è”æ—¥ç¨‹ -->
                            <div class="mb-3" x-show="newEvent.domain_id">
                                <label class="form-label">ğŸ“‹ å…³è”æ—¥ç¨‹ (å¯é€‰)</label>
                                <select class="form-control" x-model="newEvent.schedule_id">
                                    <option value="">æ— å…³è”æ—¥ç¨‹</option>
                                    <template x-for="schedule in getSchedulesForDomain(newEvent.domain_id)" :key="schedule.id">
                                        <option :value="schedule.id" x-text="schedule.name"></option>
                                    </template>
                                </select>
                            </div>

                            <!-- å¤‡æ³¨ -->
                            <div class="mb-3">
                                <label class="form-label">ğŸ“‹ å¤‡æ³¨</label>
                                <textarea class="form-control" rows="2" x-model="newEvent.notes"
                                          placeholder="ä»»ä½•é¢å¤–ä¿¡æ¯..."></textarea>
                            </div>

                            <div class="text-end">
                                <button type="button" class="btn btn-secondary me-2" @click="showNewEventModal = false">å–æ¶ˆ</button>
                                <button type="submit" class="btn btn-primary">âœ¨ åˆ›å»ºäº‹ä»¶</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ–°å»ºæ´»åŠ¨æ¨¡æ€æ¡† -->
        <div x-show="showNewActivityModal" class="modal" :class="{ 'd-block': showNewActivityModal }" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">æ–°å»ºæ´»åŠ¨</h5>
                        <button type="button" class="btn-close" @click="showNewActivityModal = false"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="createActivity()">
                            <div class="mb-3">
                                <label class="form-label">æ´»åŠ¨åç§°</label>
                                <input type="text" class="form-control" x-model="newActivity.name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">çˆ¶æ´»åŠ¨</label>
                                <select class="form-control" x-model="newActivity.parent_id">
                                    <option value="">æ— ï¼ˆé¡¶çº§æ´»åŠ¨ï¼‰</option>
                                    <template x-for="activity in flatActivities" :key="activity.id">
                                        <option :value="activity.id" x-text="activity.name"></option>
                                    </template>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">æè¿°</label>
                                <textarea class="form-control" rows="3" x-model="newActivity.description"></textarea>
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-secondary me-2" @click="showNewActivityModal = false">å–æ¶ˆ</button>
                                <button type="submit" class="btn btn-primary">åˆ›å»º</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¼–è¾‘æ´»åŠ¨æ¨¡æ€æ¡† -->
        <div x-show="showEditActivityModal" class="modal" :class="{ 'd-block': showEditActivityModal }" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ç¼–è¾‘æ´»åŠ¨</h5>
                        <button type="button" class="btn-close" @click="showEditActivityModal = false"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="updateActivity()">
                            <div class="mb-3">
                                <label class="form-label">æ´»åŠ¨åç§°</label>
                                <input type="text" class="form-control" x-model="editingActivity.name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">æè¿°</label>
                                <textarea class="form-control" rows="3" x-model="editingActivity.description"></textarea>
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-secondary me-2" @click="showEditActivityModal = false">å–æ¶ˆ</button>
                                <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- v2.1 ç¼–è¾‘äº‹ä»¶æ¨¡æ€æ¡† (åŒè½´çŸ©é˜µ) - åªåœ¨å‘¨è§†å›¾ä¸­æ˜¾ç¤º -->
        <div x-show="showEditEventModal && currentView === 'week'" class="modal" :class="{ 'd-block': showEditEventModal && currentView === 'week' }" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ğŸ“ ç¼–è¾‘äº‹ä»¶ (åŒè½´çŸ©é˜µ)</h5>
                        <button type="button" class="btn-close" @click="forceCloseModal()"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="saveEditedEvent()">
                            <!-- åŸºæœ¬ä¿¡æ¯ -->
                            <div class="row mb-3">
                                <div class="col-8">
                                    <label class="form-label">ğŸ“… æ—¥æœŸ</label>
                                    <input type="date" class="form-control" x-model="editingEvent.event_date" required readonly>
                                </div>
                                <div class="col-4">
                                    <label class="form-label">â° æ—¶é—´æ§½ (è‡ªåŠ¨è®¡ç®—)</label>
                                    <input type="text" class="form-control"
                                           x-bind:value="getTimeSlotDisplay(editingEvent.start_time)"
                                           readonly style="background-color: #f8f9fa;">
                                    <input type="hidden" x-model="editingEvent.time_slot">
                                </div>
                            </div>

                            <!-- äº‹ä»¶åç§° -->
                            <div class="mb-3">
                                <label class="form-label">ğŸ“ äº‹ä»¶åç§° <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" x-model="editingEvent.name"
                                       placeholder="æè¿°ä½ è¦åšçš„å…·ä½“äº‹æƒ…" required>
                            </div>

                            <!-- V3.0 æ—¶é•¿å’Œç²¾ç¡®æ—¶é—´è®¾ç½® (ç¼–è¾‘æ¨¡å¼) -->
                            <div x-show="isV3Mode" class="card mb-3" style="border-left: 4px solid #28a745;">
                                <div class="card-body py-2">
                                    <h6 class="card-title mb-2">ğŸ”§ V3 åŠ¨æ€ç”»å¸ƒè®¾ç½®</h6>

                                    <div class="row mb-2">
                                        <div class="col-4">
                                            <label class="form-label">ğŸ• èµ·å§‹æ—¶é—´</label>
                                            <input type="time" class="form-control" x-model="editingEvent.start_time"
                                                   @input="updateEditingTimeSlot()">
                                        </div>
                                        <div class="col-4">
                                            <label class="form-label">â±ï¸ é¢„è®¡æ—¶é•¿ (åˆ†é’Ÿ)</label>
                                            <input type="number" class="form-control" x-model="editingEvent.duration"
                                                   min="10" max="480" step="10">
                                        </div>
                                        <div class="col-4">
                                            <div class="form-check mt-4">
                                                <input class="form-check-input" type="checkbox"
                                                       x-model="editingEvent.is_precise" id="editPreciseTimeCheck">
                                                <label class="form-check-label" for="editPreciseTimeCheck">
                                                    ğŸ¯ ç²¾ç¡®æ—¶é—´
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ç»“æŸæ—¶é—´æ˜¾ç¤º -->
                                    <div class="row">
                                        <div class="col-12">
                                            <label class="form-label">ğŸ ç»“æŸæ—¶é—´ (è®¡ç®—å¾—å‡º)</label>
                                            <input type="text" class="form-control"
                                                   x-bind:value="calculateEndTime(editingEvent.start_time, editingEvent.duration)"
                                                   readonly style="background-color: #f8f9fa;">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- åŒè½´çŸ©é˜µé€‰æ‹© -->
                            <div class="row mb-3">
                                <div class="col-6">
                                    <label class="form-label">ğŸ¯ é¢†åŸŸ (ä¸ºäº†ä»€ä¹ˆ)</label>
                                    <select class="form-control" x-model="editingEvent.domain_id">
                                        <option value="">æœªæŒ‡å®šé¢†åŸŸ</option>
                                        <template x-for="domain in flatDomains" :key="domain.id">
                                            <option :value="domain.id" x-text="domain.name"></option>
                                        </template>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">âš¡ ç±»å‹ (åšä»€ä¹ˆæ€§è´¨)</label>
                                    <select class="form-control" x-model="editingEvent.activity_type_id">
                                        <option value="">æœªæŒ‡å®šç±»å‹</option>
                                        <template x-for="type in flatActivityTypes" :key="type.id">
                                            <option :value="type.id" x-text="type.name"></option>
                                        </template>
                                    </select>
                                </div>
                            </div>

                            <!-- å…³è”æ—¥ç¨‹ -->
                            <div class="mb-3" x-show="editingEvent.domain_id">
                                <label class="form-label">ğŸ“‹ å…³è”æ—¥ç¨‹ (å¯é€‰)</label>
                                <select class="form-control" x-model="editingEvent.schedule_id">
                                    <option value="">æ— å…³è”æ—¥ç¨‹</option>
                                    <template x-for="schedule in getSchedulesForDomain(editingEvent.domain_id)" :key="schedule.id">
                                        <option :value="schedule.id" x-text="schedule.name"></option>
                                    </template>
                                </select>
                            </div>

                            <!-- v1å…¼å®¹ï¼šç›®æ ‡å­—æ®µ -->
                            <div class="mb-3" x-show="editingEvent.goal || editingEvent.activity_name">
                                <label class="form-label">ğŸ¯ ç›®æ ‡ (v1å…¼å®¹)</label>
                                <input type="text" class="form-control" x-model="editingEvent.goal"
                                       placeholder="æœ¬æ¬¡è¦è¾¾æˆçš„å…·ä½“ç›®æ ‡">
                                <div class="form-text text-muted" x-show="editingEvent.activity_name">
                                    åŸæ´»åŠ¨ï¼š<span x-text="editingEvent.activity_name"></span>
                                </div>
                            </div>

                            <!-- å¤‡æ³¨ -->
                            <div class="mb-3">
                                <label class="form-label">ğŸ“‹ å¤‡æ³¨</label>
                                <textarea class="form-control" rows="2" x-model="editingEvent.notes"
                                          placeholder="ä»»ä½•é¢å¤–ä¿¡æ¯..."></textarea>
                            </div>

                            <!-- çŠ¶æ€ -->
                            <div class="mb-3">
                                <label class="form-label">ğŸ“Š çŠ¶æ€</label>
                                <select class="form-control" x-model="editingEvent.status">
                                    <option value="planned">ğŸ“‹ è®¡åˆ’ä¸­</option>
                                    <option value="completed">âœ… å·²å®Œæˆ</option>
                                </select>
                            </div>

                            <div class="text-end">
                                <button type="button" class="btn btn-danger me-2" @click="deleteEditedEvent()" x-show="editingEvent.id">ğŸ—‘ï¸ åˆ é™¤</button>
                                <button type="button" class="btn btn-secondary me-2" @click="forceCloseModal()">å–æ¶ˆ</button>
                                <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜ä¿®æ”¹</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- v2.0 æ–°å»ºDomainæ¨¡æ€æ¡† -->
        <div x-show="showNewDomainModal" class="modal" :class="{ 'd-block': showNewDomainModal }" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ğŸ¯ æ–°å»ºé¢†åŸŸ</h5>
                        <button type="button" class="btn-close" @click="showNewDomainModal = false"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="createDomain()">
                            <div class="mb-3">
                                <label class="form-label">é¢†åŸŸåç§°</label>
                                <input type="text" class="form-control" x-model="newDomain.name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">çˆ¶é¢†åŸŸï¼ˆå¯é€‰ï¼‰</label>
                                <select class="form-control" x-model="newDomain.parent_id">
                                    <option value="">æ ¹çº§é¢†åŸŸ</option>
                                    <template x-for="domain in flatDomains" :key="domain.id">
                                        <option :value="domain.id" x-text="domain.name"></option>
                                    </template>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">é¢†åŸŸæè¿°</label>
                                <textarea class="form-control" x-model="newDomain.description" rows="3"></textarea>
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-secondary me-2" @click="showNewDomainModal = false">å–æ¶ˆ</button>
                                <button type="submit" class="btn btn-primary">åˆ›å»º</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- v2.0 æ–°å»ºActivityTypeæ¨¡æ€æ¡† -->
        <div x-show="showNewActivityTypeModal" class="modal" :class="{ 'd-block': showNewActivityTypeModal }" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">âš¡ æ–°å»ºæ´»åŠ¨ç±»å‹</h5>
                        <button type="button" class="btn-close" @click="showNewActivityTypeModal = false"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="createActivityType()">
                            <div class="mb-3">
                                <label class="form-label">ç±»å‹åç§°</label>
                                <input type="text" class="form-control" x-model="newActivityType.name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">çˆ¶ç±»å‹ï¼ˆå¯é€‰ï¼‰</label>
                                <select class="form-control" x-model="newActivityType.parent_id">
                                    <option value="">æ ¹çº§ç±»å‹</option>
                                    <template x-for="type in flatActivityTypes" :key="type.id">
                                        <option :value="type.id" x-text="type.name"></option>
                                    </template>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ç±»å‹æè¿°</label>
                                <textarea class="form-control" x-model="newActivityType.description" rows="3"></textarea>
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-secondary me-2" @click="showNewActivityTypeModal = false">å–æ¶ˆ</button>
                                <button type="submit" class="btn btn-success">åˆ›å»º</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- v2.0 ç¼–è¾‘Domainæ¨¡æ€æ¡† -->
        <div x-show="showEditDomainModal" class="modal" :class="{ 'd-block': showEditDomainModal }" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ğŸ¯ ç¼–è¾‘é¢†åŸŸ</h5>
                        <button type="button" class="btn-close" @click="showEditDomainModal = false"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="updateDomain()">
                            <div class="mb-3">
                                <label class="form-label">é¢†åŸŸåç§°</label>
                                <input type="text" class="form-control" x-model="editingDomain.name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">çˆ¶é¢†åŸŸï¼ˆå¯é€‰ï¼‰</label>
                                <select class="form-control" x-model="editingDomain.parent_id">
                                    <option value="">æ ¹çº§é¢†åŸŸ</option>
                                    <template x-for="domain in flatDomains" :key="domain.id">
                                        <option :value="domain.id" x-text="domain.name" :disabled="domain.id === editingDomain.id"></option>
                                    </template>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">é¢†åŸŸæè¿°</label>
                                <textarea class="form-control" x-model="editingDomain.description" rows="3"></textarea>
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-secondary me-2" @click="showEditDomainModal = false">å–æ¶ˆ</button>
                                <button type="submit" class="btn btn-primary">æ›´æ–°</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scheduleç®¡ç†æ¨¡æ€æ¡† -->
        <div x-show="showScheduleManageModal" class="modal" :class="{ 'd-block': showScheduleManageModal }" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ğŸ“… ç®¡ç†æ—¥ç¨‹ - <span x-text="currentDomainName"></span></h5>
                        <button type="button" class="btn-close" @click="closeScheduleManageModal()"></button>
                    </div>
                    <div class="modal-body">
                        <!-- æ–°å»ºScheduleæŒ‰é’® -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">ç°æœ‰æ—¥ç¨‹</h6>
                            <button class="btn btn-primary btn-sm" @click="showNewScheduleForm = true">+ æ–°å»ºæ—¥ç¨‹</button>
                        </div>

                        <!-- æ–°å»ºScheduleè¡¨å• -->
                        <div x-show="showNewScheduleForm" class="card mb-3">
                            <div class="card-body">
                                <form @submit.prevent="createSchedule()">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="mb-3">
                                                <label class="form-label">æ—¥ç¨‹åç§°</label>
                                                <input type="text" class="form-control" x-model="newSchedule.name" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">èµ·å§‹æ—¥æœŸ</label>
                                                <input type="datetime-local" class="form-control" x-model="newSchedule.start_date">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">æˆªæ­¢æ—¥æœŸ</label>
                                                <input type="datetime-local" class="form-control" x-model="newSchedule.deadline">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">æè¿°</label>
                                        <textarea class="form-control" x-model="newSchedule.description" rows="2"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">çŠ¶æ€</label>
                                        <select class="form-select" x-model="newSchedule.status">
                                            <option value="ongoing">è¿›è¡Œä¸­</option>
                                            <option value="completed">å·²å®Œæˆ</option>
                                            <option value="paused">å·²æš‚åœ</option>
                                            <option value="cancelled">å·²å–æ¶ˆ</option>
                                        </select>
                                    </div>
                                    <div class="text-end">
                                        <button type="button" class="btn btn-secondary me-2" @click="showNewScheduleForm = false">å–æ¶ˆ</button>
                                        <button type="submit" class="btn btn-primary">åˆ›å»º</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Scheduleåˆ—è¡¨ -->
                        <div class="schedule-list">
                            <template x-for="schedule in currentDomainSchedules" :key="schedule.id">
                                <div class="card mb-2">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="card-title mb-1" x-text="schedule.name"></h6>
                                                <p class="card-text text-muted mb-1" x-text="schedule.description || 'æ— æè¿°'"></p>
                                                <div class="d-flex align-items-center flex-wrap">
                                                    <span class="badge me-2 mb-1" :class="{
                                                        'bg-primary': schedule.status === 'ongoing',
                                                        'bg-success': schedule.status === 'completed',
                                                        'bg-warning': schedule.status === 'paused',
                                                        'bg-danger': schedule.status === 'cancelled'
                                                    }" x-text="getStatusText(schedule.status)"></span>
                                                    <small class="text-muted me-3 mb-1" x-show="schedule.start_date">
                                                        èµ·å§‹: <span x-text="formatDateTime(schedule.start_date)"></span>
                                                    </small>
                                                    <small class="text-muted mb-1" x-show="schedule.deadline">
                                                        æˆªæ­¢: <span x-text="formatDateTime(schedule.deadline)"></span>
                                                    </small>
                                                </div>
                                            </div>
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-outline-primary" @click="editSchedule(schedule)">ç¼–è¾‘</button>
                                                <button class="btn btn-sm btn-outline-danger" @click="deleteSchedule(schedule.id)">åˆ é™¤</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            <div x-show="!currentDomainSchedules.length" class="text-center text-muted py-4">
                                <p>è¯¥é¢†åŸŸæš‚æ— æ—¥ç¨‹</p>
                                <button class="btn btn-outline-primary btn-sm" @click="showNewScheduleForm = true">åˆ›å»ºç¬¬ä¸€ä¸ªæ—¥ç¨‹</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¼–è¾‘Scheduleæ¨¡æ€æ¡† -->
        <div x-show="showEditScheduleModal" class="modal" :class="{ 'd-block': showEditScheduleModal }" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ğŸ“… ç¼–è¾‘æ—¥ç¨‹</h5>
                        <button type="button" class="btn-close" @click="showEditScheduleModal = false"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="updateSchedule()">
                            <div class="mb-3">
                                <label class="form-label">æ—¥ç¨‹åç§°</label>
                                <input type="text" class="form-control" x-model="editingSchedule.name" required>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">èµ·å§‹æ—¥æœŸ</label>
                                        <input type="datetime-local" class="form-control" x-model="editingSchedule.start_date">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">æˆªæ­¢æ—¥æœŸ</label>
                                        <input type="datetime-local" class="form-control" x-model="editingSchedule.deadline">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">æè¿°</label>
                                <textarea class="form-control" x-model="editingSchedule.description" rows="3"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">çŠ¶æ€</label>
                                <select class="form-select" x-model="editingSchedule.status">
                                    <option value="ongoing">è¿›è¡Œä¸­</option>
                                    <option value="completed">å·²å®Œæˆ</option>
                                    <option value="paused">å·²æš‚åœ</option>
                                    <option value="cancelled">å·²å–æ¶ˆ</option>
                                </select>
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-secondary me-2" @click="showEditScheduleModal = false">å–æ¶ˆ</button>
                                <button type="submit" class="btn btn-primary">æ›´æ–°</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- v2.0 ç¼–è¾‘ActivityTypeæ¨¡æ€æ¡† -->
        <div x-show="showEditActivityTypeModal" class="modal" :class="{ 'd-block': showEditActivityTypeModal }" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">âš¡ ç¼–è¾‘æ´»åŠ¨ç±»å‹</h5>
                        <button type="button" class="btn-close" @click="showEditActivityTypeModal = false"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="updateActivityType()">
                            <div class="mb-3">
                                <label class="form-label">ç±»å‹åç§°</label>
                                <input type="text" class="form-control" x-model="editingActivityType.name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">çˆ¶ç±»å‹ï¼ˆå¯é€‰ï¼‰</label>
                                <select class="form-control" x-model="editingActivityType.parent_id">
                                    <option value="">æ ¹çº§ç±»å‹</option>
                                    <template x-for="type in flatActivityTypes" :key="type.id">
                                        <option :value="type.id" x-text="type.name" :disabled="type.id === editingActivityType.id"></option>
                                    </template>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ç±»å‹æè¿°</label>
                                <textarea class="form-control" x-model="editingActivityType.description" rows="3"></textarea>
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-secondary me-2" @click="showEditActivityTypeModal = false">å–æ¶ˆ</button>
                                <button type="submit" class="btn btn-success">æ›´æ–°</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç›´æ¥åµŒå…¥JavaScriptä»£ç ä»¥é¿å…è·¯å¾„é—®é¢˜
        function laeApp() {
            return {
                // å½“å‰è§†å›¾çŠ¶æ€
                currentView: 'week',
                
                // æ—¥æœŸçŠ¶æ€
                currentDate: new Date(),
                currentWeekStart: null,
                currentMonth: new Date().getMonth() + 1,
                currentYear: new Date().getFullYear(),
                
                // æ•°æ®çŠ¶æ€
                activities: [],
                flatActivities: [],
                weekSchedule: {},
                monthSchedule: {},

                // ç”¨äºå¼ºåˆ¶è§¦å‘Alpine.jsé‡æ–°æ¸²æŸ“çš„è¾…åŠ©å˜é‡
                refreshTrigger: 0,

                // V3.0 åŠ¨æ€ç”»å¸ƒæ¨¡å¼
                isV3Mode: false, // æ˜¯å¦å¯ç”¨V3æ¨¡å¼
                gridSnapSize: 10, // ç½‘æ ¼å¸é™„å¤§å°(åˆ†é’Ÿ)
                canvasScrollTop: 0, // ç”»å¸ƒæ»šåŠ¨ä½ç½®
                snapIndicatorY: 0, // å¸é™„æŒ‡ç¤ºå™¨ä½ç½®
                v3SnapIndicator: { // V3ä¸“ç”¨å¸é™„æŒ‡ç¤ºå™¨
                    visible: false,
                    y: 0,
                    tooltip: ''
                },

                // V3 æ‹–æ‹½çŠ¶æ€
                isDragging: false,
                draggedEventId: null,
                dropProcessing: false, // é˜²æ­¢é‡å¤å¤„ç†dropäº‹ä»¶
                lastSnapTime: null, // ä¿å­˜æœ€åå¸é™„çš„æ—¶é—´
                v3TimeStart: 7, // V3å¼€å§‹æ—¶é—´(å°æ—¶) - 7:00
                v3TimeEnd: 23, // V3ç»“æŸæ—¶é—´(å°æ—¶) - 23:00
                v3ZoomLevel: 1.0, // V3ç¼©æ”¾çº§åˆ« (0.5 - 2.0)
                
                // æ±‡æ€»è§†å›¾æ•°æ®
                summaryStats: null,
                summaryMonth: '',
                availableMonths: [],
                activityStats: {},
                
                // æ—¶é—´æ§½é…ç½®
                timeSlots: [
                    { value: 21, name: 'ä¸Šåˆç¬¬1æ—¶æ®µ' },
                    { value: 22, name: 'ä¸Šåˆç¬¬2æ—¶æ®µ' },
                    { value: 51, name: 'ä¸‹åˆç¬¬1æ—¶æ®µ' },
                    { value: 52, name: 'ä¸‹åˆç¬¬2æ—¶æ®µ' },
                    { value: 71, name: 'æ™šä¸Šæ—¶æ®µ' }
                ],
                
                // æ¨¡æ€æ¡†çŠ¶æ€
                showNewActivityModal: false,
                showEditActivityModal: false,
                showEditEventModal: false,
                // v2.1 æ–°å»ºäº‹ä»¶æ¨¡æ€æ¡†
                showNewEventModal: false,
                // v2.0 æ–°å¢æ¨¡æ€æ¡†çŠ¶æ€
                showNewDomainModal: false,
                showNewActivityTypeModal: false,
                showEditDomainModal: false,
                showEditActivityTypeModal: false,
                // Scheduleç®¡ç†æ¨¡æ€æ¡†çŠ¶æ€
                showScheduleManageModal: false,
                showEditScheduleModal: false,
                showNewScheduleForm: false,

                // v2.0 æ•°æ®çŠ¶æ€
                domains: [],
                flatDomains: [],
                activityTypes: [],
                flatActivityTypes: [],
                domainScheduleCounts: {},  // å­˜å‚¨æ¯ä¸ªDomainçš„Scheduleæ•°é‡
                weeklySchedules: [],  // å½“å‰å‘¨çš„Scheduleæ•°æ®

                // v2.1 ä¾§è¾¹æ çŠ¶æ€
                sidebarMode: 'domain', // 'domain' or 'type'
                domainTree: [],
                typeTree: [],
                collapsedNodes: new Set(), // å­˜å‚¨æŠ˜å çš„èŠ‚ç‚¹ID
                selectedNode: { // å½“å‰é€‰ä¸­çš„èŠ‚ç‚¹
                    id: null,
                    name: '',
                    type: '', // 'domain' or 'type'
                    description: ''
                },
                // V3 ä¾§è¾¹æ é€‰æ‹©çŠ¶æ€
                selectedDomainId: null,
                selectedActivityTypeId: null,

                // è¡¨å•æ•°æ®
                newActivity: {
                    name: '',
                    parent_id: '',
                    description: ''
                },
                // v2.1 æ–°å»ºäº‹ä»¶è¡¨å•æ•°æ®
                newEvent: {
                    name: '',
                    event_date: '',
                    time_slot: '',
                    domain_id: '',
                    activity_type_id: '',
                    schedule_id: '',
                    notes: '',
                    // V3.0 æ–°å­—æ®µ
                    duration: 60,
                    start_time: null,
                    is_precise: false,
                    canvas_position_y: 0
                },
                // v2.0 æ–°å¢è¡¨å•æ•°æ®
                newDomain: {
                    name: '',
                    parent_id: '',
                    description: ''
                },
                newActivityType: {
                    name: '',
                    parent_id: '',
                    description: ''
                },

                // v2.0 ç¼–è¾‘è¡¨å•æ•°æ®
                editingDomain: {
                    id: null,
                    name: '',
                    parent_id: '',
                    description: ''
                },
                editingActivityType: {
                    id: null,
                    name: '',
                    parent_id: '',
                    description: ''
                },

                // Scheduleç®¡ç†æ•°æ®
                currentDomainId: null,
                currentDomainName: '',
                currentDomainSchedules: [],
                newSchedule: {
                    name: '',
                    description: '',
                    start_date: '',
                    deadline: '',
                    status: 'ongoing'
                },
                editingSchedule: {
                    id: null,
                    name: '',
                    description: '',
                    start_date: '',
                    deadline: '',
                    status: 'ongoing'
                },

                editingActivity: {
                    id: null,
                    name: '',
                    description: ''
                },
                
                editingEvent: {
                    id: null,
                    activity_id: null,
                    activity_name: '',
                    event_date: '',
                    time_slot: 21,
                    goal: '',
                    notes: '',
                    status: 'planned'
                },
                
                // å‘¨æ•°æ®
                weekDates: [],
                
                // å¼ºåˆ¶å…³é—­æ¨¡æ€æ¡†
                forceCloseModal() {
                    console.log('Force closing modal');
                    console.log('Before reset - showEditEventModal:', this.showEditEventModal);
                    console.log('Before reset - currentView:', this.currentView);

                    this.showEditEventModal = false;
                    this.showNewActivityModal = false;
                    this.showEditActivityModal = false;
                    // v2.1 æ–°å»ºäº‹ä»¶æ¨¡æ€æ¡†é‡ç½®
                    this.showNewEventModal = false;
                    // v2.0 æ–°å¢æ¨¡æ€æ¡†é‡ç½®
                    this.showNewDomainModal = false;
                    this.showNewActivityTypeModal = false;
                    this.showEditDomainModal = false;
                    this.showEditActivityTypeModal = false;
                    // Scheduleæ¨¡æ€æ¡†é‡ç½®
                    this.showScheduleManageModal = false;
                    this.showEditScheduleModal = false;
                    this.showNewScheduleForm = false;
                    
                    console.log('After reset - showEditEventModal:', this.showEditEventModal);
                    console.log('Modal condition check:', this.showEditEventModal && this.currentView === 'week');
                    
                    // é‡ç½®ç¼–è¾‘äº‹ä»¶æ•°æ®
                    this.editingEvent = {
                        id: null,
                        activity_id: null,
                        activity_name: '',
                        event_date: '',
                        time_slot: 21,
                        goal: '',
                        notes: '',
                        status: 'planned'
                    };
                    
                    // é‡ç½®ç¼–è¾‘æ´»åŠ¨æ•°æ®
                    this.editingActivity = {
                        id: null,
                        name: '',
                        description: ''
                    };
                },
                
                // åˆå§‹åŒ–
                async init() {
                    console.log('Initializing LAE App... v9 - Debug Enhanced');
                    console.log('Initial view:', this.currentView);
                    console.log('Time slots configuration:', this.timeSlots);
                    
                    // åˆ›å»ºå…¨å±€å¼•ç”¨ä»¥ä¾¿HTML onclickè®¿é—®
                    window.laeAppInstance = this;
                    
                    // å¼ºåˆ¶é‡ç½®æ‰€æœ‰æ¨¡æ€æ¡†çŠ¶æ€
                    this.forceCloseModal();
                    
                    // æš‚æ—¶è·³è¿‡v1.0 activitiesåŠ è½½ï¼Œé¿å…500é”™è¯¯
                    // await this.loadActivities();
                    console.log('Skipping v1.0 activities for now');

                    // v2.0 æ•°æ®åŠ è½½
                    await this.loadDomains();
                    console.log('Domains loaded, count:', this.domains.length);

                    await this.loadActivityTypes();
                    console.log('ActivityTypes loaded, count:', this.activityTypes.length);

                    // v2.1 ä¾§è¾¹æ åˆå§‹åŒ–
                    await this.loadDomainTree();
                    console.log('Domain tree loaded for sidebar');

                    this.updateWeekDates();
                    console.log('Week dates updated:', this.weekDates);
                    
                    // æ ¹æ®å½“å‰è§†å›¾åŠ è½½æ•°æ®
                    if (this.currentView === 'week') {
                        await this.loadWeekSchedule();
                    } else if (this.currentView === 'month') {
                        await this.loadMonthSchedule();
                    } else if (this.currentView === 'summary') {
                        await this.initSummaryData();
                    }
                    
                    // ç¡®ä¿DOMæ¸²æŸ“å®Œæˆååˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
                    this.$nextTick(() => {
                        console.log('DOM updated, initializing drag and drop in 300ms...');
                        
                        // å¦‚æœæ˜¯å‘¨è§†å›¾ï¼Œæ‰‹åŠ¨æ¸²æŸ“ç½‘æ ¼å’Œæ—¶é—´æ¡
                        if (this.currentView === 'week') {
                            this.rerenderWeekView();
                            console.log('Week view manually rendered');
                        }
                        
                        setTimeout(() => {
                            this.initDragAndDrop();
                            // v2.1 ä¸å†éœ€è¦ä¾§è¾¹æ æ‹–æ‹½åˆå§‹åŒ–ï¼ˆæ”¹ä¸ºé€‰æ‹©+ç‚¹å‡»æ¨¡å¼ï¼‰
                        }, 300);
                    });
                },
                
                // APIè°ƒç”¨æ–¹æ³•
                async apiCall(endpoint, options = {}) {
                    try {
                        console.log('ğŸŒ APIè°ƒç”¨:', {
                            endpoint,
                            method: options.method || 'GET',
                            body: options.body
                        });

                        const response = await fetch(`/api${endpoint}`, {
                            headers: {
                                'Content-Type': 'application/json',
                                ...options.headers
                            },
                            ...options
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('âŒ APIé”™è¯¯è¯¦æƒ…:', {
                                status: response.status,
                                statusText: response.statusText,
                                url: response.url,
                                errorBody: errorText
                            });
                            throw new Error(`APIé”™è¯¯: ${response.status} - ${errorText}`);
                        }

                        const result = await response.json();
                        console.log('âœ… APIæˆåŠŸ:', result);
                        return result;
                    } catch (error) {
                        console.error('APIè°ƒç”¨å¤±è´¥:', error);
                        alert('æ“ä½œå¤±è´¥: ' + error.message);
                        throw error;
                    }
                },
                
                // åŠ è½½æ´»åŠ¨æ•°æ®
                async loadActivities() {
                    try {
                        this.activities = await this.apiCall('/activities/tree');
                        this.flatActivities = await this.apiCall('/activities/');
                        console.log('Activities loaded:', this.flatActivities.length);
                    } catch (error) {
                        console.error('åŠ è½½æ´»åŠ¨å¤±è´¥:', error);
                    }
                },
                
                // åˆ›å»ºæ–°æ´»åŠ¨
                async createActivity() {
                    try {
                        const activityData = {
                            name: this.newActivity.name,
                            description: this.newActivity.description || null,
                            parent_id: this.newActivity.parent_id || null
                        };
                        
                        await this.apiCall('/activities/', {
                            method: 'POST',
                            body: JSON.stringify(activityData)
                        });
                        
                        // é‡æ–°åŠ è½½æ•°æ®
                        await this.loadActivities();
                        
                        // å…³é—­æ¨¡æ€æ¡†å¹¶é‡ç½®è¡¨å•
                        this.showNewActivityModal = false;
                        this.newActivity = { name: '', parent_id: '', description: '' };
                        
                        // å¦‚æœåœ¨æ±‡æ€»è§†å›¾ï¼Œé‡æ–°åŠ è½½ç»Ÿè®¡æ•°æ®
                        if (this.currentView === 'summary') {
                            await this.initSummaryData();
                        }
                        
                    } catch (error) {
                        console.error('åˆ›å»ºæ´»åŠ¨å¤±è´¥:', error);
                    }
                },

                // v2.0 CRUD æ–¹æ³•
                async createDomain() {
                    try {
                        const domainData = {
                            name: this.newDomain.name,
                            description: this.newDomain.description || null,
                            parent_id: this.newDomain.parent_id || null
                        };

                        const response = await fetch('/api/domains/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(domainData)
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        console.log('âœ… Domain created successfully');
                        this.showNewDomainModal = false;
                        this.newDomain = { name: '', parent_id: '', description: '' };

                        // é‡æ–°åŠ è½½domainsæ•°æ®
                        await this.loadDomains();

                    } catch (error) {
                        console.error('åˆ›å»ºé¢†åŸŸå¤±è´¥:', error);
                        alert('åˆ›å»ºé¢†åŸŸå¤±è´¥: ' + error.message);
                    }
                },

                async updateDomain() {
                    try {
                        const domainData = {
                            name: this.editingDomain.name,
                            description: this.editingDomain.description || null,
                            parent_id: this.editingDomain.parent_id || null
                        };

                        const response = await fetch(`/api/domains/${this.editingDomain.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(domainData)
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        console.log('âœ… Domain updated successfully');
                        this.showEditDomainModal = false;

                        // é‡æ–°åŠ è½½domainsæ•°æ®
                        await this.loadDomains();

                    } catch (error) {
                        console.error('æ›´æ–°é¢†åŸŸå¤±è´¥:', error);
                        alert('æ›´æ–°é¢†åŸŸå¤±è´¥: ' + error.message);
                    }
                },

                async createActivityType() {
                    try {
                        const typeData = {
                            name: this.newActivityType.name,
                            description: this.newActivityType.description || null,
                            parent_id: this.newActivityType.parent_id || null
                        };

                        const response = await fetch('/api/activity-types/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(typeData)
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        console.log('âœ… ActivityType created successfully');
                        this.showNewActivityTypeModal = false;
                        this.newActivityType = { name: '', parent_id: '', description: '' };

                        // é‡æ–°åŠ è½½activity typesæ•°æ®
                        await this.loadActivityTypes();

                    } catch (error) {
                        console.error('åˆ›å»ºæ´»åŠ¨ç±»å‹å¤±è´¥:', error);
                        alert('åˆ›å»ºæ´»åŠ¨ç±»å‹å¤±è´¥: ' + error.message);
                    }
                },

                // v2.1 åˆ›å»ºæ–°äº‹ä»¶ï¼ˆåŒè½´çŸ©é˜µï¼‰
                async createNewEvent() {
                    try {
                        if (!this.newEvent.name.trim()) {
                            alert('è¯·è¾“å…¥äº‹ä»¶åç§°');
                            return;
                        }

                        const eventData = {
                            name: this.newEvent.name.trim(),
                            event_date: this.newEvent.event_date,
                            time_slot: parseInt(this.newEvent.time_slot),
                            domain_id: this.newEvent.domain_id && this.newEvent.domain_id !== '' ? parseInt(this.newEvent.domain_id) : null,
                            activity_type_id: this.newEvent.activity_type_id && this.newEvent.activity_type_id !== '' ? parseInt(this.newEvent.activity_type_id) : null,
                            schedule_id: this.newEvent.schedule_id && this.newEvent.schedule_id !== '' ? parseInt(this.newEvent.schedule_id) : null,
                            notes: this.newEvent.notes || '',
                            status: 'planned',
                            // V3.0 æ–°å­—æ®µæ”¯æŒ
                            duration: this.newEvent.duration ? parseInt(this.newEvent.duration) : 60,
                            start_time: this.newEvent.start_time ? this.formatTimeForAPI(this.newEvent.start_time) : null,
                            is_precise: !!this.newEvent.is_precise,
                            canvas_position_y: this.newEvent.canvas_position_y || 0
                        };

                        console.log('ğŸ¯ Creating new event with data:', eventData);

                        const response = await fetch('/api/events/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(eventData)
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            console.error('ğŸš¨ API Error Details:', errorData);

                            // å¤„ç†422éªŒè¯é”™è¯¯çš„è¯¦ç»†ä¿¡æ¯
                            if (response.status === 422 && errorData.detail) {
                                let errorMsg = 'éªŒè¯é”™è¯¯:\n';
                                if (Array.isArray(errorData.detail)) {
                                    errorData.detail.forEach(err => {
                                        errorMsg += `- ${err.loc?.join('.') || 'unknown'}: ${err.msg}\n`;
                                    });
                                } else {
                                    errorMsg += JSON.stringify(errorData.detail, null, 2);
                                }
                                throw new Error(errorMsg);
                            }

                            throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.detail || JSON.stringify(errorData)}`);
                        }

                        const createdEvent = await response.json();
                        console.log('âœ… Event created successfully:', createdEvent);

                        // å…³é—­æ¨¡æ€æ¡†å¹¶é‡ç½®è¡¨å•
                        this.showNewEventModal = false;
                        this.newEvent = {
                            name: '',
                            event_date: '',
                            time_slot: '',
                            domain_id: '',
                            activity_type_id: '',
                            schedule_id: '',
                            notes: '',
                            // V3.0 æ–°å­—æ®µ
                            duration: 60,
                            start_time: null,
                            is_precise: false,
                            canvas_position_y: 0
                        };

                        // é‡æ–°åŠ è½½å‘¨æ•°æ®
                        await this.loadWeekSchedule();

                        // v2.1 æ”¹è¿›ï¼šä¿ç•™é€‰ä¸­çŠ¶æ€ä»¥ä¾¿å¿«é€Ÿæ‰¹é‡åˆ›å»º
                        console.log('âœ… Event created, keeping selected node for batch creation');

                    } catch (error) {
                        console.error('âŒ åˆ›å»ºäº‹ä»¶å¤±è´¥:', error);
                        alert('åˆ›å»ºäº‹ä»¶å¤±è´¥: ' + error.message);
                    }
                },

                // è·å–æŒ‡å®šé¢†åŸŸçš„æ—¥ç¨‹åˆ—è¡¨
                getSchedulesForDomain(domainId) {
                    if (!domainId) return [];
                    // è¿™é‡Œéœ€è¦å®ç°è·å–schedulesçš„é€»è¾‘
                    // æš‚æ—¶è¿”å›ç©ºæ•°ç»„ï¼Œåç»­å¯ä»¥åŠ è½½schedulesæ•°æ®
                    return [];
                },

                async updateActivityType() {
                    try {
                        const typeData = {
                            name: this.editingActivityType.name,
                            description: this.editingActivityType.description || null,
                            parent_id: this.editingActivityType.parent_id || null
                        };

                        const response = await fetch(`/api/activity-types/${this.editingActivityType.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(typeData)
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        console.log('âœ… ActivityType updated successfully');
                        this.showEditActivityTypeModal = false;

                        // é‡æ–°åŠ è½½activity typesæ•°æ®
                        await this.loadActivityTypes();

                    } catch (error) {
                        console.error('æ›´æ–°æ´»åŠ¨ç±»å‹å¤±è´¥:', error);
                        alert('æ›´æ–°æ´»åŠ¨ç±»å‹å¤±è´¥: ' + error.message);
                    }
                },

                editDomain(domainId) {
                    const domain = this.domains.find(d => d.id === domainId);
                    if (!domain) {
                        console.error('Domain not found:', domainId);
                        return;
                    }

                    this.editingDomain = {
                        id: domain.id,
                        name: domain.name,
                        description: domain.description || '',
                        parent_id: domain.parent_id
                    };
                    this.showEditDomainModal = true;
                },

                async deleteDomain(domainId) {
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¢†åŸŸå—ï¼Ÿè¿™å°†åŒæ—¶åˆ é™¤æ‰€æœ‰å­é¢†åŸŸã€‚')) {
                        try {
                            const response = await fetch(`/api/domains/${domainId}`, {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json',
                                }
                            });

                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }

                            console.log('âœ… Domain deleted successfully');

                            // é‡æ–°åŠ è½½domainsæ•°æ®
                            await this.loadDomains();

                        } catch (error) {
                            console.error('åˆ é™¤é¢†åŸŸå¤±è´¥:', error);
                            alert('åˆ é™¤é¢†åŸŸå¤±è´¥: ' + error.message);
                        }
                    }
                },

                // ===== Scheduleç®¡ç†åŠŸèƒ½ =====
                async manageSchedules(domainId) {
                    const domain = this.domains.find(d => d.id === domainId);
                    if (!domain) {
                        console.error('Domain not found:', domainId);
                        return;
                    }

                    this.currentDomainId = domainId;
                    this.currentDomainName = domain.name;
                    this.showScheduleManageModal = true;

                    // åŠ è½½è¯¥Domainçš„Schedules
                    await this.loadDomainSchedules(domainId);
                },

                async loadDomainSchedules(domainId) {
                    try {
                        console.log('ğŸ“… Loading schedules for domain:', domainId);
                        const response = await fetch(`/api/schedules/?domain_id=${domainId}`);
                        if (!response.ok) throw new Error('Failed to load schedules');

                        this.currentDomainSchedules = await response.json();
                        console.log('âœ… Domain schedules loaded:', this.currentDomainSchedules.length, 'schedules');
                    } catch (error) {
                        console.error('âŒ Error loading domain schedules:', error);
                        this.currentDomainSchedules = [];
                    }
                },

                closeScheduleManageModal() {
                    this.showScheduleManageModal = false;
                    this.showNewScheduleForm = false;
                    this.currentDomainId = null;
                    this.currentDomainName = '';
                    this.currentDomainSchedules = [];
                    this.newSchedule = {
                        name: '',
                        description: '',
                        start_date: '',
                        deadline: '',
                        status: 'ongoing'
                    };
                    // é‡æ–°åŠ è½½Scheduleæ•°é‡ä»¥æ›´æ–°æ˜¾ç¤º
                    this.loadDomainScheduleCounts();
                },

                async createSchedule() {
                    try {
                        const scheduleData = {
                            domain_id: this.currentDomainId,
                            name: this.newSchedule.name,
                            description: this.newSchedule.description || null,
                            start_date: this.newSchedule.start_date || null,
                            deadline: this.newSchedule.deadline || null,
                            status: this.newSchedule.status
                        };

                        const response = await fetch('/api/schedules/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(scheduleData)
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        console.log('âœ… Schedule created successfully');
                        this.showNewScheduleForm = false;
                        this.newSchedule = {
                            name: '',
                            description: '',
                            start_date: '',
                            deadline: '',
                            status: 'ongoing'
                        };

                        // é‡æ–°åŠ è½½è¯¥Domainçš„Schedules
                        await this.loadDomainSchedules(this.currentDomainId);

                    } catch (error) {
                        console.error('åˆ›å»ºæ—¥ç¨‹å¤±è´¥:', error);
                        alert('åˆ›å»ºæ—¥ç¨‹å¤±è´¥: ' + error.message);
                    }
                },

                editSchedule(schedule) {
                    this.editingSchedule = {
                        id: schedule.id,
                        name: schedule.name,
                        description: schedule.description || '',
                        start_date: schedule.start_date ? this.formatDateTimeForInput(schedule.start_date) : '',
                        deadline: schedule.deadline ? this.formatDateTimeForInput(schedule.deadline) : '',
                        status: schedule.status
                    };
                    this.showEditScheduleModal = true;
                },

                async updateSchedule() {
                    try {
                        const scheduleData = {
                            name: this.editingSchedule.name,
                            description: this.editingSchedule.description || null,
                            start_date: this.editingSchedule.start_date || null,
                            deadline: this.editingSchedule.deadline || null,
                            status: this.editingSchedule.status
                        };

                        const response = await fetch(`/api/schedules/${this.editingSchedule.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(scheduleData)
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        console.log('âœ… Schedule updated successfully');
                        this.showEditScheduleModal = false;

                        // é‡æ–°åŠ è½½è¯¥Domainçš„Schedules
                        await this.loadDomainSchedules(this.currentDomainId);

                    } catch (error) {
                        console.error('æ›´æ–°æ—¥ç¨‹å¤±è´¥:', error);
                        alert('æ›´æ–°æ—¥ç¨‹å¤±è´¥: ' + error.message);
                    }
                },

                async deleteSchedule(scheduleId) {
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ—¥ç¨‹å—ï¼Ÿ')) {
                        try {
                            const response = await fetch(`/api/schedules/${scheduleId}`, {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json',
                                }
                            });

                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }

                            console.log('âœ… Schedule deleted successfully');

                            // é‡æ–°åŠ è½½è¯¥Domainçš„Schedules
                            await this.loadDomainSchedules(this.currentDomainId);

                        } catch (error) {
                            console.error('åˆ é™¤æ—¥ç¨‹å¤±è´¥:', error);
                            alert('åˆ é™¤æ—¥ç¨‹å¤±è´¥: ' + error.message);
                        }
                    }
                },

                // Scheduleè¾…åŠ©å‡½æ•°
                getStatusText(status) {
                    const statusMap = {
                        'ongoing': 'è¿›è¡Œä¸­',
                        'completed': 'å·²å®Œæˆ',
                        'paused': 'å·²æš‚åœ',
                        'cancelled': 'å·²å–æ¶ˆ'
                    };
                    return statusMap[status] || status;
                },

                formatDateTime(dateTimeStr) {
                    if (!dateTimeStr) return '';
                    const date = new Date(dateTimeStr);
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                },

                formatDateTimeForInput(dateTimeStr) {
                    if (!dateTimeStr) return '';
                    const date = new Date(dateTimeStr);
                    return date.toISOString().slice(0, 16); // æ ¼å¼: YYYY-MM-DDTHH:mm
                },

                // åŠ è½½æ‰€æœ‰Domainçš„Scheduleæ•°é‡
                async loadDomainScheduleCounts() {
                    try {
                        console.log('ğŸ“Š Loading domain schedule counts...');
                        const response = await fetch('/api/schedules/');
                        if (!response.ok) throw new Error('Failed to load schedules');

                        const allSchedules = await response.json();

                        // ç»Ÿè®¡æ¯ä¸ªDomainçš„Scheduleæ•°é‡
                        this.domainScheduleCounts = {};
                        allSchedules.forEach(schedule => {
                            const domainId = schedule.domain_id;
                            this.domainScheduleCounts[domainId] = (this.domainScheduleCounts[domainId] || 0) + 1;
                        });

                        console.log('âœ… Domain schedule counts loaded:', this.domainScheduleCounts);
                    } catch (error) {
                        console.error('âŒ Error loading domain schedule counts:', error);
                        this.domainScheduleCounts = {};
                    }
                },

                // è·å–æŒ‡å®šDomainçš„Scheduleæ•°é‡
                getDomainScheduleCount(domainId) {
                    return this.domainScheduleCounts[domainId] || 0;
                },

                // åŠ è½½å½“å‰å‘¨çš„Scheduleæ•°æ®
                async loadWeeklySchedules() {
                    try {
                        console.log('ğŸ“… Loading weekly schedules...');

                        // è®¡ç®—å½“å‰å‘¨çš„å¼€å§‹å’Œç»“æŸæ—¥æœŸ
                        const startDate = new Date(this.currentWeekStart);
                        const endDate = new Date(this.currentWeekStart);
                        endDate.setDate(endDate.getDate() + 6); // å‘¨æ—¥

                        const startStr = startDate.toISOString().split('T')[0];
                        const endStr = endDate.toISOString().split('T')[0];

                        console.log('Week range:', startStr, 'to', endStr);

                        const response = await fetch(`/api/schedules/?start_date=${startStr}&end_date=${endStr}`);
                        if (!response.ok) throw new Error('Failed to load weekly schedules');

                        this.weeklySchedules = await response.json();
                        console.log('âœ… Weekly schedules loaded:', this.weeklySchedules.length, 'schedules');
                    } catch (error) {
                        console.error('âŒ Error loading weekly schedules:', error);
                        this.weeklySchedules = [];
                    }
                },

                editActivityType(typeId) {
                    const activityType = this.activityTypes.find(t => t.id === typeId);
                    if (!activityType) {
                        console.error('ActivityType not found:', typeId);
                        return;
                    }

                    this.editingActivityType = {
                        id: activityType.id,
                        name: activityType.name,
                        description: activityType.description || '',
                        parent_id: activityType.parent_id
                    };
                    this.showEditActivityTypeModal = true;
                },

                async deleteActivityType(typeId) {
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ´»åŠ¨ç±»å‹å—ï¼Ÿè¿™å°†åŒæ—¶åˆ é™¤æ‰€æœ‰å­ç±»å‹ã€‚')) {
                        try {
                            const response = await fetch(`/api/activity-types/${typeId}`, {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json',
                                }
                            });

                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }

                            console.log('âœ… ActivityType deleted successfully');

                            // é‡æ–°åŠ è½½activity typesæ•°æ®
                            await this.loadActivityTypes();

                        } catch (error) {
                            console.error('åˆ é™¤æ´»åŠ¨ç±»å‹å¤±è´¥:', error);
                            alert('åˆ é™¤æ´»åŠ¨ç±»å‹å¤±è´¥: ' + error.message);
                        }
                    }
                },

                // åŠ è½½v2.0æ•°æ®
                async loadDomains() {
                    try {
                        const response = await fetch('/api/domains/');
                        if (response.ok) {
                            this.domains = await response.json();
                            this.flatDomains = [...this.domains];
                            console.log('âœ… Domains loaded:', this.domains.length);
                        } else {
                            console.warn('âš ï¸  Failed to load domains, using fallback');
                            this.domains = [];
                            this.flatDomains = [];
                        }
                    } catch (error) {
                        console.error('âŒ Error loading domains:', error);
                        this.domains = [];
                        this.flatDomains = [];
                    }
                },

                async loadActivityTypes() {
                    try {
                        const response = await fetch('/api/activity-types/');
                        if (response.ok) {
                            this.activityTypes = await response.json();
                            this.flatActivityTypes = [...this.activityTypes];
                            console.log('âœ… ActivityTypes loaded:', this.activityTypes.length);
                        } else {
                            console.warn('âš ï¸  Failed to load activity types, using fallback');
                            this.activityTypes = [];
                            this.flatActivityTypes = [];
                        }
                    } catch (error) {
                        console.error('âŒ Error loading activity types:', error);
                        this.activityTypes = [];
                        this.flatActivityTypes = [];
                    }
                },

                // ç¼–è¾‘æ´»åŠ¨ (v1.0ä¿ç•™)
                editActivity(activityId) {
                    const activity = this.flatActivities.find(a => a.id === activityId);
                    if (!activity) {
                        console.error('Activity not found:', activityId);
                        return;
                    }
                    
                    this.editingActivity = {
                        id: activity.id,
                        name: activity.name,
                        description: activity.description || ''
                    };
                    
                    this.showEditActivityModal = true;
                },
                
                // æ›´æ–°æ´»åŠ¨
                async updateActivity() {
                    try {
                        const activityData = {
                            name: this.editingActivity.name,
                            description: this.editingActivity.description || null
                        };
                        
                        await this.apiCall(`/activities/${this.editingActivity.id}`, {
                            method: 'PUT',
                            body: JSON.stringify(activityData)
                        });
                        
                        // é‡æ–°åŠ è½½æ•°æ®
                        await this.loadActivities();
                        
                        // å…³é—­æ¨¡æ€æ¡†å¹¶é‡ç½®è¡¨å•
                        this.showEditActivityModal = false;
                        this.editingActivity = { id: null, name: '', description: '' };
                        
                        // å¦‚æœåœ¨æ±‡æ€»è§†å›¾ï¼Œé‡æ–°åŠ è½½ç»Ÿè®¡æ•°æ®
                        if (this.currentView === 'summary') {
                            await this.initSummaryData();
                        }
                        
                    } catch (error) {
                        console.error('æ›´æ–°æ´»åŠ¨å¤±è´¥:', error);
                    }
                },
                
                // è§†å›¾åˆ‡æ¢
                async switchView(view) {
                    console.log('Switching from', this.currentView, 'to', view);
                    this.currentView = view;
                    
                    // åˆ‡æ¢è§†å›¾æ—¶æ¸…ç†æ‰€æœ‰æ¨¡æ€æ¡†çŠ¶æ€
                    this.showNewActivityModal = false;
                    this.showEditActivityModal = false;
                    this.showEditEventModal = false;
                    
                    if (view === 'week') {
                        console.log('Entering week view...');
                        console.log('Current week dates:', this.weekDates);
                        console.log('Time slots:', this.timeSlots);
                        
                        await this.loadWeekSchedule();
                        
                        // å¼ºåˆ¶é‡æ–°æ¸²æŸ“ç½‘æ ¼å’Œæ—¶é—´æ¡
                        this.$nextTick(() => {
                            // æ‰‹åŠ¨è§¦å‘é‡æ–°æ¸²æŸ“
                            this.rerenderWeekView();
                            
                            console.log('Week view DOM updated, checking elements...');
                            console.log('Activity pool element:', document.getElementById('activity-pool'));
                            console.log('Week grid element:', document.getElementById('week-grid'));
                            console.log('Time slot elements:', document.querySelectorAll('.time-slot').length);
                            
                            setTimeout(() => {
                                this.initDragAndDrop();
                            }, 200);
                        });
                    } else if (view === 'month') {
                        await this.loadMonthSchedule();
                    } else if (view === 'summary') {
                        await this.initSummaryData();
                    }
                },
                
                // å‘¨è§†å›¾ç›¸å…³æ–¹æ³•
                updateWeekDates() {
                    const start = new Date(this.currentDate);
                    start.setDate(start.getDate() - start.getDay() + 1); // è·å–å‘¨ä¸€
                    this.currentWeekStart = new Date(start);
                    
                    this.weekDates = [];
                    for (let i = 0; i < 7; i++) {
                        const date = new Date(start);
                        date.setDate(start.getDate() + i);
                        this.weekDates.push(date.toISOString().split('T')[0]);
                    }
                },
                
                async loadWeekSchedule() {
                    try {
                        const targetDate = this.weekDates[0]; // å‘¨ä¸€
                        console.log('Loading week schedule for:', targetDate);
                        const data = await this.apiCall(`/calendar/week/${targetDate}`);

                        // è½¬æ¢æ•°æ®æ ¼å¼ä»¥ä¾¿æŸ¥æ‰¾
                        this.weekSchedule = {};
                        data.schedule.forEach(day => {
                            this.weekSchedule[day.date] = day.slots;
                        });
                        console.log('Week schedule loaded:', this.weekSchedule);
                        console.log('Schedule data structure:', data);

                        // åŒæ—¶åŠ è½½å½“å‰å‘¨çš„Scheduleæ—¶é—´æ¡æ•°æ®
                        await this.loadWeeklySchedules();

                        // åœ¨V3æ¨¡å¼ä¸‹é‡æ–°åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
                        if (this.isV3Mode) {
                            this.$nextTick(() => {
                                setTimeout(() => {
                                    this.initV3DragAndDrop();
                                    console.log('ğŸ”„ é‡æ–°åˆå§‹åŒ–V3æ‹–æ‹½åŠŸèƒ½');
                                }, 100);
                            });
                        }
                    } catch (error) {
                        console.error('åŠ è½½å‘¨æ—¥ç¨‹å¤±è´¥:', error);
                        // å³ä½¿åŠ è½½å¤±è´¥ä¹Ÿè¦åˆå§‹åŒ–ç©ºçš„å‘¨æ—¥ç¨‹å¯¹è±¡
                        this.weekSchedule = {};
                    }
                },
                
                getScheduledEvent(date, timeSlot) {
                    return this.weekSchedule[date]?.[timeSlot] || null;
                },
                
                async previousWeek() {
                    console.log('â¬…ï¸ åˆ‡æ¢åˆ°ä¸Šä¸€å‘¨');
                    this.currentDate.setDate(this.currentDate.getDate() - 7);
                    this.updateWeekDates();
                    await this.loadWeekSchedule();

                    // ç¡®ä¿åˆ‡æ¢å‘¨åé‡æ–°åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
                    this.$nextTick(() => {
                        this.rerenderWeekView();
                        console.log('å‘¨æ•°æ®åˆ‡æ¢åé‡æ–°æ¸²æŸ“ç½‘æ ¼å’Œæ—¶é—´æ¡');

                        setTimeout(() => {
                            this.initDragAndDrop();
                            console.log('å‘¨æ•°æ®åˆ‡æ¢åé‡æ–°åˆå§‹åŒ–æ‹–æ‹½');
                        }, 200);
                    });
                },

                async nextWeek() {
                    console.log('â¡ï¸ åˆ‡æ¢åˆ°ä¸‹ä¸€å‘¨');
                    this.currentDate.setDate(this.currentDate.getDate() + 7);
                    this.updateWeekDates();
                    await this.loadWeekSchedule();

                    // ç¡®ä¿åˆ‡æ¢å‘¨åé‡æ–°åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
                    this.$nextTick(() => {
                        this.rerenderWeekView();
                        console.log('å‘¨æ•°æ®åˆ‡æ¢åé‡æ–°æ¸²æŸ“ç½‘æ ¼å’Œæ—¶é—´æ¡');

                        setTimeout(() => {
                            this.initDragAndDrop();
                            console.log('å‘¨æ•°æ®åˆ‡æ¢åé‡æ–°åˆå§‹åŒ–æ‹–æ‹½');
                        }, 200);
                    });
                },
                
                // v2.1 ç‚¹å‡»æ—¶é—´æ§½å¤„ç†ï¼ˆé€‰æ‹©+ç‚¹å‡»æ¨¡å¼ï¼‰
                handleTimeSlotClick(date, timeSlot) {
                    console.log('ğŸ¯ Time slot clicked:', date, timeSlot, 'Selected node:', this.selectedNode);

                    // åªåœ¨å‘¨è§†å›¾ä¸­å…è®¸æ“ä½œ
                    if (this.currentView !== 'week') {
                        console.log('Time slot click blocked - not in week view');
                        return;
                    }

                    const existingEvent = this.getScheduledEvent(date, timeSlot);

                    if (existingEvent) {
                        // ç¼–è¾‘ç°æœ‰äº‹ä»¶ - ä½¿ç”¨æ—§çš„ç¼–è¾‘æ¨¡æ€æ¡†
                        this.editExistingEvent(date, timeSlot, existingEvent);
                    } else if (this.selectedNode.id) {
                        // æœ‰é€‰ä¸­èŠ‚ç‚¹ - ä½¿ç”¨æ–°çš„åˆ›å»ºæ¨¡æ€æ¡†
                        this.createEventWithSelectedNode(date, timeSlot);
                    } else {
                        // æ²¡æœ‰é€‰ä¸­èŠ‚ç‚¹ - ä½¿ç”¨æ–°çš„åˆ›å»ºæ¨¡æ€æ¡†
                        this.createEventFromBlank(date, timeSlot);
                    }
                },

                // ç¼–è¾‘ç°æœ‰äº‹ä»¶
                editExistingEvent(date, timeSlot, event) {
                    console.log('ğŸ“ Editing existing event:', event);
                    this.editingEvent = {
                        id: event.id,
                        activity_id: event.activity_id,
                        activity_name: event.activity_name,
                        event_date: date,
                        time_slot: timeSlot,
                        // v2.1 æ–°å­—æ®µ
                        name: event.name || event.activity_name || '',
                        domain_id: event.domain_id ? String(event.domain_id) : '',
                        activity_type_id: event.activity_type_id ? String(event.activity_type_id) : '',
                        schedule_id: event.schedule_id ? String(event.schedule_id) : '',
                        // v1 å…¼å®¹å­—æ®µ
                        goal: event.goal || '',
                        notes: event.notes || '',
                        status: event.status || 'planned'
                    };
                    this.showEditEventModal = true;
                },

                // åŸºäºé€‰ä¸­èŠ‚ç‚¹åˆ›å»ºäº‹ä»¶
                createEventWithSelectedNode(date, timeSlot) {
                    console.log('âœ¨ Creating event with selected node:', this.selectedNode);
                    this.newEvent = {
                        name: this.selectedNode.name, // ğŸ¯ è‡ªåŠ¨å¡«å…¥é€‰ä¸­èŠ‚ç‚¹åç§°
                        event_date: date,
                        time_slot: timeSlot,
                        domain_id: this.selectedNode.type === 'domain' ? this.selectedNode.id : '',
                        activity_type_id: this.selectedNode.type === 'type' ? this.selectedNode.id : '',
                        schedule_id: '',
                        notes: ''
                    };
                    this.showNewEventModal = true;
                },

                // ä»ç©ºç™½åˆ›å»ºäº‹ä»¶
                createEventFromBlank(date, timeSlot) {
                    console.log('ğŸ“„ Creating event from blank');
                    this.newEvent = {
                        name: '',
                        event_date: date,
                        time_slot: timeSlot,
                        domain_id: '',
                        activity_type_id: '',
                        schedule_id: '',
                        notes: ''
                    };
                    this.showNewEventModal = true;
                },

                // ä¿æŒå‘åå…¼å®¹çš„æ—§æ–¹æ³•
                editScheduledEvent(date, timeSlot) {
                    // é‡å®šå‘åˆ°æ–°çš„å¤„ç†æ–¹æ³•
                    this.handleTimeSlotClick(date, timeSlot);
                },
                
                async saveScheduledEvent() {
                    try {
                        if (!this.editingEvent.activity_id) {
                            alert('è¯·å…ˆæ‹–æ‹½æ´»åŠ¨åˆ°æ—¶é—´æ§½ä¸­');
                            return;
                        }
                        
                        const eventData = {
                            activity_id: this.editingEvent.activity_id,
                            event_date: this.editingEvent.event_date,
                            time_slot: this.editingEvent.time_slot,
                            goal: this.editingEvent.goal || null,
                            notes: this.editingEvent.notes || null,
                            status: this.editingEvent.status
                        };
                        
                        if (this.editingEvent.id) {
                            // æ›´æ–°ç°æœ‰äº‹ä»¶
                            await this.apiCall(`/events/${this.editingEvent.id}`, {
                                method: 'PUT',
                                body: JSON.stringify(eventData)
                            });
                        } else {
                            // åˆ›å»ºæ–°äº‹ä»¶
                            await this.apiCall('/events/', {
                                method: 'POST',
                                body: JSON.stringify(eventData)
                            });
                        }
                        
                        // åˆ·æ–°æ•°æ®
                        await this.loadWeekSchedule();
                        this.forceCloseModal();
                        
                    } catch (error) {
                        console.error('ä¿å­˜æ—¥ç¨‹å¤±è´¥:', error);
                    }
                },
                
                async deleteScheduledEvent() {
                    if (!this.editingEvent.id) return;
                    
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ—¥ç¨‹å—ï¼Ÿ')) {
                        try {
                            await this.apiCall(`/events/${this.editingEvent.id}`, {
                                method: 'DELETE'
                            });
                            
                            await this.loadWeekSchedule();
                            this.forceCloseModal();
                        } catch (error) {
                            console.error('åˆ é™¤æ—¥ç¨‹å¤±è´¥:', error);
                        }
                    }
                },

                // v2.1 ä¿å­˜ç¼–è¾‘çš„äº‹ä»¶ (åŒè½´çŸ©é˜µ)
                async saveEditedEvent() {
                    try {
                        if (!this.editingEvent.name.trim()) {
                            alert('è¯·è¾“å…¥äº‹ä»¶åç§°');
                            return;
                        }

                        // ç¡®ä¿time_slotæ˜¯æœ‰æ•ˆå€¼ï¼Œå¦‚æœæ— æ•ˆåˆ™æ ¹æ®start_timeé‡æ–°è®¡ç®—
                        let timeSlot = this.editingEvent.time_slot;
                        if (!timeSlot || ![21, 22, 51, 52, 71].includes(parseInt(timeSlot))) {
                            if (this.editingEvent.start_time) {
                                timeSlot = this.getTimeSlotFromTime(this.editingEvent.start_time);
                                console.log('ğŸ”§ Recalculated time_slot from start_time:', this.editingEvent.start_time, '->', timeSlot);
                            } else {
                                timeSlot = 21; // é»˜è®¤å€¼
                                console.log('ğŸ”§ Using default time_slot:', timeSlot);
                            }
                        }

                        console.log('ğŸ“ Updating event with time_slot:', timeSlot);

                        const eventData = {
                            name: this.editingEvent.name.trim(),
                            event_date: this.editingEvent.event_date,
                            time_slot: parseInt(timeSlot),
                            domain_id: this.editingEvent.domain_id && this.editingEvent.domain_id !== '' ? parseInt(this.editingEvent.domain_id) : null,
                            activity_type_id: this.editingEvent.activity_type_id && this.editingEvent.activity_type_id !== '' ? parseInt(this.editingEvent.activity_type_id) : null,
                            schedule_id: this.editingEvent.schedule_id && this.editingEvent.schedule_id !== '' ? parseInt(this.editingEvent.schedule_id) : null,
                            notes: this.editingEvent.notes || '',
                            status: this.editingEvent.status || 'planned',
                            // v1 å…¼å®¹å­—æ®µ
                            goal: this.editingEvent.goal || '',
                            // V3.0 æ–°å­—æ®µæ”¯æŒ
                            duration: this.editingEvent.duration ? parseInt(this.editingEvent.duration) : 60,
                            start_time: this.editingEvent.start_time ? this.formatTimeForAPI(this.editingEvent.start_time) : null,
                            is_precise: !!this.editingEvent.is_precise,
                            canvas_position_y: this.editingEvent.canvas_position_y || 0
                        };

                        console.log('ğŸ“ Updating event with data:', eventData);

                        const response = await fetch(`/api/events/${this.editingEvent.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(eventData)
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.detail || 'Unknown error'}`);
                        }

                        console.log('âœ… Event updated successfully');

                        // å…³é—­æ¨¡æ€æ¡†å¹¶é‡æ–°åŠ è½½æ•°æ®
                        this.forceCloseModal();
                        await this.loadWeekSchedule();

                        // é‡æ–°æ¸²æŸ“ç½‘æ ¼
                        const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                        if (gridContainer) {
                            gridContainer.innerHTML = this.renderFullWeekGrid();
                            setTimeout(() => { this.initTimeSlotsDragAndDrop(); }, 100);
                        }

                    } catch (error) {
                        console.error('âŒ æ›´æ–°äº‹ä»¶å¤±è´¥:', error);
                        alert('æ›´æ–°äº‹ä»¶å¤±è´¥: ' + error.message);
                    }
                },

                // v2.1 åˆ é™¤ç¼–è¾‘çš„äº‹ä»¶
                async deleteEditedEvent() {
                    if (!this.editingEvent.id) return;

                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäº‹ä»¶å—ï¼Ÿ')) {
                        try {
                            console.log('ğŸ—‘ï¸ Deleting event:', this.editingEvent.id);

                            const response = await fetch(`/api/events/${this.editingEvent.id}`, {
                                method: 'DELETE'
                            });

                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }

                            console.log('âœ… Event deleted successfully');

                            // å…³é—­æ¨¡æ€æ¡†å¹¶é‡æ–°åŠ è½½æ•°æ®
                            this.forceCloseModal();
                            await this.loadWeekSchedule();

                            // é‡æ–°æ¸²æŸ“ç½‘æ ¼
                            const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                            if (gridContainer) {
                                gridContainer.innerHTML = this.renderFullWeekGrid();
                                setTimeout(() => { this.initTimeSlotsDragAndDrop(); }, 100);
                            }

                        } catch (error) {
                            console.error('âŒ åˆ é™¤äº‹ä»¶å¤±è´¥:', error);
                            alert('åˆ é™¤äº‹ä»¶å¤±è´¥: ' + error.message);
                        }
                    }
                },

                // æ‹–æ‹½åŠŸèƒ½åˆå§‹åŒ–
                initDragAndDrop() {
                    console.log('Initializing drag and drop...', 'Current view:', this.currentView);
                    
                    // åªåœ¨å‘¨è§†å›¾ä¸­åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
                    if (this.currentView !== 'week') {
                        console.log('Drag and drop skipped - not in week view');
                        return;
                    }
                    
                    const self = this; // ä¿å­˜Alpine.jså®ä¾‹å¼•ç”¨
                    
                    // åªæ¸…ç†æ—¶é—´æ§½çš„Sortableå®ä¾‹ï¼Œä¿ç•™æ´»åŠ¨æ± çš„å®ä¾‹
                    document.querySelectorAll('.time-slot.sortable-initialized').forEach(el => {
                        if (el.sortableInstance) {
                            el.sortableInstance.destroy();
                        }
                        el.classList.remove('sortable-initialized');
                    });
                    
                    console.log('Cleaned up time slot sortable instances');
                    
                    // v2.1: ä¸å†éœ€è¦æ´»åŠ¨æ± æ‹–æ‹½ï¼Œæ”¹ä¸ºé€‰æ‹©+ç‚¹å‡»æ¨¡å¼
                    // this.initActivityPoolDragAndDrop();
                    
                    // åˆå§‹åŒ–æ—¶é—´æ§½çš„æ‹–æ‹½æ¥æ”¶
                    const timeSlots = document.querySelectorAll('.time-slot');
                    console.log('Found time slots:', timeSlots.length);
                    
                    timeSlots.forEach((slot, index) => {
                        if (!slot.classList.contains('sortable-initialized')) {
                            console.log(`Initializing time slot ${index}:`, {
                                date: slot.getAttribute('data-date'),
                                timeSlot: slot.getAttribute('data-time-slot')
                            });
                            
                            slot.sortableInstance = Sortable.create(slot, {
                                group: {
                                    name: 'activities',
                                    pull: true,  // å…è®¸ä»æ—¶é—´æ§½æ‹–å‡ºï¼ˆç”¨äºåˆ é™¤æˆ–ç§»åŠ¨ï¼‰
                                    put: true    // å…è®¸æ‹–å…¥æ—¶é—´æ§½
                                },
                                animation: 200,
                                ghostClass: 'sortable-ghost',
                                chosenClass: 'sortable-chosen',
                                dragClass: 'sortable-drag',
                                // æé«˜æ‹–æ‹½åˆ¤æ–­ç²¾åº¦çš„å‚æ•°
                                tolerance: 'pointer', // ä½¿ç”¨é¼ æ ‡æŒ‡é’ˆä½ç½®åˆ¤æ–­ï¼Œè€Œä¸æ˜¯å…ƒç´ ä¸­å¿ƒ
                                forceAutoScrollFallback: false, // ç¦ç”¨è‡ªåŠ¨æ»šåŠ¨é¿å…ä½ç½®è®¡ç®—é”™è¯¯
                                fallbackTolerance: 5, // è®¾ç½®å®¹å·®ä¸º5pxï¼Œæé«˜ç²¾åº¦
                                // å½“æ‹–æ‹½åˆ°æ—¶é—´æ§½ï¼ˆåŒ…æ‹¬ç§»åŠ¨ç°æœ‰äº‹ä»¶ï¼‰
                                onAdd: function(evt) {
                                    console.log('Drop event triggered on slot:', evt.to);
                                    const activityId = evt.item.getAttribute('data-activity-id');
                                    const eventId = evt.item.getAttribute('data-event-id');
                                    const eventName = evt.item.getAttribute('data-event-name');
                                    const domainId = evt.item.getAttribute('data-domain-id');
                                    const activityTypeId = evt.item.getAttribute('data-activity-type-id');
                                    const date = evt.to.getAttribute('data-date');
                                    const timeSlot = parseInt(evt.to.getAttribute('data-time-slot'));
                                    const fromPool = evt.from.id === 'activity-pool';
                                    const fromTimeSlot = evt.from.classList.contains('time-slot');

                                    // è¯¦ç»†çš„æ‹–æ‹½åˆ¤æ–­è°ƒè¯•ä¿¡æ¯
                                    const targetRect = evt.to.getBoundingClientRect();
                                    const isValidTarget = self.validateDropTarget(evt.to, targetRect);

                                    console.log('ğŸ¯ æ‹–æ‹½ä½ç½®åˆ¤æ–­è¯¦æƒ…:', {
                                        ç›®æ ‡æ§½ä½: `${date} ${timeSlot}`,
                                        ç›®æ ‡å…ƒç´ : evt.to,
                                        ç›®æ ‡å…ƒç´ æ ‡ç­¾: evt.to.tagName,
                                        ç›®æ ‡å…ƒç´ ç±»å: evt.to.className,
                                        ç›®æ ‡å…ƒç´ ID: evt.to.id,
                                        ç›®æ ‡å…ƒç´ å¯è§æ€§: window.getComputedStyle(evt.to).display,
                                        ç›®æ ‡å…ƒç´ é€æ˜åº¦: window.getComputedStyle(evt.to).opacity,
                                        ç›®æ ‡å…ƒç´ è¾¹ç•Œ: {
                                            left: targetRect.left,
                                            right: targetRect.right,
                                            top: targetRect.top,
                                            bottom: targetRect.bottom,
                                            width: targetRect.width,
                                            height: targetRect.height
                                        },
                                        ç›®æ ‡æœ‰æ•ˆæ€§: isValidTarget ? 'âœ… æœ‰æ•ˆ' : 'âŒ æ— æ•ˆ',
                                        æ‹–æ‹½æº: fromPool ? 'æ´»åŠ¨æ± ' : 'æ—¶é—´æ§½',
                                        æ´»åŠ¨ID: activityId,
                                        æ‰€æœ‰æ—¶é—´æ§½å…ƒç´ æ•°é‡: document.querySelectorAll('.time-slot').length,
                                        å½“å‰æ—¶é—´æ§½æ˜¯å¦å­˜åœ¨: document.querySelector(`[data-date="${date}"][data-time-slot="${timeSlot}"]`) !== null
                                    });

                                    // éªŒè¯ç›®æ ‡å…ƒç´ æœ‰æ•ˆæ€§
                                    if (!isValidTarget) {
                                        console.warn('âš ï¸ æ£€æµ‹åˆ°æ— æ•ˆç›®æ ‡å…ƒç´ ï¼Œå°è¯•é‡æ–°å®šä½...');

                                        // å°è¯•æ‰¾åˆ°æœ€è¿‘çš„æœ‰æ•ˆæ—¶é—´æ§½
                                        const validTarget = self.findNearestValidTimeSlot(evt.originalEvent);
                                        if (validTarget) {
                                            console.log('ğŸ”„ é‡å®šå‘åˆ°æœ‰æ•ˆç›®æ ‡:', validTarget);
                                            // æ›´æ–°ç›®æ ‡æ•°æ®
                                            evt.to = validTarget;
                                            const newDate = validTarget.getAttribute('data-date');
                                            const newTimeSlot = parseInt(validTarget.getAttribute('data-time-slot'));

                                            console.log('ğŸ¯ é‡å®šå‘åçš„ç›®æ ‡:', {
                                                åŸç›®æ ‡: `${date} ${timeSlot}`,
                                                æ–°ç›®æ ‡: `${newDate} ${newTimeSlot}`
                                            });

                                            // ä½¿ç”¨æ–°çš„ç›®æ ‡æ•°æ®
                                            if (fromTimeSlot) {
                                                self.handleMoveEvent(activityId, evt.from.getAttribute('data-date'),
                                                    parseInt(evt.from.getAttribute('data-time-slot')), newDate, newTimeSlot);
                                            } else {
                                                self.handleDrop(activityId, newDate, newTimeSlot);
                                            }
                                        } else {
                                            console.error('âŒ æ‰¾ä¸åˆ°æœ‰æ•ˆçš„ç›®æ ‡æ—¶é—´æ§½');
                                            evt.item.remove();
                                        }
                                        return;
                                    }

                                    console.log('ğŸ¯ Drop details:', {
                                        activityId, eventId, eventName, domainId, activityTypeId,
                                        date, timeSlot, fromPool, fromTimeSlot,
                                        fromElement: evt.from.id || evt.from.className
                                    });

                                    // v2.1å…¼å®¹æ€§ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„æ‹–æ‹½æ•°æ®
                                    const hasActivityId = activityId && activityId !== '';
                                    const hasEventId = eventId && eventId !== '';
                                    const hasEventName = eventName && eventName !== '';

                                    if ((!hasActivityId && !hasEventId) || !date || !timeSlot) {
                                        console.error('âŒ Missing required drop data:', {
                                            hasActivityId, hasEventId, hasEventName, date, timeSlot
                                        });
                                        evt.item.remove();
                                        return;
                                    }

                                    // ç«‹å³ç§»é™¤æ‹–æ‹½çš„ä¸´æ—¶å…ƒç´ 
                                    evt.item.remove();

                                    // å¦‚æœæ˜¯ä»å…¶ä»–æ—¶é—´æ§½ç§»åŠ¨è¿‡æ¥çš„ï¼Œéœ€è¦å…ˆåˆ é™¤åŸæœ‰äº‹ä»¶
                                    if (fromTimeSlot) {
                                        const originalDate = evt.from.getAttribute('data-date');
                                        const originalTimeSlot = parseInt(evt.from.getAttribute('data-time-slot'));
                                        console.log('ğŸ”„ Moving event from time slot:', originalDate, originalTimeSlot);

                                        if (hasEventId) {
                                            // v2.1äº‹ä»¶ç§»åŠ¨ï¼šä½¿ç”¨äº‹ä»¶ID
                                            self.handleMoveEventV2(eventId, originalDate, originalTimeSlot, date, timeSlot);
                                        } else {
                                            // v1äº‹ä»¶ç§»åŠ¨ï¼šä½¿ç”¨æ´»åŠ¨ID
                                            self.handleMoveEvent(activityId, originalDate, originalTimeSlot, date, timeSlot);
                                        }
                                    } else {
                                        // ä»æ´»åŠ¨æ± æ‹–æ‹½ï¼Œåˆ›å»ºæ–°äº‹ä»¶ï¼ˆä»…v1å…¼å®¹ï¼‰
                                        if (hasActivityId) {
                                            self.handleDrop(activityId, date, timeSlot);
                                        } else {
                                            console.warn('âš ï¸ å°è¯•ä»æ´»åŠ¨æ± æ‹–æ‹½v2.1äº‹ä»¶ï¼Œè¿™ä¸åº”è¯¥å‘ç”Ÿ');
                                        }
                                    }
                                },
                                // å½“ä»æ—¶é—´æ§½æ‹–æ‹½å…ƒç´ å‡ºå»æ—¶
                                onRemove: function(evt) {
                                    console.log('Item removed from time slot:', {
                                        from: evt.from,
                                        to: evt.to,
                                        toId: evt.to.id,
                                        toClass: evt.to.className
                                    });

                                    // å¦‚æœæ‹–æ‹½åˆ°æ´»åŠ¨æ± ï¼Œè§†ä¸ºåˆ é™¤æ“ä½œ
                                    if (evt.to.id === 'activity-pool') {
                                        const date = evt.from.getAttribute('data-date');
                                        const timeSlot = parseInt(evt.from.getAttribute('data-time-slot'));
                                        const eventId = evt.item.getAttribute('data-event-id');

                                        console.log('Deleting event by drag to pool:', { date, timeSlot, eventId });

                                        if (eventId) {
                                            self.deleteEventById(eventId);
                                        } else {
                                            // å¤‡ç”¨åˆ é™¤æ–¹æ³•ï¼šæ ¹æ®æ—¥æœŸå’Œæ—¶é—´æ§½æŸ¥æ‰¾å¹¶åˆ é™¤
                                            self.deleteEventByDateSlot(date, timeSlot);
                                        }
                                    }
                                    // å¦‚æœæ˜¯ç§»åŠ¨åˆ°å…¶ä»–æ—¶é—´æ§½ï¼ŒonAddä¼šå¤„ç†
                                }
                            });
                            slot.classList.add('sortable-initialized');
                        }
                    });
                    
                    console.log('Drag and drop initialization completed');
                },
                
                // åªåˆå§‹åŒ–æ—¶é—´æ§½çš„æ‹–æ‹½åŠŸèƒ½ï¼ˆç”¨äºåŠ¨æ€é‡æ–°åˆå§‹åŒ–ï¼‰
                initTimeSlotsDragAndDrop() {
                    if (this.currentView !== 'week') {
                        return;
                    }

                    console.log('Re-initializing time slots drag and drop...');
                    const self = this;

                    // æ›´å½»åº•çš„æ¸…ç†æ—¶é—´æ§½çš„Sortableå®ä¾‹
                    document.querySelectorAll('.time-slot').forEach(el => {
                        if (el.sortableInstance) {
                            console.log('Destroying existing sortable instance for time slot');
                            try {
                                el.sortableInstance.destroy();
                            } catch (e) {
                                console.warn('Error destroying sortable instance:', e);
                            }
                            el.sortableInstance = null;
                        }
                        el.classList.remove('sortable-initialized');

                        // æ¸…ç†å¯èƒ½æ®‹ç•™çš„æ‹–æ‹½ç›¸å…³çš„CSSç±»
                        el.classList.remove('sortable-chosen', 'sortable-drag', 'sortable-ghost', 'sortable-over');
                    });

                    // ç­‰å¾…ä¸€å¸§æ¥ç¡®ä¿DOMå®Œå…¨æ¸…ç†
                    requestAnimationFrame(() => {
                        // é‡æ–°åˆå§‹åŒ–æ—¶é—´æ§½çš„æ‹–æ‹½æ¥æ”¶
                        const timeSlots = document.querySelectorAll('.time-slot');
                        console.log('Re-initializing time slots:', timeSlots.length);

                        timeSlots.forEach((slot, index) => {
                            if (!slot.classList.contains('sortable-initialized')) {
                                slot.sortableInstance = Sortable.create(slot, {
                                    group: {
                                        name: 'activities',
                                        pull: true,
                                        put: true
                                    },
                                    animation: 200,
                                    ghostClass: 'sortable-ghost',
                                    chosenClass: 'sortable-chosen',
                                    dragClass: 'sortable-drag',
                                    // æé«˜æ‹–æ‹½åˆ¤æ–­ç²¾åº¦çš„å‚æ•°
                                    tolerance: 'pointer', // ä½¿ç”¨é¼ æ ‡æŒ‡é’ˆä½ç½®åˆ¤æ–­ï¼Œè€Œä¸æ˜¯å…ƒç´ ä¸­å¿ƒ
                                    forceAutoScrollFallback: false, // ç¦ç”¨è‡ªåŠ¨æ»šåŠ¨é¿å…ä½ç½®è®¡ç®—é”™è¯¯
                                    fallbackTolerance: 5, // è®¾ç½®å®¹å·®ä¸º5pxï¼Œæé«˜ç²¾åº¦
                                    onAdd: function(evt) {
                                        console.log('Drop event triggered on slot:', evt.to);

                                        // æ£€æµ‹æ‹–æ‹½æºç±»å‹
                                        const activityId = evt.item.getAttribute('data-activity-id');
                                        const nodeType = evt.item.getAttribute('data-node-type'); // domain æˆ– type
                                        const nodeId = evt.item.getAttribute('data-node-id');
                                        const nodeName = evt.item.getAttribute('data-node-name');

                                        const date = evt.to.getAttribute('data-date');
                                        const timeSlot = parseInt(evt.to.getAttribute('data-time-slot'));
                                        const fromPool = evt.from.id === 'activity-pool';
                                        const fromSidebar = evt.from.id === 'domain-pool' || evt.from.id === 'type-pool';
                                        const fromTimeSlot = evt.from.classList.contains('time-slot');

                                        console.log('ğŸ¯ æ‹–æ‹½æºæ£€æµ‹:', {
                                            æ¥æºç±»å‹: fromSidebar ? 'ä¾§è¾¹æ ' : (fromPool ? 'æ´»åŠ¨æ± ' : 'æ—¶é—´æ§½'),
                                            activityId,
                                            nodeType,
                                            nodeId,
                                            nodeName,
                                            ç›®æ ‡: `${date} ${timeSlot}`
                                        });

                                        // è¯¦ç»†çš„æ‹–æ‹½åˆ¤æ–­è°ƒè¯•ä¿¡æ¯
                                        const targetRect = evt.to.getBoundingClientRect();
                                        const isValidTarget = self.validateDropTarget(evt.to, targetRect);

                                        console.log('ğŸ¯ æ‹–æ‹½ä½ç½®åˆ¤æ–­è¯¦æƒ…:', {
                                            ç›®æ ‡æ§½ä½: `${date} ${timeSlot}`,
                                            ç›®æ ‡æœ‰æ•ˆæ€§: isValidTarget ? 'âœ… æœ‰æ•ˆ' : 'âŒ æ— æ•ˆ',
                                            ç›®æ ‡å…ƒç´ : evt.to,
                                            ç›®æ ‡å…ƒç´ æ ‡ç­¾: evt.to.tagName,
                                            ç›®æ ‡å…ƒç´ ç±»å: evt.to.className,
                                            ç›®æ ‡å…ƒç´ ID: evt.to.id,
                                            ç›®æ ‡å…ƒç´ å¯è§æ€§: window.getComputedStyle(evt.to).display,
                                            ç›®æ ‡å…ƒç´ é€æ˜åº¦: window.getComputedStyle(evt.to).opacity,
                                            ç›®æ ‡å…ƒç´ è¾¹ç•Œ: {
                                                left: targetRect.left,
                                                right: targetRect.right,
                                                top: targetRect.top,
                                                bottom: targetRect.bottom,
                                                width: targetRect.width,
                                                height: targetRect.height
                                            },
                                            æ‹–æ‹½æº: fromPool ? 'æ´»åŠ¨æ± ' : 'æ—¶é—´æ§½',
                                            æ´»åŠ¨ID: activityId,
                                            æ‰€æœ‰æ—¶é—´æ§½å…ƒç´ æ•°é‡: document.querySelectorAll('.time-slot').length,
                                            å½“å‰æ—¶é—´æ§½æ˜¯å¦å­˜åœ¨: document.querySelector(`[data-date="${date}"][data-time-slot="${timeSlot}"]`) !== null
                                        });

                                        // éªŒè¯ç›®æ ‡å…ƒç´ æœ‰æ•ˆæ€§
                                        if (!isValidTarget) {
                                            console.warn('âš ï¸ æ£€æµ‹åˆ°æ— æ•ˆç›®æ ‡å…ƒç´ ï¼Œå°è¯•é‡æ–°å®šä½...');

                                            // å°è¯•æ‰¾åˆ°æœ€è¿‘çš„æœ‰æ•ˆæ—¶é—´æ§½
                                            const validTarget = self.findNearestValidTimeSlot(evt.originalEvent);
                                            if (validTarget) {
                                                console.log('ğŸ”„ é‡å®šå‘åˆ°æœ‰æ•ˆç›®æ ‡:', validTarget);
                                                const newDate = validTarget.getAttribute('data-date');
                                                const newTimeSlot = parseInt(validTarget.getAttribute('data-time-slot'));

                                                console.log('ğŸ¯ é‡å®šå‘åçš„ç›®æ ‡:', {
                                                    åŸç›®æ ‡: `${date} ${timeSlot}`,
                                                    æ–°ç›®æ ‡: `${newDate} ${newTimeSlot}`
                                                });

                                                evt.item.remove();

                                                // ä½¿ç”¨æ–°çš„ç›®æ ‡æ•°æ®
                                                if (fromTimeSlot) {
                                                    self.handleMoveEvent(activityId, evt.from.getAttribute('data-date'),
                                                        parseInt(evt.from.getAttribute('data-time-slot')), newDate, newTimeSlot);
                                                } else {
                                                    self.handleDrop(activityId, newDate, newTimeSlot);
                                                }
                                            } else {
                                                console.error('âŒ æ‰¾ä¸åˆ°æœ‰æ•ˆçš„ç›®æ ‡æ—¶é—´æ§½');
                                                evt.item.remove();
                                            }
                                            return;
                                        }

                                        console.log('Drop details:', {
                                            activityId, date, timeSlot,
                                            fromPool, fromTimeSlot,
                                            fromElement: evt.from.id || evt.from.className
                                        });

                                        // éªŒè¯å¿…è¦æ•°æ®
                                        if (fromSidebar) {
                                            // ä¾§è¾¹æ æ‹–æ‹½ï¼šéœ€è¦nodeType, nodeId, nodeName
                                            if (!nodeType || !nodeId || !nodeName || !date || !timeSlot) {
                                                console.error('Missing required sidebar drop data:', {
                                                    nodeType, nodeId, nodeName, date, timeSlot
                                                });
                                                evt.item.remove();
                                                return;
                                            }
                                        } else {
                                            // æ´»åŠ¨æ± /æ—¶é—´æ§½æ‹–æ‹½ï¼šéœ€è¦activityId
                                            if (!activityId || !date || !timeSlot) {
                                                console.error('Missing required drop data');
                                                evt.item.remove();
                                                return;
                                            }
                                        }

                                        evt.item.remove();

                                        // å¤„ç†ä¸åŒæ¥æºçš„æ‹–æ‹½
                                        if (fromSidebar) {
                                            // ä»ä¾§è¾¹æ æ‹–æ‹½ï¼Œåˆ›å»ºåŸºäºdomain/typeçš„äº‹ä»¶
                                            console.log('ğŸ¯ Processing sidebar drop');
                                            self.handleSidebarDrop(nodeType, nodeId, nodeName, date, timeSlot);
                                        } else if (fromTimeSlot) {
                                            // ä»å…¶ä»–æ—¶é—´æ§½ç§»åŠ¨è¿‡æ¥çš„ï¼Œéœ€è¦å…ˆåˆ é™¤åŸæœ‰äº‹ä»¶
                                            const originalDate = evt.from.getAttribute('data-date');
                                            const originalTimeSlot = parseInt(evt.from.getAttribute('data-time-slot'));
                                            console.log('Moving from time slot:', originalDate, originalTimeSlot);

                                            // å¤„ç†ç§»åŠ¨äº‹ä»¶ï¼ˆå…ˆåˆ é™¤åŸäº‹ä»¶ï¼Œå†åˆ›å»ºæ–°äº‹ä»¶ï¼‰
                                            self.handleMoveEvent(activityId, originalDate, originalTimeSlot, date, timeSlot);
                                        } else {
                                            // ä»æ´»åŠ¨æ± æ‹–æ‹½ï¼Œåˆ›å»ºæ–°äº‹ä»¶
                                            self.handleDrop(activityId, date, timeSlot);
                                        }
                                    },
                                    onRemove: function(evt) {
                                        console.log('Item removed from time slot:', {
                                            from: evt.from,
                                            to: evt.to,
                                            toId: evt.to.id,
                                            toClass: evt.to.className
                                        });

                                        // å¦‚æœæ‹–æ‹½åˆ°æ´»åŠ¨æ± ï¼Œè§†ä¸ºåˆ é™¤æ“ä½œ
                                        if (evt.to.id === 'activity-pool') {
                                            const date = evt.from.getAttribute('data-date');
                                            const timeSlot = parseInt(evt.from.getAttribute('data-time-slot'));
                                            const eventId = evt.item.getAttribute('data-event-id');

                                            console.log('Deleting event by drag to pool:', { date, timeSlot, eventId });

                                            if (eventId) {
                                                self.deleteEventById(eventId);
                                            } else {
                                                // å¤‡ç”¨åˆ é™¤æ–¹æ³•ï¼šæ ¹æ®æ—¥æœŸå’Œæ—¶é—´æ§½æŸ¥æ‰¾å¹¶åˆ é™¤
                                                self.deleteEventByDateSlot(date, timeSlot);
                                            }
                                        }
                                        // å¦‚æœæ˜¯ç§»åŠ¨åˆ°å…¶ä»–æ—¶é—´æ§½ï¼ŒonAddä¼šå¤„ç†
                                    }
                                });
                                slot.classList.add('sortable-initialized');
                            }
                        });

                        console.log('Time slots drag and drop re-initialization completed');
                    });
                },
                
                // æ–°å¢ï¼šå¤„ç†äº‹ä»¶ç§»åŠ¨ï¼ˆä»ä¸€ä¸ªæ—¶é—´æ§½ç§»åŠ¨åˆ°å¦ä¸€ä¸ªæ—¶é—´æ§½ï¼‰
                async handleMoveEvent(activityId, fromDate, fromTimeSlot, toDate, toTimeSlot) {
                    try {
                        console.log('=== MOVE EVENT HANDLER START ===');
                        console.log('Moving event:', {
                            activityId,
                            from: { date: fromDate, timeSlot: fromTimeSlot },
                            to: { date: toDate, timeSlot: toTimeSlot }
                        });

                        // æ£€æŸ¥ç›®æ ‡æ—¶é—´æ§½æ˜¯å¦å·²è¢«å ç”¨
                        const targetEvent = this.getScheduledEvent(toDate, toTimeSlot);
                        if (targetEvent) {
                            alert('ç›®æ ‡æ—¶é—´æ§½å·²æœ‰å®‰æ’ï¼Œæ— æ³•ç§»åŠ¨');
                            // é‡æ–°æ¸²æŸ“ç½‘æ ¼ä»¥æ¢å¤åŸçŠ¶
                            await this.loadWeekSchedule();
                            const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                            if (gridContainer) {
                                gridContainer.innerHTML = this.renderFullWeekGrid();
                                setTimeout(() => {
                                    this.initTimeSlotsDragAndDrop();
                                }, 100);
                            }
                            return;
                        }

                        // æ‰¾åˆ°åŸäº‹ä»¶
                        const originalEvent = this.getScheduledEvent(fromDate, fromTimeSlot);
                        if (!originalEvent) {
                            console.error('Original event not found');
                            alert('æ‰¾ä¸åˆ°åŸå§‹äº‹ä»¶');
                            return;
                        }

                        console.log('Original event found:', originalEvent);

                        // æ›´æ–°äº‹ä»¶çš„æ—¥æœŸå’Œæ—¶é—´æ§½
                        const updateData = {
                            activity_id: parseInt(activityId),
                            event_date: toDate,
                            time_slot: parseInt(toTimeSlot),
                            goal: originalEvent.goal || '',
                            notes: originalEvent.notes || '',
                            status: originalEvent.status || 'planned'
                        };

                        console.log('Updating event with data:', updateData);

                        const result = await this.apiCall(`/events/${originalEvent.id}`, {
                            method: 'PUT',
                            body: JSON.stringify(updateData)
                        });

                        console.log('Event moved successfully:', result);

                        // åˆ·æ–°æ•°æ®å’Œé‡æ–°æ¸²æŸ“
                        await this.loadWeekSchedule();
                        const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                        if (gridContainer) {
                            gridContainer.innerHTML = this.renderFullWeekGrid();
                            console.log('Week grid re-rendered after move');

                            setTimeout(() => {
                                this.initTimeSlotsDragAndDrop();
                                // ç¡®ä¿æ´»åŠ¨æ± çŠ¶æ€æ­£å¸¸
                                this.verifyActivityPoolState();
                            }, 100);
                        }

                        console.log('=== MOVE EVENT HANDLER SUCCESS ===');

                    } catch (error) {
                        console.error('=== MOVE EVENT HANDLER ERROR ===');
                        console.error('ç§»åŠ¨äº‹ä»¶å¤±è´¥:', error);
                        alert('ç§»åŠ¨äº‹ä»¶å¤±è´¥: ' + error.message);

                        // é‡æ–°æ¸²æŸ“ç½‘æ ¼ä»¥æ¢å¤åŸçŠ¶
                        await this.loadWeekSchedule();
                        const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                        if (gridContainer) {
                            gridContainer.innerHTML = this.renderFullWeekGrid();
                            setTimeout(() => {
                                this.initTimeSlotsDragAndDrop();
                            }, 100);
                        }
                    }
                },

                // v2.1 æ–°å¢ï¼šå¤„ç†v2.1äº‹ä»¶çš„ç§»åŠ¨ï¼ˆåŸºäºäº‹ä»¶IDï¼‰
                async handleMoveEventV2(eventId, fromDate, fromTimeSlot, toDate, toTimeSlot) {
                    try {
                        console.log('ğŸ”„ === MOVE EVENT V2 HANDLER START ===');
                        console.log('Moving v2.1 event:', {
                            eventId,
                            from: { date: fromDate, timeSlot: fromTimeSlot },
                            to: { date: toDate, timeSlot: toTimeSlot }
                        });

                        // æ£€æŸ¥ç›®æ ‡æ—¶é—´æ§½æ˜¯å¦å·²è¢«å ç”¨
                        const targetEvent = this.getScheduledEvent(toDate, toTimeSlot);
                        if (targetEvent) {
                            alert('ç›®æ ‡æ—¶é—´æ§½å·²æœ‰å®‰æ’ï¼Œæ— æ³•ç§»åŠ¨');
                            await this.loadWeekSchedule();
                            const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                            if (gridContainer) {
                                gridContainer.innerHTML = this.renderFullWeekGrid();
                                setTimeout(() => { this.initTimeSlotsDragAndDrop(); }, 100);
                            }
                            return;
                        }

                        // æ‰¾åˆ°åŸäº‹ä»¶
                        const originalEvent = this.getScheduledEvent(fromDate, fromTimeSlot);
                        if (!originalEvent) {
                            console.error('âŒ Original event not found');
                            alert('æ‰¾ä¸åˆ°åŸå§‹äº‹ä»¶');
                            return;
                        }

                        console.log('âœ… Original event found:', originalEvent);

                        // æ›´æ–°äº‹ä»¶çš„æ—¥æœŸå’Œæ—¶é—´æ§½
                        const updateData = {
                            event_date: toDate,
                            time_slot: parseInt(toTimeSlot),
                            name: originalEvent.name || originalEvent.activity_name || '',
                            domain_id: originalEvent.domain_id || null,
                            activity_type_id: originalEvent.activity_type_id || null,
                            schedule_id: originalEvent.schedule_id || null,
                            notes: originalEvent.notes || '',
                            status: originalEvent.status || 'planned'
                        };

                        console.log('ğŸ¯ Updating event with data:', updateData);

                        const response = await fetch(`/api/events/${eventId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(updateData)
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.detail || 'Unknown error'}`);
                        }

                        console.log('âœ… Event moved successfully');

                        // åˆ·æ–°æ•°æ®å’Œé‡æ–°æ¸²æŸ“
                        await this.loadWeekSchedule();
                        const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                        if (gridContainer) {
                            gridContainer.innerHTML = this.renderFullWeekGrid();
                            console.log('Week grid re-rendered after v2.1 move');

                            setTimeout(() => {
                                this.initTimeSlotsDragAndDrop();
                            }, 100);
                        }

                        console.log('ğŸ”„ === MOVE EVENT V2 HANDLER SUCCESS ===');

                    } catch (error) {
                        console.error('ğŸ”„ === MOVE EVENT V2 HANDLER ERROR ===');
                        console.error('âŒ ç§»åŠ¨v2.1äº‹ä»¶å¤±è´¥:', error);
                        alert('ç§»åŠ¨äº‹ä»¶å¤±è´¥: ' + error.message);

                        // é‡æ–°æ¸²æŸ“ç½‘æ ¼ä»¥æ¢å¤åŸçŠ¶
                        await this.loadWeekSchedule();
                        const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                        if (gridContainer) {
                            gridContainer.innerHTML = this.renderFullWeekGrid();
                            setTimeout(() => { this.initTimeSlotsDragAndDrop(); }, 100);
                        }
                    }
                },

                // æ–°å¢ï¼šé€šè¿‡äº‹ä»¶IDåˆ é™¤äº‹ä»¶
                async deleteEventById(eventId) {
                    try {
                        console.log('Deleting event by ID:', eventId);

                        await this.apiCall(`/events/${eventId}`, {
                            method: 'DELETE'
                        });

                        console.log('Event deleted successfully');

                        // åˆ·æ–°æ•°æ®å’Œé‡æ–°æ¸²æŸ“
                        await this.loadWeekSchedule();
                        const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                        if (gridContainer) {
                            gridContainer.innerHTML = this.renderFullWeekGrid();
                            setTimeout(() => {
                                this.initTimeSlotsDragAndDrop();
                                // ç¡®ä¿æ´»åŠ¨æ± çŠ¶æ€æ­£å¸¸
                                this.verifyActivityPoolState();
                            }, 100);
                        }

                    } catch (error) {
                        console.error('åˆ é™¤äº‹ä»¶å¤±è´¥:', error);
                        alert('åˆ é™¤äº‹ä»¶å¤±è´¥: ' + error.message);
                    }
                },

                // æ–°å¢ï¼šé€šè¿‡æ—¥æœŸå’Œæ—¶é—´æ§½åˆ é™¤äº‹ä»¶
                async deleteEventByDateSlot(date, timeSlot) {
                    try {
                        console.log('Deleting event by date/slot:', { date, timeSlot });

                        const event = this.getScheduledEvent(date, timeSlot);
                        if (!event) {
                            console.log('No event found at specified slot');
                            return;
                        }

                        await this.deleteEventById(event.id);

                    } catch (error) {
                        console.error('æŒ‰æ—¥æœŸæ—¶é—´æ§½åˆ é™¤äº‹ä»¶å¤±è´¥:', error);
                        alert('åˆ é™¤äº‹ä»¶å¤±è´¥: ' + error.message);
                    }
                },

                // v2.1 æ–°å¢ï¼šå¤„ç†ä»ä¾§è¾¹æ æ‹–æ‹½åˆ›å»ºäº‹ä»¶
                async handleSidebarDrop(nodeType, nodeId, nodeName, date, timeSlot) {
                    try {
                        console.log('ğŸ¯ === SIDEBAR DROP HANDLER START ===');
                        console.log('å¤„ç†ä¾§è¾¹æ æ‹–æ‹½:', { nodeType, nodeId, nodeName, date, timeSlot });

                        // éªŒè¯è¾“å…¥å‚æ•°
                        if (!nodeType || !nodeId || !nodeName || !date || !timeSlot) {
                            console.error('Invalid sidebar drop parameters:', { nodeType, nodeId, nodeName, date, timeSlot });
                            alert('ä¾§è¾¹æ æ‹–æ‹½å‚æ•°é”™è¯¯ï¼Œè¯·é‡è¯•');
                            return;
                        }

                        // æ£€æŸ¥æ˜¯å¦å·²æœ‰äº‹ä»¶
                        const existing = this.getScheduledEvent(date, timeSlot);
                        console.log('ç°æœ‰äº‹ä»¶æ£€æŸ¥:', existing);
                        if (existing) {
                            alert('è¯¥æ—¶é—´æ§½å·²æœ‰å®‰æ’ï¼Œè¯·é€‰æ‹©å…¶ä»–æ—¶é—´æˆ–å…ˆåˆ é™¤ç°æœ‰å®‰æ’');
                            return;
                        }

                        // å¼¹å‡ºç›®æ ‡è¾“å…¥æ¡†ï¼Œè®©ç”¨æˆ·ä¸ºè¿™ä¸ªdomain/typeè®¾ç½®å…·ä½“ç›®æ ‡
                        const goal = prompt(
                            `ä¸ºã€Œ${nodeName}ã€è®¾ç½®å…·ä½“ç›®æ ‡ï¼š\n\nè¯·è¾“å…¥ä½ åœ¨ ${date} ${this.getTimeSlotName(timeSlot)} è¦å®Œæˆçš„å…·ä½“ä»»åŠ¡æˆ–ç›®æ ‡`,
                            nodeName // é»˜è®¤å€¼ä¸ºèŠ‚ç‚¹åç§°
                        );

                        if (goal === null) {
                            console.log('ç”¨æˆ·å–æ¶ˆäº†ç›®æ ‡è®¾ç½®');
                            return;
                        }

                        if (!goal.trim()) {
                            alert('è¯·è¾“å…¥å…·ä½“çš„ç›®æ ‡æˆ–ä»»åŠ¡');
                            return;
                        }

                        // å‡†å¤‡äº‹ä»¶æ•°æ®
                        let eventData = {
                            event_date: date,
                            time_slot: timeSlot,
                            goal: goal.trim(),
                            status: 'scheduled',
                            notes: `æ¥æºï¼š${nodeType === 'domain' ? 'é¢†åŸŸ' : 'ç±»å‹'} - ${nodeName}`
                        };

                        // æ ¹æ®nodeTypeè®¾ç½®ç›¸åº”çš„å­—æ®µ
                        if (nodeType === 'domain') {
                            eventData.domain_id = parseInt(nodeId);
                        } else if (nodeType === 'type') {
                            eventData.activity_type_id = parseInt(nodeId);
                        }

                        console.log('å‡†å¤‡åˆ›å»ºäº‹ä»¶æ•°æ®:', eventData);

                        // è°ƒç”¨APIåˆ›å»ºäº‹ä»¶
                        const response = await fetch('/api/scheduled-events/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(eventData)
                        });

                        console.log('APIå“åº”çŠ¶æ€:', response.status);

                        if (!response.ok) {
                            const error = await response.text();
                            console.error('åˆ›å»ºäº‹ä»¶å¤±è´¥:', error);
                            throw new Error(`åˆ›å»ºäº‹ä»¶å¤±è´¥ (${response.status}): ${error}`);
                        }

                        const newEvent = await response.json();
                        console.log('âœ… äº‹ä»¶åˆ›å»ºæˆåŠŸ:', newEvent);

                        // åˆ·æ–°å‘¨è§†å›¾æ•°æ®
                        await this.loadWeekSchedule();
                        console.log('ğŸ”„ å‘¨è§†å›¾æ•°æ®å·²åˆ·æ–°');

                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        console.log(`âœ¨ æˆåŠŸä¸ºã€Œ${nodeName}ã€åˆ›å»ºäº†è®¡åˆ’ï¼š${goal}`);

                    } catch (error) {
                        console.error('âŒ ä¾§è¾¹æ æ‹–æ‹½åˆ›å»ºäº‹ä»¶å¤±è´¥:', error);
                        alert('åˆ›å»ºäº‹ä»¶å¤±è´¥: ' + error.message);
                    }
                },

                async handleDrop(activityId, date, timeSlot) {
                    try {
                        console.log('=== DROP HANDLER START ===');
                        console.log('Handling drop:', { activityId, date, timeSlot });
                        console.log('Type check:', typeof activityId, typeof date, typeof timeSlot);
                        
                        // éªŒè¯è¾“å…¥å‚æ•°
                        if (!activityId || !date || !timeSlot) {
                            console.error('Invalid drop parameters:', { activityId, date, timeSlot });
                            alert('æ‹–æ‹½å‚æ•°é”™è¯¯ï¼Œè¯·é‡è¯•');
                            return;
                        }
                        
                        // æ£€æŸ¥æ˜¯å¦å·²æœ‰äº‹ä»¶
                        const existing = this.getScheduledEvent(date, timeSlot);
                        console.log('Existing event check:', existing);
                        if (existing) {
                            alert('è¯¥æ—¶é—´æ§½å·²æœ‰å®‰æ’ï¼Œè¯·é€‰æ‹©å…¶ä»–æ—¶é—´æˆ–å…ˆåˆ é™¤ç°æœ‰å®‰æ’');
                            return;
                        }
                        
                        // æ‰¾åˆ°æ´»åŠ¨ä¿¡æ¯
                        console.log('Searching for activity with ID:', activityId, 'in:', this.flatActivities.length, 'activities');
                        const activity = this.flatActivities.find(a => a.id == activityId);
                        console.log('Activity search result:', activity);
                        if (!activity) {
                            console.error('Activity not found:', activityId);
                            console.error('Available activities:', this.flatActivities.map(a => ({ id: a.id, name: a.name })));
                            alert('æœªæ‰¾åˆ°æ´»åŠ¨ä¿¡æ¯ï¼ŒID: ' + activityId);
                            return;
                        }
                        
                        console.log('Found activity:', activity);
                        
                        // åˆ›å»ºæ–°çš„æ—¥ç¨‹äº‹ä»¶
                        const eventData = {
                            activity_id: parseInt(activityId),
                            event_date: date,
                            time_slot: parseInt(timeSlot),
                            goal: '',
                            notes: '',
                            status: 'planned'
                        };
                        
                        console.log('Creating event:', eventData);
                        
                        const result = await this.apiCall('/events/', {
                            method: 'POST',
                            body: JSON.stringify(eventData)
                        });
                        
                        console.log('Event created:', result);
                        
                        // åˆ·æ–°æ•°æ®
                        console.log('Reloading week schedule after successful drop...');
                        await this.loadWeekSchedule();
                        
                        // é‡æ–°æ¸²æŸ“ç½‘æ ¼
                        const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                        if (gridContainer) {
                            gridContainer.innerHTML = this.renderFullWeekGrid();
                            console.log('Week grid re-rendered after drop');

                            // åªé‡æ–°åˆå§‹åŒ–æ—¶é—´æ§½çš„æ‹–æ‹½åŠŸèƒ½ï¼Œä¸å½±å“æ´»åŠ¨æ± 
                            setTimeout(() => {
                                this.initTimeSlotsDragAndDrop();
                                // ç¡®ä¿æ´»åŠ¨æ± çŠ¶æ€æ­£å¸¸
                                this.verifyActivityPoolState();
                            }, 100);
                        }
                        
                        // æ‹–æ‹½æˆåŠŸï¼Œä¸è‡ªåŠ¨æ‰“å¼€ç¼–è¾‘æ¡†
                        // ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨ç‚¹å‡»æ—¶é—´æ§½ä¸­çš„äº‹ä»¶æ¥ç¼–è¾‘
                        
                        console.log('=== DROP HANDLER SUCCESS ===');
                        
                    } catch (error) {
                        console.error('=== DROP HANDLER ERROR ===');
                        console.error('å¤„ç†æ‹–æ‹½å¤±è´¥:', error);
                        console.error('Error details:', {
                            name: error.name,
                            message: error.message,
                            stack: error.stack
                        });
                        alert('åˆ›å»ºæ—¥ç¨‹å¤±è´¥: ' + error.message);
                    }
                },

                // v2.0 æ¸²æŸ“æ–¹æ³•
                renderDomainTree() {
                    if (!this.domains.length) return '<p class="text-muted">æš‚æ— é¢†åŸŸï¼Œ<a href="#" @click="showNewDomainModal = true">ç‚¹å‡»åˆ›å»º</a></p>';

                    const renderNode = (domain, level = 0) => {
                        const children = this.domains.filter(d => d.parent_id === domain.id);
                        const scheduleCount = this.getDomainScheduleCount(domain.id);
                        let html = `
                            <div class="mb-2" style="margin-left: ${level * 20}px;">
                                <div class="d-flex justify-content-between align-items-center border-start border-primary border-3 ps-2 py-1">
                                    <div>
                                        <strong>${domain.name}</strong>
                                        ${scheduleCount > 0 ? `<span class="badge bg-info ms-2">${scheduleCount} æ—¥ç¨‹</span>` : ''}
                                        ${domain.description ? `<br><small class="text-muted">${domain.description}</small>` : ''}
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-info me-1" @click="manageSchedules(${domain.id})" title="ç®¡ç†æ—¥ç¨‹">ğŸ“…</button>
                                        <button class="btn btn-sm btn-outline-primary me-1" @click="editDomain(${domain.id})">ç¼–è¾‘</button>
                                        <button class="btn btn-sm btn-outline-danger" @click="deleteDomain(${domain.id})">åˆ é™¤</button>
                                    </div>
                                </div>
                        `;

                        children.forEach(child => {
                            html += renderNode(child, level + 1);
                        });

                        html += '</div>';
                        return html;
                    };

                    return this.domains.filter(d => !d.parent_id).map(domain => renderNode(domain)).join('');
                },

                renderActivityTypeTree() {
                    if (!this.activityTypes.length) return '<p class="text-muted">æš‚æ— æ´»åŠ¨ç±»å‹ï¼Œ<a href="#" @click="showNewActivityTypeModal = true">ç‚¹å‡»åˆ›å»º</a></p>';

                    const renderNode = (type, level = 0) => {
                        const children = this.activityTypes.filter(t => t.parent_id === type.id);
                        let html = `
                            <div class="mb-2" style="margin-left: ${level * 20}px;">
                                <div class="d-flex justify-content-between align-items-center border-start border-success border-3 ps-2 py-1">
                                    <div>
                                        <strong>${type.name}</strong>
                                        ${type.description ? `<br><small class="text-muted">${type.description}</small>` : ''}
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-success me-1" @click="editActivityType(${type.id})">ç¼–è¾‘</button>
                                        <button class="btn btn-sm btn-outline-danger" @click="deleteActivityType(${type.id})">åˆ é™¤</button>
                                    </div>
                                </div>
                        `;

                        children.forEach(child => {
                            html += renderNode(child, level + 1);
                        });

                        html += '</div>';
                        return html;
                    };

                    return this.activityTypes.filter(t => !t.parent_id).map(type => renderNode(type)).join('');
                },

                // æ±‡æ€»è§†å›¾æ¸²æŸ“ (v1.0ä¿ç•™)
                renderActivityTree() {
                    if (!this.activities.length) return '<p class="text-muted">æš‚æ— æ´»åŠ¨</p>';
                    
                    const renderNode = (activity, level = 0) => {
                        let html = `
                            <div class="mb-2" style="margin-left: ${level * 20}px;">
                                <div class="d-flex justify-content-between align-items-center border-bottom pb-2">
                                    <div>
                                        <strong>${activity.name}</strong>
                                        ${activity.description ? `<br><small class="text-muted">${activity.description}</small>` : ''}
                                    </div>
                                    <div class="text-end">
                                        <button class="btn btn-outline-danger btn-sm" 
                                                onclick="deleteActivity(${activity.id})">
                                            åˆ é™¤
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        if (activity.children && activity.children.length > 0) {
                            activity.children.forEach(child => {
                                html += renderNode(child, level + 1);
                            });
                        }
                        
                        return html;
                    };
                    
                    return this.activities.map(activity => renderNode(activity)).join('');
                },
                
                // å¸¦ç»Ÿè®¡ä¿¡æ¯çš„æ±‡æ€»è§†å›¾æ¸²æŸ“
                renderActivityTreeWithStats() {
                    if (!this.activities.length) return '<p class="text-muted">æš‚æ— æ´»åŠ¨</p>';
                    
                    const renderNode = (activity, level = 0) => {
                        const stats = this.activityStats[activity.id] || {};
                        const totalEvents = stats.total_events || 0;
                        const completedEvents = stats.completed_events || 0;
                        const completionRate = stats.completion_rate || 0;
                        
                        let html = `
                            <div class="mb-3" style="margin-left: ${level * 20}px;">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">${activity.name}</h6>
                                                ${activity.description ? `<p class="text-muted small mb-2">${activity.description}</p>` : ''}
                                                
                                                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                                                <div class="row text-center mb-2">
                                                    <div class="col-4">
                                                        <small class="text-muted d-block">æ€»å®‰æ’</small>
                                                        <strong class="text-primary">${totalEvents}</strong>
                                                    </div>
                                                    <div class="col-4">
                                                        <small class="text-muted d-block">å·²å®Œæˆ</small>
                                                        <strong class="text-success">${completedEvents}</strong>
                                                    </div>
                                                    <div class="col-4">
                                                        <small class="text-muted d-block">å®Œæˆç‡</small>
                                                        <strong class="text-warning">${Math.round(completionRate * 100)}%</strong>
                                                    </div>
                                                </div>
                                                
                                                <!-- Goal åˆ—è¡¨ -->
                                                ${this.renderActivityGoals(stats)}
                                            </div>
                                            <div class="text-end">
                                                <button class="btn btn-outline-primary btn-sm me-2" 
                                                        onclick="window.laeAppInstance.editActivity(${activity.id})">
                                                    ç¼–è¾‘
                                                </button>
                                                <button class="btn btn-outline-danger btn-sm" 
                                                        onclick="deleteActivity(${activity.id})">
                                                    åˆ é™¤
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        if (activity.children && activity.children.length > 0) {
                            activity.children.forEach(child => {
                                html += renderNode(child, level + 1);
                            });
                        }
                        
                        return html;
                    };
                    
                    return this.activities.map(activity => renderNode(activity)).join('');
                },
                
                // æ¸²æŸ“æ´»åŠ¨çš„Goalåˆ—è¡¨
                renderActivityGoals(stats) {
                    if (!stats.sub_activities || !stats.sub_activities.length) {
                        return '<small class="text-muted">æš‚æ— ç›®æ ‡è®°å½•</small>';
                    }
                    
                    let html = '<div class="mt-2"><small class="text-muted d-block mb-1">æœ€è¿‘ç›®æ ‡:</small>';
                    
                    // æ˜¾ç¤ºæœ€è¿‘çš„å‡ ä¸ªgoals
                    let goalCount = 0;
                    for (const subActivity of stats.sub_activities) {
                        if (subActivity.goals && subActivity.goals.length > 0) {
                            for (const goal of subActivity.goals.slice(-3)) { // åªæ˜¾ç¤ºæœ€è¿‘3ä¸ª
                                if (goalCount >= 5) break; // æœ€å¤šæ˜¾ç¤º5ä¸ª
                                
                                const statusColor = goal.status === 'completed' ? 'success' : 'secondary';
                                const statusIcon = goal.status === 'completed' ? 'âœ“' : 'â—‹';
                                
                                html += `
                                    <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                                        <small><span class="text-${statusColor}">${statusIcon}</span> ${goal.goal}</small>
                                        <small class="text-muted">${goal.date}</small>
                                    </div>
                                `;
                                goalCount++;
                            }
                        }
                        if (goalCount >= 5) break;
                    }
                    
                    html += '</div>';
                    return goalCount > 0 ? html : '<small class="text-muted">æš‚æ— ç›®æ ‡è®°å½•</small>';
                },
                
                // æ¸²æŸ“Scheduleæ—¶é—´æ¡
                renderScheduleTimeline() {
                    console.log('ğŸ” renderScheduleTimeline called');
                    console.log('weekDates:', this.weekDates);
                    console.log('weeklySchedules:', this.weeklySchedules);

                    if (!this.weekDates || !this.weekDates.length) {
                        console.log('âš ï¸ weekDates not ready, showing loading message');
                        return '<div class="schedule-timeline-label">æ—¥ç¨‹</div><div class="text-muted p-3">åŠ è½½ä¸­...</div>';
                    }

                    let html = '';

                    // æ ‡é¢˜åˆ—
                    html += '<div class="schedule-timeline-label">æ—¥ç¨‹</div>';

                    // ä¸ºæ¯ä¸€å¤©åˆ›å»ºæ—¶é—´æ¡å®¹å™¨
                    this.weekDates.forEach((dateStr, dayIndex) => {
                        html += `<div class="schedule-timeline-day" data-date="${dateStr}">`;

                        // è®¡ç®—å½“å¤©çš„Scheduleæ—¶é—´æ¡
                        const daySchedules = this.getSchedulesForDay(new Date(dateStr), dayIndex);
                        daySchedules.forEach((schedule, scheduleIndex) => {
                            const colorClass = `schedule-color-${schedule.id % 8}`;
                            const isSpanningSchedule = this.isScheduleSpanningMultipleDays(schedule);
                            const spanInfo = isSpanningSchedule ? this.getScheduleSpanInfo(schedule, new Date(dateStr)) : null;

                            html += `
                                <div class="schedule-bar ${colorClass}"
                                     data-schedule-id="${schedule.id}"
                                     title="${this.getScheduleTooltipText(schedule, spanInfo)}"
                                     @click="editScheduleFromTimeline(${schedule.id})"
                                     @mouseenter="$event.target.style.transform = 'scale(1.02)'"
                                     @mouseleave="$event.target.style.transform = 'scale(1)'">
                                    ${this.getScheduleDisplayText(schedule, spanInfo)}
                                </div>
                            `;
                        });

                        html += '</div>';
                    });

                    return html;
                },

                // è·å–æŒ‡å®šæ—¥æœŸçš„Scheduleæ•°æ®
                getSchedulesForDay(date, dayIndex) {
                    const dateStr = date.toISOString().split('T')[0];
                    const daySchedules = [];

                    this.weeklySchedules.forEach(schedule => {
                        const startDate = schedule.start_date ? new Date(schedule.start_date) : null;
                        const endDate = schedule.deadline ? new Date(schedule.deadline) : null;

                        // æ£€æŸ¥Scheduleæ˜¯å¦è·¨è¶Šè¿™ä¸€å¤©
                        if (this.scheduleSpansDay(schedule, date)) {
                            daySchedules.push({
                                ...schedule,
                                sortKey: endDate ? endDate.getTime() : (startDate ? startDate.getTime() : 0)
                            });
                        }
                    });

                    // æŒ‰æˆªæ­¢æ—¶é—´æ’åºï¼Œå®ç°å‚ç›´å †å 
                    daySchedules.sort((a, b) => a.sortKey - b.sortKey);

                    return daySchedules;
                },

                // æ£€æŸ¥Scheduleæ˜¯å¦è·¨è¶ŠæŒ‡å®šæ—¥æœŸ
                scheduleSpansDay(schedule, date) {
                    const targetDate = new Date(date);
                    targetDate.setHours(0, 0, 0, 0);

                    const startDate = schedule.start_date ? new Date(schedule.start_date) : null;
                    const endDate = schedule.deadline ? new Date(schedule.deadline) : null;

                    if (startDate) startDate.setHours(0, 0, 0, 0);
                    if (endDate) endDate.setHours(0, 0, 0, 0);

                    // å¦‚æœåªæœ‰deadlineï¼Œæ£€æŸ¥æ˜¯å¦åœ¨å½“å¤©æˆ–ä¹‹å‰
                    if (!startDate && endDate) {
                        return targetDate <= endDate;
                    }

                    // å¦‚æœåªæœ‰start_dateï¼Œæ£€æŸ¥æ˜¯å¦åœ¨å½“å¤©æˆ–ä¹‹å
                    if (startDate && !endDate) {
                        return targetDate >= startDate;
                    }

                    // å¦‚æœéƒ½æœ‰ï¼Œæ£€æŸ¥æ˜¯å¦åœ¨èŒƒå›´å†…
                    if (startDate && endDate) {
                        return targetDate >= startDate && targetDate <= endDate;
                    }

                    return false;
                },

                // æ£€æŸ¥Scheduleæ˜¯å¦è·¨è¶Šå¤šå¤©
                isScheduleSpanningMultipleDays(schedule) {
                    const startDate = schedule.start_date ? new Date(schedule.start_date) : null;
                    const endDate = schedule.deadline ? new Date(schedule.deadline) : null;

                    if (!startDate || !endDate) return false;

                    const diffDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                    return diffDays > 0;
                },

                // è·å–Scheduleåœ¨ç‰¹å®šæ—¥æœŸçš„è·¨è¶Šä¿¡æ¯
                getScheduleSpanInfo(schedule, currentDate) {
                    const startDate = schedule.start_date ? new Date(schedule.start_date) : null;
                    const endDate = schedule.deadline ? new Date(schedule.deadline) : null;
                    const weekStart = new Date(this.currentWeekStart);
                    const weekEnd = new Date(this.currentWeekStart);
                    weekEnd.setDate(weekEnd.getDate() + 6);

                    if (!startDate || !endDate) return null;

                    startDate.setHours(0, 0, 0, 0);
                    endDate.setHours(0, 0, 0, 0);
                    currentDate.setHours(0, 0, 0, 0);
                    weekStart.setHours(0, 0, 0, 0);
                    weekEnd.setHours(0, 0, 0, 0);

                    // ä¿®æ­£ï¼šåªæœ‰çœŸæ­£çš„èµ·å§‹/ç»“æŸç‚¹æ‰æ˜¾ç¤ºä¸‰è§’å½¢æ ‡è¯†
                    const isActualFirstDay = currentDate.getTime() === startDate.getTime();
                    const isActualLastDay = currentDate.getTime() === endDate.getTime();
                    const isFirstDayInWeek = currentDate.getTime() === Math.max(startDate.getTime(), weekStart.getTime()) && isActualFirstDay;
                    const isLastDayInWeek = currentDate.getTime() === Math.min(endDate.getTime(), weekEnd.getTime()) && isActualLastDay;
                    const isMiddleDay = currentDate > startDate && currentDate < endDate;

                    return {
                        isFirstDay: isFirstDayInWeek,
                        isLastDay: isLastDayInWeek,
                        isMiddleDay: isMiddleDay,
                        totalDays: Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1
                    };
                },

                // è·å–Scheduleæ˜¾ç¤ºæ–‡æœ¬
                getScheduleDisplayText(schedule, spanInfo) {
                    if (!spanInfo) {
                        return schedule.name;
                    }

                    if (spanInfo.isFirstDay) {
                        return `â—€ ${schedule.name}`;
                    } else if (spanInfo.isLastDay) {
                        return `${schedule.name} â–¶`;
                    } else if (spanInfo.isMiddleDay) {
                        return `â”€â”€ ${schedule.name} â”€â”€`;
                    }

                    return schedule.name;
                },

                // è·å–Scheduleçš„è¯¦ç»†tooltipæ–‡æœ¬
                getScheduleTooltipText(schedule, spanInfo) {
                    let tooltip = `${schedule.name}\n`;

                    if (schedule.start_date) {
                        tooltip += `å¼€å§‹: ${this.formatFullDate(schedule.start_date)}\n`;
                    }

                    if (schedule.deadline) {
                        tooltip += `æˆªæ­¢: ${this.formatFullDate(schedule.deadline)}\n`;
                    }

                    if (schedule.description) {
                        tooltip += `è¯´æ˜: ${schedule.description}\n`;
                    }

                    if (spanInfo) {
                        if (spanInfo.isFirstDay) {
                            tooltip += `çŠ¶æ€: è·¨å¤©æ—¥ç¨‹å¼€å§‹`;
                        } else if (spanInfo.isLastDay) {
                            tooltip += `çŠ¶æ€: è·¨å¤©æ—¥ç¨‹ç»“æŸ`;
                        } else if (spanInfo.isMiddleDay) {
                            tooltip += `çŠ¶æ€: è·¨å¤©æ—¥ç¨‹è¿›è¡Œä¸­`;
                        }
                    } else {
                        tooltip += `çŠ¶æ€: å•æ—¥æ—¥ç¨‹`;
                    }

                    tooltip += `\nç‚¹å‡»ç¼–è¾‘`;
                    return tooltip;
                },

                // æ ¼å¼åŒ–å®Œæ•´æ—¥æœŸæ˜¾ç¤º
                formatFullDate(dateStr) {
                    if (!dateStr) return 'æ— ';
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                },

                // ä»æ—¶é—´æ¡ç¼–è¾‘Schedule
                async editScheduleFromTimeline(scheduleId) {
                    try {
                        console.log('Editing schedule from timeline:', scheduleId);
                        const response = await fetch(`/api/schedules/${scheduleId}`);
                        if (!response.ok) throw new Error('Failed to load schedule');

                        const schedule = await response.json();
                        this.editSchedule(schedule);
                    } catch (error) {
                        console.error('Error editing schedule from timeline:', error);
                        alert('æ— æ³•ç¼–è¾‘æ—¥ç¨‹: ' + error.message);
                    }
                },

                // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
                formatDate(dateStr) {
                    if (!dateStr) return 'æ— ';
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('zh-CN', {
                        month: '2-digit',
                        day: '2-digit'
                    });
                },

                // é‡æ–°æ¸²æŸ“å‘¨è§†å›¾ï¼ˆåŒ…æ‹¬ç½‘æ ¼å’Œæ—¶é—´æ¡ï¼‰
                rerenderWeekView() {
                    const gridContainer = document.querySelector('[x-html="renderFullWeekGrid()"]');
                    const timelineContainer = document.querySelector('[x-html="renderScheduleTimeline()"]');

                    if (gridContainer) {
                        gridContainer.innerHTML = this.renderFullWeekGrid();
                    }

                    if (timelineContainer) {
                        timelineContainer.innerHTML = this.renderScheduleTimeline();
                    }
                },

                // å®Œæ•´å‘¨è§†å›¾ç½‘æ ¼æ¸²æŸ“ï¼ˆåŒ…å«æ ‡é¢˜è¡Œå’Œæ‰€æœ‰æ—¶é—´æ§½ï¼‰
                renderFullWeekGrid() {
                    if (!this.timeSlots.length || !this.weekDates.length) {
                        return '<p class="text-muted">åŠ è½½ä¸­...</p>';
                    }
                    
                    let html = '';
                    
                    console.log('Rendering full week grid:', {
                        timeSlots: this.timeSlots.length,
                        weekDates: this.weekDates.length,
                        totalElements: (this.timeSlots.length + 1) * 8 // (5+1)è¡Œ Ã— 8åˆ—
                    });
                    
                    // 1. ç”Ÿæˆæ ‡é¢˜è¡Œï¼ˆ8ä¸ªå…ƒç´ ï¼š1ä¸ª"æ—¶é—´"æ ‡é¢˜ + 7ä¸ªæ—¥æœŸæ ‡é¢˜ï¼‰
                    html += '<div class="week-header">æ—¶é—´</div>';
                    for (const day of this.weekDates) {
                        const date = new Date(day);
                        const weekday = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'][date.getDay() === 0 ? 6 : date.getDay() - 1];
                        const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
                        html += `
                            <div class="week-header">
                                <div>${weekday}</div>
                                <div>${dateStr}</div>
                            </div>
                        `;
                    }
                    
                    // 2. ä¸ºæ¯ä¸ªæ—¶é—´æ®µç”Ÿæˆä¸€è¡Œï¼ˆ8ä¸ªå…ƒç´ ï¼š1ä¸ªæ—¶é—´æ ‡ç­¾ + 7ä¸ªæ—¶é—´æ§½ï¼‰
                    for (const slot of this.timeSlots) {
                        // æ—¶é—´æ ‡ç­¾ï¼ˆç¬¬ä¸€åˆ—ï¼‰
                        html += `<div class="time-label">${slot.name}</div>`;
                        
                        // è¯¥æ—¶é—´æ®µçš„7ä¸ªæ—¶é—´æ§½ï¼ˆå‘¨ä¸€åˆ°å‘¨æ—¥ï¼‰
                        for (const day of this.weekDates) {
                            const event = this.getScheduledEvent(day, slot.value);
                            const occupiedClass = event ? 'occupied' : '';
                            
                            html += `
                                <div class="time-slot p-2 ${occupiedClass}" 
                                     data-date="${day}" 
                                     data-time-slot="${slot.value}"
                                     onclick="window.laeAppInstance.editScheduledEvent('${day}', ${slot.value})">
                            `;
                            
                            if (event) {
                                html += `
                                    <div class="scheduled-event activity-card"
                                         data-activity-id="${event.activity_id || ''}"
                                         data-event-id="${event.id}"
                                         data-event-name="${event.name || event.activity_name || ''}"
                                         data-domain-id="${event.domain_id || ''}"
                                         data-activity-type-id="${event.activity_type_id || ''}"
                                        <div class="fw-bold mb-1" style="font-size: 0.85rem; line-height: 1.2;">${event.name || event.activity_name || ''}</div>
                                        ${event.goal ? `<div class="mb-1" style="font-size: 0.75rem; color: #666; line-height: 1.3;">${event.goal}</div>` : ''}
                                        ${event.notes ? `<div style="font-size: 0.7rem; color: #888; line-height: 1.2;">å¤‡æ³¨: ${event.notes}</div>` : ''}
                                    </div>
                                `;
                            }
                            
                            html += '</div>';
                        }
                    }
                    
                    console.log('Generated full grid HTML, total elements:', (html.match(/<div/g) || []).length);
                    return html;
                },
                
                // æ¸²æŸ“æ´»åŠ¨æ± 
                renderActivityPool() {
                    if (!this.flatActivities.length) {
                        return '<p class="text-muted">æš‚æ— æ´»åŠ¨</p>';
                    }

                    return this.flatActivities.map(activity => `
                        <div class="activity-card card mb-2" data-activity-id="${activity.id}">
                            <div class="card-body py-2 px-3">
                                <div class="fw-bold" style="font-size: 0.875rem;">${activity.name}</div>
                                <small class="text-muted">${activity.description || ''}</small>
                            </div>
                        </div>
                    `).join('');
                },

                // ä¿ç•™åŸå‡½æ•°ä»¥å¤‡ç”¨
                renderWeekGrid() {
                    return this.renderFullWeekGrid();
                },

                // ========== V3.0 åŠ¨æ€ç”»å¸ƒæ–¹æ³• ==========

                // åˆ‡æ¢ç½‘æ ¼æ¨¡å¼
                switchGridMode() {
                    console.log('ğŸ”„ Switching grid mode to:', this.isV3Mode ? 'V3' : 'V2');

                    // é‡æ–°åˆå§‹åŒ–ç›¸åº”çš„æ‹–æ‹½åŠŸèƒ½
                    this.$nextTick(() => {
                        if (this.isV3Mode) {
                            this.initV3DragAndDrop();
                            this.scrollToCurrentTime();
                        } else {
                            this.initDragAndDrop();
                        }
                    });
                },

                // æ¸²æŸ“æ—¶é—´è½´
                renderTimeAxis() {
                    let html = '';

                    const hours = this.v3TimeEnd - this.v3TimeStart + 1; // ä¿®å¤ï¼š17å°æ—¶ï¼ˆåŒ…å«23:00ï¼‰
                    const gridHeight = hours * 6 * 10 * this.v3ZoomLevel; // 17å°æ—¶ Ã— 6æ ¼/å°æ—¶ Ã— 10px Ã— ç¼©æ”¾
                    const headerHeight = 50; // æ—¥æœŸæ ‡é¢˜è¡Œé«˜åº¦

                    // æ·»åŠ ç©ºç™½æ ‡é¢˜æ ¼å­ï¼Œä¸æ—¥æœŸæ ‡é¢˜è¡Œå¯¹é½
                    html += `
                        <div class="hour-marker header-spacer" style="top: 0px; height: ${headerHeight}px;">
                            <!-- ç©ºç™½æ ‡é¢˜åŒºåŸŸ -->
                        </div>
                    `;

                    // ç°åœ¨å°æ—¶æ ‡è®°ä»headerä¸‹æ–¹å¼€å§‹ï¼Œä¸ç½‘æ ¼å¯¹é½
                    for (let hour = this.v3TimeStart; hour <= this.v3TimeEnd; hour++) {
                        const relativeHour = hour - this.v3TimeStart;
                        const top = headerHeight + (relativeHour * 60 * this.v3ZoomLevel);
                        html += `
                            <div class="hour-marker" style="top: ${top}px; height: ${60 * this.v3ZoomLevel}px;">
                                ${hour.toString().padStart(2, '0')}:00
                            </div>
                        `;
                    }

                    return html;
                },

                // æ¸²æŸ“ç½‘æ ¼çº¿
                renderGridLines() {
                    let html = '';

                    // ä¿®å¤ï¼š7:00-23:00å®é™…æ˜¯17å°æ—¶ï¼ˆåŒ…å«23:00è¿™ä¸ªå®Œæ•´å°æ—¶ï¼‰
                    const hours = this.v3TimeEnd - this.v3TimeStart + 1; // 7åˆ°23åŒ…å«23ï¼Œåº”è¯¥æ˜¯17å°æ—¶
                    const totalGrids = hours * 6; // 17å°æ—¶ Ã— 6æ ¼/å°æ—¶ = 102ä¸ª10åˆ†é’Ÿæ ¼

                    for (let i = 0; i <= totalGrids; i++) {
                        const top = i * 10 * this.v3ZoomLevel; // æ¯ä¸ªç½‘æ ¼10px Ã— ç¼©æ”¾
                        const isHourLine = i % 6 === 0; // æ¯6ä¸ªç½‘æ ¼æ˜¯ä¸€å°æ—¶

                        html += `
                            <div class="${isHourLine ? 'grid-line-hour' : 'grid-line-10min'}"
                                 style="top: ${top}px;">
                            </div>
                        `;
                    }

                    return html;
                },

                // æ¸²æŸ“æ—¥æœŸæ ‡é¢˜
                getDayHeaderV3(day) {
                    const date = new Date(day);
                    const weekday = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'][date.getDay() === 0 ? 6 : date.getDay() - 1];
                    const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
                    return `${weekday}\n${dateStr}`;
                },

                // æ¸²æŸ“å•å¤©çš„ä»»åŠ¡å¡ç‰‡
                renderDayCardsV3(day) {
                    try {
                        let html = '';

                        // è·å–è¯¥æ—¥æœŸçš„æ‰€æœ‰äº‹ä»¶
                        const dayData = this.weekSchedule[day];
                        if (!dayData) {
                            console.log('No events for day:', day);
                            return ''; // è¿”å›ç©ºå­—ç¬¦ä¸²è€Œä¸æ˜¯undefined
                        }

                        const events = Object.values(dayData);
                        // console.log(`Rendering ${events.length} events for ${day}`);

                        events.forEach(event => {
                            try {
                                if (event && event.id) { // æ·»åŠ nullå’Œidæ£€æŸ¥
                                    const cardHtml = this.renderTaskCardV3(event);
                                    if (cardHtml) {
                                        html += cardHtml;
                                    }
                                } else {
                                    // é™é»˜è·³è¿‡nulläº‹ä»¶ï¼Œé¿å…æ§åˆ¶å°å™ªéŸ³
                                }
                            } catch (error) {
                                console.error('Error rendering card for event:', event, error);
                            }
                        });

                        return html;
                    } catch (error) {
                        console.error('Error in renderDayCardsV3:', error);
                        return ''; // ç¡®ä¿å§‹ç»ˆè¿”å›å­—ç¬¦ä¸²
                    }
                },

                // æ¸²æŸ“å•ä¸ªä»»åŠ¡å¡ç‰‡
                renderTaskCardV3(event) {
                    console.log('ğŸ¯ Rendering card for event:', event.id, 'start_time:', event.start_time, 'time_slot:', event.time_slot);

                    // å®‰å…¨è·å–durationï¼Œå¤„ç†null/undefinedæƒ…å†µ
                    const duration = (event.duration !== null && event.duration !== undefined) ? event.duration : 60;
                    const heightPx = Math.max((duration / 10) * 10 * this.v3ZoomLevel, 20 * this.v3ZoomLevel); // æœ€å°20px Ã— ç¼©æ”¾

                    // è®¡ç®—ä½ç½® - ä¼˜å…ˆä½¿ç”¨start_timeï¼Œå›é€€åˆ°time_slot
                    let topPx = 0;
                    let timeForCalculation = null;

                    if (event.start_time && event.start_time !== 'None' && event.start_time !== null) {
                        // æœ‰èµ·å§‹æ—¶é—´ - ç›´æ¥è§£æstart_timeï¼ˆç²¾ç¡®å’Œæ¨¡ç³Šéƒ½æœ‰start_timeï¼‰
                        console.log('ğŸ• Using start_time for position:', event.start_time);
                        timeForCalculation = event.start_time;
                        const [hours, minutes] = event.start_time.split(':').map(Number);
                        const totalMinutes = hours * 60 + minutes;
                        const relativeMinutes = totalMinutes - (this.v3TimeStart * 60); // ç›¸å¯¹äº7:00çš„åˆ†é’Ÿæ•°
                        topPx = Math.max(0, (relativeMinutes / 10) * 10 * this.v3ZoomLevel); // è½¬æ¢ä¸ºç½‘æ ¼å•ä½å¹¶ç¼©æ”¾
                        console.log('ğŸ¯ Calculated position:', { totalMinutes, relativeMinutes, topPx });
                    } else {
                        // å›é€€åˆ°time_slotï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
                        console.log('ğŸ• Using time_slot for position:', event.time_slot);
                        const slotTimes = {
                            21: 8 * 60,   // ä¸Šåˆç¬¬1æ—¶æ®µ: 8:00
                            22: 10 * 60,  // ä¸Šåˆç¬¬2æ—¶æ®µ: 10:00
                            51: 14 * 60,  // ä¸‹åˆç¬¬1æ—¶æ®µ: 14:00
                            52: 16 * 60,  // ä¸‹åˆç¬¬2æ—¶æ®µ: 16:00
                            71: 19 * 60   // æ™šä¸Šæ—¶æ®µ: 19:00
                        };
                        const totalMinutes = slotTimes[event.time_slot] || (8 * 60);
                        const relativeMinutes = totalMinutes - (this.v3TimeStart * 60);
                        topPx = Math.max(0, (relativeMinutes / 10) * 10 * this.v3ZoomLevel);

                        // ä¸ºäº†è°ƒè¯•ï¼Œè®¡ç®—ç­‰æ•ˆçš„start_time
                        const hours = Math.floor(totalMinutes / 60);
                        const minutes = totalMinutes % 60;
                        timeForCalculation = hours + ':' + minutes.toString().padStart(2, '0');
                        console.log('ğŸ¯ Time slot', event.time_slot, 'converted to time:', timeForCalculation);
                    }

                    // å¹¶è¡Œä»»åŠ¡ä½ç½®è°ƒæ•´
                    const parallelClass = event.canvas_position_y > 0 ? 'parallel' : '';
                    const preciseClass = event.is_precise ? 'precise' : '';

                    console.log('ğŸ¯ Final render - topPx:', topPx, 'heightPx:', heightPx, 'timeForCalculation:', timeForCalculation);

                    return `
                        <div class="task-card-v3 ${preciseClass} ${parallelClass}"
                             style="top: ${topPx}px; height: ${heightPx}px;"
                             data-event-id="${event.id}"
                             data-duration="${duration}"
                             onclick="window.laeAppInstance.editEventV3(${event.id}); event.stopPropagation(); return false;">
                            <div class="task-card-title">
                                ${event.name || event.activity_name || 'æœªå‘½åä»»åŠ¡'}
                            </div>
                            <div class="task-card-meta">
                                ${timeForCalculation || 'æœªè®¾ç½®æ—¶é—´'}
                                ${event.is_precise ? ' (ç²¾ç¡®)' : ' (10åˆ†é’Ÿç²¾åº¦)'}
                                (${duration}min)
                            </div>
                        </div>
                    `;
                },

                // æ¸²æŸ“å¾…å®šå¡ç‰‡
                renderPendingCards() {
                    // æš‚æ—¶è¿”å›ç¤ºä¾‹å¡ç‰‡
                    return `
                        <div class="pending-card-v3" data-task="sample1">
                            ç¤ºä¾‹ä»»åŠ¡1
                        </div>
                        <div class="pending-card-v3" data-task="sample2">
                            ç¤ºä¾‹ä»»åŠ¡2
                        </div>
                    `;
                },

                // æ»šåŠ¨åˆ°å½“å‰æ—¶é—´
                scrollToCurrentTime() {
                    const canvas = document.getElementById('week-canvas-v3');
                    if (canvas) {
                        const now = new Date();
                        const currentMinutes = now.getHours() * 60 + now.getMinutes();
                        const scrollTop = Math.max(0, (currentMinutes / 10 * 10) - 200); // å½“å‰æ—¶é—´å¾€ä¸Š200px
                        canvas.scrollTop = scrollTop;
                    }
                },

                // è®¡ç®—æ—¶é—´å¸é™„
                snapToGrid(mouseY) {
                    const canvas = document.getElementById('week-canvas-v3');
                    if (!canvas) return 0;

                    const canvasRect = canvas.getBoundingClientRect();
                    // å‡å»headeré«˜åº¦(60px)ï¼Œå¾—åˆ°ç›¸å¯¹äºç½‘æ ¼å†…å®¹åŒºåŸŸçš„ä½ç½®
                    const relativeY = mouseY - canvasRect.top - 60 + canvas.scrollTop;

                    // å¸é™„åˆ°æœ€è¿‘çš„10åˆ†é’Ÿç½‘æ ¼å•ä½
                    const gridUnit = 10 * this.v3ZoomLevel;
                    const snapY = Math.max(0, Math.round(relativeY / gridUnit) * gridUnit);

                    // console.log('ğŸ§­ å¸é™„è®¡ç®—è°ƒè¯•:', { snapY: snapY });

                    // æ›´æ–°å¸é™„æŒ‡ç¤ºå™¨ä½ç½®ï¼ˆéœ€è¦åŠ å›headeråç§»ç”¨äºæ˜¾ç¤ºï¼‰
                    this.snapIndicatorY = snapY;
                    this.showSnapIndicator(snapY + 60); // æ˜¾ç¤ºæ—¶åŠ å›headeråç§»

                    return snapY;
                },

                // æ˜¾ç¤ºå¸é™„æŒ‡ç¤ºå™¨
                showSnapIndicator(y) {
                    const indicator = document.querySelector('.snap-indicator');
                    if (indicator) {
                        indicator.style.display = 'block';
                        indicator.style.top = y + 'px';
                        indicator.classList.add('active');
                    }
                },

                // éšè—å¸é™„æŒ‡ç¤ºå™¨
                hideSnapIndicator() {
                    const indicator = document.querySelector('.snap-indicator');
                    if (indicator) {
                        indicator.style.display = 'none';
                        indicator.classList.remove('active');
                    }
                },

                // è®¡ç®—æ‹–æ‹½æ”¾ç½®ä½ç½®
                calculateDropPosition(evt) {
                    try {
                        // è·å–æ”¾ç½®ç›®æ ‡çš„æ—¥æœŸåˆ—
                        const dayColumn = evt.to.closest('.day-column-v3');
                        if (!dayColumn) {
                            console.error('âŒ Not dropped in a valid day column');
                            return null;
                        }

                        // è·å–æ—¥æœŸï¼ˆåŸºäºé¼ æ ‡æ°´å¹³ä½ç½®ï¼‰
                        // ç¡®ä¿åªè®¡ç®—day-column-v3å…ƒç´ çš„ç´¢å¼•
                        const daysContainer = dayColumn.parentElement;
                        const dayColumns = daysContainer.querySelectorAll('.day-column-v3');
                        const dayIndex = Array.from(dayColumns).indexOf(dayColumn);

                        const startDate = new Date(this.currentWeekStart);
                        startDate.setDate(startDate.getDate() + dayIndex);
                        const dateStr = startDate.toISOString().split('T')[0];

                        // console.log('ğŸ—“ï¸ ä½ç½®è®¡ç®—:', { dayIndex, dateStr });

                        // ç›´æ¥ä½¿ç”¨è“çº¿æŒ‡ç¤ºå™¨çš„ä½ç½®ï¼ˆç«–ç›´ä½ç½®ï¼‰
                        const snappedY = this.snapIndicatorY;

                        // ç›´æ¥è®¡ç®—è“çº¿å¯¹åº”çš„æ—¶é—´ - ä¿®å¤æ—¶é—´è®¡ç®—é€»è¾‘
                        // snappedYæ˜¯åƒç´ å€¼ï¼Œéœ€è¦è½¬æ¢ä¸ºåˆ†é’Ÿ
                        // æ¯10åˆ†é’Ÿåœ¨ç”»å¸ƒä¸Šå¯¹åº” 10 * this.v3ZoomLevel åƒç´ 
                        const minutesFromStart = Math.round(snappedY / (10 * this.v3ZoomLevel)) * 10;
                        const dropHour = this.v3TimeStart + Math.floor(minutesFromStart / 60);
                        const dropMinute = minutesFromStart % 60;

                        console.log('â° æ‹–æ‹½ç›®æ ‡æ—¶é—´:', `${dropHour}:${dropMinute.toString().padStart(2, '0')}`);

                        const startTime = dropHour + ':' + dropMinute.toString().padStart(2, '0');
                        const timeSlot = this.getTimeSlotFromTime(startTime);

                        // è®¡ç®—å¹¶è¡Œä½ç½®çš„Yåæ ‡(ç”¨äºå¹¶è¡Œä»»åŠ¡)
                        const canvasY = this.calculateCanvasPositionY(dateStr, startTime);

                        // console.log('ğŸ“ ç®€åŒ–ä½ç½®è®¡ç®—:', { è“çº¿ä½ç½®: snappedY, è®¡ç®—æ—¶é—´: startTime, ç›®æ ‡æ—¥æœŸ: dateStr });

                        return {
                            date: dateStr,
                            startTime: startTime,
                            timeSlot: timeSlot,
                            canvasY: canvasY
                        };

                    } catch (error) {
                        console.error('âŒ Error calculating drop position:', error);
                        return null;
                    }
                },

                // è®¡ç®—å¹¶è¡Œä½ç½®çš„Yåæ ‡
                calculateCanvasPositionY(date, startTime) {
                    // æ£€æŸ¥è¯¥æ—¶é—´æ®µæ˜¯å¦å·²ç»æœ‰ä»»åŠ¡
                    const existingTasks = this.getTasksAtTimeSlot(date, startTime);

                    // å¦‚æœæ²¡æœ‰å†²çªï¼Œè¿”å›0
                    if (existingTasks.length === 0) {
                        return 0;
                    }

                    // å¦‚æœæœ‰å†²çªï¼Œè®¡ç®—ä¸‹ä¸€ä¸ªå¯ç”¨çš„Yä½ç½®
                    const maxY = Math.max(...existingTasks.map(task => task.canvas_position_y || 0));
                    return maxY + 1;
                },

                // è·å–æŒ‡å®šæ—¶é—´æ®µçš„ä»»åŠ¡
                getTasksAtTimeSlot(date, startTime) {
                    const tasks = [];

                    // éå†å½“å‰å‘¨çš„æ‰€æœ‰ä»»åŠ¡
                    for (const day in this.weekSchedule) {
                        if (day === date) {
                            for (const slotKey in this.weekSchedule[day]) {
                                const event = this.weekSchedule[day][slotKey];
                                if (event && event.start_time) {
                                    // æ£€æŸ¥æ—¶é—´é‡å 
                                    if (this.isTimeOverlap(event.start_time, event.duration || 60, startTime, 60)) {
                                        tasks.push(event);
                                    }
                                }
                            }
                        }
                    }

                    return tasks;
                },

                // æ£€æŸ¥æ—¶é—´é‡å 
                isTimeOverlap(startTime1, duration1, startTime2, duration2) {
                    const [h1, m1] = startTime1.split(':').map(Number);
                    const [h2, m2] = startTime2.split(':').map(Number);

                    const start1 = h1 * 60 + m1;
                    const end1 = start1 + duration1;
                    const start2 = h2 * 60 + m2;
                    const end2 = start2 + duration2;

                    return !(end1 <= start2 || end2 <= start1);
                },

                // æ›´æ–°å†…å­˜ä¸­çš„äº‹ä»¶æ•°æ®
                updateEventInMemory(updatedEvent) {
                    console.log('ğŸ”„ Updating event in memory:', updatedEvent.id);

                    // å…ˆä»åŸä½ç½®ç§»é™¤äº‹ä»¶
                    for (const day in this.weekSchedule) {
                        for (const slotKey in this.weekSchedule[day]) {
                            const event = this.weekSchedule[day][slotKey];
                            if (event && event.id === updatedEvent.id) {
                                delete this.weekSchedule[day][slotKey];
                                break;
                            }
                        }
                    }

                    // æ·»åŠ åˆ°æ–°ä½ç½®
                    const date = updatedEvent.event_date;
                    const timeSlot = updatedEvent.time_slot;

                    if (!this.weekSchedule[date]) {
                        this.weekSchedule[date] = {};
                    }

                    this.weekSchedule[date][timeSlot] = updatedEvent;
                    console.log('âœ… Event updated in memory:', { date, timeSlot, eventId: updatedEvent.id });
                },

                // é‡æ–°æ¸²æŸ“å•ä¸ªå¡ç‰‡
                renderSingleCardV3(event, domElement) {
                    console.log('ğŸ¨ Re-rendering single card:', event.id);

                    try {
                        // æ£€æŸ¥DOMå…ƒç´ æ˜¯å¦æœ‰æ•ˆ
                        if (!domElement || !domElement.style) {
                            console.error('âŒ Invalid DOM element passed to renderSingleCardV3:', domElement);
                            console.log('ğŸ”„ Falling back to full reload...');
                            this.loadWeekSchedule();
                            return;
                        }

                        // æ›´æ–°DOMå…ƒç´ çš„äº‹ä»¶æ•°æ®
                        domElement.eventData = event;

                        // é‡æ–°è®¡ç®—ä½ç½®
                        const duration = event.duration || 60;
                        const heightPx = Math.max((duration / 10) * 10 * this.v3ZoomLevel, 20 * this.v3ZoomLevel);

                        let topPx = 0;
                        if (event.start_time) {
                            const [hours, minutes] = event.start_time.split(':').map(Number);
                            const totalMinutes = hours * 60 + minutes;
                            const relativeMinutes = totalMinutes - (this.v3TimeStart * 60);
                            topPx = Math.max(0, (relativeMinutes / 10) * 10 * this.v3ZoomLevel);
                        }

                        // æ›´æ–°æ ·å¼
                        domElement.style.top = topPx + 'px';
                        domElement.style.height = heightPx + 'px';

                        // æ›´æ–°å¡ç‰‡å†…å®¹ï¼ˆå¦‚æœéœ€è¦ï¼‰
                        const nameElement = domElement.querySelector('.task-card-title');
                        if (nameElement && event.name) {
                            nameElement.textContent = event.name;
                        }

                        console.log('âœ… Single card re-rendered:', { eventId: event.id, topPx, heightPx });

                    } catch (error) {
                        console.error('âŒ Error re-rendering single card:', error);
                        // å¦‚æœå•ä¸ªé‡æ–°æ¸²æŸ“å¤±è´¥ï¼Œå›é€€åˆ°å®Œæ•´é‡æ–°åŠ è½½
                        this.loadWeekSchedule();
                    }
                },

                // V3æ‹–æ‹½åˆå§‹åŒ–
                initV3DragAndDrop() {
                    console.log('ğŸ¯ Initializing V3 drag and drop...');

                    // åˆå§‹åŒ–ç®€åŒ–çš„åŸç”Ÿæ‹–æ‹½ç³»ç»Ÿ
                    this.initV3NativeDrag();

                    // åˆå§‹åŒ–å¾…å®šåŒºåŸŸæ‹–æ‹½
                    this.initV3PendingAreaDrag();
                },

                // åˆå§‹åŒ–V3åŸç”Ÿæ‹–æ‹½ç³»ç»Ÿ
                initV3NativeDrag() {
                    const self = this;

                    // ä¸ºæ¯ä¸ªå¡ç‰‡æ·»åŠ åŸç”Ÿæ‹–æ‹½äº‹ä»¶ï¼ˆåªå¤„ç†æœªåˆå§‹åŒ–çš„å¡ç‰‡ï¼‰
                    const cards = document.querySelectorAll('.task-card-v3:not([data-drag-initialized])');
                    console.log('ğŸ¯ Initializing drag for', cards.length, 'new V3 cards');

                    cards.forEach(card => {
                        // æ ‡è®°ä¸ºå·²åˆå§‹åŒ–
                        card.setAttribute('data-drag-initialized', 'true');

                        // è®¾ç½®ä¸ºå¯æ‹–æ‹½
                        card.draggable = true;
                        card.style.cursor = 'grab';

                        card.addEventListener('dragstart', function(e) {
                            console.log('ğŸ¯ V3 native drag started for card:', card.dataset.eventId);

                            self.isDragging = true;
                            self.draggedEventId = card.dataset.eventId;

                            // è®¾ç½®æ‹–æ‹½æ•°æ®
                            e.dataTransfer.setData('text/plain', card.dataset.eventId);
                            e.dataTransfer.effectAllowed = 'move';

                            // åˆ›å»ºå®Œå…¨é€æ˜çš„æ‹–æ‹½å›¾åƒï¼Œéšè—é¢„è§ˆæ•ˆæœ
                            const emptyImg = new Image();
                            emptyImg.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAUEBAAAACwAAAAAAQABAAACAkQBADs=';
                            e.dataTransfer.setDragImage(emptyImg, 0, 0);

                            // è§†è§‰åé¦ˆ - åŸå¡ç‰‡åŠé€æ˜
                            card.style.opacity = '0.3';
                            card.style.cursor = 'grabbing';
                        });

                        card.addEventListener('dragend', function(e) {
                            console.log('ğŸ¯ V3 native drag ended');

                            self.isDragging = false;
                            self.draggedEventId = null;
                            self.hideSnapIndicator();

                            // æ¢å¤è§†è§‰æ•ˆæœ
                            card.style.opacity = '1';
                            card.style.cursor = 'grab';
                        });
                    });

                    // ä¸ºæ¯ä¸ªæ—¥æœŸåˆ—è®¾ç½®æ”¾ç½®ç›®æ ‡
                    const dayColumns = document.querySelectorAll('.day-column-v3');
                    dayColumns.forEach((column, index) => {
                        column.addEventListener('dragover', function(e) {
                            e.preventDefault();
                            e.dataTransfer.dropEffect = 'move';

                            // å®æ—¶æ›´æ–°å¸é™„æŒ‡ç¤ºå™¨ï¼ŒåŸºäºé¼ æ ‡ä½ç½®
                            self.snapToGrid(e.clientY);

                            // è§†è§‰åé¦ˆ
                            column.classList.add('day-column-v3-over');
                        });

                        column.addEventListener('dragleave', function(e) {
                            column.classList.remove('day-column-v3-over');
                        });

                        column.addEventListener('drop', function(e) {
                            e.preventDefault();
                            column.classList.remove('day-column-v3-over');

                            // é˜²æ­¢é‡å¤å¤„ç†
                            if (self.dropProcessing) {
                                console.log('ğŸš« Drop already processing in drop event, ignoring');
                                return;
                            }

                            const eventId = e.dataTransfer.getData('text/plain');
                            if (eventId && self.draggedEventId === eventId) {
                                console.log('ğŸ¯ Card dropped in column', index, 'eventId:', eventId);

                                // æ¨¡æ‹ŸSortableäº‹ä»¶å¯¹è±¡
                                const mockEvt = {
                                    item: { getAttribute: () => eventId },
                                    to: column,
                                    originalEvent: e
                                };

                                self.handleV3CardDrop(mockEvt);
                            }
                        });
                    });
                },

                // åˆå§‹åŒ–V3ä¾§è¾¹æ æ‹–æ‹½
                initV3SidebarDrag() {
                    // åˆå§‹åŒ–Domainä¾§è¾¹æ 
                    const domainPool = document.getElementById('domain-pool-v3');
                    if (domainPool && !domainPool.sortableInstance) {
                        domainPool.sortableInstance = Sortable.create(domainPool, {
                            group: {
                                name: 'v3-sidebar',
                                pull: 'clone',
                                put: false
                            },
                            sort: false,
                            animation: 150,

                            onEnd: (evt) => {
                                // ä»ä¾§è¾¹æ æ‹–æ‹½åˆ°ç½‘æ ¼çš„é€»è¾‘
                                if (evt.to.classList.contains('day-column-v3')) {
                                    this.handleSidebarToGridDrop(evt);
                                }
                            }
                        });
                    }

                    // åˆå§‹åŒ–ActivityTypeä¾§è¾¹æ 
                    const typePool = document.getElementById('type-pool-v3');
                    if (typePool && !typePool.sortableInstance) {
                        typePool.sortableInstance = Sortable.create(typePool, {
                            group: {
                                name: 'v3-sidebar',
                                pull: 'clone',
                                put: false
                            },
                            sort: false,
                            animation: 150,

                            onEnd: (evt) => {
                                if (evt.to.classList.contains('day-column-v3')) {
                                    this.handleSidebarToGridDrop(evt);
                                }
                            }
                        });
                    }
                },

                // å¤„ç†ä¾§è¾¹æ åˆ°ç½‘æ ¼çš„æ‹–æ‹½
                handleSidebarToGridDrop(evt) {
                    console.log('ğŸ¯ Sidebar to grid drop', evt);

                    // è·å–èŠ‚ç‚¹ä¿¡æ¯
                    const nodeId = evt.item.getAttribute('data-node-id');
                    const nodeName = evt.item.getAttribute('data-node-name');
                    const nodeType = evt.item.getAttribute('data-node-type');

                    if (nodeId && nodeName && nodeType) {
                        // è®¾ç½®é€‰ä¸­èŠ‚ç‚¹
                        this.selectedNode = {
                            id: parseInt(nodeId),
                            name: nodeName,
                            type: nodeType
                        };

                        // è®¡ç®—æ”¾ç½®ä½ç½®
                        const dropPosition = this.calculateDropPosition(evt);
                        if (dropPosition) {
                            // è‡ªåŠ¨åˆ›å»ºäº‹ä»¶
                            this.createEventFromDrop(dropPosition);
                        }
                    }
                },

                // ä»æ‹–æ‹½ä½ç½®åˆ›å»ºäº‹ä»¶
                async createEventFromDrop(dropPosition) {
                    const eventData = {
                        name: this.selectedNode.name,
                        event_date: dropPosition.date,
                        time_slot: dropPosition.timeSlot,
                        domain_id: this.selectedNode.type === 'domain' ? this.selectedNode.id : null,
                        activity_type_id: this.selectedNode.type === 'type' ? this.selectedNode.id : null,
                        schedule_id: null,
                        notes: '',
                        status: 'planned',
                        // V3 å­—æ®µ
                        duration: 60,
                        start_time: this.formatTimeForAPI(dropPosition.startTime),
                        is_precise: false,
                        canvas_position_y: dropPosition.canvasY
                    };

                    try {
                        const response = await fetch('/api/events/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(eventData)
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        console.log('âœ… Event created from sidebar drop');
                        await this.loadWeekSchedule();

                    } catch (error) {
                        console.error('âŒ Error creating event from drop:', error);
                        alert('åˆ›å»ºäº‹ä»¶å¤±è´¥: ' + error.message);
                    }
                },


                // åˆå§‹åŒ–V3å¾…å®šåŒºåŸŸæ‹–æ‹½
                initV3PendingAreaDrag() {
                    const pendingArea = document.getElementById('pending-cards-v3');

                    if (pendingArea && !pendingArea.sortableInstance) {
                        pendingArea.sortableInstance = Sortable.create(pendingArea, {
                            group: 'v3-tasks',
                            animation: 150,

                            onEnd: (evt) => {
                                console.log('V3 pending drag end');
                                this.handleV3PendingDrop(evt);
                            }
                        });
                    }
                },

                // å¤„ç†V3å¡ç‰‡æ‹–æ‹½ç»“æŸ
                async handleV3CardDrop(evt) {
                    // é˜²æ­¢é‡å¤è§¦å‘
                    if (this.dropProcessing) {
                        console.log('ğŸš« Drop already processing, ignoring duplicate');
                        return;
                    }
                    this.dropProcessing = true;

                    console.log('ğŸ¯ Handling V3 card drop', evt);

                    try {
                        // è·å–è¢«æ‹–æ‹½çš„å¡ç‰‡ä¿¡æ¯
                        const draggedElement = evt.item;
                        const eventId = draggedElement.getAttribute('data-event-id');

                        if (!eventId) {
                            console.error('âŒ No event ID found on dragged element');
                            return;
                        }

                        // è®¡ç®—æ–°çš„ä½ç½®ä¿¡æ¯
                        const newPosition = this.calculateDropPosition(evt);
                        if (!newPosition) {
                            console.error('âŒ Could not calculate drop position');
                            return;
                        }

                        console.log('ğŸ“ Calculated new position:', newPosition);

                        // æ›´æ–°äº‹ä»¶æ•°æ®
                        const updateData = {
                            event_date: newPosition.date,
                            time_slot: newPosition.timeSlot,
                            start_time: this.formatTimeForAPI(newPosition.startTime),
                            canvas_position_y: newPosition.canvasY
                        };

                        // å‘é€APIè¯·æ±‚æ›´æ–°äº‹ä»¶
                        console.log('ğŸ“¤ Sending update data:', updateData);
                        const response = await fetch(`/api/events/${eventId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(updateData)
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('âŒ API Error Details:', {
                                status: response.status,
                                statusText: response.statusText,
                                body: errorText
                            });
                            throw new Error(`HTTP error! status: ${response.status}, details: ${errorText}`);
                        }

                        console.log('âœ… Event updated successfully');

                        // è°ƒè¯•ä¿¡æ¯ï¼šæ£€æŸ¥äº‹ä»¶æ•°æ®
                        console.log('ğŸ” Debug info:', {
                            eventId: eventId,
                            'evt.item': evt.item,
                            'evt.item.eventData': evt.item.eventData,
                            'domElement': evt.item
                        });

                        // ç›´æ¥æ›´æ–°å†…å­˜ä¸­çš„äº‹ä»¶æ•°æ®ï¼Œé¿å…é‡æ–°åŠ è½½å¯¼è‡´å¡ç‰‡æ¶ˆå¤±
                        const updatedEvent = {
                            ...evt.item.eventData,
                            id: eventId, // ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„äº‹ä»¶ID
                            event_date: newPosition.date,
                            start_time: newPosition.startTime,
                            time_slot: newPosition.timeSlot,
                            canvas_position_y: newPosition.canvasY
                        };

                        // æ›´æ–°å†…å­˜ä¸­çš„äº‹ä»¶
                        this.updateEventInMemory(updatedEvent);

                        // åªé‡æ–°æ¸²æŸ“è¿™ä¸ªç‰¹å®šçš„å¡ç‰‡ï¼Œè€Œä¸æ˜¯æ•´ä¸ªå‘¨è§†å›¾
                        this.renderSingleCardV3(updatedEvent, evt.item);

                        // éšè—å¸é™„æŒ‡ç¤ºå™¨
                        this.hideSnapIndicator();

                    } catch (error) {
                        console.error('âŒ Error handling V3 card drop:', error);
                        alert('ç§»åŠ¨å¡ç‰‡å¤±è´¥: ' + error.message);

                        // æ¢å¤åŸä½ç½®
                        await this.loadWeekSchedule();
                    } finally {
                        // é‡ç½®é˜²æŠ–æ ‡å¿—
                        this.dropProcessing = false;
                    }
                },

                // å¤„ç†V3å¾…å®šåŒºåŸŸæ‹–æ‹½ç»“æŸ
                async handleV3PendingDrop(evt) {
                    console.log('ğŸ¯ Handling V3 pending drop', evt);

                    try {
                        // è·å–è¢«æ‹–æ‹½çš„å¡ç‰‡ä¿¡æ¯
                        const draggedElement = evt.item;
                        const eventId = draggedElement.getAttribute('data-event-id');

                        if (eventId) {
                            // ä»ç½‘æ ¼æ‹–æ‹½åˆ°å¾…å®šåŒºåŸŸ - ç§»é™¤æ—¶é—´ä¿¡æ¯
                            const updateData = {
                                start_time: null,
                                is_precise: false,
                                canvas_position_y: 0
                            };

                            const response = await fetch(`/api/events/${eventId}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(updateData)
                            });

                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }

                            console.log('âœ… Event moved to pending area');
                            await this.loadWeekSchedule();
                        } else {
                            // å¾…å®šåŒºåŸŸå†…çš„é‡æ–°æ’åº
                            console.log('ğŸ“‹ Reordered pending cards');
                        }

                    } catch (error) {
                        console.error('âŒ Error handling V3 pending drop:', error);
                        alert('ç§»åŠ¨åˆ°å¾…å®šåŒºåŸŸå¤±è´¥: ' + error.message);
                        await this.loadWeekSchedule();
                    }
                },

                // ç¼–è¾‘V3ä»»åŠ¡
                editEventV3(eventId) {
                    console.log('ğŸ¯ Editing V3 event:', eventId);

                    // æ‰¾åˆ°è¦ç¼–è¾‘çš„äº‹ä»¶
                    let eventToEdit = null;
                    for (const day in this.weekSchedule) {
                        for (const slotKey in this.weekSchedule[day]) {
                            const event = this.weekSchedule[day][slotKey];
                            if (event && event.id === eventId) { // æ·»åŠ nullæ£€æŸ¥
                                eventToEdit = event;
                                break;
                            }
                        }
                        if (eventToEdit) break;
                    }

                    if (!eventToEdit) {
                        console.error('Event not found:', eventId);
                        return;
                    }

                    // ç¡®ä¿time_slotæœ‰æ•ˆï¼Œå¦‚æœæ— æ•ˆåˆ™æ ¹æ®start_timeé‡æ–°è®¡ç®—
                    let validTimeSlot = eventToEdit.time_slot;
                    if (!validTimeSlot || ![21, 22, 51, 52, 71].includes(parseInt(validTimeSlot))) {
                        if (eventToEdit.start_time) {
                            validTimeSlot = this.getTimeSlotFromTime(eventToEdit.start_time);
                            console.log('ğŸ”§ Fixed invalid time_slot for editing, calculated from start_time:', eventToEdit.start_time, '->', validTimeSlot);
                        } else {
                            validTimeSlot = 21; // é»˜è®¤å€¼
                            console.log('ğŸ”§ Fixed invalid time_slot for editing, using default:', validTimeSlot);
                        }
                    }

                    // è®¾ç½®ç¼–è¾‘æ¨¡å¼çš„æ•°æ®
                    this.editingEvent = {
                        id: eventToEdit.id,
                        name: eventToEdit.name || '',
                        event_date: eventToEdit.event_date,
                        time_slot: validTimeSlot,
                        domain_id: eventToEdit.domain_id || '',
                        activity_type_id: eventToEdit.activity_type_id || '',
                        schedule_id: eventToEdit.schedule_id || '',
                        notes: eventToEdit.notes || '',
                        // V3 å­—æ®µ
                        duration: eventToEdit.duration || 60,
                        start_time: eventToEdit.start_time || null,
                        is_precise: eventToEdit.is_precise || false,
                        canvas_position_y: eventToEdit.canvas_position_y || 0
                    };

                    this.showEditEventModal = true;
                },

                // æ ¼å¼åŒ–æ—¶é—´ä¸ºAPIæ ¼å¼
                formatTimeForAPI(timeStr) {
                    if (!timeStr || timeStr === 'None' || timeStr === null) {
                        return null;
                    }

                    // å¦‚æœæ˜¯ç®€å•çš„HH:MMæ ¼å¼ï¼Œè½¬æ¢ä¸ºHH:MM:SS
                    if (timeStr.split(':').length === 2) {
                        return timeStr + ':00';
                    }

                    return timeStr;
                },

                // V3ç½‘æ ¼ç‚¹å‡»å¤„ç†
                handleV3GridClick(event, day) {
                    console.log('ğŸ¯ V3 Grid clicked:', day, event);

                    // ç¡®ä¿ä¸æ˜¯å¡ç‰‡ç‚¹å‡»äº‹ä»¶ - æ£€æŸ¥æ•´ä¸ªäº‹ä»¶è·¯å¾„
                    if (event.target.closest('.task-card-v3')) {
                        console.log('ğŸš« Clicked on task card, ignoring grid click');
                        return;
                    }

                    // è®¡ç®—ç‚¹å‡»ä½ç½®å¯¹åº”çš„æ—¶é—´
                    const rect = event.currentTarget.getBoundingClientRect();
                    const canvasRect = document.getElementById('week-canvas-v3').getBoundingClientRect();
                    const relativeY = event.clientY - canvasRect.top - 60; // å‡å»headeré«˜åº¦

                    // è®¡ç®—å¯¹åº”çš„æ—¶é—´ï¼ˆå¸é™„åˆ°10åˆ†é’Ÿç½‘æ ¼ï¼‰- ä¿®å¤æ—¶é—´è®¡ç®—
                    const minutesFromStart = Math.max(0, Math.round(relativeY / (10 * this.v3ZoomLevel)) * 10);
                    const clickHour = this.v3TimeStart + Math.floor(minutesFromStart / 60);
                    const clickMinute = minutesFromStart % 60;

                    console.log('ğŸ¯ Calculated time:', clickHour + ':' + clickMinute.toString().padStart(2, '0'));

                    // è®¡ç®—èµ·å§‹æ—¶é—´ - æ¨¡ç³Šå’Œç²¾ç¡®å¡ç‰‡éƒ½æœ‰èµ·å§‹æ—¶é—´ï¼Œåªæ˜¯ç²¾åº¦ä¸åŒ
                    const startTimeStr = clickHour + ':' + clickMinute.toString().padStart(2, '0');

                    console.log('ğŸ¯ Selected node for V3 creation:', this.selectedNode);

                    // æ ¹æ®æ˜¯å¦æœ‰é€‰ä¸­èŠ‚ç‚¹å†³å®šåˆ›å»ºæ–¹å¼ï¼ˆé‡‡ç”¨V2çš„é€»è¾‘ï¼‰
                    if (this.selectedNode.id) {
                        // æœ‰é€‰ä¸­èŠ‚ç‚¹ - è‡ªåŠ¨å¡«å…¥ä¿¡æ¯
                        this.newEvent = {
                            name: this.selectedNode.name, // ğŸ¯ è‡ªåŠ¨å¡«å…¥é€‰ä¸­èŠ‚ç‚¹åç§°
                            event_date: day,
                            time_slot: this.getTimeSlotFromTime(startTimeStr),
                            domain_id: this.selectedNode.type === 'domain' ? this.selectedNode.id : '',
                            activity_type_id: this.selectedNode.type === 'type' ? this.selectedNode.id : '',
                            schedule_id: '',
                            notes: '',
                            // V3 æ–°å­—æ®µ
                            duration: 60,
                            start_time: startTimeStr,
                            is_precise: false,
                            canvas_position_y: 0
                        };
                        console.log('âœ¨ Created V3 event with selected node:', this.selectedNode.name);
                    } else {
                        // æ²¡æœ‰é€‰ä¸­èŠ‚ç‚¹ - ç©ºç™½åˆ›å»º
                        this.newEvent = {
                            name: '',
                            event_date: day,
                            time_slot: this.getTimeSlotFromTime(startTimeStr),
                            domain_id: '',
                            activity_type_id: '',
                            schedule_id: '',
                            notes: '',
                            // V3 æ–°å­—æ®µ
                            duration: 60,
                            start_time: startTimeStr,
                            is_precise: false,
                            canvas_position_y: 0
                        };
                        console.log('ğŸ“„ Created V3 event from blank');
                    }

                    this.showNewEventModal = true;
                },

                // æ ¹æ®å°æ—¶è·å–å¯¹åº”çš„æ—¶é—´æ§½
                getTimeSlotFromHour(hour) {
                    if (hour >= 7 && hour < 10) return 21; // ä¸Šåˆç¬¬1æ—¶æ®µ
                    if (hour >= 10 && hour < 13) return 22; // ä¸Šåˆç¬¬2æ—¶æ®µ
                    if (hour >= 13 && hour < 16) return 51; // ä¸‹åˆç¬¬1æ—¶æ®µ
                    if (hour >= 16 && hour < 19) return 52; // ä¸‹åˆç¬¬2æ—¶æ®µ
                    if (hour >= 19 && hour <= 23) return 71; // æ™šä¸Šæ—¶æ®µ
                    return 21; // é»˜è®¤
                },

                // æ ¹æ®æ—¶é—´å­—ç¬¦ä¸²è·å–å¯¹åº”çš„æ—¶é—´æ§½
                getTimeSlotFromTime(timeStr) {
                    if (!timeStr) return 21;

                    const [hours] = timeStr.split(':').map(Number);
                    return this.getTimeSlotFromHour(hours);
                },

                // è·å–æ—¶é—´æ§½çš„æ˜¾ç¤ºåç§°
                getTimeSlotDisplay(timeStr) {
                    console.log('ğŸ¯ getTimeSlotDisplay called with:', timeStr);

                    if (!timeStr || timeStr === 'None' || timeStr === null) {
                        console.log('ğŸ¯ No time string, returning "æœªè®¾ç½®"');
                        return 'æœªè®¾ç½®';
                    }

                    const timeSlot = this.getTimeSlotFromTime(timeStr);
                    console.log('ğŸ¯ Calculated time slot:', timeSlot);

                    const timeSlotNames = {
                        21: "ä¸Šåˆç¬¬1æ—¶æ®µ (7-10ç‚¹)",
                        22: "ä¸Šåˆç¬¬2æ—¶æ®µ (10-13ç‚¹)",
                        51: "ä¸‹åˆç¬¬1æ—¶æ®µ (13-16ç‚¹)",
                        52: "ä¸‹åˆç¬¬2æ—¶æ®µ (16-19ç‚¹)",
                        71: "æ™šä¸Šæ—¶æ®µ (19-23ç‚¹)"
                    };

                    const result = timeSlotNames[timeSlot] || `æ—¶æ®µ${timeSlot}`;
                    console.log('ğŸ¯ Time slot display result:', result);
                    return result;
                },

                // æ›´æ–°æ—¶é—´æ§½ï¼ˆå½“èµ·å§‹æ—¶é—´æ”¹å˜æ—¶è°ƒç”¨ï¼‰
                updateTimeSlot() {
                    console.log('ğŸ• updateTimeSlot called, start_time:', this.newEvent.start_time);
                    if (this.newEvent.start_time) {
                        const oldTimeSlot = this.newEvent.time_slot;
                        this.newEvent.time_slot = this.getTimeSlotFromTime(this.newEvent.start_time);
                        console.log('ğŸ• Updated time slot from', oldTimeSlot, 'to:', this.newEvent.time_slot, 'for time:', this.newEvent.start_time);
                    } else {
                        console.log('ğŸ• No start_time set, keeping current time_slot:', this.newEvent.time_slot);
                    }
                },

                // æ›´æ–°ç¼–è¾‘äº‹ä»¶çš„æ—¶é—´æ§½
                updateEditingTimeSlot() {
                    if (this.editingEvent.start_time) {
                        this.editingEvent.time_slot = this.getTimeSlotFromTime(this.editingEvent.start_time);
                        console.log('ğŸ”§ Updated editing time slot to:', this.editingEvent.time_slot, 'for time:', this.editingEvent.start_time);
                    }
                },

                // è®¡ç®—ç»“æŸæ—¶é—´
                calculateEndTime(startTime, duration) {
                    if (!startTime || !duration) return '';

                    const [hours, minutes] = startTime.split(':').map(Number);
                    const totalMinutes = hours * 60 + minutes + parseInt(duration);
                    const endHours = Math.floor(totalMinutes / 60);
                    const endMinutes = totalMinutes % 60;

                    return endHours.toString().padStart(2, '0') + ':' + endMinutes.toString().padStart(2, '0');
                },

                // V3æ™ºèƒ½å¸é™„ç³»ç»Ÿ
                snapToV3Grid(mouseY, canvasRect) {
                    // è®¡ç®—ç›¸å¯¹äºç”»å¸ƒçš„Yåæ ‡
                    const relativeY = mouseY - canvasRect.top - 60; // å‡å»headeré«˜åº¦

                    // å¸é™„åˆ°æœ€è¿‘çš„10åˆ†é’Ÿç½‘æ ¼
                    const gridUnit = 10 * this.v3ZoomLevel; // 10åˆ†é’Ÿç½‘æ ¼çš„åƒç´ é«˜åº¦
                    const snappedY = Math.round(relativeY / gridUnit) * gridUnit;

                    // è½¬æ¢ä¸ºæ—¶é—´ - ä¿®å¤æ—¶é—´è®¡ç®—
                    const minutesFromStart = Math.round(snappedY / (10 * this.v3ZoomLevel)) * 10;
                    const hour = this.v3TimeStart + Math.floor(minutesFromStart / 60);
                    const minute = minutesFromStart % 60;

                    // ç¡®ä¿åœ¨æœ‰æ•ˆæ—¶é—´èŒƒå›´å†…
                    if (hour < this.v3TimeStart || hour > this.v3TimeEnd) {
                        return null;
                    }

                    return {
                        y: snappedY + 60, // åŠ å›headeré«˜åº¦
                        time: hour.toString().padStart(2, '0') + ':' + minute.toString().padStart(2, '0'),
                        hour: hour,
                        minute: minute
                    };
                },

                // æ˜¾ç¤ºV3å¸é™„æŒ‡ç¤ºå™¨
                showV3SnapIndicator(snapData) {
                    if (!snapData) {
                        this.v3SnapIndicator.visible = false;
                        return;
                    }

                    this.v3SnapIndicator.visible = true;
                    this.v3SnapIndicator.y = snapData.y;
                    this.v3SnapIndicator.tooltip = `ğŸ“ ${snapData.time}`;
                },

                // éšè—V3å¸é™„æŒ‡ç¤ºå™¨
                hideV3SnapIndicator() {
                    this.v3SnapIndicator.visible = false;
                },

                // æ¸…ç†æ‹–æ‹½å®ä¾‹
                cleanupDragInstances() {
                    // æ¸…ç†æ‰€æœ‰ç°æœ‰çš„sortableå®ä¾‹
                    document.querySelectorAll('.sortable-initialized').forEach(el => {
                        if (el.sortableInstance) {
                            el.sortableInstance.destroy();
                        }
                        el.classList.remove('sortable-initialized');
                    });
                },

                // ç¼©æ”¾æ§åˆ¶
                adjustZoom(delta) {
                    const newZoom = this.v3ZoomLevel + delta;
                    if (newZoom >= 0.5 && newZoom <= 2.0) {
                        this.v3ZoomLevel = newZoom;
                        console.log('ğŸ” V3 zoom adjusted to:', Math.round(newZoom * 100) + '%');

                        // é‡æ–°æ¸²æŸ“ç”»å¸ƒ
                        this.$nextTick(() => {
                            this.rerenderV3Canvas();
                        });
                    }
                },

                // è®¡ç®—ç”»å¸ƒé«˜åº¦
                getCanvasHeight() {
                    const hours = this.v3TimeEnd - this.v3TimeStart + 1; // ä¿®å¤ï¼š17å°æ—¶ï¼ˆåŒ…å«23:00ï¼‰
                    return (hours * 60 * this.v3ZoomLevel) + 60; // 17å°æ—¶ Ã— 60px/å°æ—¶ Ã— ç¼©æ”¾ + é¡¶éƒ¨padding
                },

                // é‡æ–°æ¸²æŸ“V3ç”»å¸ƒ
                rerenderV3Canvas() {
                    if (!this.isV3Mode) return;

                    const timeAxisContainer = document.querySelector('[x-html="renderTimeAxis()"]');
                    const gridLinesContainer = document.querySelector('[x-html="renderGridLines()"]');

                    if (timeAxisContainer) {
                        timeAxisContainer.innerHTML = this.renderTimeAxis();
                    }

                    if (gridLinesContainer) {
                        gridLinesContainer.innerHTML = this.renderGridLines();
                    }

                    // é‡æ–°æ¸²æŸ“æ‰€æœ‰æ—¥æœŸåˆ—çš„å¡ç‰‡
                    this.weekDates.forEach(day => {
                        const dayCardContainer = document.querySelector(`[x-html="renderDayCardsV3('${day}')"]`);
                        if (dayCardContainer) {
                            dayCardContainer.innerHTML = this.renderDayCardsV3(day);
                        }
                    });

                    console.log('ğŸ¨ V3 canvas re-rendered with zoom:', this.v3ZoomLevel);

                    // é‡æ–°åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½ï¼ˆç¼©æ”¾åå¡ç‰‡éœ€è¦é‡æ–°ç»‘å®šäº‹ä»¶ï¼‰
                    this.$nextTick(() => {
                        this.initV3DragAndDrop();
                    });
                },
                
                // æ–°å¢ï¼šåˆ·æ–°æ´»åŠ¨æ± æ–¹æ³•
                refreshActivityPool() {
                    console.log('Refreshing activity pool...');
                    const activityPool = document.getElementById('activity-pool');
                    if (!activityPool) {
                        console.error('Activity pool not found');
                        return;
                    }

                    // é”€æ¯ç°æœ‰çš„ Sortable å®ä¾‹
                    if (activityPool.sortableInstance) {
                        activityPool.sortableInstance.destroy();
                        activityPool.sortableInstance = null;
                    }
                    activityPool.classList.remove('sortable-initialized');

                    // è§¦å‘Alpine.jsé‡æ–°æ¸²æŸ“æ´»åŠ¨æ± ï¼ˆx-htmlä¼šè‡ªåŠ¨é‡æ–°æ¸²æŸ“ï¼‰
                    console.log('Triggering Alpine.js re-render for activity pool');

                    // ç­‰å¾…Alpine.jsé‡æ–°æ¸²æŸ“å®Œæˆï¼Œç„¶åé‡æ–°åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
                    this.$nextTick(() => {
                        console.log('Activity pool re-rendered, re-initializing drag and drop');
                        this.initActivityPoolDragAndDrop();
                    });
                },

                // æ–°å¢ï¼šéªŒè¯æ‹–æ‹½ç›®æ ‡æœ‰æ•ˆæ€§
                validateDropTarget(targetElement, targetRect) {
                    // æ£€æŸ¥åŸºæœ¬æœ‰æ•ˆæ€§
                    if (!targetElement || !targetElement.classList.contains('time-slot')) {
                        return false;
                    }

                    // æ£€æŸ¥å…ƒç´ æ˜¯å¦å¯è§å’Œæœ‰è¾¹ç•Œ
                    if (targetRect.width === 0 || targetRect.height === 0) {
                        console.warn('ç›®æ ‡å…ƒç´ è¾¹ç•Œä¸º0');
                        return false;
                    }

                    // æ£€æŸ¥å…ƒç´ æ˜¯å¦åœ¨è§†å£å†…
                    if (targetRect.left === 0 && targetRect.top === 0 &&
                        targetRect.right === 0 && targetRect.bottom === 0) {
                        console.warn('ç›®æ ‡å…ƒç´ ä½ç½®å…¨ä¸º0');
                        return false;
                    }

                    // æ£€æŸ¥CSSæ˜¾ç¤ºçŠ¶æ€
                    const computedStyle = window.getComputedStyle(targetElement);
                    if (computedStyle.display === 'none' || computedStyle.visibility === 'hidden') {
                        console.warn('ç›®æ ‡å…ƒç´ è¢«éšè—');
                        return false;
                    }

                    return true;
                },

                // æ–°å¢ï¼šæ ¹æ®é¼ æ ‡ä½ç½®æ‰¾åˆ°æœ€è¿‘çš„æœ‰æ•ˆæ—¶é—´æ§½
                findNearestValidTimeSlot(mouseEvent) {
                    if (!mouseEvent) {
                        console.warn('æ²¡æœ‰é¼ æ ‡äº‹ä»¶ä¿¡æ¯');
                        return null;
                    }

                    const mouseX = mouseEvent.clientX || mouseEvent.pageX;
                    const mouseY = mouseEvent.clientY || mouseEvent.pageY;

                    console.log('é¼ æ ‡ä½ç½®:', { x: mouseX, y: mouseY });

                    // è·å–æ‰€æœ‰æœ‰æ•ˆçš„æ—¶é—´æ§½
                    const timeSlots = Array.from(document.querySelectorAll('.time-slot')).filter(slot => {
                        const rect = slot.getBoundingClientRect();
                        return this.validateDropTarget(slot, rect);
                    });

                    console.log('æ‰¾åˆ°æœ‰æ•ˆæ—¶é—´æ§½æ•°é‡:', timeSlots.length);

                    if (timeSlots.length === 0) {
                        return null;
                    }

                    // æ‰¾åˆ°è·ç¦»é¼ æ ‡æœ€è¿‘çš„æ—¶é—´æ§½
                    let nearestSlot = null;
                    let minDistance = Infinity;

                    timeSlots.forEach(slot => {
                        const rect = slot.getBoundingClientRect();
                        const centerX = rect.left + rect.width / 2;
                        const centerY = rect.top + rect.height / 2;

                        const distance = Math.sqrt(
                            Math.pow(mouseX - centerX, 2) + Math.pow(mouseY - centerY, 2)
                        );

                        if (distance < minDistance) {
                            minDistance = distance;
                            nearestSlot = slot;
                        }
                    });

                    console.log('æœ€è¿‘æ—¶é—´æ§½è·ç¦»:', minDistance);
                    return nearestSlot;
                },

                // æ–°å¢ï¼šéªŒè¯æ´»åŠ¨æ± çŠ¶æ€
                verifyActivityPoolState() {
                    console.log('Verifying activity pool state...');
                    const activityPool = document.getElementById('activity-pool');
                    if (!activityPool) {
                        console.error('Activity pool not found during verification');
                        return;
                    }

                    const currentCards = activityPool.querySelectorAll('.activity-card');
                    const expectedCount = this.flatActivities.length;

                    console.log('Activity pool verification:', {
                        currentCards: currentCards.length,
                        expectedCount: expectedCount,
                        isInitialized: activityPool.classList.contains('sortable-initialized')
                    });

                    // å¦‚æœå¡ç‰‡æ•°é‡ä¸åŒ¹é…æˆ–è€…æ²¡æœ‰åˆå§‹åŒ–ï¼Œåˆ·æ–°æ´»åŠ¨æ± 
                    if (currentCards.length !== expectedCount || !activityPool.classList.contains('sortable-initialized')) {
                        console.warn('Activity pool state incorrect, refreshing...');
                        this.refreshActivityPool();
                    } else {
                        console.log('Activity pool state verified - all good');
                    }
                },

                // æ–°å¢ï¼šä»…åˆå§‹åŒ–æ´»åŠ¨æ± çš„æ‹–æ‹½åŠŸèƒ½
                initActivityPoolDragAndDrop() {
                    console.log('Initializing activity pool drag and drop...');
                    const activityPool = document.getElementById('activity-pool');
                    if (!activityPool || activityPool.classList.contains('sortable-initialized')) {
                        console.log('Activity pool already initialized or not found');
                        return;
                    }

                    const self = this;

                    activityPool.sortableInstance = Sortable.create(activityPool, {
                        group: {
                            name: 'activities',
                            pull: 'clone', // ç¡®ä¿æ˜¯å…‹éš†æ¨¡å¼
                            put: function(to, from) {
                                // åªå…è®¸ä»time-slotæ‹–æ‹½å›æ´»åŠ¨æ± ï¼ˆåˆ é™¤åŠŸèƒ½ï¼‰
                                return from.classList && from.classList.contains('time-slot');
                            }
                        },
                        sort: false, // æ´»åŠ¨æ± å†…ä¸å…è®¸æ’åº
                        animation: 200,
                        ghostClass: 'sortable-ghost',
                        chosenClass: 'sortable-chosen',
                        dragClass: 'sortable-drag',
                        // å…³é”®ï¼šç¡®ä¿å…‹éš†è¡Œä¸ºæ­£ç¡®
                        onClone: function(evt) {
                            console.log('Activity cloned from pool:', evt.clone);
                            const originalId = evt.item.getAttribute('data-activity-id');
                            if (originalId) {
                                evt.clone.setAttribute('data-activity-id', originalId);
                            }
                        },
                        // ä»æ´»åŠ¨æ± å¼€å§‹æ‹–æ‹½æ—¶
                        onStart: function(evt) {
                            console.log('Drag started from activity pool:', evt.item.getAttribute('data-activity-id'));
                            evt.item.classList.add('dragging-from-pool');
                        },
                        // æ‹–æ‹½ç»“æŸæ—¶çš„æ¸…ç†å’Œæ¢å¤
                        onEnd: function(evt) {
                            console.log('Drag ended from activity pool');

                            // æ¸…ç†æ ‡è®°
                            if (evt.item) {
                                evt.item.classList.remove('dragging-from-pool');
                            }

                            // æ£€æŸ¥æ´»åŠ¨æ± çŠ¶æ€
                            const currentCards = activityPool.querySelectorAll('.activity-card');
                            console.log('Activity pool cards after drag:', currentCards.length, 'Expected:', self.flatActivities.length);

                            // å¦‚æœå¡ç‰‡æ•°é‡ä¸åŒ¹é…ï¼Œå¼ºåˆ¶åˆ·æ–°
                            if (currentCards.length !== self.flatActivities.length) {
                                console.warn('Activity pool cards count mismatch, forcing refresh');
                                setTimeout(() => {
                                    self.refreshActivityPool();
                                }, 100);
                            }
                        },
                        // å¤„ç†åˆ é™¤æ“ä½œï¼ˆä»æ—¶é—´æ§½æ‹–å›æ´»åŠ¨æ± ï¼‰
                        onAdd: function(evt) {
                            console.log('Item dropped back to activity pool - deleting event');
                            evt.item.remove();
                            // åˆ é™¤æ“ä½œç”±æ—¶é—´æ§½çš„ onRemove å¤„ç†
                        }
                    });

                    activityPool.classList.add('sortable-initialized');
                    console.log('Activity pool sortable initialized successfully');
                },

                // =============================================================================
                // ä¾§è¾¹æ åŠŸèƒ½ v2.1 (äº¤äº’é©å‘½)
                // =============================================================================

                // è®¾ç½®ä¾§è¾¹æ æ¨¡å¼
                setSidebarMode(mode) {
                    console.log('ğŸ”„ Setting sidebar mode to:', mode);
                    this.sidebarMode = mode;

                    // åŠ è½½ç›¸åº”çš„æ•°æ®
                    if (mode === 'domain') {
                        this.loadDomainTree();
                    } else if (mode === 'type') {
                        this.loadTypeTree();
                    }

                    // æ¸…é™¤å½“å‰é€‰ä¸­èŠ‚ç‚¹ï¼ˆåˆ‡æ¢æ¨¡å¼æ—¶ï¼‰
                    if (this.selectedNode.id && this.selectedNode.type !== mode) {
                        console.log('ğŸ”„ Clearing selected node due to mode switch');
                        this.clearSelectedNode();
                    }
                },

                // åŠ è½½Domainå±‚çº§æ ‘æ•°æ®
                async loadDomainTree() {
                    try {
                        console.log('ğŸ“‚ Loading domain tree...');
                        const response = await fetch('/api/domains/tree');
                        if (!response.ok) throw new Error('Failed to load domain tree');

                        this.domainTree = await response.json();
                        console.log('âœ… Domain tree loaded:', this.domainTree.length, 'root nodes');

                        // ç­‰å¾…DOMæ›´æ–°åé‡æ–°åˆå§‹åŒ–æ‹–æ‹½
                        this.$nextTick(() => {
                            setTimeout(() => {
                                console.log('ğŸ”„ Re-initializing drag after domain tree load...');
                                // v2.1 ä¸å†éœ€è¦æ‹–æ‹½åˆå§‹åŒ–
                            }, 50);
                        });
                    } catch (error) {
                        console.error('âŒ Error loading domain tree:', error);
                        this.domainTree = [];
                    }
                },

                // åŠ è½½ActivityTypeå±‚çº§æ ‘æ•°æ®
                async loadTypeTree() {
                    try {
                        console.log('ğŸ·ï¸ Loading activity type tree...');
                        const response = await fetch('/api/activity-types/tree');
                        if (!response.ok) throw new Error('Failed to load activity type tree');

                        this.typeTree = await response.json();
                        console.log('âœ… Activity type tree loaded:', this.typeTree.length, 'root nodes');

                        // ç­‰å¾…DOMæ›´æ–°åé‡æ–°åˆå§‹åŒ–æ‹–æ‹½
                        this.$nextTick(() => {
                            setTimeout(() => {
                                console.log('ğŸ”„ Re-initializing drag after type tree load...');
                                // v2.1 ä¸å†éœ€è¦æ‹–æ‹½åˆå§‹åŒ–
                            }, 50);
                        });
                    } catch (error) {
                        console.error('âŒ Error loading activity type tree:', error);
                        this.typeTree = [];
                    }
                },

                // æ¸²æŸ“é€‰æ‹©é¢æ¿Domainæ ‘ï¼ˆv2.1ä¸“ç”¨ï¼Œç‚¹å‡»é€‰æ‹©ï¼‰
                renderSelectionDomainTree() {
                    if (!this.domainTree.length) {
                        return '<p class="text-muted">æš‚æ— é¢†åŸŸæ•°æ®</p>';
                    }
                    return this.renderSelectionTreeNodes(this.domainTree, 'domain');
                },

                // æ¸²æŸ“é€‰æ‹©é¢æ¿ActivityTypeæ ‘ï¼ˆv2.1ä¸“ç”¨ï¼Œç‚¹å‡»é€‰æ‹©ï¼‰
                renderSelectionTypeTree() {
                    if (!this.typeTree.length) {
                        return '<p class="text-muted">æš‚æ— ç±»å‹æ•°æ®</p>';
                    }
                    return this.renderSelectionTreeNodes(this.typeTree, 'type');
                },

                // æ¸²æŸ“æ ‘èŠ‚ç‚¹çš„é€’å½’æ–¹æ³•
                renderTreeNodes(nodes, nodeType) {
                    return nodes.map(node => {
                        const hasChildren = node.children && node.children.length > 0;
                        const isCollapsed = this.collapsedNodes.has(`${nodeType}-${node.id}`);
                        const toggleIcon = hasChildren ? (isCollapsed ? 'â–¶' : 'â–¼') : '';
                        const nodeKey = `${nodeType}-${node.id}`;

                        // æ£€æŸ¥æ˜¯å¦è¢«é€‰ä¸­ï¼ˆä½¿ç”¨V2å…¼å®¹çš„selectedNodeæ–¹å¼ï¼‰
                        const isSelected = this.selectedNode.id === node.id && this.selectedNode.type === nodeType;
                        const selectedClass = isSelected ? 'tree-node-selected' : '';

                        let html = `
                            <div class="tree-node">
                                <div class="tree-node-content draggable ${selectedClass}"
                                     data-node-type="${nodeType}"
                                     data-node-id="${node.id}"
                                     data-node-name="${node.name}"
                                     onclick="window.laeAppInstance.selectNode('${nodeType}', ${node.id}, '${node.name}'); event.stopPropagation();">
                                    ${hasChildren ?
                                        `<button class="tree-toggle ${isCollapsed ? '' : 'expanded'}"
                                                onclick="window.laeAppInstance.toggleNode('${nodeKey}'); event.stopPropagation();">
                                            ${toggleIcon}
                                        </button>` :
                                        `<div style="width: 16px; margin-right: 0.5rem;"></div>`
                                    }
                                    <div style="flex: 1;">
                                        <div class="tree-node-label">${node.name}</div>
                                        ${node.description ?
                                            `<div class="tree-node-description">${node.description}</div>` :
                                            ''
                                        }
                                    </div>
                                </div>
                        `;

                        if (hasChildren && !isCollapsed) {
                            html += `
                                <div class="tree-children">
                                    ${this.renderTreeNodes(node.children, nodeType)}
                                </div>
                            `;
                        }

                        html += '</div>';
                        return html;
                    }).join('');
                },

                // åˆ‡æ¢èŠ‚ç‚¹å±•å¼€/æŠ˜å çŠ¶æ€
                toggleNode(nodeKey) {
                    console.log('ğŸ”„ Toggling node:', nodeKey);

                    if (this.collapsedNodes.has(nodeKey)) {
                        this.collapsedNodes.delete(nodeKey);
                        console.log('ğŸ“‚ Expanded node:', nodeKey);
                    } else {
                        this.collapsedNodes.add(nodeKey);
                        console.log('ğŸ“ Collapsed node:', nodeKey);
                    }

                    // è§¦å‘é‡æ–°æ¸²æŸ“
                    this.refreshTrigger++;
                },

                // é€‰æ‹©ä¾§è¾¹æ èŠ‚ç‚¹ - V3ç‰ˆæœ¬ï¼Œå…¼å®¹V2çš„selectedNodeç³»ç»Ÿ
                selectNode(nodeType, nodeId, nodeName) {
                    console.log('ğŸ¯ V3 Selecting node:', nodeType, nodeId, nodeName);

                    // å¦‚æœç‚¹å‡»çš„æ˜¯å·²é€‰ä¸­çš„èŠ‚ç‚¹ï¼Œåˆ™å–æ¶ˆé€‰æ‹©
                    if (this.selectedNode.id === nodeId && this.selectedNode.type === nodeType) {
                        this.selectedNode = { id: null, name: '', type: '', description: '' };
                        this.selectedDomainId = null;
                        this.selectedActivityTypeId = null;
                        console.log('ğŸ¯ Deselected node');
                    } else {
                        // é€‰ä¸­æ–°èŠ‚ç‚¹ï¼ŒåŒæ—¶æ›´æ–°V2å…¼å®¹å­—æ®µå’ŒV3ä¸“ç”¨å­—æ®µ
                        this.selectedNode = {
                            id: nodeId,
                            name: nodeName,
                            type: nodeType,
                            description: ''
                        };

                        if (nodeType === 'domain') {
                            this.selectedDomainId = nodeId;
                            this.selectedActivityTypeId = null;
                        } else if (nodeType === 'type') {
                            this.selectedActivityTypeId = nodeId;
                            this.selectedDomainId = null;
                        }

                        console.log('ğŸ¯ Selected node:', this.selectedNode);
                    }

                    // è§¦å‘é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°é€‰ä¸­çŠ¶æ€æ ·å¼
                    this.refreshTrigger++;
                },

                // æ¸²æŸ“é€‰æ‹©æ ‘èŠ‚ç‚¹çš„é€’å½’æ–¹æ³•ï¼ˆå¯ç‚¹å‡»é€‰æ‹©ï¼‰
                renderSelectionTreeNodes(nodes, nodeType) {
                    return nodes.map(node => {
                        const hasChildren = node.children && node.children.length > 0;
                        const isCollapsed = this.collapsedNodes.has(`${nodeType}-${node.id}`);
                        const toggleIcon = hasChildren ? (isCollapsed ? 'â–¶' : 'â–¼') : '';
                        const nodeKey = `${nodeType}-${node.id}`;
                        const isSelected = this.selectedNode.id === node.id && this.selectedNode.type === nodeType;

                        let html = `
                            <div class="tree-node">
                                <div class="tree-node-content selectable ${isSelected ? 'selected' : ''}"
                                     onclick="window.laeAppInstance.selectNode('${nodeType}', ${node.id}, '${node.name.replace(/'/g, "\\'")}', '${(node.description || '').replace(/'/g, "\\'")}')">
                                    ${hasChildren ?
                                        `<button class="tree-toggle ${isCollapsed ? '' : 'expanded'}"
                                                onclick="event.stopPropagation(); window.laeAppInstance.toggleNode('${nodeKey}')">
                                            ${toggleIcon}
                                        </button>` :
                                        `<div style="width: 16px; margin-right: 0.5rem;"></div>`
                                    }
                                    <div style="flex: 1;">
                                        <div class="tree-node-label">
                                            ${isSelected ? '<strong>âœ“ ' + node.name + '</strong>' : node.name}
                                        </div>
                                        ${node.description ?
                                            `<div class="tree-node-description">${node.description}</div>` :
                                            ''
                                        }
                                    </div>
                                </div>
                        `;

                        if (hasChildren && !isCollapsed) {
                            html += `
                                <div class="tree-children">
                                    ${this.renderSelectionTreeNodes(node.children, nodeType)}
                                </div>
                            `;
                        }

                        html += '</div>';
                        return html;
                    }).join('');
                },

                // é€‰ä¸­èŠ‚ç‚¹
                selectNode(nodeType, nodeId, nodeName, nodeDescription) {
                    console.log('ğŸ¯ Selecting node:', { nodeType, nodeId, nodeName });
                    this.selectedNode = {
                        id: nodeId,
                        name: nodeName,
                        type: nodeType,
                        description: nodeDescription || ''
                    };
                    // è§¦å‘é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°é€‰ä¸­çŠ¶æ€
                    this.refreshTrigger++;
                },

                // æ¸…é™¤é€‰ä¸­èŠ‚ç‚¹
                clearSelectedNode() {
                    console.log('ğŸ”„ Clearing selected node');
                    this.selectedNode = {
                        id: null,
                        name: '',
                        type: '',
                        description: ''
                    };
                    // è§¦å‘é‡æ–°æ¸²æŸ“
                    this.refreshTrigger++;
                },

                // åˆå§‹åŒ–ä¾§è¾¹æ æ‹–æ‹½åŠŸèƒ½
                initSidebarDragAndDrop() {
                    console.log('ğŸ¯ Initializing sidebar drag and drop...');

                    // åªåœ¨å‘¨è§†å›¾ä¸­åˆå§‹åŒ–ä¾§è¾¹æ æ‹–æ‹½åŠŸèƒ½
                    if (this.currentView !== 'week') {
                        console.log('Sidebar drag and drop skipped - not in week view');
                        return;
                    }

                    const domainPool = document.getElementById('domain-pool');
                    const typePool = document.getElementById('type-pool');

                    console.log('ğŸ¯ Sidebar elements found:', {
                        domainPool: !!domainPool,
                        typePool: !!typePool,
                        domainPoolVisible: domainPool ? !domainPool.hidden : false,
                        typePoolVisible: typePool ? !typePool.hidden : false
                    });

                    if (domainPool) {
                        console.log('ğŸ¯ Initializing domain pool drag...');
                        this.initPoolDragAndDrop(domainPool, 'domain');
                    } else {
                        console.warn('âš ï¸ Domain pool not found');
                    }

                    if (typePool) {
                        console.log('ğŸ¯ Initializing type pool drag...');
                        this.initPoolDragAndDrop(typePool, 'type');
                    } else {
                        console.warn('âš ï¸ Type pool not found');
                    }
                },

                // ä¸ºç‰¹å®šæ± åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
                initPoolDragAndDrop(poolElement, poolType) {
                    if (poolElement.sortableInstance) {
                        poolElement.sortableInstance.destroy();
                    }

                    const self = this;

                    // æ·»åŠ æµ‹è¯•ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
                    poolElement.addEventListener('mousedown', function(e) {
                        console.log('ğŸ–±ï¸ Mouse down on pool element:', {
                            target: e.target,
                            className: e.target.className,
                            tagName: e.target.tagName,
                            closest_draggable: e.target.closest('.tree-node-content')
                        });
                    });

                    poolElement.sortableInstance = Sortable.create(poolElement, {
                        group: {
                            name: 'activities',
                            pull: 'clone'
                        },
                        sort: false,
                        // æ˜ç¡®æŒ‡å®šåªæ‹–æ‹½.tree-node-contentå…ƒç´ 
                        draggable: '.tree-node-content',
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        chosenClass: 'sortable-chosen',
                        onStart: function(evt) {
                            console.log('ğŸ¯ Starting drag from', poolType, 'pool');
                            console.log('ğŸ¯ Dragging item:', {
                                nodeType: evt.item.getAttribute('data-node-type'),
                                nodeId: evt.item.getAttribute('data-node-id'),
                                nodeName: evt.item.getAttribute('data-node-name'),
                                element: evt.item,
                                elementClass: evt.item.className,
                                parentElement: evt.item.parentElement
                            });
                        },
                        onEnd: function(evt) {
                            console.log('ğŸ¯ Drag ended from', poolType, 'pool');
                            // æ¸…ç†å…‹éš†å…ƒç´ 
                            if (evt.clone && evt.clone !== evt.item) {
                                evt.clone.remove();
                            }
                        }
                    });

                    console.log('âœ…', poolType, 'pool drag initialized');
                },

                // =============================================================================
                // å·¥å…·æ–¹æ³•
                getCurrentDateString() {
                    return this.currentDate.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        weekday: 'long'
                    });
                },
                
                getWeekTitle() {
                    if (this.weekDates.length === 0) return '';
                    const start = new Date(this.weekDates[0]);
                    const end = new Date(this.weekDates[6]);
                    return `${start.getMonth() + 1}æœˆ${start.getDate()}æ—¥ - ${end.getMonth() + 1}æœˆ${end.getDate()}æ—¥`;
                },
                
                getMonthTitle() {
                    return `${this.currentYear}å¹´${this.currentMonth}æœˆ`;
                },
                
                // æœˆè§†å›¾ç›¸å…³æ–¹æ³•
                previousMonth() {
                    this.currentMonth--;
                    if (this.currentMonth < 1) {
                        this.currentMonth = 12;
                        this.currentYear--;
                    }
                    this.loadMonthSchedule();
                },
                
                nextMonth() {
                    this.currentMonth++;
                    if (this.currentMonth > 12) {
                        this.currentMonth = 1;
                        this.currentYear++;
                    }
                    this.loadMonthSchedule();
                },
                
                async loadMonthSchedule() {
                    try {
                        console.log(`Loading month schedule for ${this.currentYear}-${this.currentMonth}`);
                        
                        // æ¸²æŸ“æœˆå†ï¼ˆç°åœ¨ç›´æ¥åœ¨renderMonthCalendarä¸­åŠ è½½æ•°æ®ï¼‰
                        await this.renderMonthCalendar();
                        
                        console.log('Month schedule loaded and rendered');
                    } catch (error) {
                        console.error('åŠ è½½æœˆæ—¥ç¨‹å¤±è´¥:', error);
                        const monthCalendarContainer = document.getElementById('month-calendar');
                        if (monthCalendarContainer) {
                            monthCalendarContainer.innerHTML = '<p class="text-danger">åŠ è½½æœˆè§†å›¾å¤±è´¥</p>';
                        }
                    }
                },
                
                // æ±‡æ€»è§†å›¾ç›¸å…³æ–¹æ³•
                async initSummaryData() {
                    console.log('Initializing summary data...');
                    await this.generateAvailableMonths();
                    await this.loadSummaryStatistics();
                    await this.loadActivityStatistics();
                    await this.loadDomainScheduleCounts();  // åŠ è½½Domainçš„Scheduleæ•°é‡
                },
                
                generateAvailableMonths() {
                    // ç”Ÿæˆå¯é€‰æ‹©çš„æœˆä»½åˆ—è¡¨ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼ŒåŸºäºå½“å‰æ—¥æœŸï¼‰
                    const now = new Date();
                    const months = [];
                    
                    // æ·»åŠ å½“å‰æœˆå’Œå‰é¢å‡ ä¸ªæœˆ
                    for (let i = 2; i >= 0; i--) {
                        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                        months.push({
                            value: `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`,
                            label: `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ`
                        });
                    }
                    
                    this.availableMonths = months;
                    console.log('Available months:', this.availableMonths);
                },
                
                async loadSummaryStatistics() {
                    try {
                        console.log('Loading summary statistics for month:', this.summaryMonth);
                        let endpoint = '/statistics/summary';
                        
                        // å¦‚æœé€‰æ‹©äº†ç‰¹å®šæœˆä»½ï¼Œæ·»åŠ æŸ¥è¯¢å‚æ•°ï¼ˆå‡è®¾åç«¯æ”¯æŒï¼‰
                        if (this.summaryMonth) {
                            endpoint += `?month=${this.summaryMonth}`;
                        }
                        
                        this.summaryStats = await this.apiCall(endpoint);
                        console.log('Summary statistics loaded:', this.summaryStats);
                    } catch (error) {
                        console.error('Failed to load summary statistics:', error);
                        this.summaryStats = {
                            total_activities: 0,
                            total_events: 0,
                            completed_events: 0,
                            completion_rate: 0
                        };
                    }
                },
                
                async loadActivityStatistics() {
                    try {
                        console.log('Loading activity statistics...');
                        this.activityStats = {};
                        
                        // ä¸ºæ¯ä¸ªæ´»åŠ¨åŠ è½½ç»Ÿè®¡æ•°æ®
                        for (const activity of this.flatActivities) {
                            const stats = await this.apiCall(`/statistics/activities/${activity.id}/statistics`);
                            this.activityStats[activity.id] = stats;
                            console.log(`Stats for ${activity.name}:`, stats);
                        }
                    } catch (error) {
                        console.error('Failed to load activity statistics:', error);
                        this.activityStats = {};
                    }
                },
                
                formatWeekday(dateString) {
                    const date = new Date(dateString);
                    return ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'][date.getDay() === 0 ? 6 : date.getDay() - 1];
                },
                
                formatDate(dateString) {
                    const date = new Date(dateString);
                    return `${date.getMonth() + 1}/${date.getDate()}`;
                },
                
                // æœˆå†æ¸²æŸ“ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼Œæ˜¾ç¤ºäº‹ä»¶æ•°é‡ï¼‰
                async renderMonthCalendar() {
                    try {
                        // é‡æ–°åŠ è½½æœˆæ•°æ®ä»¥è·å–å®Œæ•´çš„å¤©æ•°ä¿¡æ¯
                        const data = await this.apiCall(`/calendar/month/${this.currentYear}/${this.currentMonth}`);
                        
                        if (!data.days || data.days.length === 0) {
                            const monthCalendarContainer = document.getElementById('month-calendar');
                            if (monthCalendarContainer) {
                                monthCalendarContainer.innerHTML = '<p class="text-muted">æ— æ³•åŠ è½½æœˆè§†å›¾æ•°æ®</p>';
                            }
                            return;
                        }
                        
                        const firstDay = new Date(this.currentYear, this.currentMonth - 1, 1);
                        const lastDay = new Date(this.currentYear, this.currentMonth, 0);
                        
                        // è®¡ç®—æœˆå†åº”è¯¥ä»å“ªä¸€å¤©å¼€å§‹ï¼ˆå‘¨ä¸€ï¼‰
                        const startDate = new Date(firstDay);
                        const dayOfWeek = firstDay.getDay() === 0 ? 7 : firstDay.getDay();
                        startDate.setDate(firstDay.getDate() - dayOfWeek + 1);
                        
                        // è®¡ç®—æœˆå†åº”è¯¥åˆ°å“ªä¸€å¤©ç»“æŸï¼ˆç¡®ä¿å®Œæ•´çš„å‘¨ï¼‰
                        const endDate = new Date(lastDay);
                        const endDayOfWeek = lastDay.getDay() === 0 ? 7 : lastDay.getDay();
                        endDate.setDate(lastDay.getDate() + (7 - endDayOfWeek));
                        
                        // åˆ›å»ºæ—¥æœŸåˆ°äº‹ä»¶æ•°é‡çš„æ˜ å°„
                        const dayEventsMap = {};
                        data.days.forEach(day => {
                            dayEventsMap[day.date] = {
                                event_count: day.event_count,
                                is_today: day.is_today
                            };
                        });

                        // ä¿å­˜Scheduleæ•°æ®ä¾›æ¸²æŸ“ä½¿ç”¨
                        this.monthSchedules = data.schedules || [];
                        
                        let html = '';
                        let currentDate = new Date(startDate);
                        
                        // æŒ‰å‘¨æ¸²æŸ“
                        while (currentDate <= endDate) {
                            html += '<div class="row mb-1">';
                            
                            // ä¸€å‘¨7å¤©
                            for (let i = 0; i < 7; i++) {
                                const dateStr = currentDate.toISOString().split('T')[0];
                                const dayData = dayEventsMap[dateStr] || { event_count: 0, is_today: false };
                                const isCurrentMonth = currentDate.getMonth() === this.currentMonth - 1;
                                
                                let cellClass = 'col border p-2';
                                if (!isCurrentMonth) {
                                    cellClass += ' text-muted bg-light';
                                }
                                if (dayData.is_today) {
                                    cellClass += ' bg-warning bg-opacity-25 fw-bold';
                                }
                                
                                html += `<div class="${cellClass}" style="min-height: 100px; position: relative;">`;
                                html += `<div class="fw-bold">${currentDate.getDate()}</div>`;

                                // æ˜¾ç¤ºäº‹ä»¶æ•°é‡ï¼ˆåº•å±‚ï¼‰
                                if (dayData.event_count > 0) {
                                    html += `
                                        <div class="mt-2">
                                            <span class="badge bg-primary">${dayData.event_count} ä¸ªæ—¥ç¨‹</span>
                                        </div>
                                    `;
                                }

                                // æ¸²æŸ“Scheduleæ—¶é—´æ¡ï¼ˆé¡¶å±‚ï¼ŒåŠé€æ˜ï¼‰
                                const dayScheduleBars = this.getMonthScheduleBarsForDay(currentDate);
                                if (dayScheduleBars.length > 0) {
                                    html += '<div class="schedule-bars-container">';
                                    dayScheduleBars.forEach(bar => {
                                        html += `
                                            <div class="month-schedule-bar schedule-color-${bar.id % 8}"
                                                 data-schedule-id="${bar.id}"
                                                 title="${bar.name}${bar.tooltip}"
                                                 style="opacity: 0.8;"
                                                 onclick="window.laeAppInstance.editScheduleFromTimeline(${bar.id})">
                                                ${bar.displayText}
                                            </div>
                                        `;
                                    });
                                    html += '</div>';
                                }

                                html += '</div>';
                                
                                // ç§»åŠ¨åˆ°ä¸‹ä¸€å¤©
                                currentDate.setDate(currentDate.getDate() + 1);
                            }
                            
                            html += '</div>';
                        }
                        
                        // æ›´æ–°DOM
                        const monthCalendarContainer = document.getElementById('month-calendar');
                        if (monthCalendarContainer) {
                            monthCalendarContainer.innerHTML = html;
                        }
                    } catch (error) {
                        console.error('æ¸²æŸ“æœˆå†å¤±è´¥:', error);
                        const monthCalendarContainer = document.getElementById('month-calendar');
                        if (monthCalendarContainer) {
                            monthCalendarContainer.innerHTML = '<p class="text-danger">åŠ è½½æœˆè§†å›¾å¤±è´¥</p>';
                        }
                    }
                },

                // è·å–æŒ‡å®šæ—¥æœŸçš„æœˆè§†å›¾Scheduleæ—¶é—´æ¡
                getMonthScheduleBarsForDay(date) {
                    if (!this.monthSchedules) return [];

                    const targetDate = new Date(date);
                    targetDate.setHours(0, 0, 0, 0);
                    const bars = [];

                    this.monthSchedules.forEach(schedule => {
                        if (this.scheduleSpansDay(schedule, targetDate)) {
                            const spanInfo = this.getMonthScheduleSpanInfo(schedule, targetDate);
                            bars.push({
                                id: schedule.id,
                                name: schedule.name,
                                displayText: this.getMonthScheduleDisplayText(schedule, spanInfo),
                                tooltip: `\nå¼€å§‹: ${this.formatFullDate(schedule.start_date)}\næˆªæ­¢: ${this.formatFullDate(schedule.deadline)}`
                            });
                        }
                    });

                    // æŒ‰æˆªæ­¢æ—¶é—´æ’åº
                    bars.sort((a, b) => {
                        const aDeadline = this.monthSchedules.find(s => s.id === a.id)?.deadline;
                        const bDeadline = this.monthSchedules.find(s => s.id === b.id)?.deadline;
                        if (!aDeadline && !bDeadline) return 0;
                        if (!aDeadline) return 1;
                        if (!bDeadline) return -1;
                        return new Date(aDeadline) - new Date(bDeadline);
                    });

                    return bars;
                },

                // è·å–æœˆè§†å›¾Scheduleè·¨è¶Šä¿¡æ¯
                getMonthScheduleSpanInfo(schedule, currentDate) {
                    const startDate = schedule.start_date ? new Date(schedule.start_date) : null;
                    const endDate = schedule.deadline ? new Date(schedule.deadline) : null;

                    if (!startDate || !endDate) return null;

                    startDate.setHours(0, 0, 0, 0);
                    endDate.setHours(0, 0, 0, 0);
                    currentDate.setHours(0, 0, 0, 0);

                    const isFirstDay = currentDate.getTime() === startDate.getTime();
                    const isLastDay = currentDate.getTime() === endDate.getTime();
                    const isMiddleDay = currentDate > startDate && currentDate < endDate;

                    return {
                        isFirstDay,
                        isLastDay,
                        isMiddleDay,
                        totalDays: Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1
                    };
                },

                // è·å–æœˆè§†å›¾Scheduleæ˜¾ç¤ºæ–‡æœ¬
                getMonthScheduleDisplayText(schedule, spanInfo) {
                    if (!spanInfo) {
                        return schedule.name.length > 8 ? schedule.name.substring(0, 8) + '...' : schedule.name;
                    }

                    const shortName = schedule.name.length > 6 ? schedule.name.substring(0, 6) + '...' : schedule.name;

                    if (spanInfo.isFirstDay) {
                        return `â—€${shortName}`;
                    } else if (spanInfo.isLastDay) {
                        return `${shortName}â–¶`;
                    } else if (spanInfo.isMiddleDay) {
                        return `â”€â”€${shortName}â”€â”€`;
                    }

                    return shortName;
                },

                // è·å–æ—¶é—´æ§½åç§°çš„è¾…åŠ©æ–¹æ³•
                getTimeSlotName(timeSlotValue) {
                    const slot = this.timeSlots.find(s => s.value === timeSlotValue);
                    return slot ? slot.name.replace('ç¬¬1æ—¶æ®µ', '1').replace('ç¬¬2æ—¶æ®µ', '2').replace('æ—¶æ®µ', '') : `æ—¶æ®µ${timeSlotValue}`;
                },

                // æ ¼å¼åŒ–æ—¶é—´ä¸ºAPIæ ‡å‡†æ ¼å¼
                formatTimeForAPI(timeString) {
                    if (!timeString) return null;

                    console.log('ğŸ• Formatting time for API:', timeString, 'length:', timeString.length);

                    // ç¡®ä¿æ—¶é—´æ ¼å¼ä¸ºHH:MM:SSï¼ˆAPIæœŸæœ›çš„æ ¼å¼ï¼‰
                    if (timeString.length === 4 || timeString.length === 5) { // "8:40" or "08:40" -> "08:40:00"
                        const [hours, minutes] = timeString.split(':');
                        const formatted = hours.padStart(2, '0') + ':' + minutes.padStart(2, '0') + ':00';
                        console.log('ğŸ• Formatted result:', formatted);
                        return formatted;
                    } else if (timeString.length === 8) { // "08:40:00" å·²ç»æ˜¯æ­£ç¡®æ ¼å¼
                        console.log('ğŸ• Already in correct format:', timeString);
                        return timeString;
                    }

                    console.warn('ğŸš¨ Unexpected time format:', timeString, 'length:', timeString.length);
                    return timeString;
                }
            }
        }

        // å…¨å±€è¾…åŠ©å‡½æ•°
        async function deleteActivity(activityId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ´»åŠ¨å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰ç›¸å…³çš„æ—¥ç¨‹å®‰æ’ã€‚')) {
                try {
                    await fetch(`/api/activities/${activityId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    // åˆ·æ–°é¡µé¢
                    location.reload();
                } catch (error) {
                    console.error('åˆ é™¤æ´»åŠ¨å¤±è´¥:', error);
                    alert('åˆ é™¤å¤±è´¥');
                }
            }
        }
    </script>
</body>
</html>